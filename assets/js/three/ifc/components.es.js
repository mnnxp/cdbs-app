/**
 * Bundled by jsDelivr using Rollup v2.79.2 and Terser v5.39.0.
 * Original file: /npm/@thatopen/components@3.2.6/dist/index.mjs
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import*as t from"./fragments.es.js";import{DataMap as e,FragmentsModels as i}from"./fragments.es.js";import*as s from"../three.module.min.js";import{Vector3 as n,Vector2 as r,Plane as o,Line3 as a,Box3 as h,Mesh as l,Raycaster as c,Quaternion as u,Euler as d,Matrix4 as p,Triangle as f,Sphere as m,Controls as g,Object3D as _,MeshBasicMaterial as y,LineBasicMaterial as w,CylinderGeometry as v,BoxGeometry as b,BufferGeometry as x,Float32BufferAttribute as E,OctahedronGeometry as T,Line as A,SphereGeometry as C,TorusGeometry as S,PlaneGeometry as O,DoubleSide as P,BufferAttribute as I,FrontSide as D,Ray as k,BackSide as z}from"../three.module.min.js";import*as M from"./web-ifc-api.js";var B="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},U=[],R=[],N="undefined"!=typeof Uint8Array?Uint8Array:Array,L=!1;function F(){L=!0;for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e=0;e<64;++e)U[e]=t[e],R[t.charCodeAt(e)]=e;R["-".charCodeAt(0)]=62,R["_".charCodeAt(0)]=63}function V(t,e,i){for(var s,n,r=[],o=e;o<i;o+=3)s=(t[o]<<16)+(t[o+1]<<8)+t[o+2],r.push(U[(n=s)>>18&63]+U[n>>12&63]+U[n>>6&63]+U[63&n]);return r.join("")}function j(t){var e;L||F();for(var i=t.length,s=i%3,n="",r=[],o=16383,a=0,h=i-s;a<h;a+=o)r.push(V(t,a,a+o>h?h:a+o));return 1===s?(e=t[i-1],n+=U[e>>2],n+=U[e<<4&63],n+="=="):2===s&&(e=(t[i-2]<<8)+t[i-1],n+=U[e>>10],n+=U[e>>4&63],n+=U[e<<2&63],n+="="),r.push(n),r.join("")}function Y(t,e,i,s,n){var r,o,a=8*n-s-1,h=(1<<a)-1,l=h>>1,c=-7,u=i?n-1:0,d=i?-1:1,p=t[e+u];for(u+=d,r=p&(1<<-c)-1,p>>=-c,c+=a;c>0;r=256*r+t[e+u],u+=d,c-=8);for(o=r&(1<<-c)-1,r>>=-c,c+=s;c>0;o=256*o+t[e+u],u+=d,c-=8);if(0===r)r=1-l;else{if(r===h)return o?NaN:1/0*(p?-1:1);o+=Math.pow(2,s),r-=l}return(p?-1:1)*o*Math.pow(2,r-s)}function Z(t,e,i,s,n,r){var o,a,h,l=8*r-n-1,c=(1<<l)-1,u=c>>1,d=23===n?Math.pow(2,-24)-Math.pow(2,-77):0,p=s?0:r-1,f=s?1:-1,m=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,o=c):(o=Math.floor(Math.log(e)/Math.LN2),e*(h=Math.pow(2,-o))<1&&(o--,h*=2),(e+=o+u>=1?d/h:d*Math.pow(2,1-u))*h>=2&&(o++,h/=2),o+u>=c?(a=0,o=c):o+u>=1?(a=(e*h-1)*Math.pow(2,n),o+=u):(a=e*Math.pow(2,u-1)*Math.pow(2,n),o=0));n>=8;t[i+p]=255&a,p+=f,a/=256,n-=8);for(o=o<<n|a,l+=n;l>0;t[i+p]=255&o,p+=f,o/=256,l-=8);t[i+p-f]|=128*m}var H={}.toString,$=Array.isArray||function(t){return"[object Array]"==H.call(t)};function W(){return X.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function q(t,e){if(W()<e)throw new RangeError("Invalid typed array length");return X.TYPED_ARRAY_SUPPORT?(t=new Uint8Array(e)).__proto__=X.prototype:(null===t&&(t=new X(e)),t.length=e),t}function X(t,e,i){if(!(X.TYPED_ARRAY_SUPPORT||this instanceof X))return new X(t,e,i);if("number"==typeof t){if("string"==typeof e)throw new Error("If encoding is specified then the first argument must be a string");return K(this,t)}return G(this,t,e,i)}function G(t,e,i,s){if("number"==typeof e)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&e instanceof ArrayBuffer?function(t,e,i,s){if(e.byteLength,i<0||e.byteLength<i)throw new RangeError("'offset' is out of bounds");if(e.byteLength<i+(s||0))throw new RangeError("'length' is out of bounds");e=void 0===i&&void 0===s?new Uint8Array(e):void 0===s?new Uint8Array(e,i):new Uint8Array(e,i,s);X.TYPED_ARRAY_SUPPORT?(t=e).__proto__=X.prototype:t=J(t,e);return t}(t,e,i,s):"string"==typeof e?function(t,e,i){"string"==typeof i&&""!==i||(i="utf8");if(!X.isEncoding(i))throw new TypeError('"encoding" must be a valid string encoding');var s=0|it(e,i);t=q(t,s);var n=t.write(e,i);n!==s&&(t=t.slice(0,n));return t}(t,e,i):function(t,e){if(et(e)){var i=0|tt(e.length);return 0===(t=q(t,i)).length||e.copy(t,0,0,i),t}if(e){if("undefined"!=typeof ArrayBuffer&&e.buffer instanceof ArrayBuffer||"length"in e)return"number"!=typeof e.length||function(t){return t!=t}(e.length)?q(t,0):J(t,e);if("Buffer"===e.type&&$(e.data))return J(t,e.data)}throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(t,e)}function Q(t){if("number"!=typeof t)throw new TypeError('"size" argument must be a number');if(t<0)throw new RangeError('"size" argument must not be negative')}function K(t,e){if(Q(e),t=q(t,e<0?0:0|tt(e)),!X.TYPED_ARRAY_SUPPORT)for(var i=0;i<e;++i)t[i]=0;return t}function J(t,e){var i=e.length<0?0:0|tt(e.length);t=q(t,i);for(var s=0;s<i;s+=1)t[s]=255&e[s];return t}function tt(t){if(t>=W())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+W().toString(16)+" bytes");return 0|t}function et(t){return!(null==t||!t._isBuffer)}function it(t,e){if(et(t))return t.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(t)||t instanceof ArrayBuffer))return t.byteLength;"string"!=typeof t&&(t=""+t);var i=t.length;if(0===i)return 0;for(var s=!1;;)switch(e){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":case void 0:return Pt(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return It(t).length;default:if(s)return Pt(t).length;e=(""+e).toLowerCase(),s=!0}}function st(t,e,i){var s=!1;if((void 0===e||e<0)&&(e=0),e>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),i<=0)return"";if((i>>>=0)<=(e>>>=0))return"";for(t||(t="utf8");;)switch(t){case"hex":return yt(this,e,i);case"utf8":case"utf-8":return ft(this,e,i);case"ascii":return gt(this,e,i);case"latin1":case"binary":return _t(this,e,i);case"base64":return pt(this,e,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return wt(this,e,i);default:if(s)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),s=!0}}function nt(t,e,i){var s=t[e];t[e]=t[i],t[i]=s}function rt(t,e,i,s,n){if(0===t.length)return-1;if("string"==typeof i?(s=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),i=+i,isNaN(i)&&(i=n?0:t.length-1),i<0&&(i=t.length+i),i>=t.length){if(n)return-1;i=t.length-1}else if(i<0){if(!n)return-1;i=0}if("string"==typeof e&&(e=X.from(e,s)),et(e))return 0===e.length?-1:ot(t,e,i,s,n);if("number"==typeof e)return e&=255,X.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?n?Uint8Array.prototype.indexOf.call(t,e,i):Uint8Array.prototype.lastIndexOf.call(t,e,i):ot(t,[e],i,s,n);throw new TypeError("val must be string, number or Buffer")}function ot(t,e,i,s,n){var r,o=1,a=t.length,h=e.length;if(void 0!==s&&("ucs2"===(s=String(s).toLowerCase())||"ucs-2"===s||"utf16le"===s||"utf-16le"===s)){if(t.length<2||e.length<2)return-1;o=2,a/=2,h/=2,i/=2}function l(t,e){return 1===o?t[e]:t.readUInt16BE(e*o)}if(n){var c=-1;for(r=i;r<a;r++)if(l(t,r)===l(e,-1===c?0:r-c)){if(-1===c&&(c=r),r-c+1===h)return c*o}else-1!==c&&(r-=r-c),c=-1}else for(i+h>a&&(i=a-h),r=i;r>=0;r--){for(var u=!0,d=0;d<h;d++)if(l(t,r+d)!==l(e,d)){u=!1;break}if(u)return r}return-1}function at(t,e,i,s){i=Number(i)||0;var n=t.length-i;s?(s=Number(s))>n&&(s=n):s=n;var r=e.length;if(r%2!=0)throw new TypeError("Invalid hex string");s>r/2&&(s=r/2);for(var o=0;o<s;++o){var a=parseInt(e.substr(2*o,2),16);if(isNaN(a))return o;t[i+o]=a}return o}function ht(t,e,i,s){return Dt(Pt(e,t.length-i),t,i,s)}function lt(t,e,i,s){return Dt(function(t){for(var e=[],i=0;i<t.length;++i)e.push(255&t.charCodeAt(i));return e}(e),t,i,s)}function ct(t,e,i,s){return lt(t,e,i,s)}function ut(t,e,i,s){return Dt(It(e),t,i,s)}function dt(t,e,i,s){return Dt(function(t,e){for(var i,s,n,r=[],o=0;o<t.length&&!((e-=2)<0);++o)s=(i=t.charCodeAt(o))>>8,n=i%256,r.push(n),r.push(s);return r}(e,t.length-i),t,i,s)}function pt(t,e,i){return 0===e&&i===t.length?j(t):j(t.slice(e,i))}function ft(t,e,i){i=Math.min(t.length,i);for(var s=[],n=e;n<i;){var r,o,a,h,l=t[n],c=null,u=l>239?4:l>223?3:l>191?2:1;if(n+u<=i)switch(u){case 1:l<128&&(c=l);break;case 2:128==(192&(r=t[n+1]))&&(h=(31&l)<<6|63&r)>127&&(c=h);break;case 3:r=t[n+1],o=t[n+2],128==(192&r)&&128==(192&o)&&(h=(15&l)<<12|(63&r)<<6|63&o)>2047&&(h<55296||h>57343)&&(c=h);break;case 4:r=t[n+1],o=t[n+2],a=t[n+3],128==(192&r)&&128==(192&o)&&128==(192&a)&&(h=(15&l)<<18|(63&r)<<12|(63&o)<<6|63&a)>65535&&h<1114112&&(c=h)}null===c?(c=65533,u=1):c>65535&&(c-=65536,s.push(c>>>10&1023|55296),c=56320|1023&c),s.push(c),n+=u}return function(t){var e=t.length;if(e<=mt)return String.fromCharCode.apply(String,t);var i="",s=0;for(;s<e;)i+=String.fromCharCode.apply(String,t.slice(s,s+=mt));return i}(s)}X.TYPED_ARRAY_SUPPORT=void 0===B.TYPED_ARRAY_SUPPORT||B.TYPED_ARRAY_SUPPORT,W(),X.poolSize=8192,X._augment=function(t){return t.__proto__=X.prototype,t},X.from=function(t,e,i){return G(null,t,e,i)},X.TYPED_ARRAY_SUPPORT&&(X.prototype.__proto__=Uint8Array.prototype,X.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&X[Symbol.species]),X.alloc=function(t,e,i){return function(t,e,i,s){return Q(e),e<=0?q(t,e):void 0!==i?"string"==typeof s?q(t,e).fill(i,s):q(t,e).fill(i):q(t,e)}(null,t,e,i)},X.allocUnsafe=function(t){return K(null,t)},X.allocUnsafeSlow=function(t){return K(null,t)},X.isBuffer=function(t){return null!=t&&(!!t._isBuffer||kt(t)||function(t){return"function"==typeof t.readFloatLE&&"function"==typeof t.slice&&kt(t.slice(0,0))}(t))},X.compare=function(t,e){if(!et(t)||!et(e))throw new TypeError("Arguments must be Buffers");if(t===e)return 0;for(var i=t.length,s=e.length,n=0,r=Math.min(i,s);n<r;++n)if(t[n]!==e[n]){i=t[n],s=e[n];break}return i<s?-1:s<i?1:0},X.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},X.concat=function(t,e){if(!$(t))throw new TypeError('"list" argument must be an Array of Buffers');if(0===t.length)return X.alloc(0);var i;if(void 0===e)for(e=0,i=0;i<t.length;++i)e+=t[i].length;var s=X.allocUnsafe(e),n=0;for(i=0;i<t.length;++i){var r=t[i];if(!et(r))throw new TypeError('"list" argument must be an Array of Buffers');r.copy(s,n),n+=r.length}return s},X.byteLength=it,X.prototype._isBuffer=!0,X.prototype.swap16=function(){var t=this.length;if(t%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var e=0;e<t;e+=2)nt(this,e,e+1);return this},X.prototype.swap32=function(){var t=this.length;if(t%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var e=0;e<t;e+=4)nt(this,e,e+3),nt(this,e+1,e+2);return this},X.prototype.swap64=function(){var t=this.length;if(t%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var e=0;e<t;e+=8)nt(this,e,e+7),nt(this,e+1,e+6),nt(this,e+2,e+5),nt(this,e+3,e+4);return this},X.prototype.toString=function(){var t=0|this.length;return 0===t?"":0===arguments.length?ft(this,0,t):st.apply(this,arguments)},X.prototype.equals=function(t){if(!et(t))throw new TypeError("Argument must be a Buffer");return this===t||0===X.compare(this,t)},X.prototype.inspect=function(){var t="";return this.length>0&&(t=this.toString("hex",0,50).match(/.{2}/g).join(" "),this.length>50&&(t+=" ... ")),"<Buffer "+t+">"},X.prototype.compare=function(t,e,i,s,n){if(!et(t))throw new TypeError("Argument must be a Buffer");if(void 0===e&&(e=0),void 0===i&&(i=t?t.length:0),void 0===s&&(s=0),void 0===n&&(n=this.length),e<0||i>t.length||s<0||n>this.length)throw new RangeError("out of range index");if(s>=n&&e>=i)return 0;if(s>=n)return-1;if(e>=i)return 1;if(this===t)return 0;for(var r=(n>>>=0)-(s>>>=0),o=(i>>>=0)-(e>>>=0),a=Math.min(r,o),h=this.slice(s,n),l=t.slice(e,i),c=0;c<a;++c)if(h[c]!==l[c]){r=h[c],o=l[c];break}return r<o?-1:o<r?1:0},X.prototype.includes=function(t,e,i){return-1!==this.indexOf(t,e,i)},X.prototype.indexOf=function(t,e,i){return rt(this,t,e,i,!0)},X.prototype.lastIndexOf=function(t,e,i){return rt(this,t,e,i,!1)},X.prototype.write=function(t,e,i,s){if(void 0===e)s="utf8",i=this.length,e=0;else if(void 0===i&&"string"==typeof e)s=e,i=this.length,e=0;else{if(!isFinite(e))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");e|=0,isFinite(i)?(i|=0,void 0===s&&(s="utf8")):(s=i,i=void 0)}var n=this.length-e;if((void 0===i||i>n)&&(i=n),t.length>0&&(i<0||e<0)||e>this.length)throw new RangeError("Attempt to write outside buffer bounds");s||(s="utf8");for(var r=!1;;)switch(s){case"hex":return at(this,t,e,i);case"utf8":case"utf-8":return ht(this,t,e,i);case"ascii":return lt(this,t,e,i);case"latin1":case"binary":return ct(this,t,e,i);case"base64":return ut(this,t,e,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return dt(this,t,e,i);default:if(r)throw new TypeError("Unknown encoding: "+s);s=(""+s).toLowerCase(),r=!0}},X.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var mt=4096;function gt(t,e,i){var s="";i=Math.min(t.length,i);for(var n=e;n<i;++n)s+=String.fromCharCode(127&t[n]);return s}function _t(t,e,i){var s="";i=Math.min(t.length,i);for(var n=e;n<i;++n)s+=String.fromCharCode(t[n]);return s}function yt(t,e,i){var s=t.length;(!e||e<0)&&(e=0),(!i||i<0||i>s)&&(i=s);for(var n="",r=e;r<i;++r)n+=Ot(t[r]);return n}function wt(t,e,i){for(var s=t.slice(e,i),n="",r=0;r<s.length;r+=2)n+=String.fromCharCode(s[r]+256*s[r+1]);return n}function vt(t,e,i){if(t%1!=0||t<0)throw new RangeError("offset is not uint");if(t+e>i)throw new RangeError("Trying to access beyond buffer length")}function bt(t,e,i,s,n,r){if(!et(t))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>n||e<r)throw new RangeError('"value" argument is out of bounds');if(i+s>t.length)throw new RangeError("Index out of range")}function xt(t,e,i,s){e<0&&(e=65535+e+1);for(var n=0,r=Math.min(t.length-i,2);n<r;++n)t[i+n]=(e&255<<8*(s?n:1-n))>>>8*(s?n:1-n)}function Et(t,e,i,s){e<0&&(e=4294967295+e+1);for(var n=0,r=Math.min(t.length-i,4);n<r;++n)t[i+n]=e>>>8*(s?n:3-n)&255}function Tt(t,e,i,s,n,r){if(i+s>t.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function At(t,e,i,s,n){return n||Tt(t,0,i,4),Z(t,e,i,s,23,4),i+4}function Ct(t,e,i,s,n){return n||Tt(t,0,i,8),Z(t,e,i,s,52,8),i+8}X.prototype.slice=function(t,e){var i,s=this.length;if((t=~~t)<0?(t+=s)<0&&(t=0):t>s&&(t=s),(e=void 0===e?s:~~e)<0?(e+=s)<0&&(e=0):e>s&&(e=s),e<t&&(e=t),X.TYPED_ARRAY_SUPPORT)(i=this.subarray(t,e)).__proto__=X.prototype;else{var n=e-t;i=new X(n,void 0);for(var r=0;r<n;++r)i[r]=this[r+t]}return i},X.prototype.readUIntLE=function(t,e,i){t|=0,e|=0,i||vt(t,e,this.length);for(var s=this[t],n=1,r=0;++r<e&&(n*=256);)s+=this[t+r]*n;return s},X.prototype.readUIntBE=function(t,e,i){t|=0,e|=0,i||vt(t,e,this.length);for(var s=this[t+--e],n=1;e>0&&(n*=256);)s+=this[t+--e]*n;return s},X.prototype.readUInt8=function(t,e){return e||vt(t,1,this.length),this[t]},X.prototype.readUInt16LE=function(t,e){return e||vt(t,2,this.length),this[t]|this[t+1]<<8},X.prototype.readUInt16BE=function(t,e){return e||vt(t,2,this.length),this[t]<<8|this[t+1]},X.prototype.readUInt32LE=function(t,e){return e||vt(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},X.prototype.readUInt32BE=function(t,e){return e||vt(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},X.prototype.readIntLE=function(t,e,i){t|=0,e|=0,i||vt(t,e,this.length);for(var s=this[t],n=1,r=0;++r<e&&(n*=256);)s+=this[t+r]*n;return s>=(n*=128)&&(s-=Math.pow(2,8*e)),s},X.prototype.readIntBE=function(t,e,i){t|=0,e|=0,i||vt(t,e,this.length);for(var s=e,n=1,r=this[t+--s];s>0&&(n*=256);)r+=this[t+--s]*n;return r>=(n*=128)&&(r-=Math.pow(2,8*e)),r},X.prototype.readInt8=function(t,e){return e||vt(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},X.prototype.readInt16LE=function(t,e){e||vt(t,2,this.length);var i=this[t]|this[t+1]<<8;return 32768&i?4294901760|i:i},X.prototype.readInt16BE=function(t,e){e||vt(t,2,this.length);var i=this[t+1]|this[t]<<8;return 32768&i?4294901760|i:i},X.prototype.readInt32LE=function(t,e){return e||vt(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},X.prototype.readInt32BE=function(t,e){return e||vt(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},X.prototype.readFloatLE=function(t,e){return e||vt(t,4,this.length),Y(this,t,!0,23,4)},X.prototype.readFloatBE=function(t,e){return e||vt(t,4,this.length),Y(this,t,!1,23,4)},X.prototype.readDoubleLE=function(t,e){return e||vt(t,8,this.length),Y(this,t,!0,52,8)},X.prototype.readDoubleBE=function(t,e){return e||vt(t,8,this.length),Y(this,t,!1,52,8)},X.prototype.writeUIntLE=function(t,e,i,s){(t=+t,e|=0,i|=0,s)||bt(this,t,e,i,Math.pow(2,8*i)-1,0);var n=1,r=0;for(this[e]=255&t;++r<i&&(n*=256);)this[e+r]=t/n&255;return e+i},X.prototype.writeUIntBE=function(t,e,i,s){(t=+t,e|=0,i|=0,s)||bt(this,t,e,i,Math.pow(2,8*i)-1,0);var n=i-1,r=1;for(this[e+n]=255&t;--n>=0&&(r*=256);)this[e+n]=t/r&255;return e+i},X.prototype.writeUInt8=function(t,e,i){return t=+t,e|=0,i||bt(this,t,e,1,255,0),X.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),this[e]=255&t,e+1},X.prototype.writeUInt16LE=function(t,e,i){return t=+t,e|=0,i||bt(this,t,e,2,65535,0),X.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):xt(this,t,e,!0),e+2},X.prototype.writeUInt16BE=function(t,e,i){return t=+t,e|=0,i||bt(this,t,e,2,65535,0),X.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):xt(this,t,e,!1),e+2},X.prototype.writeUInt32LE=function(t,e,i){return t=+t,e|=0,i||bt(this,t,e,4,4294967295,0),X.TYPED_ARRAY_SUPPORT?(this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=255&t):Et(this,t,e,!0),e+4},X.prototype.writeUInt32BE=function(t,e,i){return t=+t,e|=0,i||bt(this,t,e,4,4294967295,0),X.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):Et(this,t,e,!1),e+4},X.prototype.writeIntLE=function(t,e,i,s){if(t=+t,e|=0,!s){var n=Math.pow(2,8*i-1);bt(this,t,e,i,n-1,-n)}var r=0,o=1,a=0;for(this[e]=255&t;++r<i&&(o*=256);)t<0&&0===a&&0!==this[e+r-1]&&(a=1),this[e+r]=(t/o|0)-a&255;return e+i},X.prototype.writeIntBE=function(t,e,i,s){if(t=+t,e|=0,!s){var n=Math.pow(2,8*i-1);bt(this,t,e,i,n-1,-n)}var r=i-1,o=1,a=0;for(this[e+r]=255&t;--r>=0&&(o*=256);)t<0&&0===a&&0!==this[e+r+1]&&(a=1),this[e+r]=(t/o|0)-a&255;return e+i},X.prototype.writeInt8=function(t,e,i){return t=+t,e|=0,i||bt(this,t,e,1,127,-128),X.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),t<0&&(t=255+t+1),this[e]=255&t,e+1},X.prototype.writeInt16LE=function(t,e,i){return t=+t,e|=0,i||bt(this,t,e,2,32767,-32768),X.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):xt(this,t,e,!0),e+2},X.prototype.writeInt16BE=function(t,e,i){return t=+t,e|=0,i||bt(this,t,e,2,32767,-32768),X.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):xt(this,t,e,!1),e+2},X.prototype.writeInt32LE=function(t,e,i){return t=+t,e|=0,i||bt(this,t,e,4,2147483647,-2147483648),X.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24):Et(this,t,e,!0),e+4},X.prototype.writeInt32BE=function(t,e,i){return t=+t,e|=0,i||bt(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),X.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):Et(this,t,e,!1),e+4},X.prototype.writeFloatLE=function(t,e,i){return At(this,t,e,!0,i)},X.prototype.writeFloatBE=function(t,e,i){return At(this,t,e,!1,i)},X.prototype.writeDoubleLE=function(t,e,i){return Ct(this,t,e,!0,i)},X.prototype.writeDoubleBE=function(t,e,i){return Ct(this,t,e,!1,i)},X.prototype.copy=function(t,e,i,s){if(i||(i=0),s||0===s||(s=this.length),e>=t.length&&(e=t.length),e||(e=0),s>0&&s<i&&(s=i),s===i)return 0;if(0===t.length||0===this.length)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("sourceStart out of bounds");if(s<0)throw new RangeError("sourceEnd out of bounds");s>this.length&&(s=this.length),t.length-e<s-i&&(s=t.length-e+i);var n,r=s-i;if(this===t&&i<e&&e<s)for(n=r-1;n>=0;--n)t[n+e]=this[n+i];else if(r<1e3||!X.TYPED_ARRAY_SUPPORT)for(n=0;n<r;++n)t[n+e]=this[n+i];else Uint8Array.prototype.set.call(t,this.subarray(i,i+r),e);return r},X.prototype.fill=function(t,e,i,s){if("string"==typeof t){if("string"==typeof e?(s=e,e=0,i=this.length):"string"==typeof i&&(s=i,i=this.length),1===t.length){var n=t.charCodeAt(0);n<256&&(t=n)}if(void 0!==s&&"string"!=typeof s)throw new TypeError("encoding must be a string");if("string"==typeof s&&!X.isEncoding(s))throw new TypeError("Unknown encoding: "+s)}else"number"==typeof t&&(t&=255);if(e<0||this.length<e||this.length<i)throw new RangeError("Out of range index");if(i<=e)return this;var r;if(e>>>=0,i=void 0===i?this.length:i>>>0,t||(t=0),"number"==typeof t)for(r=e;r<i;++r)this[r]=t;else{var o=et(t)?t:Pt(new X(t,s).toString()),a=o.length;for(r=0;r<i-e;++r)this[r+e]=o[r%a]}return this};var St=/[^+\/0-9A-Za-z-_]/g;function Ot(t){return t<16?"0"+t.toString(16):t.toString(16)}function Pt(t,e){var i;e=e||1/0;for(var s=t.length,n=null,r=[],o=0;o<s;++o){if((i=t.charCodeAt(o))>55295&&i<57344){if(!n){if(i>56319){(e-=3)>-1&&r.push(239,191,189);continue}if(o+1===s){(e-=3)>-1&&r.push(239,191,189);continue}n=i;continue}if(i<56320){(e-=3)>-1&&r.push(239,191,189),n=i;continue}i=65536+(n-55296<<10|i-56320)}else n&&(e-=3)>-1&&r.push(239,191,189);if(n=null,i<128){if((e-=1)<0)break;r.push(i)}else if(i<2048){if((e-=2)<0)break;r.push(i>>6|192,63&i|128)}else if(i<65536){if((e-=3)<0)break;r.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((e-=4)<0)break;r.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return r}function It(t){return function(t){var e,i,s,n,r,o;L||F();var a=t.length;if(a%4>0)throw new Error("Invalid string. Length must be a multiple of 4");r="="===t[a-2]?2:"="===t[a-1]?1:0,o=new N(3*a/4-r),s=r>0?a-4:a;var h=0;for(e=0,i=0;e<s;e+=4,i+=3)n=R[t.charCodeAt(e)]<<18|R[t.charCodeAt(e+1)]<<12|R[t.charCodeAt(e+2)]<<6|R[t.charCodeAt(e+3)],o[h++]=n>>16&255,o[h++]=n>>8&255,o[h++]=255&n;return 2===r?(n=R[t.charCodeAt(e)]<<2|R[t.charCodeAt(e+1)]>>4,o[h++]=255&n):1===r&&(n=R[t.charCodeAt(e)]<<10|R[t.charCodeAt(e+1)]<<4|R[t.charCodeAt(e+2)]>>2,o[h++]=n>>8&255,o[h++]=255&n),o}(function(t){if((t=function(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}(t).replace(St,"")).length<2)return"";for(;t.length%4!=0;)t+="=";return t}(t))}function Dt(t,e,i,s){for(var n=0;n<s&&!(n+i>=e.length||n>=t.length);++n)e[n+i]=t[n];return n}function kt(t){return!!t.constructor&&"function"==typeof t.constructor.isBuffer&&t.constructor.isBuffer(t)}function zt(){throw new Error("setTimeout has not been defined")}function Mt(){throw new Error("clearTimeout has not been defined")}var Bt=zt,Ut=Mt;function Rt(t){if(Bt===setTimeout)return setTimeout(t,0);if((Bt===zt||!Bt)&&setTimeout)return Bt=setTimeout,setTimeout(t,0);try{return Bt(t,0)}catch(e){try{return Bt.call(null,t,0)}catch(e){return Bt.call(this,t,0)}}}"function"==typeof B.setTimeout&&(Bt=setTimeout),"function"==typeof B.clearTimeout&&(Ut=clearTimeout);var Nt,Lt=[],Ft=!1,Vt=-1;function jt(){Ft&&Nt&&(Ft=!1,Nt.length?Lt=Nt.concat(Lt):Vt=-1,Lt.length&&Yt())}function Yt(){if(!Ft){var t=Rt(jt);Ft=!0;for(var e=Lt.length;e;){for(Nt=Lt,Lt=[];++Vt<e;)Nt&&Nt[Vt].run();Vt=-1,e=Lt.length}Nt=null,Ft=!1,function(t){if(Ut===clearTimeout)return clearTimeout(t);if((Ut===Mt||!Ut)&&clearTimeout)return Ut=clearTimeout,clearTimeout(t);try{return Ut(t)}catch(e){try{return Ut.call(null,t)}catch(e){return Ut.call(this,t)}}}(t)}}function Zt(t,e){this.fun=t,this.array=e}Zt.prototype.run=function(){this.fun.apply(null,this.array)};function Ht(){}var $t=Ht,Wt=Ht,qt=Ht,Xt=Ht,Gt=Ht,Qt=Ht,Kt=Ht;var Jt=B.performance||{},te=Jt.now||Jt.mozNow||Jt.msNow||Jt.oNow||Jt.webkitNow||function(){return(new Date).getTime()};var ee=new Date;var ie={nextTick:function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];Lt.push(new Zt(t,e)),1!==Lt.length||Ft||Rt(Yt)},title:"browser",browser:!0,env:{},argv:[],version:"",versions:{},on:$t,addListener:Wt,once:qt,off:Xt,removeListener:Gt,removeAllListeners:Qt,emit:Kt,binding:function(t){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(t){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(t){var e=.001*te.call(Jt),i=Math.floor(e),s=Math.floor(e%1*1e9);return t&&(i-=t[0],(s-=t[1])<0&&(i--,s+=1e9)),[i,s]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-ee)/1e3}},se=Object.defineProperty,ne=(t,e,i)=>(((t,e,i)=>{e in t?se(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i})(t,"symbol"!=typeof e?e+"":e,i),i);class re{constructor(){ne(this,"enabled",!0),ne(this,"trigger",(t=>{if(!this.enabled)return;const e=this.handlers.slice(0);for(const i of e)i(t)})),ne(this,"handlers",[])}add(t){this.handlers.push(t)}remove(t){this.handlers=this.handlers.filter((e=>e!==t))}reset(){this.handlers.length=0}}class oe{constructor(){ne(this,"enabled",!0),ne(this,"trigger",(async t=>{if(!this.enabled)return;const e=this.handlers.slice(0);for(const i of e)await i(t)})),ne(this,"handlers",[])}add(t){this.handlers.push(t)}remove(t){this.handlers=this.handlers.filter((e=>e!==t))}reset(){this.handlers.length=0}}class ae{constructor(t){ne(this,"isDisposeable",(()=>"dispose"in this&&"onDisposed"in this)),ne(this,"isResizeable",(()=>"resize"in this&&"getSize"in this)),ne(this,"isUpdateable",(()=>"onAfterUpdate"in this&&"onBeforeUpdate"in this&&"update"in this)),ne(this,"isHideable",(()=>"visible"in this)),ne(this,"isConfigurable",(()=>"setup"in this&&"config"in this&&"onSetup"in this)),ne(this,"isSerializable",(()=>"import"in this&&"export"in this)),this.components=t}}class he extends ae{}class le extends ae{constructor(t){super(t),ne(this,"worlds",new e),ne(this,"onWorldChanged",new re),ne(this,"_currentWorld",null),this.onWorldChanged.add((({world:t,action:e})=>{"removed"===e&&this.worlds.delete(t.uuid)}))}set currentWorld(t){this._currentWorld=t}get currentWorld(){return this._currentWorld}}class ce extends le{constructor(){super(...arguments),ne(this,"hasCameraControls",(()=>"controls"in this))}}class ue extends le{constructor(){super(...arguments),ne(this,"onAfterUpdate",new re),ne(this,"onBeforeUpdate",new re),ne(this,"onDisposed",new re),ne(this,"onResize",new re),ne(this,"onClippingPlanesUpdated",new re),ne(this,"clippingPlanes",[])}updateClippingPlanes(){this.onClippingPlanesUpdated.trigger()}setPlane(t,e,i){e.isLocal=i;const s=this.clippingPlanes.indexOf(e);t&&-1===s?this.clippingPlanes.push(e):!t&&s>-1&&this.clippingPlanes.splice(s,1),this.three.clippingPlanes=this.clippingPlanes.filter((t=>!t.isLocal))}}const de=class t extends he{constructor(e){super(e),ne(this,"_disposedComponents",new Set),ne(this,"enabled",!0),e.add(t.uuid,this)}get(){return this._disposedComponents}destroy(t,e=!0,i=!0){t.removeFromParent();const s=t;s.dispose&&s.dispose(),this.disposeGeometryAndMaterials(t,e),i&&s.children&&s.children.length&&this.disposeChildren(s),t.children.length=0}disposeGeometry(t){t.boundsTree&&t.disposeBoundsTree&&t.disposeBoundsTree(),t.dispose()}disposeGeometryAndMaterials(e,i){const s=e;s.geometry&&this.disposeGeometry(s.geometry),i&&s.material&&t.disposeMaterial(s),s.material=[],s.geometry=null}disposeChildren(t){for(const e of t.children)this.destroy(e)}static disposeMaterial(t){if(t.material)if(Array.isArray(t.material))for(const e of t.material)e.dispose();else t.material.dispose()}};ne(de,"uuid","76e9cd8e-ad8f-4753-9ef6-cbc60f7247fe");let pe=de;class fe extends le{constructor(t){super(t),ne(this,"onDisposed",new re),ne(this,"directionalLights",new Map),ne(this,"ambientLights",new Map)}dispose(){const t=this.components.get(pe);for(const e of this.three.children){const i=e;i.geometry&&t.destroy(i)}this.deleteAllLights(),this.three.children=[],this.onDisposed.trigger(),this.onDisposed.reset()}deleteAllLights(){for(const[,t]of this.directionalLights)t.removeFromParent(),t.target.removeFromParent(),t.dispose();this.directionalLights.clear();for(const[,t]of this.ambientLights)t.removeFromParent(),t.dispose();this.ambientLights.clear()}}class me extends Set{constructor(t){super(t),ne(this,"onItemAdded",new re),ne(this,"onItemDeleted",new re),ne(this,"onCleared",new re),ne(this,"guard",(()=>!0))}clear(){super.clear(),this.onCleared.trigger()}add(...t){for(const e of t){if(this.has(e))continue;this.guard(e)&&(super.add(e),this.onItemAdded||(this.onItemAdded=new re),this.onItemAdded.trigger(e))}return this}delete(t){const e=super.delete(t);return e&&this.onItemDeleted.trigger(),e}dispose(){this.clear(),this.onItemAdded.reset(),this.onItemDeleted.reset(),this.onCleared.reset()}}const ge=class t{static create(){const e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,s=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return`${t._lut[255&e]+t._lut[e>>8&255]+t._lut[e>>16&255]+t._lut[e>>24&255]}-${t._lut[255&i]}${t._lut[i>>8&255]}-${t._lut[i>>16&15|64]}${t._lut[i>>24&255]}-${t._lut[63&s|128]}${t._lut[s>>8&255]}-${t._lut[s>>16&255]}${t._lut[s>>24&255]}${t._lut[255&n]}${t._lut[n>>8&255]}${t._lut[n>>16&255]}${t._lut[n>>24&255]}`.toLowerCase()}static validate(e){if(!t._pattern.test(e))throw new Error(`${e} is not a valid UUID v4.\n\n- If you're the tool creator, you can take one from https://www.uuidgenerator.net/.\n\n- If you're using a platform tool, verify the uuid isn't misspelled or contact the tool creator.`)}};ne(ge,"_pattern",/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-4[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/),ne(ge,"_lut",["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"]);let _e=ge;var ye="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==B?B:"undefined"!=typeof self?self:{};function we(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var ve={},be={};!function(t){const e=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",i="["+e+"]["+(e+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040")+"]*",s=new RegExp("^"+i+"$");t.isExist=function(t){return void 0!==t},t.isEmptyObject=function(t){return 0===Object.keys(t).length},t.merge=function(t,e,i){if(e){const s=Object.keys(e),n=s.length;for(let r=0;r<n;r++)t[s[r]]="strict"===i?[e[s[r]]]:e[s[r]]}},t.getValue=function(e){return t.isExist(e)?e:""},t.isName=function(t){const e=s.exec(t);return!(null==e)},t.getAllMatches=function(t,e){const i=[];let s=e.exec(t);for(;s;){const n=[];n.startIndex=e.lastIndex-s[0].length;const r=s.length;for(let t=0;t<r;t++)n.push(s[t]);i.push(n),s=e.exec(t)}return i},t.nameRegexp=i}(be);const xe=be,Ee={allowBooleanAttributes:!1,unpairedTags:[]};function Te(t){return" "===t||"\t"===t||"\n"===t||"\r"===t}function Ae(t,e){const i=e;for(;e<t.length;e++)if("?"!=t[e]&&" "!=t[e]);else{const s=t.substr(i,e-i);if(e>5&&"xml"===s)return ze("InvalidXml","XML declaration allowed only at the start of the document.",Be(t,e));if("?"==t[e]&&">"==t[e+1]){e++;break}}return e}function Ce(t,e){if(t.length>e+5&&"-"===t[e+1]&&"-"===t[e+2]){for(e+=3;e<t.length;e++)if("-"===t[e]&&"-"===t[e+1]&&">"===t[e+2]){e+=2;break}}else if(t.length>e+8&&"D"===t[e+1]&&"O"===t[e+2]&&"C"===t[e+3]&&"T"===t[e+4]&&"Y"===t[e+5]&&"P"===t[e+6]&&"E"===t[e+7]){let i=1;for(e+=8;e<t.length;e++)if("<"===t[e])i++;else if(">"===t[e]&&(i--,0===i))break}else if(t.length>e+9&&"["===t[e+1]&&"C"===t[e+2]&&"D"===t[e+3]&&"A"===t[e+4]&&"T"===t[e+5]&&"A"===t[e+6]&&"["===t[e+7])for(e+=8;e<t.length;e++)if("]"===t[e]&&"]"===t[e+1]&&">"===t[e+2]){e+=2;break}return e}ve.validate=function(t,e){e=Object.assign({},Ee,e);const i=[];let s=!1,n=!1;"\ufeff"===t[0]&&(t=t.substr(1));for(let o=0;o<t.length;o++)if("<"===t[o]&&"?"===t[o+1]){if(o+=2,o=Ae(t,o),o.err)return o}else{if("<"!==t[o]){if(Te(t[o]))continue;return ze("InvalidChar","char '"+t[o]+"' is not expected.",Be(t,o))}{let a=o;if(o++,"!"===t[o]){o=Ce(t,o);continue}{let h=!1;"/"===t[o]&&(h=!0,o++);let l="";for(;o<t.length&&">"!==t[o]&&" "!==t[o]&&"\t"!==t[o]&&"\n"!==t[o]&&"\r"!==t[o];o++)l+=t[o];if(l=l.trim(),"/"===l[l.length-1]&&(l=l.substring(0,l.length-1),o--),r=l,!xe.isName(r)){let e;return e=0===l.trim().length?"Invalid space after '<'.":"Tag '"+l+"' is an invalid name.",ze("InvalidTag",e,Be(t,o))}const c=Pe(t,o);if(!1===c)return ze("InvalidAttr","Attributes for '"+l+"' have open quote.",Be(t,o));let u=c.value;if(o=c.index,"/"===u[u.length-1]){const i=o-u.length;u=u.substring(0,u.length-1);const n=De(u,e);if(!0!==n)return ze(n.err.code,n.err.msg,Be(t,i+n.err.line));s=!0}else if(h){if(!c.tagClosed)return ze("InvalidTag","Closing tag '"+l+"' doesn't have proper closing.",Be(t,o));if(u.trim().length>0)return ze("InvalidTag","Closing tag '"+l+"' can't have attributes or invalid starting.",Be(t,a));if(0===i.length)return ze("InvalidTag","Closing tag '"+l+"' has not been opened.",Be(t,a));{const e=i.pop();if(l!==e.tagName){let i=Be(t,e.tagStartPos);return ze("InvalidTag","Expected closing tag '"+e.tagName+"' (opened in line "+i.line+", col "+i.col+") instead of closing tag '"+l+"'.",Be(t,a))}0==i.length&&(n=!0)}}else{const r=De(u,e);if(!0!==r)return ze(r.err.code,r.err.msg,Be(t,o-u.length+r.err.line));if(!0===n)return ze("InvalidXml","Multiple possible root nodes found.",Be(t,o));-1!==e.unpairedTags.indexOf(l)||i.push({tagName:l,tagStartPos:a}),s=!0}for(o++;o<t.length;o++)if("<"===t[o]){if("!"===t[o+1]){o++,o=Ce(t,o);continue}if("?"!==t[o+1])break;if(o=Ae(t,++o),o.err)return o}else if("&"===t[o]){const e=ke(t,o);if(-1==e)return ze("InvalidChar","char '&' is not expected.",Be(t,o));o=e}else if(!0===n&&!Te(t[o]))return ze("InvalidXml","Extra text at the end",Be(t,o));"<"===t[o]&&o--}}}var r;return s?1==i.length?ze("InvalidTag","Unclosed tag '"+i[0].tagName+"'.",Be(t,i[0].tagStartPos)):!(i.length>0)||ze("InvalidXml","Invalid '"+JSON.stringify(i.map((t=>t.tagName)),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1}):ze("InvalidXml","Start tag expected.",1)};const Se='"',Oe="'";function Pe(t,e){let i="",s="",n=!1;for(;e<t.length;e++){if(t[e]===Se||t[e]===Oe)""===s?s=t[e]:s!==t[e]||(s="");else if(">"===t[e]&&""===s){n=!0;break}i+=t[e]}return""===s&&{value:i,index:e,tagClosed:n}}const Ie=new RegExp("(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['\"])(([\\s\\S])*?)\\5)?","g");function De(t,e){const i=xe.getAllMatches(t,Ie),s={};for(let t=0;t<i.length;t++){if(0===i[t][1].length)return ze("InvalidAttr","Attribute '"+i[t][2]+"' has no space in starting.",Ue(i[t]));if(void 0!==i[t][3]&&void 0===i[t][4])return ze("InvalidAttr","Attribute '"+i[t][2]+"' is without value.",Ue(i[t]));if(void 0===i[t][3]&&!e.allowBooleanAttributes)return ze("InvalidAttr","boolean attribute '"+i[t][2]+"' is not allowed.",Ue(i[t]));const n=i[t][2];if(!Me(n))return ze("InvalidAttr","Attribute '"+n+"' is an invalid name.",Ue(i[t]));if(s.hasOwnProperty(n))return ze("InvalidAttr","Attribute '"+n+"' is repeated.",Ue(i[t]));s[n]=1}return!0}function ke(t,e){if(";"===t[++e])return-1;if("#"===t[e])return function(t,e){let i=/\d/;for("x"===t[e]&&(e++,i=/[\da-fA-F]/);e<t.length;e++){if(";"===t[e])return e;if(!t[e].match(i))break}return-1}(t,++e);let i=0;for(;e<t.length;e++,i++)if(!(t[e].match(/\w/)&&i<20)){if(";"===t[e])break;return-1}return e}function ze(t,e,i){return{err:{code:t,msg:e,line:i.line||i,col:i.col}}}function Me(t){return xe.isName(t)}function Be(t,e){const i=t.substring(0,e).split(/\r?\n/);return{line:i.length,col:i[i.length-1].length+1}}function Ue(t){return t.startIndex+t[1].length}var Re={};const Ne={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(t,e){return e},attributeValueProcessor:function(t,e){return e},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(t,e,i){return t}};Re.buildOptions=function(t){return Object.assign({},Ne,t)},Re.defaultOptions=Ne;const Le=be;function Fe(t,e){let i="";for(;e<t.length&&"'"!==t[e]&&'"'!==t[e];e++)i+=t[e];if(i=i.trim(),-1!==i.indexOf(" "))throw new Error("External entites are not supported");const s=t[e++];let n="";for(;e<t.length&&t[e]!==s;e++)n+=t[e];return[i,n,e]}function Ve(t,e){return"!"===t[e+1]&&"-"===t[e+2]&&"-"===t[e+3]}function je(t,e){return"!"===t[e+1]&&"E"===t[e+2]&&"N"===t[e+3]&&"T"===t[e+4]&&"I"===t[e+5]&&"T"===t[e+6]&&"Y"===t[e+7]}function Ye(t,e){return"!"===t[e+1]&&"E"===t[e+2]&&"L"===t[e+3]&&"E"===t[e+4]&&"M"===t[e+5]&&"E"===t[e+6]&&"N"===t[e+7]&&"T"===t[e+8]}function Ze(t,e){return"!"===t[e+1]&&"A"===t[e+2]&&"T"===t[e+3]&&"T"===t[e+4]&&"L"===t[e+5]&&"I"===t[e+6]&&"S"===t[e+7]&&"T"===t[e+8]}function He(t,e){return"!"===t[e+1]&&"N"===t[e+2]&&"O"===t[e+3]&&"T"===t[e+4]&&"A"===t[e+5]&&"T"===t[e+6]&&"I"===t[e+7]&&"O"===t[e+8]&&"N"===t[e+9]}function $e(t){if(Le.isName(t))return t;throw new Error(`Invalid entity name ${t}`)}const We=/^[-+]?0x[a-fA-F0-9]+$/,qe=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,Xe={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};const Ge=be,Qe=class{constructor(t){this.tagname=t,this.child=[],this[":@"]={}}add(t,e){"__proto__"===t&&(t="#__proto__"),this.child.push({[t]:e})}addChild(t){"__proto__"===t.tagname&&(t.tagname="#__proto__"),t[":@"]&&Object.keys(t[":@"]).length>0?this.child.push({[t.tagname]:t.child,":@":t[":@"]}):this.child.push({[t.tagname]:t.child})}},Ke=function(t,e){const i={};if("O"!==t[e+3]||"C"!==t[e+4]||"T"!==t[e+5]||"Y"!==t[e+6]||"P"!==t[e+7]||"E"!==t[e+8])throw new Error("Invalid Tag instead of DOCTYPE");{e+=9;let s=1,n=!1,r=!1,o="";for(;e<t.length;e++)if("<"!==t[e]||r)if(">"===t[e]){if(r?"-"===t[e-1]&&"-"===t[e-2]&&(r=!1,s--):s--,0===s)break}else"["===t[e]?n=!0:o+=t[e];else{if(n&&je(t,e))e+=7,[entityName,val,e]=Fe(t,e+1),-1===val.indexOf("&")&&(i[$e(entityName)]={regx:RegExp(`&${entityName};`,"g"),val:val});else if(n&&Ye(t,e))e+=8;else if(n&&Ze(t,e))e+=8;else if(n&&He(t,e))e+=9;else{if(!Ve)throw new Error("Invalid DOCTYPE");r=!0}s++,o=""}if(0!==s)throw new Error("Unclosed DOCTYPE")}return{entities:i,i:e}},Je=function(t,e={}){if(e=Object.assign({},Xe,e),!t||"string"!=typeof t)return t;let i=t.trim();if(void 0!==e.skipLike&&e.skipLike.test(i))return t;if("0"===t)return 0;if(e.hex&&We.test(i))return function(t,e){if(parseInt)return parseInt(t,e);if(Number.parseInt)return Number.parseInt(t,e);if(window&&window.parseInt)return window.parseInt(t,e);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}(i,16);if(-1!==i.search(/[eE]/)){const s=i.match(/^([-\+])?(0*)([0-9]*(\.[0-9]*)?[eE][-\+]?[0-9]+)$/);if(s){if(e.leadingZeros)i=(s[1]||"")+s[3];else if("0"!==s[2]||"."!==s[3][0])return t;return e.eNotation?Number(i):t}return t}{const s=qe.exec(i);if(s){const n=s[1],r=s[2];let o=function(t){if(t&&-1!==t.indexOf("."))return"."===(t=t.replace(/0+$/,""))?t="0":"."===t[0]?t="0"+t:"."===t[t.length-1]&&(t=t.substr(0,t.length-1)),t;return t}(s[3]);if(!e.leadingZeros&&r.length>0&&n&&"."!==i[2])return t;if(!e.leadingZeros&&r.length>0&&!n&&"."!==i[1])return t;if(e.leadingZeros&&r===t)return 0;{const s=Number(i),a=""+s;return-1!==a.search(/[eE]/)?e.eNotation?s:t:-1!==i.indexOf(".")?"0"===a&&""===o||a===o||n&&a==="-"+o?s:t:r?o===a||n+o===a?s:t:i===a||i===n+a?s:t}}return t}};function ti(t){const e=Object.keys(t);for(let i=0;i<e.length;i++){const s=e[i];this.lastEntities[s]={regex:new RegExp("&"+s+";","g"),val:t[s]}}}function ei(t,e,i,s,n,r,o){if(void 0!==t&&(this.options.trimValues&&!s&&(t=t.trim()),t.length>0)){o||(t=this.replaceEntitiesValue(t));const s=this.options.tagValueProcessor(e,t,i,n,r);if(null==s)return t;if(typeof s!=typeof t||s!==t)return s;if(this.options.trimValues)return pi(t,this.options.parseTagValue,this.options.numberParseOptions);return t.trim()===t?pi(t,this.options.parseTagValue,this.options.numberParseOptions):t}}function ii(t){if(this.options.removeNSPrefix){const e=t.split(":"),i="/"===t.charAt(0)?"/":"";if("xmlns"===e[0])return"";2===e.length&&(t=i+e[1])}return t}const si=new RegExp("([^\\s=]+)\\s*(=\\s*(['\"])([\\s\\S]*?)\\3)?","gm");function ni(t,e,i){if(!this.options.ignoreAttributes&&"string"==typeof t){const i=Ge.getAllMatches(t,si),s=i.length,n={};for(let t=0;t<s;t++){const s=this.resolveNameSpace(i[t][1]);let r=i[t][4],o=this.options.attributeNamePrefix+s;if(s.length)if(this.options.transformAttributeName&&(o=this.options.transformAttributeName(o)),"__proto__"===o&&(o="#__proto__"),void 0!==r){this.options.trimValues&&(r=r.trim()),r=this.replaceEntitiesValue(r);const t=this.options.attributeValueProcessor(s,r,e);n[o]=null==t?r:typeof t!=typeof r||t!==r?t:pi(r,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(n[o]=!0)}if(!Object.keys(n).length)return;if(this.options.attributesGroupName){const t={};return t[this.options.attributesGroupName]=n,t}return n}}const ri=function(t){t=t.replace(/\r\n?/g,"\n");const e=new Qe("!xml");let i=e,s="",n="";for(let r=0;r<t.length;r++){if("<"===t[r])if("/"===t[r+1]){const e=ci(t,">",r,"Closing Tag is not closed.");let o=t.substring(r+2,e).trim();if(this.options.removeNSPrefix){const t=o.indexOf(":");-1!==t&&(o=o.substr(t+1))}this.options.transformTagName&&(o=this.options.transformTagName(o)),i&&(s=this.saveTextToParentTag(s,i,n));const a=n.substring(n.lastIndexOf(".")+1);if(o&&-1!==this.options.unpairedTags.indexOf(o))throw new Error(`Unpaired tag can not be used as closing tag: </${o}>`);let h=0;a&&-1!==this.options.unpairedTags.indexOf(a)?(h=n.lastIndexOf(".",n.lastIndexOf(".")-1),this.tagsNodeStack.pop()):h=n.lastIndexOf("."),n=n.substring(0,h),i=this.tagsNodeStack.pop(),s="",r=e}else if("?"===t[r+1]){let e=ui(t,r,!1,"?>");if(!e)throw new Error("Pi Tag is not closed.");if(s=this.saveTextToParentTag(s,i,n),this.options.ignoreDeclaration&&"?xml"===e.tagName||this.options.ignorePiTags);else{const t=new Qe(e.tagName);t.add(this.options.textNodeName,""),e.tagName!==e.tagExp&&e.attrExpPresent&&(t[":@"]=this.buildAttributesMap(e.tagExp,n,e.tagName)),this.addChild(i,t,n)}r=e.closeIndex+1}else if("!--"===t.substr(r+1,3)){const e=ci(t,"--\x3e",r+4,"Comment is not closed.");if(this.options.commentPropName){const o=t.substring(r+4,e-2);s=this.saveTextToParentTag(s,i,n),i.add(this.options.commentPropName,[{[this.options.textNodeName]:o}])}r=e}else if("!D"===t.substr(r+1,2)){const e=Ke(t,r);this.docTypeEntities=e.entities,r=e.i}else if("!["===t.substr(r+1,2)){const e=ci(t,"]]>",r,"CDATA is not closed.")-2,o=t.substring(r+9,e);s=this.saveTextToParentTag(s,i,n);let a=this.parseTextData(o,i.tagname,n,!0,!1,!0,!0);null==a&&(a=""),this.options.cdataPropName?i.add(this.options.cdataPropName,[{[this.options.textNodeName]:o}]):i.add(this.options.textNodeName,a),r=e+2}else{let o=ui(t,r,this.options.removeNSPrefix),a=o.tagName;const h=o.rawTagName;let l=o.tagExp,c=o.attrExpPresent,u=o.closeIndex;this.options.transformTagName&&(a=this.options.transformTagName(a)),i&&s&&"!xml"!==i.tagname&&(s=this.saveTextToParentTag(s,i,n,!1));const d=i;if(d&&-1!==this.options.unpairedTags.indexOf(d.tagname)&&(i=this.tagsNodeStack.pop(),n=n.substring(0,n.lastIndexOf("."))),a!==e.tagname&&(n+=n?"."+a:a),this.isItStopNode(this.options.stopNodes,n,a)){let e="";if(l.length>0&&l.lastIndexOf("/")===l.length-1)"/"===a[a.length-1]?(a=a.substr(0,a.length-1),n=n.substr(0,n.length-1),l=a):l=l.substr(0,l.length-1),r=o.closeIndex;else if(-1!==this.options.unpairedTags.indexOf(a))r=o.closeIndex;else{const i=this.readStopNodeData(t,h,u+1);if(!i)throw new Error(`Unexpected end of ${h}`);r=i.i,e=i.tagContent}const s=new Qe(a);a!==l&&c&&(s[":@"]=this.buildAttributesMap(l,n,a)),e&&(e=this.parseTextData(e,a,n,!0,c,!0,!0)),n=n.substr(0,n.lastIndexOf(".")),s.add(this.options.textNodeName,e),this.addChild(i,s,n)}else{if(l.length>0&&l.lastIndexOf("/")===l.length-1){"/"===a[a.length-1]?(a=a.substr(0,a.length-1),n=n.substr(0,n.length-1),l=a):l=l.substr(0,l.length-1),this.options.transformTagName&&(a=this.options.transformTagName(a));const t=new Qe(a);a!==l&&c&&(t[":@"]=this.buildAttributesMap(l,n,a)),this.addChild(i,t,n),n=n.substr(0,n.lastIndexOf("."))}else{const t=new Qe(a);this.tagsNodeStack.push(i),a!==l&&c&&(t[":@"]=this.buildAttributesMap(l,n,a)),this.addChild(i,t,n),i=t}s="",r=u}}else s+=t[r]}return e.child};function oi(t,e,i){const s=this.options.updateTag(e.tagname,i,e[":@"]);!1===s||("string"==typeof s?(e.tagname=s,t.addChild(e)):t.addChild(e))}const ai=function(t){if(this.options.processEntities){for(let e in this.docTypeEntities){const i=this.docTypeEntities[e];t=t.replace(i.regx,i.val)}for(let e in this.lastEntities){const i=this.lastEntities[e];t=t.replace(i.regex,i.val)}if(this.options.htmlEntities)for(let e in this.htmlEntities){const i=this.htmlEntities[e];t=t.replace(i.regex,i.val)}t=t.replace(this.ampEntity.regex,this.ampEntity.val)}return t};function hi(t,e,i,s){return t&&(void 0===s&&(s=0===Object.keys(e.child).length),void 0!==(t=this.parseTextData(t,e.tagname,i,!1,!!e[":@"]&&0!==Object.keys(e[":@"]).length,s))&&""!==t&&e.add(this.options.textNodeName,t),t=""),t}function li(t,e,i){const s="*."+i;for(const i in t){const n=t[i];if(s===n||e===n)return!0}return!1}function ci(t,e,i,s){const n=t.indexOf(e,i);if(-1===n)throw new Error(s);return n+e.length-1}function ui(t,e,i,s=">"){const n=function(t,e,i=">"){let s,n="";for(let r=e;r<t.length;r++){let e=t[r];if(s)e===s&&(s="");else if('"'===e||"'"===e)s=e;else if(e===i[0]){if(!i[1])return{data:n,index:r};if(t[r+1]===i[1])return{data:n,index:r}}else"\t"===e&&(e=" ");n+=e}}(t,e+1,s);if(!n)return;let r=n.data;const o=n.index,a=r.search(/\s/);let h=r,l=!0;-1!==a&&(h=r.substring(0,a),r=r.substring(a+1).trimStart());const c=h;if(i){const t=h.indexOf(":");-1!==t&&(h=h.substr(t+1),l=h!==n.data.substr(t+1))}return{tagName:h,tagExp:r,closeIndex:o,attrExpPresent:l,rawTagName:c}}function di(t,e,i){const s=i;let n=1;for(;i<t.length;i++)if("<"===t[i])if("/"===t[i+1]){const r=ci(t,">",i,`${e} is not closed`);if(t.substring(i+2,r).trim()===e&&(n--,0===n))return{tagContent:t.substring(s,i),i:r};i=r}else if("?"===t[i+1]){i=ci(t,"?>",i+1,"StopNode is not closed.")}else if("!--"===t.substr(i+1,3)){i=ci(t,"--\x3e",i+3,"StopNode is not closed.")}else if("!["===t.substr(i+1,2)){i=ci(t,"]]>",i,"StopNode is not closed.")-2}else{const s=ui(t,i,">");if(s){(s&&s.tagName)===e&&"/"!==s.tagExp[s.tagExp.length-1]&&n++,i=s.closeIndex}}}function pi(t,e,i){if(e&&"string"==typeof t){const e=t.trim();return"true"===e||"false"!==e&&Je(t,i)}return Ge.isExist(t)?t:""}var fi=class{constructor(t){this.options=t,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(t,e)=>String.fromCharCode(Number.parseInt(e,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(t,e)=>String.fromCharCode(Number.parseInt(e,16))}},this.addExternalEntities=ti,this.parseXml=ri,this.parseTextData=ei,this.resolveNameSpace=ii,this.buildAttributesMap=ni,this.isItStopNode=li,this.replaceEntitiesValue=ai,this.readStopNodeData=di,this.saveTextToParentTag=hi,this.addChild=oi}},mi={};function gi(t,e,i){let s;const n={};for(let r=0;r<t.length;r++){const o=t[r],a=_i(o);let h="";if(h=void 0===i?a:i+"."+a,a===e.textNodeName)void 0===s?s=o[a]:s+=""+o[a];else{if(void 0===a)continue;if(o[a]){let t=gi(o[a],e,h);const i=wi(t,e);o[":@"]?yi(t,o[":@"],h,e):1!==Object.keys(t).length||void 0===t[e.textNodeName]||e.alwaysCreateTextNode?0===Object.keys(t).length&&(e.alwaysCreateTextNode?t[e.textNodeName]="":t=""):t=t[e.textNodeName],void 0!==n[a]&&n.hasOwnProperty(a)?(Array.isArray(n[a])||(n[a]=[n[a]]),n[a].push(t)):e.isArray(a,h,i)?n[a]=[t]:n[a]=t}}}return"string"==typeof s?s.length>0&&(n[e.textNodeName]=s):void 0!==s&&(n[e.textNodeName]=s),n}function _i(t){const e=Object.keys(t);for(let t=0;t<e.length;t++){const i=e[t];if(":@"!==i)return i}}function yi(t,e,i,s){if(e){const n=Object.keys(e),r=n.length;for(let o=0;o<r;o++){const r=n[o];s.isArray(r,i+"."+r,!0,!0)?t[r]=[e[r]]:t[r]=e[r]}}}function wi(t,e){const{textNodeName:i}=e,s=Object.keys(t).length;return 0===s||!(1!==s||!t[i]&&"boolean"!=typeof t[i]&&0!==t[i])}mi.prettify=function(t,e){return gi(t,e)};const{buildOptions:vi}=Re,bi=fi,{prettify:xi}=mi,Ei=ve;var Ti=class{constructor(t){this.externalEntities={},this.options=vi(t)}parse(t,e){if("string"==typeof t);else{if(!t.toString)throw new Error("XML data is accepted in String or Bytes[] form.");t=t.toString()}if(e){!0===e&&(e={});const i=Ei.validate(t,e);if(!0!==i)throw Error(`${i.err.msg}:${i.err.line}:${i.err.col}`)}const i=new bi(this.options);i.addExternalEntities(this.externalEntities);const s=i.parseXml(t);return this.options.preserveOrder||void 0===s?s:xi(s,this.options)}addEntity(t,e){if(-1!==e.indexOf("&"))throw new Error("Entity value can't have '&'");if(-1!==t.indexOf("&")||-1!==t.indexOf(";"))throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if("&"===e)throw new Error("An entity with value '&' is not permitted");this.externalEntities[t]=e}};function Ai(t,e,i,s){let n="",r=!1;for(let o=0;o<t.length;o++){const a=t[o],h=Ci(a);if(void 0===h)continue;let l="";if(l=0===i.length?h:`${i}.${h}`,h===e.textNodeName){let t=a[h];Oi(l,e)||(t=e.tagValueProcessor(h,t),t=Pi(t,e)),r&&(n+=s),n+=t,r=!1;continue}if(h===e.cdataPropName){r&&(n+=s),n+=`<![CDATA[${a[h][0][e.textNodeName]}]]>`,r=!1;continue}if(h===e.commentPropName){n+=s+`\x3c!--${a[h][0][e.textNodeName]}--\x3e`,r=!0;continue}if("?"===h[0]){const t=Si(a[":@"],e),i="?xml"===h?"":s;let o=a[h][0][e.textNodeName];o=0!==o.length?" "+o:"",n+=i+`<${h}${o}${t}?>`,r=!0;continue}let c=s;""!==c&&(c+=e.indentBy);const u=s+`<${h}${Si(a[":@"],e)}`,d=Ai(a[h],e,l,c);-1!==e.unpairedTags.indexOf(h)?e.suppressUnpairedNode?n+=u+">":n+=u+"/>":d&&0!==d.length||!e.suppressEmptyNode?d&&d.endsWith(">")?n+=u+`>${d}${s}</${h}>`:(n+=u+">",d&&""!==s&&(d.includes("/>")||d.includes("</"))?n+=s+e.indentBy+d+s:n+=d,n+=`</${h}>`):n+=u+"/>",r=!0}return n}function Ci(t){const e=Object.keys(t);for(let i=0;i<e.length;i++){const s=e[i];if(t.hasOwnProperty(s)&&":@"!==s)return s}}function Si(t,e){let i="";if(t&&!e.ignoreAttributes)for(let s in t){if(!t.hasOwnProperty(s))continue;let n=e.attributeValueProcessor(s,t[s]);n=Pi(n,e),!0===n&&e.suppressBooleanAttributes?i+=` ${s.substr(e.attributeNamePrefix.length)}`:i+=` ${s.substr(e.attributeNamePrefix.length)}="${n}"`}return i}function Oi(t,e){let i=(t=t.substr(0,t.length-e.textNodeName.length-1)).substr(t.lastIndexOf(".")+1);for(let s in e.stopNodes)if(e.stopNodes[s]===t||e.stopNodes[s]==="*."+i)return!0;return!1}function Pi(t,e){if(t&&t.length>0&&e.processEntities)for(let i=0;i<e.entities.length;i++){const s=e.entities[i];t=t.replace(s.regex,s.val)}return t}const Ii=function(t,e){let i="";return e.format&&e.indentBy.length>0&&(i="\n"),Ai(t,e,"",i)},Di={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(t,e){return e},attributeValueProcessor:function(t,e){return e},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],oneListGroup:!1};function ki(t){this.options=Object.assign({},Di,t),this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=Bi),this.processTextOrObjNode=zi,this.options.format?(this.indentate=Mi,this.tagEndChar=">\n",this.newLine="\n"):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine="")}function zi(t,e,i){const s=this.j2x(t,i+1);return void 0!==t[this.options.textNodeName]&&1===Object.keys(t).length?this.buildTextValNode(t[this.options.textNodeName],e,s.attrStr,i):this.buildObjectNode(s.val,e,s.attrStr,i)}function Mi(t){return this.options.indentBy.repeat(t)}function Bi(t){return!(!t.startsWith(this.options.attributeNamePrefix)||t===this.options.textNodeName)&&t.substr(this.attrPrefixLen)}ki.prototype.build=function(t){return this.options.preserveOrder?Ii(t,this.options):(Array.isArray(t)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1&&(t={[this.options.arrayNodeName]:t}),this.j2x(t,0).val)},ki.prototype.j2x=function(t,e){let i="",s="";for(let n in t)if(Object.prototype.hasOwnProperty.call(t,n))if(void 0===t[n])this.isAttribute(n)&&(s+="");else if(null===t[n])this.isAttribute(n)?s+="":"?"===n[0]?s+=this.indentate(e)+"<"+n+"?"+this.tagEndChar:s+=this.indentate(e)+"<"+n+"/"+this.tagEndChar;else if(t[n]instanceof Date)s+=this.buildTextValNode(t[n],n,"",e);else if("object"!=typeof t[n]){const r=this.isAttribute(n);if(r)i+=this.buildAttrPairStr(r,""+t[n]);else if(n===this.options.textNodeName){let e=this.options.tagValueProcessor(n,""+t[n]);s+=this.replaceEntitiesValue(e)}else s+=this.buildTextValNode(t[n],n,"",e)}else if(Array.isArray(t[n])){const i=t[n].length;let r="",o="";for(let a=0;a<i;a++){const i=t[n][a];if(void 0===i);else if(null===i)"?"===n[0]?s+=this.indentate(e)+"<"+n+"?"+this.tagEndChar:s+=this.indentate(e)+"<"+n+"/"+this.tagEndChar;else if("object"==typeof i)if(this.options.oneListGroup){const t=this.j2x(i,e+1);r+=t.val,this.options.attributesGroupName&&i.hasOwnProperty(this.options.attributesGroupName)&&(o+=t.attrStr)}else r+=this.processTextOrObjNode(i,n,e);else if(this.options.oneListGroup){let t=this.options.tagValueProcessor(n,i);t=this.replaceEntitiesValue(t),r+=t}else r+=this.buildTextValNode(i,n,"",e)}this.options.oneListGroup&&(r=this.buildObjectNode(r,n,o,e)),s+=r}else if(this.options.attributesGroupName&&n===this.options.attributesGroupName){const e=Object.keys(t[n]),s=e.length;for(let r=0;r<s;r++)i+=this.buildAttrPairStr(e[r],""+t[n][e[r]])}else s+=this.processTextOrObjNode(t[n],n,e);return{attrStr:i,val:s}},ki.prototype.buildAttrPairStr=function(t,e){return e=this.options.attributeValueProcessor(t,""+e),e=this.replaceEntitiesValue(e),this.options.suppressBooleanAttributes&&"true"===e?" "+t:" "+t+'="'+e+'"'},ki.prototype.buildObjectNode=function(t,e,i,s){if(""===t)return"?"===e[0]?this.indentate(s)+"<"+e+i+"?"+this.tagEndChar:this.indentate(s)+"<"+e+i+this.closeTag(e)+this.tagEndChar;{let n="</"+e+this.tagEndChar,r="";return"?"===e[0]&&(r="?",n=""),!i&&""!==i||-1!==t.indexOf("<")?!1!==this.options.commentPropName&&e===this.options.commentPropName&&0===r.length?this.indentate(s)+`\x3c!--${t}--\x3e`+this.newLine:this.indentate(s)+"<"+e+i+r+this.tagEndChar+t+this.indentate(s)+n:this.indentate(s)+"<"+e+i+r+">"+t+n}},ki.prototype.closeTag=function(t){let e="";return-1!==this.options.unpairedTags.indexOf(t)?this.options.suppressUnpairedNode||(e="/"):e=this.options.suppressEmptyNode?"/":`></${t}`,e},ki.prototype.buildTextValNode=function(t,e,i,s){if(!1!==this.options.cdataPropName&&e===this.options.cdataPropName)return this.indentate(s)+`<![CDATA[${t}]]>`+this.newLine;if(!1!==this.options.commentPropName&&e===this.options.commentPropName)return this.indentate(s)+`\x3c!--${t}--\x3e`+this.newLine;if("?"===e[0])return this.indentate(s)+"<"+e+i+"?"+this.tagEndChar;{let n=this.options.tagValueProcessor(e,t);return n=this.replaceEntitiesValue(n),""===n?this.indentate(s)+"<"+e+i+this.closeTag(e)+this.tagEndChar:this.indentate(s)+"<"+e+i+">"+n+"</"+e+this.tagEndChar}},ki.prototype.replaceEntitiesValue=function(t){if(t&&t.length>0&&this.options.processEntities)for(let e=0;e<this.options.entities.length;e++){const i=this.options.entities[e];t=t.replace(i.regex,i.val)}return t};var Ui={XMLParser:Ti,XMLValidator:ve,XMLBuilder:ki};class Ri{}ne(Ri,"parser",new Ui.XMLParser({allowBooleanAttributes:!0,attributeNamePrefix:"",ignoreAttributes:!1,ignoreDeclaration:!0,ignorePiTags:!0,numberParseOptions:{leadingZeros:!0,hex:!0},parseAttributeValue:!0,preserveOrder:!1,processEntities:!1,removeNSPrefix:!0,trimValues:!0})),ne(Ri,"builder",new Ui.XMLBuilder({attributeNamePrefix:"$",ignoreAttributes:!1,suppressBooleanAttributes:!1}));class Ni extends he{constructor(t,e){super(t),ne(this,"onDisposed",new re),ne(this,"onVertexFound",new re),ne(this,"onVertexLost",new re),ne(this,"onEnabled",new re),ne(this,"components"),ne(this,"workingPlane",null),ne(this,"_pickedPoint",null),ne(this,"_config"),ne(this,"_enabled",!1),this.components=t,this.config={snapDistance:.25,showOnlyVertex:!1,...e},this.enabled=!1}set enabled(t){this._enabled=t,t||(this._pickedPoint=null),this.onEnabled.trigger(t)}get enabled(){return this._enabled}set config(t){this._config={...this._config,...t}}get config(){return this._config}dispose(){this.onVertexFound.reset(),this.onVertexLost.reset(),this.components=null,this.onDisposed.trigger(),this.onDisposed.reset()}async get(t){if(!this.enabled)return this._pickedPoint;const e=this.components.get(ls).get(t),i=await e.castRay();if(!i)return null!==this._pickedPoint&&(this.onVertexLost.trigger(),this._pickedPoint=null),this._pickedPoint;const s=i.point;return null!==this._pickedPoint&&this._pickedPoint.equals(s)||(this._pickedPoint=s.clone(),this.onVertexFound.trigger(this._pickedPoint)),this._pickedPoint}}class Li{static join(t){const e={};for(const i of t)for(const t in i)if(e[t])for(const s of i[t])e[t].add(s);else e[t]=new Set(i[t]);return e}static intersect(t){if(0===t.length)return{};let e=Li.clone(t[0]);for(let i=1;i<t.length;i++){const s=t[i],n={};for(const t in e)if(s[t]){const i=new Set;for(const n of e[t])s[t].has(n)&&i.add(n);i.size>0&&(n[t]=i)}e=n}return e}static clone(t){const e={};for(const i in t)e[i]=new Set(t[i]);return e}static remove(t,e,i=!1){i&&(t=Li.clone(t));for(const i in e)if(t[i]){for(const s of e[i])t[i].delete(s);0===t[i].size&&delete t[i]}}static add(t,e,i=!1){i&&(t=Li.clone(t));for(const i in e)if(t[i])for(const s of e[i])t[i].add(s);else t[i]=new Set(e[i])}static append(t,e,...i){let s=t[e];s||(s=new Set,t[e]=s);for(const t of i)s.add(t)}static isEqual(t,e){const i=Object.keys(t),s=Object.keys(e);if(i.length!==s.length)return!1;for(const s of i){if(!e[s])return!1;if(t[s].size!==e[s].size)return!1;for(const i of t[s])if(!e[s].has(i))return!1}return!0}static isEmpty(t){return 0===Object.values(t).reduce(((t,e)=>t+e.size),0)}static toRaw(t){const e={};for(const i in t)e[i]=Array.from(t[i]);return e}static fromRaw(t){const e={};for(const i in t)e[i]=new Set(t[i]);return e}}class Fi extends Map{constructor(t){super(t),ne(this,"onItemSet",new re),ne(this,"onItemUpdated",new re),ne(this,"onItemDeleted",new re),ne(this,"onCleared",new re),ne(this,"guard",(()=>!0))}clear(){super.clear(),this.onCleared.trigger()}set(t,e){const i=this.has(t);if(!(this.guard??(()=>!0))(t,e))return this;const s=super.set(t,e);return i?(this.onItemUpdated||(this.onItemUpdated=new re),this.onItemUpdated.trigger({key:t,value:e})):(this.onItemSet||(this.onItemSet=new re),this.onItemSet.trigger({key:t,value:e})),s}add(t){const e=_e.create();return this.set(e,t),e}delete(t){const e=super.delete(t);return e&&this.onItemDeleted.trigger(t),e}dispose(){this.clear(),this.onItemSet.reset(),this.onItemDeleted.reset(),this.onCleared.reset()}}class Vi{static isEntry(t){return new Set(["Boolean","Color","Text","Number","Select","Vector3","TextSet","None"]).has(t.type)}static copySchema(t,e={}){for(const i in t){const s=t[i];this.isEntry(s)?e[i]=this.copyEntry(s):(e[i]={},this.copySchema(s,e[i]))}return e}static copyEntry(t){if("Boolean"===t.type){const e=t;return{type:e.type,value:e.value}}if("Color"===t.type){const e=t;return{type:e.type,value:e.value.clone()}}if("Text"===t.type){const e=t;return{type:e.type,value:e.value}}if("Number"===t.type){const e=t;return{type:e.type,value:e.value,min:e.min,max:e.max,interpolable:e.interpolable}}if("Select"===t.type){const e=t;return{type:e.type,value:e.value,multiple:e.multiple,options:new Set(e.options)}}if("Vector3"===t.type){const e=t;return{type:e.type,value:e.value.clone()}}if("TextSet"===t.type){const e=t;return{type:e.type,value:new Set(e.value)}}if("None"===t.type){const e=t;return{type:e.type,value:e.value}}throw new Error("Invalid entry!")}}class ji{constructor(){ne(this,"list",new Set)}add(t){for(const e of t)this.list.add(e)}remove(t){for(const e of t)this.list.delete(e)}set(t){for(const e of this.list)e.enabled=t}reset(){for(const t of this.list)t.reset()}}class Yi{constructor(t,e,i,s){ne(this,"_component"),ne(this,"name"),ne(this,"uuid"),this._component=t,this.name=i,this.uuid=s??_e.create();e.get(Hi).list.set(this.uuid,this)}get controls(){return Vi.copySchema(this._config)}set(t){for(const e in t)if(e in this){this[e]=t[e].value}}export(t=this._config,e={}){for(const i in t){const s=t[i];if(Vi.isEntry(s))if("Color"===s.type){const{r:t,g:n,b:r}=s.value;e[i]={...s,value:{r:t,g:n,b:r}}}else if("Vector3"===s.type){const{x:t,y:n,z:r}=s.value;e[i]={...s,value:{x:t,y:n,z:r}}}else if("TextSet"===s.type){const t=Array.from(s.value);e[i]={...s,value:t}}else if("Select"===s.type){const t=Array.from(s.options);e[i]={...s,options:t}}else e[i]={...s};else e[i]={},this.export(s,e[i])}return e}import(t,e={},i=!0){for(const i in t){const n=t[i];if(Vi.isEntry(n))if("Color"===n.type){const{r:t,g:r,b:o}=n.value;e[i]={...n,value:new s.Color(t,r,o)}}else if("Vector3"===n.type){const{x:t,y:r,z:o}=n.value;e[i]={...n,value:new s.Vector3(t,r,o)}}else"TextSet"===n.type?e[i]={...n,value:new Set(n.value)}:"Select"===n.type?e[i]={...n,options:new Set(n.options)}:e[i]={...n};else e[i]={},this.import(n,e[i],!1)}i&&this.set(e)}}const Zi=class t extends he{constructor(e){super(e),ne(this,"list",new Fi),ne(this,"enabled",!0),e.add(t.uuid,this)}};ne(Zi,"uuid","b8c764e0-6b24-4e77-9a32-35fa728ee5b4");let Hi=Zi;class $i{constructor(t){ne(this,"_event"),ne(this,"_position",new s.Vector2),ne(this,"onDisposed",new re),ne(this,"updateMouseInfo",(t=>{this._event=t})),this.dom=t,this.setupEvents(!0)}get position(){return this.updatePosition(!1),this._position.clone()}get rawPosition(){return this.updatePosition(!0),this._position.clone()}dispose(){this.setupEvents(!1),this.onDisposed.trigger(),this.onDisposed.reset()}updatePosition(t){if(this._event){const e=this.dom.getBoundingClientRect();this._position.x=this.getPositionX(e,this._event,t),this._position.y=this.getPositionY(e,this._event,t)}}getPositionY(t,e,i){const s=this.getDataObject(e);return i?s.clientY:-(s.clientY-t.top)/(t.bottom-t.top)*2+1}getPositionX(t,e,i){const s=this.getDataObject(e);return i?s.clientX:(s.clientX-t.left)/(t.right-t.left)*2-1}getDataObject(t){return t instanceof MouseEvent?t:t.touches[0]}setupEvents(t){t?(this.dom.addEventListener("pointermove",this.updateMouseInfo),this.dom.addEventListener("touchstart",this.updateMouseInfo)):(this.dom.removeEventListener("pointermove",this.updateMouseInfo),this.dom.removeEventListener("touchstart",this.updateMouseInfo))}}const Wi=class t extends he{constructor(e){super(e),ne(this,"onDisposed",new re),ne(this,"onBeforeDispose",new re),ne(this,"onFragmentsLoaded",new re),ne(this,"baseCoordinationModel",""),ne(this,"baseCoordinationMatrix",new s.Matrix4),ne(this,"enabled",!0),ne(this,"_core"),this.components.add(t.uuid,this)}get initialized(){return!!this._core}get list(){return this.core.models.list}get core(){if(!this._core)throw new Error("FragmentsManager not initialized. Call init() first.");return this._core}get _hasCoordinationModel(){return""!==this.baseCoordinationModel}dispose(){this.onBeforeDispose.trigger(),this._core&&(this.core.dispose(),this._core=void 0),this.baseCoordinationModel="",this.onFragmentsLoaded.reset(),this.onDisposed.trigger(),this.onDisposed.reset()}init(t){this._core=new i(t),this.core.onModelLoaded.add((async()=>{if(this._hasCoordinationModel)return;const t=[...this.list.values()][0];t&&(this.baseCoordinationModel=t.modelId,this.baseCoordinationMatrix=await t.getCoordinationMatrix())})),this.list.onItemDeleted.add((()=>{this.list.size>0||(this.baseCoordinationModel="",this.baseCoordinationMatrix=new s.Matrix4)}))}async raycast(t){const e=[];for(const i of this.core.models.list.values())if(t.snappingClasses&&t.snappingClasses.length>0){const s=await i.raycastWithSnapping(t);if(s&&s.length>0)e.push(s[0]);else{const s=await i.raycast(t);s&&e.push(s)}}else{const s=await i.raycast(t);s&&e.push(s)}if(await Promise.all(e),0===e.length)return;let i=e[0],s=i.distance;for(let t=1;t<e.length;t++)e[t].distance<s&&(s=e[t].distance,i=e[t]);return i}async getPositions(t){const e=[],i=async(t,i)=>{const s=await t.getPositions(i);for(const t of s)e.push(t)},s=[];for(const e in t){const n=this.core.models.list.get(e);n&&s.push(i(n,Array.from(t[e])))}return await Promise.all(s),e}async getBBoxes(t){const e=[],i=async(t,i)=>{const s=await t.getBoxes(i);if(s)for(const t of s)e.push(t)},s=[];for(const e in t){const n=this.core.models.list.get(e);n&&s.push(i(n,Array.from(t[e])))}return await Promise.all(s),e}async highlight(t,e){await this.forEachModel(e,"highlight",t)}async getData(t,e){const i={};for(const[s,n]of Object.entries(t)){const t=this.list.get(s);if(!t)continue;if(0===n.size){i[s]=[];continue}const r=await t.getItemsData([...n],e);i[s]=r}return i}async resetHighlight(t){await this.forEachModel(t,"resetHighlight")}async forEachModel(t,e,...i){const s={};if(t)for(const e in t){const i=t[e];s[e]=Array.from(i)}else for(const t of this.core.models.list.keys())s[t]=void 0;const n=[];for(const t in s){const r=this.core.models.list.get(t);if(r){const o=s[t],a=r[e](o,...i);n.push(a)}}await Promise.all(n)}async guidsToModelIdMap(t){const e={};for(const[i,s]of this.list){const n=(await s.getLocalIdsByGuids([...t])).filter((t=>null!==t));e[i]=new Set(n)}return e}async modelIdMapToGuids(t){const e=[];for(const[i,s]of Object.entries(t)){const t=this.list.get(i);if(!t)continue;const n=(await t.getGuidsByLocalIds([...s])).filter((t=>null!==t));e.push(...n)}return e}applyBaseCoordinateSystem(t,e){const i=new s.Matrix4;return e&&i.copy(e.clone()).invert(),i.multiply(this.baseCoordinationMatrix),t.applyMatrix4(i),i}};ne(Wi,"uuid","fef46874-46a3-461b-8c44-2922ab77c806");let qi=Wi;class Xi{constructor(){ne(this,"wasm",{path:"",absolute:!1,logLevel:M.LogLevel.LOG_LEVEL_OFF}),ne(this,"webIfc",{COORDINATE_TO_ORIGIN:!0}),ne(this,"autoSetWasm",!0),ne(this,"customLocateFileHandler",null)}}const Gi=class e extends he{constructor(t){super(t),ne(this,"onDisposed",new re),ne(this,"onIfcStartedLoading",new re),ne(this,"onIfcImporterInitialized",new re),ne(this,"onSetup",new re),ne(this,"settings",new Xi),ne(this,"webIfc",new M.IfcAPI),ne(this,"enabled",!0),this.components.add(e.uuid,this)}dispose(){this.webIfc=null,this.onDisposed.trigger(e.uuid),this.onDisposed.reset()}async setup(t){this.settings={...this.settings,...t},this.settings.autoSetWasm&&await this.autoSetWasm(),this.onSetup.trigger()}async load(e,i,s,n){const r=this.components.get(qi);if(!r.initialized)throw new Error("You need to initialize fragments first.");this.settings.autoSetWasm&&await this.autoSetWasm(),r.core.settings.autoCoordinate=i;const o=new t.IfcImporter;o.wasm.path=this.settings.wasm.path,o.wasm.absolute=this.settings.wasm.absolute,o.webIfcSettings=this.settings.webIfc,this.onIfcImporterInitialized.trigger(o),(null==n?void 0:n.instanceCallback)&&n.instanceCallback(o);const a=await o.process({...null==n?void 0:n.processData,bytes:e});return await r.core.load(a,{modelId:s,userData:null==n?void 0:n.userData})}async readIfcFile(t){const{path:e,absolute:i,logLevel:s}=this.settings.wasm;return this.webIfc.SetWasmPath(e,i),await this.webIfc.Init(this.settings.customLocateFileHandler||void 0),s&&this.webIfc.SetLogLevel(s),this.webIfc.OpenModel(t,this.settings.webIfc)}cleanUp(){try{this.webIfc.Dispose()}catch(t){console.log("Web-ifc wasn't disposed.")}this.webIfc=null,this.webIfc=new M.IfcAPI}async autoSetWasm(){const t=await fetch(`https://unpkg.com/@thatopen/components@${qo.release}/package.json`);if(!t.ok)return void console.warn("Couldn't get openbim-components package.json. Set wasm settings manually.");const e=await t.json();if("web-ifc"in e.peerDependencies){const t=e.peerDependencies["web-ifc"];this.settings.wasm.path=`https://unpkg.com/web-ifc@${t}/`,this.settings.wasm.absolute=!0}else console.warn("Couldn't get web-ifc from peer dependencies in openbim-components. Set wasm settings manually.")}};ne(Gi,"uuid","a659add7-1418-4771-a0d6-7d4d438e4624");let Qi=Gi;const Ki=class t extends he{constructor(e){super(e),ne(this,"enabled",!0),this.components.add(t.uuid,this)}async set(t,e){const i=this.components.get(qi),s=[];if(e)for(const[n,r]of Object.entries(e)){const e=i.list.get(n);e&&s.push(e.setVisible([...r],t))}else for(const e of i.list.values())s.push(e.setVisible(void 0,t));await Promise.all(s),await i.core.update(!0)}async isolate(t){await Promise.all([this.set(!1),this.set(!0,t)])}async toggle(t){const e=[],i=this.components.get(qi);for(const[s,n]of Object.entries(t)){const t=i.list.get(s);t&&e.push(t.toggleVisible([...n]))}await Promise.all(e),await i.core.update(!0)}async getVisibilityMap(t,e){const i=[],s=[],n=this.components.get(qi);if(e)for(const r of e){const e=n.list.get(r);e&&(i.push(e.modelId),s.push(e.getItemsByVisibility(t)))}else for(const e of n.list.values())i.push(e.modelId),s.push(e.getItemsByVisibility(t));const r=await Promise.all(s),o={};for(const[t,e]of i.entries())o[e]=r[t];return o}};ne(Ki,"uuid","dd9ccf2d-8a21-4821-b7f6-2949add16a29");let Ji=Ki;const ts=class e extends he{constructor(i){super(i),ne(this,"enabled",!0),ne(this,"onDisposed",new re),ne(this,"list",new t.DataSet),this.components.add(e.uuid,this)}dispose(t=!0){this.list.clear(),this.onDisposed.trigger(e.uuid),t&&(this.onDisposed.reset(),this.list.eventsEnabled=!1,this.list.dispose())}get(){const t=new s.Box3;for(const e of this.list)t.union(e);return t}async addFromModelIdMap(t){const e=this.components.get(qi),i=new s.Box3;for(const[s,n]of Object.entries(t)){const t=e.list.get(s);if(!t)continue;const r=await t.getMergedBox([...n]);i.union(r)}this.list.add(i)}addFromModels(t){const e=this.components.get(qi);for(const[i,s]of e.list)t&&!t.some((t=>t.test(i)))||this.list.add(s.box)}async getCenter(t){this.list.clear(),await this.addFromModelIdMap(t);const e=this.get();this.list.clear();const i=new s.Vector3;return e.getCenter(i),i}async getCameraOrientation(t,e=1){const i=this.components.get(qi);this.list.clear();for(const[t,e]of i.list)this.list.add(e.box);const n=this.get();this.list.clear();const r=new s.Vector3;n.getCenter(r);const o=new s.Vector3;n.getSize(o);const a=Math.max(o.x,o.y,o.z)*e,h=new s.Vector3;switch(t){case"front":default:h.set(r.x,r.y,r.z+a);break;case"back":h.set(r.x,r.y,r.z-a);break;case"left":h.set(r.x-a,r.y,r.z);break;case"right":h.set(r.x+a,r.y,r.z);break;case"top":h.set(r.x,r.y+a,r.z);break;case"bottom":h.set(r.x,r.y-a,r.z)}return{position:h,target:r}}};ne(ts,"uuid","d1444724-dba6-4cdd-a0c7-68ee1450d166");let es=ts;class is{constructor(t,e){ne(this,"customData",{}),ne(this,"_components"),ne(this,"_queries",[]),ne(this,"_aggregation","exclusive"),ne(this,"result",null),ne(this,"cache",!0),ne(this,"serializeQueryParameters",(t=>{var e;return{categories:null==(e=t.categories)?void 0:e.map((t=>t.source)),attributes:t.attributes?{aggregation:t.attributes.aggregation,queries:t.attributes.queries.map(this.serializeAttributeQuery)}:void 0,relation:t.relation?{name:t.relation.name,query:t.relation.query?this.serializeQueryParameters(t.relation.query):void 0}:void 0}})),ne(this,"deserializeQueryParameters",(t=>{var e;return{categories:null==(e=t.categories)?void 0:e.map((t=>new RegExp(t))),attributes:t.attributes?{aggregation:t.attributes.aggregation,queries:t.attributes.queries.map(this.deserializeAttributeQuery)}:void 0,relation:t.relation?{name:t.relation.name,query:t.relation.query?this.deserializeQueryParameters(t.relation.query):void 0}:void 0}})),this._components=t,this.queries=e}set queries(t){this._queries=t,this.clearCache()}get queries(){return this._queries}set aggregation(t){t!==this._aggregation&&this.clearCache(),this._aggregation=t}get aggregation(){return this._aggregation}async test(t){const{modelIds:e,force:i}={force:!1,...t};if(this.result&&!i)return this.result;const s=this._components.get(ns),n=await s.getItems(this.queries,{modelIds:e,aggregation:this.aggregation});return this.cache&&(this.result=n),n}clearCache(){this.result=null}serializeAttributeQuery(t){let e;e=Array.isArray(t.value)?t.value.map((t=>t.source)):t.value instanceof RegExp?t.value.source:t.value;return{name:t.name.source,value:e,type:t.type instanceof RegExp?t.type.source:t.type,negate:t.negate,itemIds:t.itemIds}}toJSON(){return{name:this._components.get(ns).list.getKey(this)??"Finder Query",customData:this.customData,queries:this.queries.map(this.serializeQueryParameters),aggregation:this.aggregation,cache:this.cache}}deserializeAttributeQuery(t){let e;e=Array.isArray(t.value)?t.value.map((t=>new RegExp(t))):"string"==typeof t.value?new RegExp(t.value):t.value;return{name:new RegExp(t.name),value:e,type:t.type?new RegExp(t.type):void 0,negate:t.negate,itemIds:t.itemIds}}fromJSON(t){return this.customData=t.customData,this.aggregation=t.aggregation,this.cache=t.cache,this.queries=t.queries.map(this.deserializeQueryParameters),this}}const ss=class e extends he{constructor(i){super(i),ne(this,"enabled",!0),ne(this,"list",new t.DataMap),i.add(e.uuid,this)}async getItems(t,e){const{modelIds:i}=e??{},s=(null==e?void 0:e.aggregation)??"exclusive",n=this.components.get(qi),r=await Promise.all(t.map((async t=>{const e={};return await Promise.all(Array.from(n.list).map((async([s,n])=>{if(i&&!i.some((t=>t.test(s))))return;const r=await n.getItemsByQuery(t);e[s]=new Set(r)}))),e})));return"inclusive"===s?Li.join(r):Li.intersect(r)}create(t,e){const i=new is(this.components,e);return this.list.set(t,i),i}async addFromCategories(t){const e=new Set,i=this.components.get(qi);for(const[s,n]of i.list){if(t&&!t.some((t=>t.test(s))))continue;const i=(await n.getItemsWithGeometryCategories()).filter((t=>null!==t)),r=new Set(i);for(const t of r)this.list.has(t)||(this.create(t,[{categories:[new RegExp(`^${t}$`)]}]),e.add(t))}return[...e]}import(t){const{data:e}=t,i=[];if(!e)return i;for(const t of e){const{name:e,customData:s,queries:n,aggregation:r,cache:o}=t,a=this.create(e,[]);a.fromJSON({customData:s,queries:n,aggregation:r,cache:o}),i.push(a)}return i}export(){const t=[];for(const[e,i]of this.list.entries()){const s={...i.toJSON(),name:e};t.push(s)}return{data:t}}};ne(ss,"uuid","0da7ad77-f734-42ca-942f-a074adfd1e3a");let ns=ss;const rs=class e extends he{constructor(i){super(i),ne(this,"enabled",!0),ne(this,"onDisposed",new re),ne(this,"list",new t.DataMap),ne(this,"defaultSaveFunction",(t=>"value"in t.Name?t.Name.value:null)),ne(this,"onBeforeFragmentsDispose",(async t=>{const{key:e,value:i}=t,s=await i.getLocalIds(),n={[e]:new Set(s)};this.removeItems(n)})),i.add(e.uuid,this),this.setupEvents();i.get(qi).list.onBeforeDelete.add(this.onBeforeFragmentsDispose)}setupEvents(){this.list.onBeforeDelete.add((({value:t})=>t.dispose()))}getClassificationGroups(e){let i=this.list.get(e);return i||(i=new t.DataMap,this.list.set(e,i)),i}getModelItems(t,e,i){const{map:s}=this.getGroupData(t,e);let n=s[i];return n||(n=new Set,s[i]=n),n}getGroupData(t,e){const i=this.components.get(ns),s=this.getClassificationGroups(t);let n=s.get(e);return n||(n={map:{},get:()=>new Promise((t=>{if(n)if(n.query){const{name:e,config:s}=n.query,r=i.list.get(e);if(!r)throw new Error("Classifier: the query name associated with the group doesn't exist in the ItemsFinder component");r.test(s).then((e=>{if(!n)return void t({});const i=Li.join([e,n.map]);t(i)}))}else t(n.map);else t({})}))},s.set(e,n)),n}async aggregateItems(t,e,i){const s=(null==i?void 0:i.data)??void 0,n=(null==i?void 0:i.aggregationCallback)??this.defaultSaveFunction,r=this.components.get(qi),o=this.components.get(ns),a=await o.getItems([e],{modelIds:null==i?void 0:i.modelIds});for(const[e,i]of Object.entries(a)){const o=r.list.get(e);if(!o)continue;const a=(i,...s)=>{const n=this.getModelItems(t,i,e);for(const t of s)n.add(t)},h=await o.getItemsData([...i],s);for(const t of h)n(t,a)}}addGroupItems(t,e,i){const{map:s}=this.getGroupData(t,e);Li.add(s,i)}setGroupQuery(t,e,i){this.getGroupData(t,e).query=i}async find(t){const e=[];for(const[i,s]of Object.entries(t)){const t=[],n=this.list.get(i);if(!n)continue;for(const e of s){const i=n.get(e);if(!i)continue;const s=await i.get();t.push(s)}const r=Li.join(t);e.push(r)}return Li.intersect(e)}async aggregateItemRelations(t,e,i,s){const n=(null==s?void 0:s.attribute)??"Name",r={relations:{[i]:{attributes:!0,relations:!1}}};await this.aggregateItems(t,e,{modelIds:null==s?void 0:s.modelIds,data:r,aggregationCallback:(t,e)=>{if(!(null==t?void 0:t[n]))return;const s=t[n];if(!("value"in s))return;const r=t[i];if(Array.isArray(r))for(const t of r)"value"in t._localId&&e(s.value,t._localId.value)}})}async byIfcBuildingStorey(t){await this.aggregateItemRelations((null==t?void 0:t.classificationName)??"Storeys",{categories:[/BUILDINGSTOREY/]},"ContainsElements",{modelIds:null==t?void 0:t.modelIds})}async byCategory(t){const e=this.components.get(ns),i=await e.addFromCategories(null==t?void 0:t.modelIds);for(const e of i)this.setGroupQuery((null==t?void 0:t.classificationName)??"Categories",e,{name:e})}dispose(){this.list.clear();this.components.get(qi).list.onBeforeDelete.remove(this.onBeforeFragmentsDispose),this.onDisposed.trigger()}removeItems(t,e){if(e&&e.classificationName){const i=this.list.get(e.classificationName);if(!i)return;if(e.groupName){if(!i.get(e.groupName))return}for(const[,e]of i)Li.remove(e.map,t)}else for(const[,e]of this.list.entries())for(const[,i]of e)Li.remove(i.map,t)}async byModel(t){const e=this.components.get(qi),i=(null==t?void 0:t.classificationName)??"Models";for(const[s,n]of e.list){if(t&&t.modelIds&&!t.modelIds.some((t=>t.test(s))))continue;const e=await n.getItemsIdsWithGeometry(),r={[s]:new Set(e)};this.getGroupData(i,s),this.addGroupItems(i,s,r)}}};ne(rs,"uuid","e25a7f3c-46c4-4a14-9d3d-5115f24ebeb7");let os=rs;class as{constructor(t,e){ne(this,"enabled",!0),ne(this,"components"),ne(this,"onDisposed",new re),ne(this,"mouse"),ne(this,"three",new s.Raycaster),ne(this,"world");const i=e.renderer;if(!i)throw new Error("A renderer is needed for the raycaster to work!");this.world=e,this.mouse=new $i(i.three.domElement),this.components=t}dispose(){this.mouse.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}castRayToObjects(t=Array.from(this.world.meshes),e=this.mouse.position){if(!this.world)throw new Error("A world is needed to cast rays!");const i=this.world.camera.three;return this.three.setFromCamera(e,i),this.intersect(t)}async castRay(t){const e=null==t?void 0:t.snappingClasses,i=(null==t?void 0:t.items)??Array.from(this.world.meshes),s=(null==t?void 0:t.position)??this.mouse.position;if(!this.world)throw new Error("A world is needed to cast rays!");const n=this.world.camera.three,r=this.components.get(qi),o=this.world.renderer.three.domElement,a=this.mouse.rawPosition;let h=null;if(r.initialized&&(h=await r.raycast({camera:n,dom:o,mouse:a,snappingClasses:e}),0===i.length))return h;this.three.setFromCamera(s,n);const l=this.intersect(i);return h?l&&l.distance<h.distance?l:h:l}castRayFromVector(t,e,i=Array.from(this.world.meshes)){return this.three.set(t,e),this.intersect(i)}intersect(t=Array.from(this.world.meshes)){const e=this.three.intersectObjects(t),i=this.filterClippingPlanes(e);return i.length>0?i[0]:null}filterClippingPlanes(t){if(!this.world.renderer)throw new Error("Renderer not found!");const e=this.world.renderer.three;if(!e.clippingPlanes)return t;const i=e.clippingPlanes;return t.length<=0||!i||(null==i?void 0:i.length)<=0?t:t.filter((t=>i.every((e=>e.distanceToPoint(t.point)>0))))}}const hs=class t extends he{constructor(e){super(e),ne(this,"enabled",!0),ne(this,"list",new Map),ne(this,"onDisposed",new re),e.add(t.uuid,this)}get(t){if(this.list.has(t.uuid))return this.list.get(t.uuid);const e=new as(this.components,t);return this.list.set(t.uuid,e),t.onDisposed.add((()=>{this.delete(t)})),e}delete(t){const e=this.list.get(t.uuid);e&&e.dispose(),this.list.delete(t.uuid)}dispose(){for(const[t,e]of this.list)e.dispose();this.list.clear(),this.onDisposed.trigger()}};ne(hs,"uuid","d5d8bdf0-db25-4952-b951-b643af207ace");let ls=hs;class cs extends ae{constructor(){super(...arguments),ne(this,"onCameraChanged",new re),ne(this,"meshes",new Set),ne(this,"onAfterUpdate",new re),ne(this,"onBeforeUpdate",new re),ne(this,"onDisposed",new re),ne(this,"isDisposing",!1),ne(this,"enabled",!0),ne(this,"_dynamicAnchor",!1),ne(this,"uuid",_e.create()),ne(this,"name"),ne(this,"_scene"),ne(this,"_camera"),ne(this,"_renderer",null),ne(this,"onPointerDown",(async t=>{if(!this.camera.hasCameraControls())throw new Error("World: can't set dynamic anchor if the camera doesn't have controls.");const e=this.components.get(ls).get(this),i=await e.castRay();i&&i.point&&0===t.button&&this.camera.controls.setOrbitPoint(i.point.x,i.point.y,i.point.z)})),ne(this,"_defaultCamera")}set dynamicAnchor(t){var e;const i=null==(e=this.renderer)?void 0:e.three.domElement.parentElement;if(!i)throw new Error("World: the renderer must have a parentElement to set dynamic anchoring.");t?(this.camera.controls&&(this.camera.controls.minDistance=.01),i.addEventListener("pointerdown",this.onPointerDown)):i.removeEventListener("pointerdown",this.onPointerDown)}get dynamicAnchor(){return this._dynamicAnchor}get defaultCamera(){if(!this._defaultCamera)throw new Error("World: there is no default camera defined.");return this._defaultCamera}set defaultCamera(t){this._defaultCamera=t}get scene(){if(!this._scene)throw new Error("No scene initialized!");return this._scene}set scene(t){this._scene=t,t.worlds.set(this.uuid,this),t.currentWorld=this,t.onWorldChanged.trigger({world:this,action:"added"})}get camera(){if(!this._camera)throw new Error("No camera initialized!");return this._camera}set camera(t){this._camera||(this.defaultCamera=t),this._camera=t,t.currentWorld=this,this.onCameraChanged.trigger(t)}get renderer(){return this._renderer}set renderer(t){this._renderer=t,t&&(t.worlds.set(this.uuid,this),t.currentWorld=this,t.onWorldChanged.trigger({world:this,action:"added"}))}useDefaultCamera(){this.camera=this.defaultCamera}update(t){this.enabled&&this._scene&&this._camera&&(this.scene.currentWorld=this,this.camera.currentWorld=this,this.renderer&&(this.renderer.currentWorld=this),this.onBeforeUpdate.trigger(),this.scene.isUpdateable()&&this.scene.update(t),this.camera.isUpdateable()&&this.camera.update(t),this.renderer&&this.renderer.update(t),this.onAfterUpdate.trigger())}dispose(t=!0){if(this.enabled=!1,this.isDisposing=!0,this.scene.onWorldChanged.trigger({world:this,action:"removed"}),this.camera.onWorldChanged.trigger({world:this,action:"removed"}),this.renderer&&this.renderer.onWorldChanged.trigger({world:this,action:"removed"}),t){const t=this.components.get(pe);this.scene.dispose(),this.camera.isDisposeable()&&this.camera.dispose(),this.renderer&&this.renderer.dispose();for(const e of this.meshes)t.destroy(e);this.meshes.clear()}this._scene=null,this._camera=null,this._renderer=null;this.components.get(gn).list.delete(this.uuid),this.onDisposed.trigger(),this.onDisposed.reset()}}class us{constructor(t,e){ne(this,"_list"),ne(this,"_scene"),this._list=t,this._scene=e}get color(){return this._list.directionalLight.color.value}set color(t){this._list.directionalLight.color.value=t;for(const[,e]of this._scene.directionalLights)e.color.copy(t)}get intensity(){return this._list.directionalLight.intensity.value}set intensity(t){this._list.directionalLight.intensity.value=t;for(const[,e]of this._scene.directionalLights)e.intensity=t}get position(){return this._list.directionalLight.position.value.clone()}set position(t){this._list.directionalLight.position.value=t;for(const[,e]of this._scene.directionalLights)e.position.copy(t)}}class ds{constructor(t,e){ne(this,"_list"),ne(this,"_scene"),this._list=t,this._scene=e}get color(){return this._list.ambientLight.color.value}set color(t){this._list.ambientLight.color.value=t;for(const[,e]of this._scene.ambientLights)e.color.copy(t)}get intensity(){return this._list.ambientLight.intensity.value}set intensity(t){this._list.ambientLight.intensity.value=t;for(const[,e]of this._scene.ambientLights)e.intensity=t}}class ps extends Yi{constructor(){super(...arguments),ne(this,"_config",{backgroundColor:{value:new s.Color,type:"Color"},ambientLight:{color:{type:"Color",value:new s.Color},intensity:{type:"Number",interpolable:!0,min:0,max:10,value:2}},directionalLight:{color:{type:"Color",value:new s.Color},intensity:{type:"Number",interpolable:!0,min:0,max:10,value:2},position:{type:"Vector3",value:new s.Vector3}}}),ne(this,"ambientLight",new ds(this._config,this._component)),ne(this,"directionalLight",new us(this._config,this._component))}get backgroundColor(){return this._config.backgroundColor.value}set backgroundColor(t){this._config.backgroundColor.value=t,this._component.three.background=t}}class fs extends fe{constructor(t){super(t),ne(this,"onSetup",new re),ne(this,"isSetup",!1),ne(this,"three"),ne(this,"config",new ps(this,this.components,"Scene")),ne(this,"_defaultConfig",{backgroundColor:new s.Color(2107698),directionalLight:{color:new s.Color("white"),intensity:1.5,position:new s.Vector3(5,10,3)},ambientLight:{color:new s.Color("white"),intensity:1}}),this.three=new s.Scene,this.three.background=new s.Color(2107698)}setup(t){const e={...this._defaultConfig,...t};this.config.backgroundColor=e.backgroundColor;const i=e.ambientLight;this.config.ambientLight.color=i.color,this.config.ambientLight.intensity=i.intensity;const n=e.directionalLight;this.config.directionalLight.color=n.color,this.config.directionalLight.intensity=n.intensity,this.config.directionalLight.position=n.position,this.deleteAllLights();const{color:r,intensity:o}=this.config.directionalLight,a=new s.DirectionalLight(r,o);a.position.copy(n.position);const{color:h,intensity:l}=this.config.directionalLight,c=new s.AmbientLight(h,l);this.three.add(a,c),this.directionalLights.set(a.uuid,a),this.ambientLights.set(c.uuid,c),this.isSetup=!0,this.onSetup.trigger()}dispose(){super.dispose();this.components.get(Hi).list.delete(this.config.uuid)}}var ms=(t=>(t[t.MANUAL=0]="MANUAL",t[t.AUTO=1]="AUTO",t))(ms||{});class gs extends ue{constructor(t,e,i){super(t),ne(this,"enabled",!0),ne(this,"container"),ne(this,"three"),ne(this,"mode",1),ne(this,"needsUpdate",!1),ne(this,"_canvas"),ne(this,"_parameters"),ne(this,"_resizeObserver",null),ne(this,"onContainerUpdated",new re),ne(this,"_resizing",!1),ne(this,"resize",(t=>{if(this._resizing)return;this._resizing=!0,this.onContainerUpdated.trigger();const e=t?t.x:this.container.clientWidth,i=t?t.y:this.container.clientHeight;this.three.setSize(e,i),this.onResize.trigger(new s.Vector2(e,i)),this._resizing=!1})),ne(this,"resizeEvent",(()=>{this.resize()})),ne(this,"onContextLost",(t=>{t.preventDefault(),this.enabled=!1})),ne(this,"onContextBack",(()=>{this.three.setRenderTarget(null),this.three.dispose(),this.three=new s.WebGLRenderer({canvas:this._canvas,antialias:!0,alpha:!0,...this._parameters}),this.enabled=!0})),this.container=e,this._parameters=i,this.three=new s.WebGLRenderer({antialias:!0,alpha:!0,...i}),this.three.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.setupRenderer(),this.setupEvents(!0),this.resize(),this._canvas=this.three.domElement;const n=this.three.getContext(),{canvas:r}=n;r.addEventListener("webglcontextlost",this.onContextLost,!1),r.addEventListener("webglcontextrestored",this.onContextBack,!1)}update(){if(!this.enabled||!this.currentWorld)return;if(0===this.mode&&!this.needsUpdate)return;this.needsUpdate=!1,this.onBeforeUpdate.trigger(this);const t=this.currentWorld.scene.three,e=this.currentWorld.camera.three;this.three.render(t,e),this.onAfterUpdate.trigger(this)}dispose(){this.enabled=!1,this.setupEvents(!1),this.three.domElement.remove(),this.three.forceContextLoss(),this.three.dispose(),this.onResize.reset(),this.onAfterUpdate.reset(),this.onBeforeUpdate.reset(),this.onDisposed.trigger(),this.onDisposed.reset()}getSize(){return new s.Vector2(this.three.domElement.clientWidth,this.three.domElement.clientHeight)}setupEvents(t){const e=this.three.domElement.parentElement;if(!e)throw new Error("This renderer needs to have an HTML container!");this._resizeObserver&&(this._resizeObserver.disconnect(),this._resizeObserver=null),window.removeEventListener("resize",this.resizeEvent),t&&(this._resizeObserver=new ResizeObserver(this.resizeEvent),this._resizeObserver.observe(e),window.addEventListener("resize",this.resizeEvent))}setupRenderer(){this.three.localClippingEnabled=!0,this.container&&this.container.appendChild(this.three.domElement),this.onContainerUpdated.trigger()}}
/*!
 * camera-controls
 * https://github.com/yomotsu/camera-controls
 * (c) 2017 @yomotsu
 * Released under the MIT License.
 */const _s=1,ys=2,ws=4,vs=Object.freeze({NONE:0,ROTATE:1,TRUCK:2,SCREEN_PAN:4,OFFSET:8,DOLLY:16,ZOOM:32,TOUCH_ROTATE:64,TOUCH_TRUCK:128,TOUCH_SCREEN_PAN:256,TOUCH_OFFSET:512,TOUCH_DOLLY:1024,TOUCH_ZOOM:2048,TOUCH_DOLLY_TRUCK:4096,TOUCH_DOLLY_SCREEN_PAN:8192,TOUCH_DOLLY_OFFSET:16384,TOUCH_DOLLY_ROTATE:32768,TOUCH_ZOOM_TRUCK:65536,TOUCH_ZOOM_OFFSET:131072,TOUCH_ZOOM_SCREEN_PAN:262144,TOUCH_ZOOM_ROTATE:524288}),bs=0,xs=1,Es=-1;function Ts(t){return t.isPerspectiveCamera}function As(t){return t.isOrthographicCamera}const Cs=2*Math.PI,Ss=Math.PI/2,Os=Math.PI/180;function Ps(t,e,i){return Math.max(e,Math.min(i,t))}function Is(t,e=1e-5){return Math.abs(t)<e}function Ds(t,e,i=1e-5){return Is(t-e,i)}function ks(t,e){return Math.round(t/e)*e}function zs(t){return isFinite(t)?t:t<0?-Number.MAX_VALUE:Number.MAX_VALUE}function Ms(t){return Math.abs(t)<Number.MAX_VALUE?t:t*(1/0)}function Bs(t,e,i,s,n=1/0,r){const o=2/(s=Math.max(1e-4,s)),a=o*r,h=1/(1+a+.48*a*a+.235*a*a*a);let l=t-e;const c=e,u=n*s;l=Ps(l,-u,u),e=t-l;const d=(i.value+o*l)*r;i.value=(i.value-o*d)*h;let p=e+(l+d)*h;return c-t>0==p>c&&(p=c,i.value=(p-c)/r),p}function Us(t,e,i,s,n=1/0,r,o){const a=2/(s=Math.max(1e-4,s)),h=a*r,l=1/(1+h+.48*h*h+.235*h*h*h);let c=e.x,u=e.y,d=e.z,p=t.x-c,f=t.y-u,m=t.z-d;const g=c,_=u,y=d,w=n*s,v=p*p+f*f+m*m;if(v>w*w){const t=Math.sqrt(v);p=p/t*w,f=f/t*w,m=m/t*w}c=t.x-p,u=t.y-f,d=t.z-m;const b=(i.x+a*p)*r,x=(i.y+a*f)*r,E=(i.z+a*m)*r;i.x=(i.x-a*b)*l,i.y=(i.y-a*x)*l,i.z=(i.z-a*E)*l,o.x=c+(p+b)*l,o.y=u+(f+x)*l,o.z=d+(m+E)*l;const T=g-t.x,A=_-t.y,C=y-t.z;return T*(o.x-g)+A*(o.y-_)+C*(o.z-y)>0&&(o.x=g,o.y=_,o.z=y,i.x=(o.x-g)/r,i.y=(o.y-_)/r,i.z=(o.z-y)/r),o}function Rs(t,e){e.set(0,0),t.forEach((t=>{e.x+=t.clientX,e.y+=t.clientY})),e.x/=t.length,e.y/=t.length}function Ns(t,e){return!!As(t)&&(console.warn(`${e} is not supported in OrthographicCamera`),!0)}class Ls{constructor(){this._listeners={}}addEventListener(t,e){const i=this._listeners;void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e)}hasEventListener(t,e){const i=this._listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)}removeEventListener(t,e){const i=this._listeners[t];if(void 0!==i){const t=i.indexOf(e);-1!==t&&i.splice(t,1)}}removeAllEventListeners(t){t?Array.isArray(this._listeners[t])&&(this._listeners[t].length=0):this._listeners={}}dispatchEvent(t){const e=this._listeners[t.type];if(void 0!==e){t.target=this;const i=e.slice(0);for(let e=0,s=i.length;e<s;e++)i[e].call(this,t)}}}var Fs;const Vs=1/8,js=/Mac/.test(null===(Fs=null===globalThis||void 0===globalThis?void 0:globalThis.navigator)||void 0===Fs?void 0:Fs.platform);let Ys,Zs,Hs,$s,Ws,qs,Xs,Gs,Qs,Ks,Js,tn,en,sn,nn,rn,on,an,hn,ln,cn,un,dn;class pn extends Ls{static install(t){Ys=t.THREE,Zs=Object.freeze(new Ys.Vector3(0,0,0)),Hs=Object.freeze(new Ys.Vector3(0,1,0)),$s=Object.freeze(new Ys.Vector3(0,0,1)),Ws=new Ys.Vector2,qs=new Ys.Vector3,Xs=new Ys.Vector3,Gs=new Ys.Vector3,Qs=new Ys.Vector3,Ks=new Ys.Vector3,Js=new Ys.Vector3,tn=new Ys.Vector3,en=new Ys.Vector3,sn=new Ys.Vector3,nn=new Ys.Spherical,rn=new Ys.Spherical,on=new Ys.Box3,an=new Ys.Box3,hn=new Ys.Sphere,ln=new Ys.Quaternion,cn=new Ys.Quaternion,un=new Ys.Matrix4,dn=new Ys.Raycaster}static get ACTION(){return vs}set verticalDragToForward(t){console.warn("camera-controls: `verticalDragToForward` was removed. Use `mouseButtons.left = CameraControls.ACTION.SCREEN_PAN` instead.")}constructor(t,e){super(),this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.minDistance=Number.EPSILON,this.maxDistance=1/0,this.infinityDolly=!1,this.minZoom=.01,this.maxZoom=1/0,this.smoothTime=.25,this.draggingSmoothTime=.125,this.maxSpeed=1/0,this.azimuthRotateSpeed=1,this.polarRotateSpeed=1,this.dollySpeed=1,this.dollyDragInverted=!1,this.truckSpeed=2,this.dollyToCursor=!1,this.dragToOffset=!1,this.boundaryFriction=0,this.restThreshold=.01,this.colliderMeshes=[],this.cancel=()=>{},this._enabled=!0,this._state=vs.NONE,this._viewport=null,this._changedDolly=0,this._changedZoom=0,this._hasRested=!0,this._boundaryEnclosesCamera=!1,this._needsUpdate=!0,this._updatedLastTime=!1,this._elementRect=new DOMRect,this._isDragging=!1,this._dragNeedsUpdate=!0,this._activePointers=[],this._lockedPointer=null,this._interactiveArea=new DOMRect(0,0,1,1),this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._isUserControllingOffset=!1,this._isUserControllingZoom=!1,this._lastDollyDirection=bs,this._thetaVelocity={value:0},this._phiVelocity={value:0},this._radiusVelocity={value:0},this._targetVelocity=new Ys.Vector3,this._focalOffsetVelocity=new Ys.Vector3,this._zoomVelocity={value:0},this._truckInternal=(t,e,i,s)=>{let n,r;if(Ts(this._camera)){const i=qs.copy(this._camera.position).sub(this._target),s=this._camera.getEffectiveFOV()*Os,o=i.length()*Math.tan(.5*s);n=this.truckSpeed*t*o/this._elementRect.height,r=this.truckSpeed*e*o/this._elementRect.height}else{if(!As(this._camera))return;{const i=this._camera;n=this.truckSpeed*t*(i.right-i.left)/i.zoom/this._elementRect.width,r=this.truckSpeed*e*(i.top-i.bottom)/i.zoom/this._elementRect.height}}s?(i?this.setFocalOffset(this._focalOffsetEnd.x+n,this._focalOffsetEnd.y,this._focalOffsetEnd.z,!0):this.truck(n,0,!0),this.forward(-r,!0)):i?this.setFocalOffset(this._focalOffsetEnd.x+n,this._focalOffsetEnd.y+r,this._focalOffsetEnd.z,!0):this.truck(n,r,!0)},this._rotateInternal=(t,e)=>{const i=Cs*this.azimuthRotateSpeed*t/this._elementRect.height,s=Cs*this.polarRotateSpeed*e/this._elementRect.height;this.rotate(i,s,!0)},this._dollyInternal=(t,e,i)=>{const s=Math.pow(.95,-t*this.dollySpeed),n=this._sphericalEnd.radius,r=this._sphericalEnd.radius*s,o=Ps(r,this.minDistance,this.maxDistance),a=o-r;this.infinityDolly&&this.dollyToCursor?this._dollyToNoClamp(r,!0):this.infinityDolly&&!this.dollyToCursor?(this.dollyInFixed(a,!0),this._dollyToNoClamp(o,!0)):this._dollyToNoClamp(o,!0),this.dollyToCursor&&(this._changedDolly+=(this.infinityDolly?r:o)-n,this._dollyControlCoord.set(e,i)),this._lastDollyDirection=Math.sign(-t)},this._zoomInternal=(t,e,i)=>{const s=Math.pow(.95,t*this.dollySpeed),n=this._zoom,r=this._zoom*s;this.zoomTo(r,!0),this.dollyToCursor&&(this._changedZoom+=r-n,this._dollyControlCoord.set(e,i))},void 0===Ys&&console.error("camera-controls: `THREE` is undefined. You must first run `CameraControls.install( { THREE: THREE } )`. Check the docs for further information."),this._camera=t,this._yAxisUpSpace=(new Ys.Quaternion).setFromUnitVectors(this._camera.up,Hs),this._yAxisUpSpaceInverse=this._yAxisUpSpace.clone().invert(),this._state=vs.NONE,this._target=new Ys.Vector3,this._targetEnd=this._target.clone(),this._focalOffset=new Ys.Vector3,this._focalOffsetEnd=this._focalOffset.clone(),this._spherical=(new Ys.Spherical).setFromVector3(qs.copy(this._camera.position).applyQuaternion(this._yAxisUpSpace)),this._sphericalEnd=this._spherical.clone(),this._lastDistance=this._spherical.radius,this._zoom=this._camera.zoom,this._zoomEnd=this._zoom,this._lastZoom=this._zoom,this._nearPlaneCorners=[new Ys.Vector3,new Ys.Vector3,new Ys.Vector3,new Ys.Vector3],this._updateNearPlaneCorners(),this._boundary=new Ys.Box3(new Ys.Vector3(-1/0,-1/0,-1/0),new Ys.Vector3(1/0,1/0,1/0)),this._cameraUp0=this._camera.up.clone(),this._target0=this._target.clone(),this._position0=this._camera.position.clone(),this._zoom0=this._zoom,this._focalOffset0=this._focalOffset.clone(),this._dollyControlCoord=new Ys.Vector2,this.mouseButtons={left:vs.ROTATE,middle:vs.DOLLY,right:vs.TRUCK,wheel:Ts(this._camera)?vs.DOLLY:As(this._camera)?vs.ZOOM:vs.NONE},this.touches={one:vs.TOUCH_ROTATE,two:Ts(this._camera)?vs.TOUCH_DOLLY_TRUCK:As(this._camera)?vs.TOUCH_ZOOM_TRUCK:vs.NONE,three:vs.TOUCH_TRUCK};const i=new Ys.Vector2,s=new Ys.Vector2,n=new Ys.Vector2,r=t=>{if(!this._enabled||!this._domElement)return;if(0!==this._interactiveArea.left||0!==this._interactiveArea.top||1!==this._interactiveArea.width||1!==this._interactiveArea.height){const e=this._domElement.getBoundingClientRect(),i=t.clientX/e.width,s=t.clientY/e.height;if(i<this._interactiveArea.left||i>this._interactiveArea.right||s<this._interactiveArea.top||s>this._interactiveArea.bottom)return}const e="mouse"!==t.pointerType?null:(t.buttons&_s)===_s?_s:(t.buttons&ws)===ws?ws:(t.buttons&ys)===ys?ys:null;if(null!==e){const t=this._findPointerByMouseButton(e);t&&this._disposePointer(t)}if((t.buttons&_s)===_s&&this._lockedPointer)return;const i={pointerId:t.pointerId,clientX:t.clientX,clientY:t.clientY,deltaX:0,deltaY:0,mouseButton:e};this._activePointers.push(i),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",a),this._domElement.ownerDocument.addEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",a),this._isDragging=!0,u(t)},o=t=>{t.cancelable&&t.preventDefault();const e=t.pointerId,i=this._lockedPointer||this._findPointerById(e);if(i){if(i.clientX=t.clientX,i.clientY=t.clientY,i.deltaX=t.movementX,i.deltaY=t.movementY,this._state=0,"touch"===t.pointerType)switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three}else(!this._isDragging&&this._lockedPointer||this._isDragging&&(t.buttons&_s)===_s)&&(this._state=this._state|this.mouseButtons.left),this._isDragging&&(t.buttons&ws)===ws&&(this._state=this._state|this.mouseButtons.middle),this._isDragging&&(t.buttons&ys)===ys&&(this._state=this._state|this.mouseButtons.right);d()}},a=t=>{const e=this._findPointerById(t.pointerId);if(!e||e!==this._lockedPointer){if(e&&this._disposePointer(e),"touch"===t.pointerType)switch(this._activePointers.length){case 0:this._state=vs.NONE;break;case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three}else this._state=vs.NONE;p()}};let h=-1;const l=t=>{if(!this._domElement)return;if(!this._enabled||this.mouseButtons.wheel===vs.NONE)return;if(0!==this._interactiveArea.left||0!==this._interactiveArea.top||1!==this._interactiveArea.width||1!==this._interactiveArea.height){const e=this._domElement.getBoundingClientRect(),i=t.clientX/e.width,s=t.clientY/e.height;if(i<this._interactiveArea.left||i>this._interactiveArea.right||s<this._interactiveArea.top||s>this._interactiveArea.bottom)return}if(t.preventDefault(),this.dollyToCursor||this.mouseButtons.wheel===vs.ROTATE||this.mouseButtons.wheel===vs.TRUCK){const t=performance.now();h-t<1e3&&this._getClientRect(this._elementRect),h=t}const e=js?-1:-3,i=1===t.deltaMode||t.ctrlKey?t.deltaY/e:t.deltaY/(10*e),s=this.dollyToCursor?(t.clientX-this._elementRect.x)/this._elementRect.width*2-1:0,n=this.dollyToCursor?(t.clientY-this._elementRect.y)/this._elementRect.height*-2+1:0;switch(this.mouseButtons.wheel){case vs.ROTATE:this._rotateInternal(t.deltaX,t.deltaY),this._isUserControllingRotate=!0;break;case vs.TRUCK:this._truckInternal(t.deltaX,t.deltaY,!1,!1),this._isUserControllingTruck=!0;break;case vs.SCREEN_PAN:this._truckInternal(t.deltaX,t.deltaY,!1,!0),this._isUserControllingTruck=!0;break;case vs.OFFSET:this._truckInternal(t.deltaX,t.deltaY,!0,!1),this._isUserControllingOffset=!0;break;case vs.DOLLY:this._dollyInternal(-i,s,n),this._isUserControllingDolly=!0;break;case vs.ZOOM:this._zoomInternal(-i,s,n),this._isUserControllingZoom=!0}this.dispatchEvent({type:"control"})},c=t=>{if(this._domElement&&this._enabled){if(this.mouseButtons.right===pn.ACTION.NONE){const e=t instanceof PointerEvent?t.pointerId:0,i=this._findPointerById(e);return i&&this._disposePointer(i),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),void this._domElement.ownerDocument.removeEventListener("pointerup",a)}t.preventDefault()}},u=t=>{if(!this._enabled)return;Rs(this._activePointers,Ws),this._getClientRect(this._elementRect),i.copy(Ws),s.copy(Ws);if(this._activePointers.length>=2){const t=Ws.x-this._activePointers[1].clientX,e=Ws.y-this._activePointers[1].clientY,i=Math.sqrt(t*t+e*e);n.set(0,i);const r=.5*(this._activePointers[0].clientX+this._activePointers[1].clientX),o=.5*(this._activePointers[0].clientY+this._activePointers[1].clientY);s.set(r,o)}if(this._state=0,t)if("pointerType"in t&&"touch"===t.pointerType)switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three}else this._lockedPointer||(t.buttons&_s)!==_s||(this._state=this._state|this.mouseButtons.left),(t.buttons&ws)===ws&&(this._state=this._state|this.mouseButtons.middle),(t.buttons&ys)===ys&&(this._state=this._state|this.mouseButtons.right);else this._lockedPointer&&(this._state=this._state|this.mouseButtons.left);(this._state&vs.ROTATE)!==vs.ROTATE&&(this._state&vs.TOUCH_ROTATE)!==vs.TOUCH_ROTATE&&(this._state&vs.TOUCH_DOLLY_ROTATE)!==vs.TOUCH_DOLLY_ROTATE&&(this._state&vs.TOUCH_ZOOM_ROTATE)!==vs.TOUCH_ZOOM_ROTATE||(this._sphericalEnd.theta=this._spherical.theta,this._sphericalEnd.phi=this._spherical.phi,this._thetaVelocity.value=0,this._phiVelocity.value=0),(this._state&vs.TRUCK)!==vs.TRUCK&&(this._state&vs.SCREEN_PAN)!==vs.SCREEN_PAN&&(this._state&vs.TOUCH_TRUCK)!==vs.TOUCH_TRUCK&&(this._state&vs.TOUCH_SCREEN_PAN)!==vs.TOUCH_SCREEN_PAN&&(this._state&vs.TOUCH_DOLLY_TRUCK)!==vs.TOUCH_DOLLY_TRUCK&&(this._state&vs.TOUCH_DOLLY_SCREEN_PAN)!==vs.TOUCH_DOLLY_SCREEN_PAN&&(this._state&vs.TOUCH_ZOOM_TRUCK)!==vs.TOUCH_ZOOM_TRUCK&&(this._state&vs.TOUCH_ZOOM_SCREEN_PAN)!==vs.TOUCH_DOLLY_SCREEN_PAN||(this._targetEnd.copy(this._target),this._targetVelocity.set(0,0,0)),(this._state&vs.DOLLY)!==vs.DOLLY&&(this._state&vs.TOUCH_DOLLY)!==vs.TOUCH_DOLLY&&(this._state&vs.TOUCH_DOLLY_TRUCK)!==vs.TOUCH_DOLLY_TRUCK&&(this._state&vs.TOUCH_DOLLY_SCREEN_PAN)!==vs.TOUCH_DOLLY_SCREEN_PAN&&(this._state&vs.TOUCH_DOLLY_OFFSET)!==vs.TOUCH_DOLLY_OFFSET&&(this._state&vs.TOUCH_DOLLY_ROTATE)!==vs.TOUCH_DOLLY_ROTATE||(this._sphericalEnd.radius=this._spherical.radius,this._radiusVelocity.value=0),(this._state&vs.ZOOM)!==vs.ZOOM&&(this._state&vs.TOUCH_ZOOM)!==vs.TOUCH_ZOOM&&(this._state&vs.TOUCH_ZOOM_TRUCK)!==vs.TOUCH_ZOOM_TRUCK&&(this._state&vs.TOUCH_ZOOM_SCREEN_PAN)!==vs.TOUCH_ZOOM_SCREEN_PAN&&(this._state&vs.TOUCH_ZOOM_OFFSET)!==vs.TOUCH_ZOOM_OFFSET&&(this._state&vs.TOUCH_ZOOM_ROTATE)!==vs.TOUCH_ZOOM_ROTATE||(this._zoomEnd=this._zoom,this._zoomVelocity.value=0),(this._state&vs.OFFSET)!==vs.OFFSET&&(this._state&vs.TOUCH_OFFSET)!==vs.TOUCH_OFFSET&&(this._state&vs.TOUCH_DOLLY_OFFSET)!==vs.TOUCH_DOLLY_OFFSET&&(this._state&vs.TOUCH_ZOOM_OFFSET)!==vs.TOUCH_ZOOM_OFFSET||(this._focalOffsetEnd.copy(this._focalOffset),this._focalOffsetVelocity.set(0,0,0)),this.dispatchEvent({type:"controlstart"})},d=()=>{if(!this._enabled||!this._dragNeedsUpdate)return;this._dragNeedsUpdate=!1,Rs(this._activePointers,Ws);const t=this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement?this._lockedPointer||this._activePointers[0]:null,e=t?-t.deltaX:s.x-Ws.x,r=t?-t.deltaY:s.y-Ws.y;if(s.copy(Ws),(this._state&vs.ROTATE)!==vs.ROTATE&&(this._state&vs.TOUCH_ROTATE)!==vs.TOUCH_ROTATE&&(this._state&vs.TOUCH_DOLLY_ROTATE)!==vs.TOUCH_DOLLY_ROTATE&&(this._state&vs.TOUCH_ZOOM_ROTATE)!==vs.TOUCH_ZOOM_ROTATE||(this._rotateInternal(e,r),this._isUserControllingRotate=!0),(this._state&vs.DOLLY)===vs.DOLLY||(this._state&vs.ZOOM)===vs.ZOOM){const t=this.dollyToCursor?(i.x-this._elementRect.x)/this._elementRect.width*2-1:0,e=this.dollyToCursor?(i.y-this._elementRect.y)/this._elementRect.height*-2+1:0,s=this.dollyDragInverted?-1:1;(this._state&vs.DOLLY)===vs.DOLLY?(this._dollyInternal(s*r*Vs,t,e),this._isUserControllingDolly=!0):(this._zoomInternal(s*r*Vs,t,e),this._isUserControllingZoom=!0)}if((this._state&vs.TOUCH_DOLLY)===vs.TOUCH_DOLLY||(this._state&vs.TOUCH_ZOOM)===vs.TOUCH_ZOOM||(this._state&vs.TOUCH_DOLLY_TRUCK)===vs.TOUCH_DOLLY_TRUCK||(this._state&vs.TOUCH_ZOOM_TRUCK)===vs.TOUCH_ZOOM_TRUCK||(this._state&vs.TOUCH_DOLLY_SCREEN_PAN)===vs.TOUCH_DOLLY_SCREEN_PAN||(this._state&vs.TOUCH_ZOOM_SCREEN_PAN)===vs.TOUCH_ZOOM_SCREEN_PAN||(this._state&vs.TOUCH_DOLLY_OFFSET)===vs.TOUCH_DOLLY_OFFSET||(this._state&vs.TOUCH_ZOOM_OFFSET)===vs.TOUCH_ZOOM_OFFSET||(this._state&vs.TOUCH_DOLLY_ROTATE)===vs.TOUCH_DOLLY_ROTATE||(this._state&vs.TOUCH_ZOOM_ROTATE)===vs.TOUCH_ZOOM_ROTATE){const t=Ws.x-this._activePointers[1].clientX,e=Ws.y-this._activePointers[1].clientY,i=Math.sqrt(t*t+e*e),r=n.y-i;n.set(0,i);const o=this.dollyToCursor?(s.x-this._elementRect.x)/this._elementRect.width*2-1:0,a=this.dollyToCursor?(s.y-this._elementRect.y)/this._elementRect.height*-2+1:0;(this._state&vs.TOUCH_DOLLY)===vs.TOUCH_DOLLY||(this._state&vs.TOUCH_DOLLY_ROTATE)===vs.TOUCH_DOLLY_ROTATE||(this._state&vs.TOUCH_DOLLY_TRUCK)===vs.TOUCH_DOLLY_TRUCK||(this._state&vs.TOUCH_DOLLY_SCREEN_PAN)===vs.TOUCH_DOLLY_SCREEN_PAN||(this._state&vs.TOUCH_DOLLY_OFFSET)===vs.TOUCH_DOLLY_OFFSET?(this._dollyInternal(r*Vs,o,a),this._isUserControllingDolly=!0):(this._zoomInternal(r*Vs,o,a),this._isUserControllingZoom=!0)}(this._state&vs.TRUCK)!==vs.TRUCK&&(this._state&vs.TOUCH_TRUCK)!==vs.TOUCH_TRUCK&&(this._state&vs.TOUCH_DOLLY_TRUCK)!==vs.TOUCH_DOLLY_TRUCK&&(this._state&vs.TOUCH_ZOOM_TRUCK)!==vs.TOUCH_ZOOM_TRUCK||(this._truckInternal(e,r,!1,!1),this._isUserControllingTruck=!0),(this._state&vs.SCREEN_PAN)!==vs.SCREEN_PAN&&(this._state&vs.TOUCH_SCREEN_PAN)!==vs.TOUCH_SCREEN_PAN&&(this._state&vs.TOUCH_DOLLY_SCREEN_PAN)!==vs.TOUCH_DOLLY_SCREEN_PAN&&(this._state&vs.TOUCH_ZOOM_SCREEN_PAN)!==vs.TOUCH_ZOOM_SCREEN_PAN||(this._truckInternal(e,r,!1,!0),this._isUserControllingTruck=!0),(this._state&vs.OFFSET)!==vs.OFFSET&&(this._state&vs.TOUCH_OFFSET)!==vs.TOUCH_OFFSET&&(this._state&vs.TOUCH_DOLLY_OFFSET)!==vs.TOUCH_DOLLY_OFFSET&&(this._state&vs.TOUCH_ZOOM_OFFSET)!==vs.TOUCH_ZOOM_OFFSET||(this._truckInternal(e,r,!0,!1),this._isUserControllingOffset=!0),this.dispatchEvent({type:"control"})},p=()=>{Rs(this._activePointers,Ws),s.copy(Ws),this._dragNeedsUpdate=!1,(0===this._activePointers.length||1===this._activePointers.length&&this._activePointers[0]===this._lockedPointer)&&(this._isDragging=!1),0===this._activePointers.length&&this._domElement&&(this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",a),this.dispatchEvent({type:"controlend"}))};this.lockPointer=()=>{this._enabled&&this._domElement&&(this.cancel(),this._lockedPointer={pointerId:-1,clientX:0,clientY:0,deltaX:0,deltaY:0,mouseButton:null},this._activePointers.push(this._lockedPointer),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",a),this._domElement.requestPointerLock(),this._domElement.ownerDocument.addEventListener("pointerlockchange",f),this._domElement.ownerDocument.addEventListener("pointerlockerror",m),this._domElement.ownerDocument.addEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",a),u())},this.unlockPointer=()=>{var t,e,i;null!==this._lockedPointer&&(this._disposePointer(this._lockedPointer),this._lockedPointer=null),null===(t=this._domElement)||void 0===t||t.ownerDocument.exitPointerLock(),null===(e=this._domElement)||void 0===e||e.ownerDocument.removeEventListener("pointerlockchange",f),null===(i=this._domElement)||void 0===i||i.ownerDocument.removeEventListener("pointerlockerror",m),this.cancel()};const f=()=>{this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement||this.unlockPointer()},m=()=>{this.unlockPointer()};this._addAllEventListeners=t=>{this._domElement=t,this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none",this._domElement.addEventListener("pointerdown",r),this._domElement.addEventListener("pointercancel",a),this._domElement.addEventListener("wheel",l,{passive:!1}),this._domElement.addEventListener("contextmenu",c)},this._removeAllEventListeners=()=>{this._domElement&&(this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect="",this._domElement.removeEventListener("pointerdown",r),this._domElement.removeEventListener("pointercancel",a),this._domElement.removeEventListener("wheel",l,{passive:!1}),this._domElement.removeEventListener("contextmenu",c),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",a),this._domElement.ownerDocument.removeEventListener("pointerlockchange",f),this._domElement.ownerDocument.removeEventListener("pointerlockerror",m))},this.cancel=()=>{this._state!==vs.NONE&&(this._state=vs.NONE,this._activePointers.length=0,p())},e&&this.connect(e),this.update(0)}get camera(){return this._camera}set camera(t){this._camera=t,this.updateCameraUp(),this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0}get enabled(){return this._enabled}set enabled(t){this._enabled=t,this._domElement&&(t?(this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none"):(this.cancel(),this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect=""))}get active(){return!this._hasRested}get currentAction(){return this._state}get distance(){return this._spherical.radius}set distance(t){this._spherical.radius===t&&this._sphericalEnd.radius===t||(this._spherical.radius=t,this._sphericalEnd.radius=t,this._needsUpdate=!0)}get azimuthAngle(){return this._spherical.theta}set azimuthAngle(t){this._spherical.theta===t&&this._sphericalEnd.theta===t||(this._spherical.theta=t,this._sphericalEnd.theta=t,this._needsUpdate=!0)}get polarAngle(){return this._spherical.phi}set polarAngle(t){this._spherical.phi===t&&this._sphericalEnd.phi===t||(this._spherical.phi=t,this._sphericalEnd.phi=t,this._needsUpdate=!0)}get boundaryEnclosesCamera(){return this._boundaryEnclosesCamera}set boundaryEnclosesCamera(t){this._boundaryEnclosesCamera=t,this._needsUpdate=!0}set interactiveArea(t){this._interactiveArea.width=Ps(t.width,0,1),this._interactiveArea.height=Ps(t.height,0,1),this._interactiveArea.x=Ps(t.x,0,1-this._interactiveArea.width),this._interactiveArea.y=Ps(t.y,0,1-this._interactiveArea.height)}addEventListener(t,e){super.addEventListener(t,e)}removeEventListener(t,e){super.removeEventListener(t,e)}rotate(t,e,i=!1){return this.rotateTo(this._sphericalEnd.theta+t,this._sphericalEnd.phi+e,i)}rotateAzimuthTo(t,e=!1){return this.rotateTo(t,this._sphericalEnd.phi,e)}rotatePolarTo(t,e=!1){return this.rotateTo(this._sphericalEnd.theta,t,e)}rotateTo(t,e,i=!1){this._isUserControllingRotate=!1;const s=Ps(t,this.minAzimuthAngle,this.maxAzimuthAngle),n=Ps(e,this.minPolarAngle,this.maxPolarAngle);this._sphericalEnd.theta=s,this._sphericalEnd.phi=n,this._sphericalEnd.makeSafe(),this._needsUpdate=!0,i||(this._spherical.theta=this._sphericalEnd.theta,this._spherical.phi=this._sphericalEnd.phi);const r=!i||Ds(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Ds(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold);return this._createOnRestPromise(r)}dolly(t,e=!1){return this.dollyTo(this._sphericalEnd.radius-t,e)}dollyTo(t,e=!1){return this._isUserControllingDolly=!1,this._lastDollyDirection=bs,this._changedDolly=0,this._dollyToNoClamp(Ps(t,this.minDistance,this.maxDistance),e)}_dollyToNoClamp(t,e=!1){const i=this._sphericalEnd.radius;if(this.colliderMeshes.length>=1){const e=this._collisionTest(),s=Ds(e,this._spherical.radius);if(!(i>t)&&s)return Promise.resolve();this._sphericalEnd.radius=Math.min(t,e)}else this._sphericalEnd.radius=t;this._needsUpdate=!0,e||(this._spherical.radius=this._sphericalEnd.radius);const s=!e||Ds(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(s)}dollyInFixed(t,e=!1){this._targetEnd.add(this._getCameraDirection(Qs).multiplyScalar(t)),e||this._target.copy(this._targetEnd);const i=!e||Ds(this._target.x,this._targetEnd.x,this.restThreshold)&&Ds(this._target.y,this._targetEnd.y,this.restThreshold)&&Ds(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(i)}zoom(t,e=!1){return this.zoomTo(this._zoomEnd+t,e)}zoomTo(t,e=!1){this._isUserControllingZoom=!1,this._zoomEnd=Ps(t,this.minZoom,this.maxZoom),this._needsUpdate=!0,e||(this._zoom=this._zoomEnd);const i=!e||Ds(this._zoom,this._zoomEnd,this.restThreshold);return this._changedZoom=0,this._createOnRestPromise(i)}pan(t,e,i=!1){return console.warn("`pan` has been renamed to `truck`"),this.truck(t,e,i)}truck(t,e,i=!1){this._camera.updateMatrix(),Ks.setFromMatrixColumn(this._camera.matrix,0),Js.setFromMatrixColumn(this._camera.matrix,1),Ks.multiplyScalar(t),Js.multiplyScalar(-e);const s=qs.copy(Ks).add(Js),n=Xs.copy(this._targetEnd).add(s);return this.moveTo(n.x,n.y,n.z,i)}forward(t,e=!1){qs.setFromMatrixColumn(this._camera.matrix,0),qs.crossVectors(this._camera.up,qs),qs.multiplyScalar(t);const i=Xs.copy(this._targetEnd).add(qs);return this.moveTo(i.x,i.y,i.z,e)}elevate(t,e=!1){return qs.copy(this._camera.up).multiplyScalar(t),this.moveTo(this._targetEnd.x+qs.x,this._targetEnd.y+qs.y,this._targetEnd.z+qs.z,e)}moveTo(t,e,i,s=!1){this._isUserControllingTruck=!1;const n=qs.set(t,e,i).sub(this._targetEnd);this._encloseToBoundary(this._targetEnd,n,this.boundaryFriction),this._needsUpdate=!0,s||this._target.copy(this._targetEnd);const r=!s||Ds(this._target.x,this._targetEnd.x,this.restThreshold)&&Ds(this._target.y,this._targetEnd.y,this.restThreshold)&&Ds(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(r)}lookInDirectionOf(t,e,i,s=!1){const n=qs.set(t,e,i).sub(this._targetEnd).normalize().multiplyScalar(-this._sphericalEnd.radius).add(this._targetEnd);return this.setPosition(n.x,n.y,n.z,s)}fitToBox(t,e,{cover:i=!1,paddingLeft:s=0,paddingRight:n=0,paddingBottom:r=0,paddingTop:o=0}={}){const a=[],h=t.isBox3?on.copy(t):on.setFromObject(t);h.isEmpty()&&(console.warn("camera-controls: fitTo() cannot be used with an empty box. Aborting"),Promise.resolve());const l=ks(this._sphericalEnd.theta,Ss),c=ks(this._sphericalEnd.phi,Ss);a.push(this.rotateTo(l,c,e));const u=qs.setFromSpherical(this._sphericalEnd).normalize(),d=ln.setFromUnitVectors(u,$s),p=Ds(Math.abs(u.y),1);p&&d.multiply(cn.setFromAxisAngle(Hs,l)),d.multiply(this._yAxisUpSpaceInverse);const f=an.makeEmpty();Xs.copy(h.min).applyQuaternion(d),f.expandByPoint(Xs),Xs.copy(h.min).setX(h.max.x).applyQuaternion(d),f.expandByPoint(Xs),Xs.copy(h.min).setY(h.max.y).applyQuaternion(d),f.expandByPoint(Xs),Xs.copy(h.max).setZ(h.min.z).applyQuaternion(d),f.expandByPoint(Xs),Xs.copy(h.min).setZ(h.max.z).applyQuaternion(d),f.expandByPoint(Xs),Xs.copy(h.max).setY(h.min.y).applyQuaternion(d),f.expandByPoint(Xs),Xs.copy(h.max).setX(h.min.x).applyQuaternion(d),f.expandByPoint(Xs),Xs.copy(h.max).applyQuaternion(d),f.expandByPoint(Xs),f.min.x-=s,f.min.y-=r,f.max.x+=n,f.max.y+=o,d.setFromUnitVectors($s,u),p&&d.premultiply(cn.invert()),d.premultiply(this._yAxisUpSpace);const m=f.getSize(qs),g=f.getCenter(Xs).applyQuaternion(d);if(Ts(this._camera)){const t=this.getDistanceToFitBox(m.x,m.y,m.z,i);a.push(this.moveTo(g.x,g.y,g.z,e)),a.push(this.dollyTo(t,e)),a.push(this.setFocalOffset(0,0,0,e))}else if(As(this._camera)){const t=this._camera,s=t.right-t.left,n=t.top-t.bottom,r=i?Math.max(s/m.x,n/m.y):Math.min(s/m.x,n/m.y);a.push(this.moveTo(g.x,g.y,g.z,e)),a.push(this.zoomTo(r,e)),a.push(this.setFocalOffset(0,0,0,e))}return Promise.all(a)}fitToSphere(t,e){const i=[],s="isObject3D"in t?pn.createBoundingSphere(t,hn):hn.copy(t);if(i.push(this.moveTo(s.center.x,s.center.y,s.center.z,e)),Ts(this._camera)){const t=this.getDistanceToFitSphere(s.radius);i.push(this.dollyTo(t,e))}else if(As(this._camera)){const t=this._camera.right-this._camera.left,n=this._camera.top-this._camera.bottom,r=2*s.radius,o=Math.min(t/r,n/r);i.push(this.zoomTo(o,e))}return i.push(this.setFocalOffset(0,0,0,e)),Promise.all(i)}setLookAt(t,e,i,s,n,r,o=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=bs,this._changedDolly=0;const a=Xs.set(s,n,r),h=qs.set(t,e,i);this._targetEnd.copy(a),this._sphericalEnd.setFromVector3(h.sub(a).applyQuaternion(this._yAxisUpSpace)),this.normalizeRotations(),this._needsUpdate=!0,o||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const l=!o||Ds(this._target.x,this._targetEnd.x,this.restThreshold)&&Ds(this._target.y,this._targetEnd.y,this.restThreshold)&&Ds(this._target.z,this._targetEnd.z,this.restThreshold)&&Ds(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Ds(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&Ds(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(l)}lerpLookAt(t,e,i,s,n,r,o,a,h,l,c,u,d,p=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=bs,this._changedDolly=0;const f=qs.set(s,n,r),m=Xs.set(t,e,i);nn.setFromVector3(m.sub(f).applyQuaternion(this._yAxisUpSpace));const g=Gs.set(l,c,u),_=Xs.set(o,a,h);rn.setFromVector3(_.sub(g).applyQuaternion(this._yAxisUpSpace)),this._targetEnd.copy(f.lerp(g,d));const y=rn.theta-nn.theta,w=rn.phi-nn.phi,v=rn.radius-nn.radius;this._sphericalEnd.set(nn.radius+v*d,nn.phi+w*d,nn.theta+y*d),this.normalizeRotations(),this._needsUpdate=!0,p||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const b=!p||Ds(this._target.x,this._targetEnd.x,this.restThreshold)&&Ds(this._target.y,this._targetEnd.y,this.restThreshold)&&Ds(this._target.z,this._targetEnd.z,this.restThreshold)&&Ds(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Ds(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&Ds(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(b)}setPosition(t,e,i,s=!1){return this.setLookAt(t,e,i,this._targetEnd.x,this._targetEnd.y,this._targetEnd.z,s)}setTarget(t,e,i,s=!1){const n=this.getPosition(qs),r=this.setLookAt(n.x,n.y,n.z,t,e,i,s);return this._sphericalEnd.phi=Ps(this._sphericalEnd.phi,this.minPolarAngle,this.maxPolarAngle),r}setFocalOffset(t,e,i,s=!1){this._isUserControllingOffset=!1,this._focalOffsetEnd.set(t,e,i),this._needsUpdate=!0,s||this._focalOffset.copy(this._focalOffsetEnd);const n=!s||Ds(this._focalOffset.x,this._focalOffsetEnd.x,this.restThreshold)&&Ds(this._focalOffset.y,this._focalOffsetEnd.y,this.restThreshold)&&Ds(this._focalOffset.z,this._focalOffsetEnd.z,this.restThreshold);return this._createOnRestPromise(n)}setOrbitPoint(t,e,i){this._camera.updateMatrixWorld(),Ks.setFromMatrixColumn(this._camera.matrixWorldInverse,0),Js.setFromMatrixColumn(this._camera.matrixWorldInverse,1),tn.setFromMatrixColumn(this._camera.matrixWorldInverse,2);const s=qs.set(t,e,i),n=s.distanceTo(this._camera.position),r=s.sub(this._camera.position);Ks.multiplyScalar(r.x),Js.multiplyScalar(r.y),tn.multiplyScalar(r.z),qs.copy(Ks).add(Js).add(tn),qs.z=qs.z+n,this.dollyTo(n,!1),this.setFocalOffset(-qs.x,qs.y,-qs.z,!1),this.moveTo(t,e,i,!1)}setBoundary(t){if(!t)return this._boundary.min.set(-1/0,-1/0,-1/0),this._boundary.max.set(1/0,1/0,1/0),void(this._needsUpdate=!0);this._boundary.copy(t),this._boundary.clampPoint(this._targetEnd,this._targetEnd),this._needsUpdate=!0}setViewport(t,e,i,s){null!==t?(this._viewport=this._viewport||new Ys.Vector4,"number"==typeof t?this._viewport.set(t,e,i,s):this._viewport.copy(t)):this._viewport=null}getDistanceToFitBox(t,e,i,s=!1){if(Ns(this._camera,"getDistanceToFitBox"))return this._spherical.radius;const n=t/e,r=this._camera.getEffectiveFOV()*Os,o=this._camera.aspect;return.5*((s?n>o:n<o)?e:t/o)/Math.tan(.5*r)+.5*i}getDistanceToFitSphere(t){if(Ns(this._camera,"getDistanceToFitSphere"))return this._spherical.radius;const e=this._camera.getEffectiveFOV()*Os,i=2*Math.atan(Math.tan(.5*e)*this._camera.aspect),s=1<this._camera.aspect?e:i;return t/Math.sin(.5*s)}getTarget(t,e=!0){return(t&&t.isVector3?t:new Ys.Vector3).copy(e?this._targetEnd:this._target)}getPosition(t,e=!0){return(t&&t.isVector3?t:new Ys.Vector3).setFromSpherical(e?this._sphericalEnd:this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(e?this._targetEnd:this._target)}getSpherical(t,e=!0){return(t||new Ys.Spherical).copy(e?this._sphericalEnd:this._spherical)}getFocalOffset(t,e=!0){return(t&&t.isVector3?t:new Ys.Vector3).copy(e?this._focalOffsetEnd:this._focalOffset)}normalizeRotations(){this._sphericalEnd.theta=this._sphericalEnd.theta%Cs,this._sphericalEnd.theta<0&&(this._sphericalEnd.theta+=Cs),this._spherical.theta+=Cs*Math.round((this._sphericalEnd.theta-this._spherical.theta)/Cs)}stop(){this._focalOffset.copy(this._focalOffsetEnd),this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd),this._zoom=this._zoomEnd}reset(t=!1){if(!Ds(this._camera.up.x,this._cameraUp0.x)||!Ds(this._camera.up.y,this._cameraUp0.y)||!Ds(this._camera.up.z,this._cameraUp0.z)){this._camera.up.copy(this._cameraUp0);const t=this.getPosition(qs);this.updateCameraUp(),this.setPosition(t.x,t.y,t.z)}const e=[this.setLookAt(this._position0.x,this._position0.y,this._position0.z,this._target0.x,this._target0.y,this._target0.z,t),this.setFocalOffset(this._focalOffset0.x,this._focalOffset0.y,this._focalOffset0.z,t),this.zoomTo(this._zoom0,t)];return Promise.all(e)}saveState(){this._cameraUp0.copy(this._camera.up),this.getTarget(this._target0),this.getPosition(this._position0),this._zoom0=this._zoom,this._focalOffset0.copy(this._focalOffset)}updateCameraUp(){this._yAxisUpSpace.setFromUnitVectors(this._camera.up,Hs),this._yAxisUpSpaceInverse.copy(this._yAxisUpSpace).invert()}applyCameraUp(){const t=qs.subVectors(this._target,this._camera.position).normalize(),e=Xs.crossVectors(t,this._camera.up);this._camera.up.crossVectors(e,t).normalize(),this._camera.updateMatrixWorld();const i=this.getPosition(qs);this.updateCameraUp(),this.setPosition(i.x,i.y,i.z)}update(t){const e=this._sphericalEnd.theta-this._spherical.theta,i=this._sphericalEnd.phi-this._spherical.phi,s=this._sphericalEnd.radius-this._spherical.radius,n=en.subVectors(this._targetEnd,this._target),r=sn.subVectors(this._focalOffsetEnd,this._focalOffset),o=this._zoomEnd-this._zoom;if(Is(e))this._thetaVelocity.value=0,this._spherical.theta=this._sphericalEnd.theta;else{const e=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.theta=Bs(this._spherical.theta,this._sphericalEnd.theta,this._thetaVelocity,e,1/0,t),this._needsUpdate=!0}if(Is(i))this._phiVelocity.value=0,this._spherical.phi=this._sphericalEnd.phi;else{const e=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.phi=Bs(this._spherical.phi,this._sphericalEnd.phi,this._phiVelocity,e,1/0,t),this._needsUpdate=!0}if(Is(s))this._radiusVelocity.value=0,this._spherical.radius=this._sphericalEnd.radius;else{const e=this._isUserControllingDolly?this.draggingSmoothTime:this.smoothTime;this._spherical.radius=Bs(this._spherical.radius,this._sphericalEnd.radius,this._radiusVelocity,e,this.maxSpeed,t),this._needsUpdate=!0}if(Is(n.x)&&Is(n.y)&&Is(n.z))this._targetVelocity.set(0,0,0),this._target.copy(this._targetEnd);else{const e=this._isUserControllingTruck?this.draggingSmoothTime:this.smoothTime;Us(this._target,this._targetEnd,this._targetVelocity,e,this.maxSpeed,t,this._target),this._needsUpdate=!0}if(Is(r.x)&&Is(r.y)&&Is(r.z))this._focalOffsetVelocity.set(0,0,0),this._focalOffset.copy(this._focalOffsetEnd);else{const e=this._isUserControllingOffset?this.draggingSmoothTime:this.smoothTime;Us(this._focalOffset,this._focalOffsetEnd,this._focalOffsetVelocity,e,this.maxSpeed,t,this._focalOffset),this._needsUpdate=!0}if(Is(o))this._zoomVelocity.value=0,this._zoom=this._zoomEnd;else{const e=this._isUserControllingZoom?this.draggingSmoothTime:this.smoothTime;this._zoom=Bs(this._zoom,this._zoomEnd,this._zoomVelocity,e,1/0,t)}if(this.dollyToCursor)if(Ts(this._camera)&&0!==this._changedDolly){const t=this._spherical.radius-this._lastDistance,e=this._camera,i=this._getCameraDirection(Qs),s=qs.copy(i).cross(e.up).normalize();0===s.lengthSq()&&(s.x=1);const n=Xs.crossVectors(s,i),r=this._sphericalEnd.radius*Math.tan(e.getEffectiveFOV()*Os*.5),o=(this._sphericalEnd.radius-t-this._sphericalEnd.radius)/this._sphericalEnd.radius,a=Gs.copy(this._targetEnd).add(s.multiplyScalar(this._dollyControlCoord.x*r*e.aspect)).add(n.multiplyScalar(this._dollyControlCoord.y*r)),h=qs.copy(this._targetEnd).lerp(a,o),l=this._lastDollyDirection===xs&&this._spherical.radius<=this.minDistance,c=this._lastDollyDirection===Es&&this.maxDistance<=this._spherical.radius;if(this.infinityDolly&&(l||c)){this._sphericalEnd.radius-=t,this._spherical.radius-=t;const e=Xs.copy(i).multiplyScalar(-t);h.add(e)}this._boundary.clampPoint(h,h);const u=Xs.subVectors(h,this._targetEnd);this._targetEnd.copy(h),this._target.add(u),this._changedDolly-=t,Is(this._changedDolly)&&(this._changedDolly=0)}else if(As(this._camera)&&0!==this._changedZoom){const t=this._zoom-this._lastZoom,e=this._camera,i=qs.set(this._dollyControlCoord.x,this._dollyControlCoord.y,(e.near+e.far)/(e.near-e.far)).unproject(e),s=Xs.set(0,0,-1).applyQuaternion(e.quaternion),n=Gs.copy(i).add(s.multiplyScalar(-i.dot(e.up))),r=-(this._zoom-t-this._zoom)/this._zoom,o=this._getCameraDirection(Qs),a=this._targetEnd.dot(o),h=qs.copy(this._targetEnd).lerp(n,r),l=h.dot(o),c=o.multiplyScalar(l-a);h.sub(c),this._boundary.clampPoint(h,h);const u=Xs.subVectors(h,this._targetEnd);this._targetEnd.copy(h),this._target.add(u),this._changedZoom-=t,Is(this._changedZoom)&&(this._changedZoom=0)}this._camera.zoom!==this._zoom&&(this._camera.zoom=this._zoom,this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0),this._dragNeedsUpdate=!0;const a=this._collisionTest();this._spherical.radius=Math.min(this._spherical.radius,a),this._spherical.makeSafe(),this._camera.position.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(this._target),this._camera.lookAt(this._target);(!Is(this._focalOffset.x)||!Is(this._focalOffset.y)||!Is(this._focalOffset.z))&&(Ks.setFromMatrixColumn(this._camera.matrix,0),Js.setFromMatrixColumn(this._camera.matrix,1),tn.setFromMatrixColumn(this._camera.matrix,2),Ks.multiplyScalar(this._focalOffset.x),Js.multiplyScalar(-this._focalOffset.y),tn.multiplyScalar(this._focalOffset.z),qs.copy(Ks).add(Js).add(tn),this._camera.position.add(qs),this._camera.updateMatrixWorld()),this._boundaryEnclosesCamera&&this._encloseToBoundary(this._camera.position.copy(this._target),qs.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse),1);const h=this._needsUpdate;return h&&!this._updatedLastTime?(this._hasRested=!1,this.dispatchEvent({type:"wake"}),this.dispatchEvent({type:"update"})):h?(this.dispatchEvent({type:"update"}),Is(e,this.restThreshold)&&Is(i,this.restThreshold)&&Is(s,this.restThreshold)&&Is(n.x,this.restThreshold)&&Is(n.y,this.restThreshold)&&Is(n.z,this.restThreshold)&&Is(r.x,this.restThreshold)&&Is(r.y,this.restThreshold)&&Is(r.z,this.restThreshold)&&Is(o,this.restThreshold)&&!this._hasRested&&(this._hasRested=!0,this.dispatchEvent({type:"rest"}))):!h&&this._updatedLastTime&&this.dispatchEvent({type:"sleep"}),this._lastDistance=this._spherical.radius,this._lastZoom=this._zoom,this._updatedLastTime=h,this._needsUpdate=!1,h}toJSON(){return JSON.stringify({enabled:this._enabled,minDistance:this.minDistance,maxDistance:zs(this.maxDistance),minZoom:this.minZoom,maxZoom:zs(this.maxZoom),minPolarAngle:this.minPolarAngle,maxPolarAngle:zs(this.maxPolarAngle),minAzimuthAngle:zs(this.minAzimuthAngle),maxAzimuthAngle:zs(this.maxAzimuthAngle),smoothTime:this.smoothTime,draggingSmoothTime:this.draggingSmoothTime,dollySpeed:this.dollySpeed,truckSpeed:this.truckSpeed,dollyToCursor:this.dollyToCursor,target:this._targetEnd.toArray(),position:qs.setFromSpherical(this._sphericalEnd).add(this._targetEnd).toArray(),zoom:this._zoomEnd,focalOffset:this._focalOffsetEnd.toArray(),target0:this._target0.toArray(),position0:this._position0.toArray(),zoom0:this._zoom0,focalOffset0:this._focalOffset0.toArray()})}fromJSON(t,e=!1){const i=JSON.parse(t);this.enabled=i.enabled,this.minDistance=i.minDistance,this.maxDistance=Ms(i.maxDistance),this.minZoom=i.minZoom,this.maxZoom=Ms(i.maxZoom),this.minPolarAngle=i.minPolarAngle,this.maxPolarAngle=Ms(i.maxPolarAngle),this.minAzimuthAngle=Ms(i.minAzimuthAngle),this.maxAzimuthAngle=Ms(i.maxAzimuthAngle),this.smoothTime=i.smoothTime,this.draggingSmoothTime=i.draggingSmoothTime,this.dollySpeed=i.dollySpeed,this.truckSpeed=i.truckSpeed,this.dollyToCursor=i.dollyToCursor,this._target0.fromArray(i.target0),this._position0.fromArray(i.position0),this._zoom0=i.zoom0,this._focalOffset0.fromArray(i.focalOffset0),this.moveTo(i.target[0],i.target[1],i.target[2],e),nn.setFromVector3(qs.fromArray(i.position).sub(this._targetEnd).applyQuaternion(this._yAxisUpSpace)),this.rotateTo(nn.theta,nn.phi,e),this.dollyTo(nn.radius,e),this.zoomTo(i.zoom,e),this.setFocalOffset(i.focalOffset[0],i.focalOffset[1],i.focalOffset[2],e),this._needsUpdate=!0}connect(t){this._domElement?console.warn("camera-controls is already connected."):(t.setAttribute("data-camera-controls-version","2.10.1"),this._addAllEventListeners(t),this._getClientRect(this._elementRect))}disconnect(){this.cancel(),this._removeAllEventListeners(),this._domElement&&(this._domElement.removeAttribute("data-camera-controls-version"),this._domElement=void 0)}dispose(){this.removeAllEventListeners(),this.disconnect()}_getTargetDirection(t){return t.setFromSpherical(this._spherical).divideScalar(this._spherical.radius).applyQuaternion(this._yAxisUpSpaceInverse)}_getCameraDirection(t){return this._getTargetDirection(t).negate()}_findPointerById(t){return this._activePointers.find((e=>e.pointerId===t))}_findPointerByMouseButton(t){return this._activePointers.find((e=>e.mouseButton===t))}_disposePointer(t){this._activePointers.splice(this._activePointers.indexOf(t),1)}_encloseToBoundary(t,e,i){const s=e.lengthSq();if(0===s)return t;const n=Xs.copy(e).add(t),r=this._boundary.clampPoint(n,Gs).sub(n),o=r.lengthSq();if(0===o)return t.add(e);if(o===s)return t;if(0===i)return t.add(e).add(r);{const s=1+i*o/e.dot(r);return t.add(Xs.copy(e).multiplyScalar(s)).add(r.multiplyScalar(1-i))}}_updateNearPlaneCorners(){if(Ts(this._camera)){const t=this._camera,e=t.near,i=t.getEffectiveFOV()*Os,s=Math.tan(.5*i)*e,n=s*t.aspect;this._nearPlaneCorners[0].set(-n,-s,0),this._nearPlaneCorners[1].set(n,-s,0),this._nearPlaneCorners[2].set(n,s,0),this._nearPlaneCorners[3].set(-n,s,0)}else if(As(this._camera)){const t=this._camera,e=1/t.zoom,i=t.left*e,s=t.right*e,n=t.top*e,r=t.bottom*e;this._nearPlaneCorners[0].set(i,n,0),this._nearPlaneCorners[1].set(s,n,0),this._nearPlaneCorners[2].set(s,r,0),this._nearPlaneCorners[3].set(i,r,0)}}_collisionTest(){let t=1/0;if(!(this.colliderMeshes.length>=1))return t;if(Ns(this._camera,"_collisionTest"))return t;const e=this._getTargetDirection(Qs);un.lookAt(Zs,e,this._camera.up);for(let i=0;i<4;i++){const s=Xs.copy(this._nearPlaneCorners[i]);s.applyMatrix4(un);const n=Gs.addVectors(this._target,s);dn.set(n,e),dn.far=this._spherical.radius+1;const r=dn.intersectObjects(this.colliderMeshes);0!==r.length&&r[0].distance<t&&(t=r[0].distance)}return t}_getClientRect(t){if(!this._domElement)return;const e=this._domElement.getBoundingClientRect();return t.x=e.left,t.y=e.top,this._viewport?(t.x+=this._viewport.x,t.y+=e.height-this._viewport.w-this._viewport.y,t.width=this._viewport.z,t.height=this._viewport.w):(t.width=e.width,t.height=e.height),t}_createOnRestPromise(t){return t?Promise.resolve():(this._hasRested=!1,this.dispatchEvent({type:"transitionstart"}),new Promise((t=>{const e=()=>{this.removeEventListener("rest",e),t()};this.addEventListener("rest",e)})))}_addAllEventListeners(t){}_removeAllEventListeners(){}get dampingFactor(){return console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead."),0}set dampingFactor(t){console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead.")}get draggingDampingFactor(){return console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead."),0}set draggingDampingFactor(t){console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead.")}static createBoundingSphere(t,e=new Ys.Sphere){const i=e,s=i.center;on.makeEmpty(),t.traverseVisible((t=>{t.isMesh&&on.expandByObject(t)})),on.getCenter(s);let n=0;return t.traverseVisible((t=>{if(!t.isMesh)return;const e=t;if(!e.geometry)return;const i=e.geometry.clone();i.applyMatrix4(e.matrixWorld);const r=i.attributes.position;for(let t=0,e=r.count;t<e;t++)qs.fromBufferAttribute(r,t),n=Math.max(n,s.distanceToSquared(qs))})),i.radius=Math.sqrt(n),i}}class fn extends ce{constructor(t){super(t),ne(this,"onBeforeUpdate",new re),ne(this,"onAfterUpdate",new re),ne(this,"onAspectUpdated",new re),ne(this,"onDisposed",new re),ne(this,"three"),ne(this,"_allControls",new Map),ne(this,"updateAspect",(()=>{var t;if(this.currentWorld&&this.currentWorld.renderer)if(this.three instanceof s.OrthographicCamera)this.onAspectUpdated.trigger();else if(null==(t=this.currentWorld.renderer)?void 0:t.isResizeable()){const t=this.currentWorld.renderer.getSize();this.three.aspect=t.width/t.height,this.three.updateProjectionMatrix(),this.onAspectUpdated.trigger()}})),this.three=this.setupCamera(),this.setupEvents(!0),this.worlds.onItemSet.add((({value:t})=>{const e=this.newCameraControls();this._allControls.set(t.uuid,e)})),this.worlds.onBeforeDelete.add((({value:t})=>{const e=this._allControls.get(t.uuid);e&&(e.dispose(),this._allControls.delete(t.uuid))}))}get controls(){if(!this.currentWorld)throw new Error("This camera needs a world to work!");const t=this._allControls.get(this.currentWorld.uuid);if(!t)throw new Error("Controls not found!");return t}get enabled(){return null!==this.currentWorld&&this.controls.enabled}set enabled(t){null!==this.currentWorld&&(this.controls.enabled=t)}set currentWorld(t){if(super.currentWorld=t,!t)return;this.worlds.get(t.uuid)||this.worlds.set(t.uuid,t)}get currentWorld(){return this._currentWorld}dispose(){this.setupEvents(!1),this.onAspectUpdated.reset(),this.onBeforeUpdate.reset(),this.onAfterUpdate.reset(),this.three.removeFromParent(),this.onDisposed.trigger(),this.onDisposed.reset();for(const[t,e]of this._allControls)e.dispose();this.worlds.clear()}async fitToItems(t){const e=await this.getItemsBounding(t);await this.controls.fitToSphere(e,!0)}async setOrbitToItems(t){const e=await this.getItemsBounding(t);this.controls.setOrbitPoint(e.center.x,e.center.y,e.center.z)}update(t){this.enabled&&(this.onBeforeUpdate.trigger(this),this.controls.update(t),this.onAfterUpdate.trigger(this))}async getItemsBounding(t){const e=this.components.get(qi),i=this.components.get(es);i.list.clear();const n=new s.Sphere;if(t)await i.addFromModelIdMap(t);else for(const[,t]of e.list)i.list.add(t.box);return i.get().getBoundingSphere(n),i.list.clear(),n}setupCamera(){const t=window.innerWidth/window.innerHeight,e=new s.PerspectiveCamera(60,t,1,1e3);return e.position.set(50,50,50),e.lookAt(new s.Vector3(0,0,0)),e}newCameraControls(){if(!this.currentWorld)throw new Error("This camera needs a world to work!");if(!this.currentWorld.renderer)throw new Error("This camera needs a renderer to work!");pn.install({THREE:fn.getSubsetOfThree()});const{domElement:t}=this.currentWorld.renderer.three,e=new pn(this.three,t);return e.smoothTime=.2,e.dollyToCursor=!0,e.infinityDolly=!0,e.minDistance=6,e}setupEvents(t){t?window.addEventListener("resize",this.updateAspect):window.removeEventListener("resize",this.updateAspect)}static getSubsetOfThree(){return{MOUSE:s.MOUSE,Vector2:s.Vector2,Vector3:s.Vector3,Vector4:s.Vector4,Quaternion:s.Quaternion,Matrix4:s.Matrix4,Spherical:s.Spherical,Box3:s.Box3,Sphere:s.Sphere,Raycaster:s.Raycaster,MathUtils:s.MathUtils}}}const mn=class t extends he{constructor(e){super(e),ne(this,"onAfterUpdate",new re),ne(this,"onBeforeUpdate",new re),ne(this,"onDisposed",new re),ne(this,"list",new Fi),ne(this,"enabled",!0),e.add(t.uuid,this)}create(){const t=new cs(this.components),e=t.uuid;if(this.list.has(e))throw new Error("There is already a world with this name!");return this.list.set(e,t),t}delete(t){if(!this.list.has(t.uuid))throw new Error("The provided world is not found in the list!");this.list.delete(t.uuid),t.dispose()}dispose(){this.enabled=!1;for(const[t,e]of this.list)e.dispose();this.list.clear(),this.onDisposed.trigger()}update(t){if(this.enabled)for(const[e,i]of this.list)i.update(t)}};ne(mn,"uuid","fdb61dc4-2ec1-4966-b83d-54ea795fad4a");let gn=mn;class _n extends Yi{constructor(){super(...arguments),ne(this,"_config",{visible:{value:!0,type:"Boolean"},color:{value:new s.Color,type:"Color"},primarySize:{type:"Number",interpolable:!0,value:1,min:0,max:1e3},secondarySize:{type:"Number",interpolable:!0,value:10,min:0,max:1e3},distance:{type:"Number",interpolable:!0,value:500,min:0,max:500}})}get visible(){return this._config.visible.value}set visible(t){this._config.visible.value=t,this._component.visible=t}get color(){return this._config.color.value}set color(t){this._config.color.value=t,this._component.material.uniforms.uColor.value=t,this._component.material.uniformsNeedUpdate=!0}get primarySize(){return this._config.primarySize.value}set primarySize(t){this._config.primarySize.value=t,this._component.material.uniforms.uSize1.value=t,this._component.material.uniformsNeedUpdate=!0}get secondarySize(){return this._config.secondarySize.value}set secondarySize(t){this._config.secondarySize.value=t,this._component.material.uniforms.uSize2.value=t,this._component.material.uniformsNeedUpdate=!0}get distance(){return this._config.distance.value}set distance(t){this._config.distance.value=t,this._component.material.uniforms.uDistance.value=t,this._component.material.uniformsNeedUpdate=!0}}class yn{constructor(t,e){ne(this,"onDisposed",new re),ne(this,"onSetup",new re),ne(this,"isSetup",!1),ne(this,"world"),ne(this,"components"),ne(this,"config"),ne(this,"_defaultConfig",{visible:!0,color:new s.Color(12303291),primarySize:1,secondarySize:10,distance:500}),ne(this,"three"),ne(this,"_fade",3),ne(this,"updateZoom",(()=>{this.world.camera instanceof fn&&(this.material.uniforms.uZoom.value=this.world.camera.three.zoom)})),this.world=e;const{color:i,primarySize:n,secondarySize:r,distance:o}=this._defaultConfig;this.components=t,this.config=new _n(this,this.components,"Grid");const a=new s.PlaneGeometry(2,2,1,1),h=new s.ShaderMaterial({side:s.DoubleSide,uniforms:{uSize1:{value:n},uSize2:{value:r},uColor:{value:i},uDistance:{value:o},uFade:{value:this._fade},uZoom:{value:1}},transparent:!0,vertexShader:"\n            \n            varying vec3 worldPosition;\n            \n            uniform float uDistance;\n            \n            void main() {\n            \n                    vec3 pos = position.xzy * uDistance;\n                    pos.xz += cameraPosition.xz;\n                    \n                    worldPosition = pos;\n                    \n                    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);\n            \n            }\n            ",fragmentShader:"\n            \n            varying vec3 worldPosition;\n            \n            uniform float uZoom;\n            uniform float uFade;\n            uniform float uSize1;\n            uniform float uSize2;\n            uniform vec3 uColor;\n            uniform float uDistance;\n                \n                \n                \n                float getGrid(float size) {\n                \n                    vec2 r = worldPosition.xz / size;\n                    \n                    \n                    vec2 grid = abs(fract(r - 0.5) - 0.5) / fwidth(r);\n                    float line = min(grid.x, grid.y);\n                    \n                \n                    return 1.0 - min(line, 1.0);\n                }\n                \n            void main() {\n            \n                    \n                    float d = 1.0 - min(distance(cameraPosition.xz, worldPosition.xz) / uDistance, 1.0);\n                    \n                    float g1 = getGrid(uSize1);\n                    float g2 = getGrid(uSize2);\n                    \n                    // Ortho camera fades the grid away when zooming out\n                    float minZoom = step(0.2, uZoom);\n                    float zoomFactor = pow(min(uZoom, 1.), 2.) * minZoom;\n                    \n                    gl_FragColor = vec4(uColor.rgb, mix(g2, g1, g1) * pow(d, uFade));\n                    gl_FragColor.a = mix(0.5 * gl_FragColor.a, gl_FragColor.a, g2) * zoomFactor;\n                    \n                    if ( gl_FragColor.a <= 0.0 ) discard;\n                    \n            \n            }\n            \n            ",extensions:{derivatives:!0}});this.three=new s.Mesh(a,h),this.three.frustumCulled=!1,e.scene.three.add(this.three),this.setupEvents(!0)}get visible(){return this.three.visible}set visible(t){if(this.three.visible=t,t){this.world.scene.three.add(this.three)}else this.three.removeFromParent()}get material(){return this.three.material}get fade(){return 3===this._fade}set fade(t){this._fade=t?3:0,this.material.uniforms.uFade.value=this._fade}setup(t){const e={...this._defaultConfig,...t};this.config.visible=!0,this.config.color=e.color,this.config.primarySize=e.primarySize,this.config.secondarySize=e.secondarySize,this.config.distance=e.distance,this.isSetup=!0,this.onSetup.trigger()}dispose(){this.setupEvents(!1);this.components.get(Hi).list.delete(this.config.uuid);this.components.get(pe).destroy(this.three),this.onDisposed.trigger(),this.onDisposed.reset(),this.world=null,this.components=null}setupEvents(t){if(this.world.isDisposing)return;if(!(this.world.camera instanceof fn))return;const e=this.world.camera.controls;t?e.addEventListener("update",this.updateZoom):e.removeEventListener("update",this.updateZoom)}}const wn=class t extends he{constructor(e){super(e),ne(this,"list",new Map),ne(this,"onDisposed",new re),ne(this,"enabled",!0),e.add(t.uuid,this)}create(t){if(this.list.has(t.uuid))throw new Error("This world already has a grid!");const e=new yn(this.components,t);return this.list.set(t.uuid,e),t.onDisposed.add((()=>{this.delete(t)})),e}delete(t){const e=this.list.get(t.uuid);e&&e.dispose(),this.list.delete(t.uuid)}dispose(){for(const[t,e]of this.list)e.dispose();this.list.clear(),this.onDisposed.trigger(),this.onDisposed.reset()}};ne(wn,"uuid","d1e814d5-b81c-4452-87a2-f039375e0489");let vn=wn;const bn=1.25,xn=65535,En=Math.pow(2,-24),Tn=Symbol("SKIP_GENERATION");function An(t){return function(t){return t.index?t.index.count:t.attributes.position.count}(t)/3}function Cn(t,e){if(!t.index){const i=t.attributes.position.count,s=function(t,e=ArrayBuffer){return t>65535?new Uint32Array(new e(4*t)):new Uint16Array(new e(2*t))}(i,e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer);t.setIndex(new I(s,1));for(let t=0;t<i;t++)s[t]=t}}function Sn(t){const e=An(t),i=t.drawRange,s=i.start/3,n=(i.start+i.count)/3,r=Math.max(0,s),o=Math.min(e,n)-r;return[{offset:Math.floor(r),count:Math.floor(o)}]}function On(t){if(!t.groups||!t.groups.length)return Sn(t);const e=[],i=new Set,s=t.drawRange,n=s.start/3,r=(s.start+s.count)/3;for(const e of t.groups){const t=e.start/3,s=(e.start+e.count)/3;i.add(Math.max(n,t)),i.add(Math.min(r,s))}const o=Array.from(i.values()).sort(((t,e)=>t-e));for(let t=0;t<o.length-1;t++){const i=o[t],s=o[t+1];e.push({offset:Math.floor(i),count:Math.floor(s-i)})}return e}function Pn(t,e,i){return i.min.x=e[t],i.min.y=e[t+1],i.min.z=e[t+2],i.max.x=e[t+3],i.max.y=e[t+4],i.max.z=e[t+5],i}function In(t){let e=-1,i=-1/0;for(let s=0;s<3;s++){const n=t[s+3]-t[s];n>i&&(i=n,e=s)}return e}function Dn(t,e){e.set(t)}function kn(t,e,i){let s,n;for(let r=0;r<3;r++){const o=r+3;s=t[r],n=e[r],i[r]=s<n?s:n,s=t[o],n=e[o],i[o]=s>n?s:n}}function zn(t,e,i){for(let s=0;s<3;s++){const n=e[t+2*s],r=e[t+2*s+1],o=n-r,a=n+r;o<i[s]&&(i[s]=o),a>i[s+3]&&(i[s+3]=a)}}function Mn(t){const e=t[3]-t[0],i=t[4]-t[1],s=t[5]-t[2];return 2*(e*i+i*s+s*e)}function Bn(t,e,i,s,n=null){let r=1/0,o=1/0,a=1/0,h=-1/0,l=-1/0,c=-1/0,u=1/0,d=1/0,p=1/0,f=-1/0,m=-1/0,g=-1/0;const _=null!==n;for(let s=6*e,n=6*(e+i);s<n;s+=6){const e=t[s+0],i=t[s+1],n=e-i,y=e+i;n<r&&(r=n),y>h&&(h=y),_&&e<u&&(u=e),_&&e>f&&(f=e);const w=t[s+2],v=t[s+3],b=w-v,x=w+v;b<o&&(o=b),x>l&&(l=x),_&&w<d&&(d=w),_&&w>m&&(m=w);const E=t[s+4],T=t[s+5],A=E-T,C=E+T;A<a&&(a=A),C>c&&(c=C),_&&E<p&&(p=E),_&&E>g&&(g=E)}s[0]=r,s[1]=o,s[2]=a,s[3]=h,s[4]=l,s[5]=c,_&&(n[0]=u,n[1]=d,n[2]=p,n[3]=f,n[4]=m,n[5]=g)}const Un=32,Rn=(t,e)=>t.candidate-e.candidate,Nn=new Array(Un).fill().map((()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0}))),Ln=new Float32Array(6);class Fn{constructor(){}}function Vn(t,e,i,s,n,r){let o=s,a=s+n-1;const h=r.pos,l=2*r.axis;for(;;){for(;o<=a&&i[6*o+l]<h;)o++;for(;o<=a&&i[6*a+l]>=h;)a--;if(!(o<a))return o;for(let t=0;t<3;t++){let i=e[3*o+t];e[3*o+t]=e[3*a+t],e[3*a+t]=i}for(let t=0;t<6;t++){let e=i[6*o+t];i[6*o+t]=i[6*a+t],i[6*a+t]=e}o++,a--}}function jn(t,e,i,s,n,r){let o=s,a=s+n-1;const h=r.pos,l=2*r.axis;for(;;){for(;o<=a&&i[6*o+l]<h;)o++;for(;o<=a&&i[6*a+l]>=h;)a--;if(!(o<a))return o;{let e=t[o];t[o]=t[a],t[a]=e;for(let t=0;t<6;t++){let e=i[6*o+t];i[6*o+t]=i[6*a+t],i[6*a+t]=e}o++,a--}}}function Yn(t,e){const i=t.geometry,s=i.index?i.index.array:null,n=e.maxDepth,r=e.verbose,o=e.maxLeafTris,a=e.strategy,h=e.onProgress,l=An(i),c=t._indirectBuffer;let u=!1;const d=new Float32Array(6),p=new Float32Array(6),f=function(t,e){var i;(i=e)[0]=i[1]=i[2]=1/0,i[3]=i[4]=i[5]=-1/0;const s=t.attributes.position,n=t.index?t.index.array:null,r=An(t),o=new Float32Array(6*r),a=s.normalized,h=s.array,l=s.offset||0;let c=3;s.isInterleavedBufferAttribute&&(c=s.data.stride);const u=["getX","getY","getZ"];for(let t=0;t<r;t++){const i=3*t,r=6*t;let d=i+0,p=i+1,f=i+2;n&&(d=n[d],p=n[p],f=n[f]),a||(d=d*c+l,p=p*c+l,f=f*c+l);for(let t=0;t<3;t++){let i,n,l;a?(i=s[u[t]](d),n=s[u[t]](p),l=s[u[t]](f)):(i=h[d+t],n=h[p+t],l=h[f+t]);let c=i;n<c&&(c=n),l<c&&(c=l);let m=i;n>m&&(m=n),l>m&&(m=l);const g=(m-c)/2,_=2*t;o[r+_+0]=c+g,o[r+_+1]=g+(Math.abs(c)+g)*En,c<e[t]&&(e[t]=c),m>e[t+3]&&(e[t+3]=m)}}return o}(i,d),m=e.indirect?jn:Vn,g=[],_=e.indirect?Sn(i):On(i);if(1===_.length){const t=_[0],e=new Fn;e.boundingData=d,function(t,e,i,s){let n=1/0,r=1/0,o=1/0,a=-1/0,h=-1/0,l=-1/0;for(let s=6*e,c=6*(e+i);s<c;s+=6){const e=t[s+0];e<n&&(n=e),e>a&&(a=e);const i=t[s+2];i<r&&(r=i),i>h&&(h=i);const c=t[s+4];c<o&&(o=c),c>l&&(l=c)}s[0]=n,s[1]=r,s[2]=o,s[3]=a,s[4]=h,s[5]=l}(f,t.offset,t.count,p),w(e,t.offset,t.count,p),g.push(e)}else for(let t of _){const e=new Fn;e.boundingData=new Float32Array(6),Bn(f,t.offset,t.count,e.boundingData,p),w(e,t.offset,t.count,p),g.push(e)}return g;function y(t){h&&h(t/l)}function w(t,e,h,l=null,d=0){if(!u&&d>=n&&(u=!0,r&&(console.warn(`MeshBVH: Max depth of ${n} reached when generating BVH. Consider increasing maxDepth.`),console.warn(i))),h<=o||d>=n)return y(e+h),t.offset=e,t.count=h,t;const g=function(t,e,i,s,n,r){let o=-1,a=0;if(0===r)o=In(e),-1!==o&&(a=(e[o]+e[o+3])/2);else if(1===r)o=In(t),-1!==o&&(a=function(t,e,i,s){let n=0;for(let r=e,o=e+i;r<o;r++)n+=t[6*r+2*s];return n/i}(i,s,n,o));else if(2===r){const r=Mn(t);let h=bn*n;const l=6*s,c=6*(s+n);for(let t=0;t<3;t++){const s=e[t],u=(e[t+3]-s)/Un;if(n<8){const e=[...Nn];e.length=n;let s=0;for(let n=l;n<c;n+=6,s++){const r=e[s];r.candidate=i[n+2*t],r.count=0;const{bounds:o,leftCacheBounds:a,rightCacheBounds:h}=r;for(let t=0;t<3;t++)h[t]=1/0,h[t+3]=-1/0,a[t]=1/0,a[t+3]=-1/0,o[t]=1/0,o[t+3]=-1/0;zn(n,i,o)}e.sort(Rn);let u=n;for(let t=0;t<u;t++){const i=e[t];for(;t+1<u&&e[t+1].candidate===i.candidate;)e.splice(t+1,1),u--}for(let s=l;s<c;s+=6){const n=i[s+2*t];for(let t=0;t<u;t++){const r=e[t];n>=r.candidate?zn(s,i,r.rightCacheBounds):(zn(s,i,r.leftCacheBounds),r.count++)}}for(let i=0;i<u;i++){const s=e[i],l=s.count,c=n-s.count,u=s.leftCacheBounds,d=s.rightCacheBounds;let p=0;0!==l&&(p=Mn(u)/r);let f=0;0!==c&&(f=Mn(d)/r);const m=1+bn*(p*l+f*c);m<h&&(o=t,h=m,a=s.candidate)}}else{for(let t=0;t<Un;t++){const e=Nn[t];e.count=0,e.candidate=s+u+t*u;const i=e.bounds;for(let t=0;t<3;t++)i[t]=1/0,i[t+3]=-1/0}for(let e=l;e<c;e+=6){let n=~~((i[e+2*t]-s)/u);n>=Un&&(n=31);const r=Nn[n];r.count++,zn(e,i,r.bounds)}const e=Nn[31];Dn(e.bounds,e.rightCacheBounds);for(let t=30;t>=0;t--){const e=Nn[t],i=Nn[t+1];kn(e.bounds,i.rightCacheBounds,e.rightCacheBounds)}let d=0;for(let e=0;e<31;e++){const i=Nn[e],s=i.count,l=i.bounds,c=Nn[e+1].rightCacheBounds;0!==s&&(0===d?Dn(l,Ln):kn(l,Ln,Ln)),d+=s;let u=0,p=0;0!==d&&(u=Mn(Ln)/r);const f=n-d;0!==f&&(p=Mn(c)/r);const m=1+bn*(u*d+p*f);m<h&&(o=t,h=m,a=i.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${r} used.`);return{axis:o,pos:a}}(t.boundingData,l,f,e,h,a);if(-1===g.axis)return y(e+h),t.offset=e,t.count=h,t;const _=m(c,s,f,e,h,g);if(_===e||_===e+h)y(e+h),t.offset=e,t.count=h;else{t.splitAxis=g.axis;const i=new Fn,s=e,n=_-e;t.left=i,i.boundingData=new Float32Array(6),Bn(f,s,n,i.boundingData,p),w(i,s,n,p,d+1);const r=new Fn,o=_,a=h-n;t.right=r,r.boundingData=new Float32Array(6),Bn(f,o,a,r.boundingData,p),w(r,o,a,p,d+1)}return t}}function Zn(t,e){const i=t.geometry;e.indirect&&(t._indirectBuffer=function(t,e){const i=(t.index?t.index.count:t.attributes.position.count)/3,s=i>65536,n=s?4:2,r=e?new SharedArrayBuffer(i*n):new ArrayBuffer(i*n),o=s?new Uint32Array(r):new Uint16Array(r);for(let t=0,e=o.length;t<e;t++)o[t]=t;return o}(i,e.useSharedArrayBuffer),function(t){if(0===t.groups.length)return!1;const e=An(t),i=On(t).sort(((t,e)=>t.offset-e.offset)),s=i[i.length-1];s.count=Math.min(e-s.offset,s.count);let n=0;return i.forEach((({count:t})=>n+=t)),e!==n}(i)&&!e.verbose&&console.warn('MeshBVH: Provided geometry contains groups that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),t._indirectBuffer||Cn(i,e);const s=Yn(t,e);let n,r,o;const a=[],h=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer;for(let t=0;t<s.length;t++){const e=s[t];const i=new h(32*l(e));n=new Float32Array(i),r=new Uint32Array(i),o=new Uint16Array(i),c(0,e),a.push(i)}return void(t._roots=a);function l(t){return t.count?1:1+l(t.left)+l(t.right)}function c(t,e){const i=t/4,s=t/2,a=!!e.count,h=e.boundingData;for(let t=0;t<6;t++)n[i+t]=h[t];if(a){const n=e.offset,a=e.count;return r[i+6]=n,o[s+14]=a,o[s+15]=xn,t+32}{const s=e.left,n=e.right,o=e.splitAxis;let a;if(a=c(t+32,s),a/4>Math.pow(2,32))throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return r[i+6]=a/4,a=c(a,n),r[i+7]=o,a}}}class Hn{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(t,e){let i=1/0,s=-1/0;for(let n=0,r=t.length;n<r;n++){const r=t[n][e];i=r<i?r:i,s=r>s?r:s}this.min=i,this.max=s}setFromPoints(t,e){let i=1/0,s=-1/0;for(let n=0,r=e.length;n<r;n++){const r=e[n],o=t.dot(r);i=o<i?o:i,s=o>s?o:s}this.min=i,this.max=s}isSeparated(t){return this.min>t.max||t.min>this.max}}Hn.prototype.setFromBox=function(){const t=new n;return function(e,i){const s=i.min,n=i.max;let r=1/0,o=-1/0;for(let i=0;i<=1;i++)for(let a=0;a<=1;a++)for(let h=0;h<=1;h++){t.x=s.x*i+n.x*(1-i),t.y=s.y*a+n.y*(1-a),t.z=s.z*h+n.z*(1-h);const l=e.dot(t);r=Math.min(l,r),o=Math.max(l,o)}this.min=r,this.max=o}}();const $n=function(){const t=new n,e=new n,i=new n;return function(s,n,r){const o=s.start,a=t,h=n.start,l=e;i.subVectors(o,h),t.subVectors(s.end,s.start),e.subVectors(n.end,n.start);const c=i.dot(l),u=l.dot(a),d=l.dot(l),p=i.dot(a),f=a.dot(a)*d-u*u;let m,g;m=0!==f?(c*u-p*d)/f:0,g=(c+m*u)/d,r.x=m,r.y=g}}(),Wn=function(){const t=new r,e=new n,i=new n;return function(s,n,r,o){$n(s,n,t);let a=t.x,h=t.y;if(a>=0&&a<=1&&h>=0&&h<=1)return s.at(a,r),void n.at(h,o);if(a>=0&&a<=1)return h<0?n.at(0,o):n.at(1,o),void s.closestPointToPoint(o,!0,r);if(h>=0&&h<=1)return a<0?s.at(0,r):s.at(1,r),void n.closestPointToPoint(r,!0,o);{let t,l;t=a<0?s.start:s.end,l=h<0?n.start:n.end;const c=e,u=i;return s.closestPointToPoint(l,!0,e),n.closestPointToPoint(t,!0,i),c.distanceToSquared(l)<=u.distanceToSquared(t)?(r.copy(c),void o.copy(l)):(r.copy(t),void o.copy(u))}}}(),qn=function(){const t=new n,e=new n,i=new o,s=new a;return function(n,r){const{radius:o,center:a}=n,{a:h,b:l,c:c}=r;s.start=h,s.end=l;if(s.closestPointToPoint(a,!0,t).distanceTo(a)<=o)return!0;s.start=h,s.end=c;if(s.closestPointToPoint(a,!0,t).distanceTo(a)<=o)return!0;s.start=l,s.end=c;if(s.closestPointToPoint(a,!0,t).distanceTo(a)<=o)return!0;const u=r.getPlane(i);if(Math.abs(u.distanceToPoint(a))<=o){const t=u.projectPoint(a,e);if(r.containsPoint(t))return!0}return!1}}();function Xn(t){return Math.abs(t)<1e-15}class Gn extends f{constructor(...t){super(...t),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map((()=>new n)),this.satBounds=new Array(4).fill().map((()=>new Hn)),this.points=[this.a,this.b,this.c],this.sphere=new m,this.plane=new o,this.needsUpdate=!0}intersectsSphere(t){return qn(t,this)}update(){const t=this.a,e=this.b,i=this.c,s=this.points,n=this.satAxes,r=this.satBounds,o=n[0],a=r[0];this.getNormal(o),a.setFromPoints(o,s);const h=n[1],l=r[1];h.subVectors(t,e),l.setFromPoints(h,s);const c=n[2],u=r[2];c.subVectors(e,i),u.setFromPoints(c,s);const d=n[3],p=r[3];d.subVectors(i,t),p.setFromPoints(d,s),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(o,t),this.needsUpdate=!1}}Gn.prototype.closestPointToSegment=function(){const t=new n,e=new n,i=new a;return function(s,n=null,r=null){const{start:o,end:a}=s,h=this.points;let l,c=1/0;for(let o=0;o<3;o++){const a=(o+1)%3;i.start.copy(h[o]),i.end.copy(h[a]),Wn(i,s,t,e),l=t.distanceToSquared(e),l<c&&(c=l,n&&n.copy(t),r&&r.copy(e))}return this.closestPointToPoint(o,t),l=o.distanceToSquared(t),l<c&&(c=l,n&&n.copy(t),r&&r.copy(o)),this.closestPointToPoint(a,t),l=a.distanceToSquared(t),l<c&&(c=l,n&&n.copy(t),r&&r.copy(a)),Math.sqrt(c)}}(),Gn.prototype.intersectsTriangle=function(){const t=new Gn,e=new Array(3),i=new Array(3),s=new Hn,r=new Hn,o=new n,h=new n,l=new n,c=new n,u=new n,d=new a,p=new a,f=new a,m=new n;function g(t,e,i){const s=t.points;let n=0,r=-1;for(let t=0;t<3;t++){const{start:o,end:a}=d;o.copy(s[t]),a.copy(s[(t+1)%3]),d.delta(h);const l=Xn(e.distanceToPoint(o));if(Xn(e.normal.dot(h))&&l){i.copy(d),n=2;break}const c=e.intersectLine(d,m);if(!c&&l&&m.copy(o),(c||l)&&!Xn(m.distanceTo(a))){if(n<=1){(1===n?i.start:i.end).copy(m),l&&(r=n)}else if(n>=2){(1===r?i.start:i.end).copy(m),n=2;break}if(n++,2===n&&-1===r)break}}return n}return function(n,a=null,h=!1){this.needsUpdate&&this.update(),n.isExtendedTriangle?n.needsUpdate&&n.update():(t.copy(n),t.update(),n=t);const d=this.plane,m=n.plane;if(Math.abs(d.normal.dot(m.normal))>1-1e-10){const t=this.satBounds,l=this.satAxes;i[0]=n.a,i[1]=n.b,i[2]=n.c;for(let e=0;e<4;e++){const n=t[e],r=l[e];if(s.setFromPoints(r,i),n.isSeparated(s))return!1}const c=n.satBounds,u=n.satAxes;e[0]=this.a,e[1]=this.b,e[2]=this.c;for(let t=0;t<4;t++){const i=c[t],n=u[t];if(s.setFromPoints(n,e),i.isSeparated(s))return!1}for(let t=0;t<4;t++){const n=l[t];for(let t=0;t<4;t++){const a=u[t];if(o.crossVectors(n,a),s.setFromPoints(o,e),r.setFromPoints(o,i),s.isSeparated(r))return!1}}return a&&(h||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),a.start.set(0,0,0),a.end.set(0,0,0)),!0}{const t=g(this,m,p);if(1===t&&n.containsPoint(p.end))return a&&(a.start.copy(p.end),a.end.copy(p.end)),!0;if(2!==t)return!1;const e=g(n,d,f);if(1===e&&this.containsPoint(f.end))return a&&(a.start.copy(f.end),a.end.copy(f.end)),!0;if(2!==e)return!1;if(p.delta(l),f.delta(c),l.dot(c)<0){let t=f.start;f.start=f.end,f.end=t}const i=p.start.dot(l),s=p.end.dot(l),r=f.start.dot(l),o=f.end.dot(l);return(i===o||r===s||s<r!==i<o)&&(a&&(u.subVectors(p.start,f.start),u.dot(l)>0?a.start.copy(p.start):a.start.copy(f.start),u.subVectors(p.end,f.end),u.dot(l)<0?a.end.copy(p.end):a.end.copy(f.end)),!0)}}}(),Gn.prototype.distanceToPoint=function(){const t=new n;return function(e){return this.closestPointToPoint(e,t),e.distanceTo(t)}}(),Gn.prototype.distanceToTriangle=function(){const t=new n,e=new n,i=["a","b","c"],s=new a,r=new a;return function(n,o=null,a=null){const h=o||a?s:null;if(this.intersectsTriangle(n,h))return(o||a)&&(o&&h.getCenter(o),a&&h.getCenter(a)),0;let l=1/0;for(let e=0;e<3;e++){let s;const r=i[e],h=n[r];this.closestPointToPoint(h,t),s=h.distanceToSquared(t),s<l&&(l=s,o&&o.copy(t),a&&a.copy(h));const c=this[r];n.closestPointToPoint(c,t),s=c.distanceToSquared(t),s<l&&(l=s,o&&o.copy(c),a&&a.copy(t))}for(let h=0;h<3;h++){const c=i[h],u=i[(h+1)%3];s.set(this[c],this[u]);for(let h=0;h<3;h++){const c=i[h],u=i[(h+1)%3];r.set(n[c],n[u]),Wn(s,r,t,e);const d=t.distanceToSquared(e);d<l&&(l=d,o&&o.copy(t),a&&a.copy(e))}}return Math.sqrt(l)}}();class Qn{constructor(t,e,i){this.isOrientedBox=!0,this.min=new n,this.max=new n,this.matrix=new p,this.invMatrix=new p,this.points=new Array(8).fill().map((()=>new n)),this.satAxes=new Array(3).fill().map((()=>new n)),this.satBounds=new Array(3).fill().map((()=>new Hn)),this.alignedSatBounds=new Array(3).fill().map((()=>new Hn)),this.needsUpdate=!1,t&&this.min.copy(t),e&&this.max.copy(e),i&&this.matrix.copy(i)}set(t,e,i){this.min.copy(t),this.max.copy(e),this.matrix.copy(i),this.needsUpdate=!0}copy(t){this.min.copy(t.min),this.max.copy(t.max),this.matrix.copy(t.matrix),this.needsUpdate=!0}}Qn.prototype.update=function(){return function(){const t=this.matrix,e=this.min,i=this.max,s=this.points;for(let n=0;n<=1;n++)for(let r=0;r<=1;r++)for(let o=0;o<=1;o++){const a=s[1*n|2*r|4*o];a.x=n?i.x:e.x,a.y=r?i.y:e.y,a.z=o?i.z:e.z,a.applyMatrix4(t)}const n=this.satBounds,r=this.satAxes,o=s[0];for(let t=0;t<3;t++){const e=r[t],i=n[t],a=s[1<<t];e.subVectors(o,a),i.setFromPoints(e,s)}const a=this.alignedSatBounds;a[0].setFromPointsField(s,"x"),a[1].setFromPointsField(s,"y"),a[2].setFromPointsField(s,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}}(),Qn.prototype.intersectsBox=function(){const t=new Hn;return function(e){this.needsUpdate&&this.update();const i=e.min,s=e.max,n=this.satBounds,r=this.satAxes,o=this.alignedSatBounds;if(t.min=i.x,t.max=s.x,o[0].isSeparated(t))return!1;if(t.min=i.y,t.max=s.y,o[1].isSeparated(t))return!1;if(t.min=i.z,t.max=s.z,o[2].isSeparated(t))return!1;for(let i=0;i<3;i++){const s=r[i],o=n[i];if(t.setFromBox(s,e),o.isSeparated(t))return!1}return!0}}(),Qn.prototype.intersectsTriangle=function(){const t=new Gn,e=new Array(3),i=new Hn,s=new Hn,r=new n;return function(n){this.needsUpdate&&this.update(),n.isExtendedTriangle?n.needsUpdate&&n.update():(t.copy(n),t.update(),n=t);const o=this.satBounds,a=this.satAxes;e[0]=n.a,e[1]=n.b,e[2]=n.c;for(let t=0;t<3;t++){const s=o[t],n=a[t];if(i.setFromPoints(n,e),s.isSeparated(i))return!1}const h=n.satBounds,l=n.satAxes,c=this.points;for(let t=0;t<3;t++){const e=h[t],s=l[t];if(i.setFromPoints(s,c),e.isSeparated(i))return!1}for(let t=0;t<3;t++){const n=a[t];for(let t=0;t<4;t++){const o=l[t];if(r.crossVectors(n,o),i.setFromPoints(r,e),s.setFromPoints(r,c),i.isSeparated(s))return!1}}return!0}}(),Qn.prototype.closestPointToPoint=function(){return function(t,e){return this.needsUpdate&&this.update(),e.copy(t).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),e}}(),Qn.prototype.distanceToPoint=function(){const t=new n;return function(e){return this.closestPointToPoint(e,t),e.distanceTo(t)}}(),Qn.prototype.distanceToBox=function(){const t=["x","y","z"],e=new Array(12).fill().map((()=>new a)),i=new Array(12).fill().map((()=>new a)),s=new n,r=new n;return function(n,o=0,a=null,h=null){if(this.needsUpdate&&this.update(),this.intersectsBox(n))return(a||h)&&(n.getCenter(r),this.closestPointToPoint(r,s),n.closestPointToPoint(s,r),a&&a.copy(s),h&&h.copy(r)),0;const l=o*o,c=n.min,u=n.max,d=this.points;let p=1/0;for(let t=0;t<8;t++){const e=d[t];r.copy(e).clamp(c,u);const i=e.distanceToSquared(r);if(i<p&&(p=i,a&&a.copy(e),h&&h.copy(r),i<l))return Math.sqrt(i)}let f=0;for(let s=0;s<3;s++)for(let n=0;n<=1;n++)for(let r=0;r<=1;r++){const o=(s+1)%3,a=(s+2)%3,h=1<<s|n<<o|r<<a,l=d[n<<o|r<<a],p=d[h];e[f].set(l,p);const m=t[s],g=t[o],_=t[a],y=i[f],w=y.start,v=y.end;w[m]=c[m],w[g]=n?c[g]:u[g],w[_]=r?c[_]:u[g],v[m]=u[m],v[g]=n?c[g]:u[g],v[_]=r?c[_]:u[g],f++}for(let t=0;t<=1;t++)for(let e=0;e<=1;e++)for(let i=0;i<=1;i++){r.x=t?u.x:c.x,r.y=e?u.y:c.y,r.z=i?u.z:c.z,this.closestPointToPoint(r,s);const n=r.distanceToSquared(s);if(n<p&&(p=n,a&&a.copy(s),h&&h.copy(r),n<l))return Math.sqrt(n)}for(let t=0;t<12;t++){const n=e[t];for(let t=0;t<12;t++){const e=i[t];Wn(n,e,s,r);const o=s.distanceToSquared(r);if(o<p&&(p=o,a&&a.copy(s),h&&h.copy(r),o<l))return Math.sqrt(o)}}return Math.sqrt(p)}}();class Kn{constructor(t){this._getNewPrimitive=t,this._primitives=[]}getPrimitive(){const t=this._primitives;return 0===t.length?this._getNewPrimitive():t.pop()}releasePrimitive(t){this._primitives.push(t)}}class Jn extends Kn{constructor(){super((()=>new Gn))}}const tr=new Jn;function er(t,e){return 65535===e[t+15]}function ir(t,e){return e[t+6]}function sr(t,e){return e[t+14]}function nr(t){return t+8}function rr(t,e){return e[t+6]}function or(t,e){return e[t+7]}const ar=new class{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const t=[];let e=null;this.setBuffer=i=>{e&&t.push(e),e=i,this.float32Array=new Float32Array(i),this.uint16Array=new Uint16Array(i),this.uint32Array=new Uint32Array(i)},this.clearBuffer=()=>{e=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,0!==t.length&&this.setBuffer(t.pop())}}};let hr,lr;const cr=[],ur=new Kn((()=>new h));function dr(t,e,i,s,n,r){hr=ur.getPrimitive(),lr=ur.getPrimitive(),cr.push(hr,lr),ar.setBuffer(t._roots[e]);const o=pr(0,t.geometry,i,s,n,r);ar.clearBuffer(),ur.releasePrimitive(hr),ur.releasePrimitive(lr),cr.pop(),cr.pop();const a=cr.length;return a>0&&(lr=cr[a-1],hr=cr[a-2]),o}function pr(t,e,i,s,n=null,r=0,o=0){const{float32Array:a,uint16Array:h,uint32Array:l}=ar;let c=2*t;if(er(c,h)){const e=ir(t,l),i=sr(c,h);return Pn(t,a,hr),s(e,i,!1,o,r+t,hr)}{let c=function(t){const{uint16Array:e,uint32Array:i}=ar;let s=2*t;for(;!er(s,e);)s=2*(t=nr(t));return ir(t,i)},u=function(t){const{uint16Array:e,uint32Array:i}=ar;let s=2*t;for(;!er(s,e);)s=2*(t=rr(t,i));return ir(t,i)+sr(s,e)};const d=nr(t),p=rr(t,l);let f,m,g,_,y=d,w=p;if(n&&(g=hr,_=lr,Pn(y,a,g),Pn(w,a,_),f=n(g),m=n(_),m<f)){y=p,w=d;const t=f;f=m,m=t,g=_}g||(g=hr,Pn(y,a,g));const v=i(g,er(2*y,h),f,o+1,r+y);let b;if(2===v){const t=c(y);b=s(t,u(y)-t,!0,o+1,r+y,g)}else b=v&&pr(y,e,i,s,n,r,o+1);if(b)return!0;_=lr,Pn(w,a,_);const x=i(_,er(2*w,h),m,o+1,r+w);let E;if(2===x){const t=c(w);E=s(t,u(w)-t,!0,o+1,r+w,_)}else E=x&&pr(w,e,i,s,n,r,o+1);return!!E}}const fr=new n,mr=new n;const gr=new n,_r=new n,yr=new n,wr=new r,vr=new r,br=new r,xr=new n,Er=new n,Tr=new n,Ar=new n;function Cr(t,e,i,s,o,a,h,l,c){gr.fromBufferAttribute(e,a),_r.fromBufferAttribute(e,h),yr.fromBufferAttribute(e,l);const u=function(t,e,i,s,n,r){let o;return o=r===z?t.intersectTriangle(s,i,e,!0,n):t.intersectTriangle(e,i,s,r!==P,n),null===o?null:{distance:t.origin.distanceTo(n),point:n.clone()}}(t,gr,_r,yr,Ar,c);if(u){s&&(wr.fromBufferAttribute(s,a),vr.fromBufferAttribute(s,h),br.fromBufferAttribute(s,l),u.uv=f.getInterpolation(Ar,gr,_r,yr,wr,vr,br,new r)),o&&(wr.fromBufferAttribute(o,a),vr.fromBufferAttribute(o,h),br.fromBufferAttribute(o,l),u.uv1=f.getInterpolation(Ar,gr,_r,yr,wr,vr,br,new r)),i&&(xr.fromBufferAttribute(i,a),Er.fromBufferAttribute(i,h),Tr.fromBufferAttribute(i,l),u.normal=f.getInterpolation(Ar,gr,_r,yr,xr,Er,Tr,new n),u.normal.dot(t.direction)>0&&u.normal.multiplyScalar(-1));const e={a:a,b:h,c:l,normal:new n,materialIndex:0};f.getNormal(gr,_r,yr,e.normal),u.face=e,u.faceIndex=a}return u}function Sr(t,e,i,s,n){const r=3*s;let o=r+0,a=r+1,h=r+2;const l=t.index;t.index&&(o=l.getX(o),a=l.getX(a),h=l.getX(h));const{position:c,normal:u,uv:d,uv1:p}=t.attributes,f=Cr(i,c,u,d,p,o,a,h,e);return f?(f.faceIndex=s,n&&n.push(f),f):null}function Or(t,e,i,s){const n=t.a,r=t.b,o=t.c;let a=e,h=e+1,l=e+2;i&&(a=i.getX(a),h=i.getX(h),l=i.getX(l)),n.x=s.getX(a),n.y=s.getY(a),n.z=s.getZ(a),r.x=s.getX(h),r.y=s.getY(h),r.z=s.getZ(h),o.x=s.getX(l),o.y=s.getY(l),o.z=s.getZ(l)}function Pr(t,e,i,s,n,r,o){const{geometry:a}=i,{index:h}=a,l=a.attributes.position;for(let i=t,a=e+t;i<a;i++){let t;if(t=i,Or(o,3*t,h,l),o.needsUpdate=!0,s(o,t,n,r))return!0}return!1}function Ir(t,e=null){e&&Array.isArray(e)&&(e=new Set(e));const i=t.geometry,s=i.index?i.index.array:null,n=i.attributes.position;let r,o,a,h,l=0;const c=t._roots;for(let t=0,e=c.length;t<e;t++)r=c[t],o=new Uint32Array(r),a=new Uint16Array(r),h=new Float32Array(r),u(0,l),l+=r.byteLength;function u(t,i,r=!1){const l=2*t;if(a[l+15]===xn){const e=o[t+6];let i=1/0,r=1/0,c=1/0,u=-1/0,d=-1/0,p=-1/0;for(let t=3*e,o=3*(e+a[l+14]);t<o;t++){let e=s[t];const o=n.getX(e),a=n.getY(e),h=n.getZ(e);o<i&&(i=o),o>u&&(u=o),a<r&&(r=a),a>d&&(d=a),h<c&&(c=h),h>p&&(p=h)}return(h[t+0]!==i||h[t+1]!==r||h[t+2]!==c||h[t+3]!==u||h[t+4]!==d||h[t+5]!==p)&&(h[t+0]=i,h[t+1]=r,h[t+2]=c,h[t+3]=u,h[t+4]=d,h[t+5]=p,!0)}{const s=t+8,n=o[t+6],a=s+i,l=n+i;let c=r,d=!1,p=!1;e?c||(d=e.has(a),p=e.has(l),c=!d&&!p):(d=!0,p=!0);const f=c||p;let m=!1;(c||d)&&(m=u(s,i,c));let g=!1;f&&(g=u(n,i,c));const _=m||g;if(_)for(let e=0;e<3;e++){const i=s+e,r=n+e,o=h[i],a=h[i+3],l=h[r],c=h[r+3];h[t+e]=o<l?o:l,h[t+e+3]=a>c?a:c}return _}}}const Dr=new h;function kr(t,e,i,s){return Pn(t,e,Dr),i.intersectBox(Dr,s)}function zr(t,e,i,s,n,r,o){const{geometry:a}=i,{index:h}=a,l=a.attributes.position;for(let a=t,c=e+t;a<c;a++){let t;if(t=i.resolveTriangleIndex(a),Or(o,3*t,h,l),o.needsUpdate=!0,s(o,t,n,r))return!0}return!1}const Mr=new n;function Br(t,e,i,s,n){ar.setBuffer(t._roots[e]),Ur(0,t,i,s,n),ar.clearBuffer()}function Ur(t,e,i,s,n){const{float32Array:r,uint16Array:o,uint32Array:a}=ar,h=2*t;if(er(h,o)){!function(t,e,i,s,n,r){const{geometry:o,_indirectBuffer:a}=t;for(let t=s,a=s+n;t<a;t++)Sr(o,e,i,t,r)}(e,i,s,ir(t,a),sr(h,o),n)}else{const o=nr(t);kr(o,r,s,Mr)&&Ur(o,e,i,s,n);const h=rr(t,a);kr(h,r,s,Mr)&&Ur(h,e,i,s,n)}}const Rr=new n,Nr=["x","y","z"];function Lr(t,e,i,s){ar.setBuffer(t._roots[e]);const n=Fr(0,t,i,s);return ar.clearBuffer(),n}function Fr(t,e,i,s){const{float32Array:n,uint16Array:r,uint32Array:o}=ar;let a=2*t;if(er(a,r)){return function(t,e,i,s,n){const{geometry:r,_indirectBuffer:o}=t;let a=1/0,h=null;for(let t=s,o=s+n;t<o;t++){let s;s=Sr(r,e,i,t),s&&s.distance<a&&(h=s,a=s.distance)}return h}(e,i,s,ir(t,o),sr(a,r))}{const r=or(t,o),a=Nr[r],h=s.direction[a]>=0;let l,c;h?(l=nr(t),c=rr(t,o)):(l=rr(t,o),c=nr(t));const u=kr(l,n,s,Rr)?Fr(l,e,i,s):null;if(u){const t=u.point[a];if(h?t<=n[c+r]:t>=n[c+r+3])return u}const d=kr(c,n,s,Rr)?Fr(c,e,i,s):null;return u&&d?u.distance<=d.distance?u:d:u||d||null}}const Vr=new h,jr=new Gn,Yr=new Gn,Zr=new p,Hr=new Qn,$r=new Qn;function Wr(t,e,i,s){ar.setBuffer(t._roots[e]);const n=qr(0,t,i,s);return ar.clearBuffer(),n}function qr(t,e,i,s,n=null){const{float32Array:r,uint16Array:o,uint32Array:a}=ar;let h=2*t;null===n&&(i.boundingBox||i.computeBoundingBox(),Hr.set(i.boundingBox.min,i.boundingBox.max,s),n=Hr);if(!er(h,o)){const o=t+8,h=a[t+6];Pn(o,r,Vr);if(n.intersectsBox(Vr)&&qr(o,e,i,s,n))return!0;Pn(h,r,Vr);return!!(n.intersectsBox(Vr)&&qr(h,e,i,s,n))}{const n=e.geometry,l=n.index,c=n.attributes.position,u=i.index,d=i.attributes.position,p=ir(t,a),f=sr(h,o);if(Zr.copy(s).invert(),i.boundsTree){Pn(t,r,$r),$r.matrix.copy(Zr),$r.needsUpdate=!0;return i.boundsTree.shapecast({intersectsBounds:t=>$r.intersectsBox(t),intersectsTriangle:t=>{t.a.applyMatrix4(s),t.b.applyMatrix4(s),t.c.applyMatrix4(s),t.needsUpdate=!0;for(let e=3*p,i=3*(f+p);e<i;e+=3)if(Or(Yr,e,l,c),Yr.needsUpdate=!0,t.intersectsTriangle(Yr))return!0;return!1}})}for(let t=3*p,e=3*(f+p);t<e;t+=3){Or(jr,t,l,c),jr.a.applyMatrix4(Zr),jr.b.applyMatrix4(Zr),jr.c.applyMatrix4(Zr),jr.needsUpdate=!0;for(let t=0,e=u.count;t<e;t+=3)if(Or(Yr,t,u,d),Yr.needsUpdate=!0,jr.intersectsTriangle(Yr))return!0}}}const Xr=new p,Gr=new Qn,Qr=new Qn,Kr=new n,Jr=new n,to=new n,eo=new n;function io(t,e,i,s={},n={},r=0,o=1/0){e.boundingBox||e.computeBoundingBox(),Gr.set(e.boundingBox.min,e.boundingBox.max,i),Gr.needsUpdate=!0;const a=t.geometry,h=a.attributes.position,l=a.index,c=e.attributes.position,u=e.index,d=tr.getPrimitive(),p=tr.getPrimitive();let f=Kr,m=Jr,g=null,_=null;n&&(g=to,_=eo);let y=1/0,w=null,v=null;return Xr.copy(i).invert(),Qr.matrix.copy(Xr),t.shapecast({boundsTraverseOrder:t=>Gr.distanceToBox(t),intersectsBounds:(t,e,i)=>i<y&&i<o&&(e&&(Qr.min.copy(t.min),Qr.max.copy(t.max),Qr.needsUpdate=!0),!0),intersectsRange:(t,s)=>{if(e.boundsTree){return e.boundsTree.shapecast({boundsTraverseOrder:t=>Qr.distanceToBox(t),intersectsBounds:(t,e,i)=>i<y&&i<o,intersectsRange:(e,n)=>{for(let o=e,a=e+n;o<a;o++){Or(p,3*o,u,c),p.a.applyMatrix4(i),p.b.applyMatrix4(i),p.c.applyMatrix4(i),p.needsUpdate=!0;for(let e=t,i=t+s;e<i;e++){Or(d,3*e,l,h),d.needsUpdate=!0;const t=d.distanceToTriangle(p,f,g);if(t<y&&(m.copy(f),_&&_.copy(g),y=t,w=e,v=o),t<r)return!0}}}})}for(let n=0,o=An(e);n<o;n++){Or(p,3*n,u,c),p.a.applyMatrix4(i),p.b.applyMatrix4(i),p.c.applyMatrix4(i),p.needsUpdate=!0;for(let e=t,i=t+s;e<i;e++){Or(d,3*e,l,h),d.needsUpdate=!0;const t=d.distanceToTriangle(p,f,g);if(t<y&&(m.copy(f),_&&_.copy(g),y=t,w=e,v=n),t<r)return!0}}}}),tr.releasePrimitive(d),tr.releasePrimitive(p),y===1/0?null:(s.point?s.point.copy(m):s.point=m.clone(),s.distance=y,s.faceIndex=w,n&&(n.point?n.point.copy(_):n.point=_.clone(),n.point.applyMatrix4(Xr),m.applyMatrix4(Xr),n.distance=m.sub(n.point).length(),n.faceIndex=v),s)}function so(t,e=null){e&&Array.isArray(e)&&(e=new Set(e));const i=t.geometry,s=i.index?i.index.array:null,n=i.attributes.position;let r,o,a,h,l=0;const c=t._roots;for(let t=0,e=c.length;t<e;t++)r=c[t],o=new Uint32Array(r),a=new Uint16Array(r),h=new Float32Array(r),u(0,l),l+=r.byteLength;function u(i,r,l=!1){const c=2*i;if(a[c+15]===xn){const e=o[i+6];let r=1/0,l=1/0,u=1/0,d=-1/0,p=-1/0,f=-1/0;for(let i=e,o=e+a[c+14];i<o;i++){const e=3*t.resolveTriangleIndex(i);for(let t=0;t<3;t++){let i=e+t;i=s?s[i]:i;const o=n.getX(i),a=n.getY(i),h=n.getZ(i);o<r&&(r=o),o>d&&(d=o),a<l&&(l=a),a>p&&(p=a),h<u&&(u=h),h>f&&(f=h)}}return(h[i+0]!==r||h[i+1]!==l||h[i+2]!==u||h[i+3]!==d||h[i+4]!==p||h[i+5]!==f)&&(h[i+0]=r,h[i+1]=l,h[i+2]=u,h[i+3]=d,h[i+4]=p,h[i+5]=f,!0)}{const t=i+8,s=o[i+6],n=t+r,a=s+r;let c=l,d=!1,p=!1;e?c||(d=e.has(n),p=e.has(a),c=!d&&!p):(d=!0,p=!0);const f=c||p;let m=!1;(c||d)&&(m=u(t,r,c));let g=!1;f&&(g=u(s,r,c));const _=m||g;if(_)for(let e=0;e<3;e++){const n=t+e,r=s+e,o=h[n],a=h[n+3],l=h[r],c=h[r+3];h[i+e]=o<l?o:l,h[i+e+3]=a>c?a:c}return _}}}const no=new n;function ro(t,e,i,s,n){ar.setBuffer(t._roots[e]),oo(0,t,i,s,n),ar.clearBuffer()}function oo(t,e,i,s,n){const{float32Array:r,uint16Array:o,uint32Array:a}=ar,h=2*t;if(er(h,o)){!function(t,e,i,s,n,r){const{geometry:o,_indirectBuffer:a}=t;for(let t=s,h=s+n;t<h;t++)Sr(o,e,i,a?a[t]:t,r)}(e,i,s,ir(t,a),sr(h,o),n)}else{const o=nr(t);kr(o,r,s,no)&&oo(o,e,i,s,n);const h=rr(t,a);kr(h,r,s,no)&&oo(h,e,i,s,n)}}const ao=new n,ho=["x","y","z"];function lo(t,e,i,s){ar.setBuffer(t._roots[e]);const n=co(0,t,i,s);return ar.clearBuffer(),n}function co(t,e,i,s){const{float32Array:n,uint16Array:r,uint32Array:o}=ar;let a=2*t;if(er(a,r)){return function(t,e,i,s,n){const{geometry:r,_indirectBuffer:o}=t;let a=1/0,h=null;for(let t=s,l=s+n;t<l;t++){let s;s=Sr(r,e,i,o?o[t]:t),s&&s.distance<a&&(h=s,a=s.distance)}return h}(e,i,s,ir(t,o),sr(a,r))}{const r=or(t,o),a=ho[r],h=s.direction[a]>=0;let l,c;h?(l=nr(t),c=rr(t,o)):(l=rr(t,o),c=nr(t));const u=kr(l,n,s,ao)?co(l,e,i,s):null;if(u){const t=u.point[a];if(h?t<=n[c+r]:t>=n[c+r+3])return u}const d=kr(c,n,s,ao)?co(c,e,i,s):null;return u&&d?u.distance<=d.distance?u:d:u||d||null}}const uo=new h,po=new Gn,fo=new Gn,mo=new p,go=new Qn,_o=new Qn;function yo(t,e,i,s){ar.setBuffer(t._roots[e]);const n=wo(0,t,i,s);return ar.clearBuffer(),n}function wo(t,e,i,s,n=null){const{float32Array:r,uint16Array:o,uint32Array:a}=ar;let h=2*t;null===n&&(i.boundingBox||i.computeBoundingBox(),go.set(i.boundingBox.min,i.boundingBox.max,s),n=go);if(!er(h,o)){const o=t+8,h=a[t+6];Pn(o,r,uo);if(n.intersectsBox(uo)&&wo(o,e,i,s,n))return!0;Pn(h,r,uo);return!!(n.intersectsBox(uo)&&wo(h,e,i,s,n))}{const n=e.geometry,l=n.index,c=n.attributes.position,u=i.index,d=i.attributes.position,p=ir(t,a),f=sr(h,o);if(mo.copy(s).invert(),i.boundsTree){Pn(t,r,_o),_o.matrix.copy(mo),_o.needsUpdate=!0;return i.boundsTree.shapecast({intersectsBounds:t=>_o.intersectsBox(t),intersectsTriangle:t=>{t.a.applyMatrix4(s),t.b.applyMatrix4(s),t.c.applyMatrix4(s),t.needsUpdate=!0;for(let i=p,s=f+p;i<s;i++)if(Or(fo,3*e.resolveTriangleIndex(i),l,c),fo.needsUpdate=!0,t.intersectsTriangle(fo))return!0;return!1}})}for(let t=p,i=f+p;t<i;t++){const i=e.resolveTriangleIndex(t);Or(po,3*i,l,c),po.a.applyMatrix4(mo),po.b.applyMatrix4(mo),po.c.applyMatrix4(mo),po.needsUpdate=!0;for(let t=0,e=u.count;t<e;t+=3)if(Or(fo,t,u,d),fo.needsUpdate=!0,po.intersectsTriangle(fo))return!0}}}const vo=new p,bo=new Qn,xo=new Qn,Eo=new n,To=new n,Ao=new n,Co=new n;function So(t,e,i,s={},n={},r=0,o=1/0){e.boundingBox||e.computeBoundingBox(),bo.set(e.boundingBox.min,e.boundingBox.max,i),bo.needsUpdate=!0;const a=t.geometry,h=a.attributes.position,l=a.index,c=e.attributes.position,u=e.index,d=tr.getPrimitive(),p=tr.getPrimitive();let f=Eo,m=To,g=null,_=null;n&&(g=Ao,_=Co);let y=1/0,w=null,v=null;return vo.copy(i).invert(),xo.matrix.copy(vo),t.shapecast({boundsTraverseOrder:t=>bo.distanceToBox(t),intersectsBounds:(t,e,i)=>i<y&&i<o&&(e&&(xo.min.copy(t.min),xo.max.copy(t.max),xo.needsUpdate=!0),!0),intersectsRange:(s,n)=>{if(e.boundsTree){const a=e.boundsTree;return a.shapecast({boundsTraverseOrder:t=>xo.distanceToBox(t),intersectsBounds:(t,e,i)=>i<y&&i<o,intersectsRange:(e,o)=>{for(let b=e,x=e+o;b<x;b++){const e=a.resolveTriangleIndex(b);Or(p,3*e,u,c),p.a.applyMatrix4(i),p.b.applyMatrix4(i),p.c.applyMatrix4(i),p.needsUpdate=!0;for(let e=s,i=s+n;e<i;e++){const i=t.resolveTriangleIndex(e);Or(d,3*i,l,h),d.needsUpdate=!0;const s=d.distanceToTriangle(p,f,g);if(s<y&&(m.copy(f),_&&_.copy(g),y=s,w=e,v=b),s<r)return!0}}}})}for(let o=0,a=An(e);o<a;o++){Or(p,3*o,u,c),p.a.applyMatrix4(i),p.b.applyMatrix4(i),p.c.applyMatrix4(i),p.needsUpdate=!0;for(let e=s,i=s+n;e<i;e++){const i=t.resolveTriangleIndex(e);Or(d,3*i,l,h),d.needsUpdate=!0;const s=d.distanceToTriangle(p,f,g);if(s<y&&(m.copy(f),_&&_.copy(g),y=s,w=e,v=o),s<r)return!0}}}}),tr.releasePrimitive(d),tr.releasePrimitive(p),y===1/0?null:(s.point?s.point.copy(m):s.point=m.clone(),s.distance=y,s.faceIndex=w,n&&(n.point?n.point.copy(_):n.point=_.clone(),n.point.applyMatrix4(vo),m.applyMatrix4(vo),n.distance=m.sub(n.point).length(),n.faceIndex=v),s)}const Oo=new ar.constructor,Po=new ar.constructor,Io=new Kn((()=>new h)),Do=new h,ko=new h,zo=new h,Mo=new h;let Bo=!1;function Uo(t,e,i,s,n,r=0,o=0,a=0,h=0,l=null,c=!1){let u,d;c?(u=Po,d=Oo):(u=Oo,d=Po);const p=u.float32Array,f=u.uint32Array,m=u.uint16Array,g=d.float32Array,_=d.uint32Array,y=d.uint16Array,w=2*e,v=er(2*t,m),b=er(w,y);let x=!1;if(b&&v)x=c?n(ir(e,_),sr(2*e,y),ir(t,f),sr(2*t,m),h,o+e,a,r+t):n(ir(t,f),sr(2*t,m),ir(e,_),sr(2*e,y),a,r+t,h,o+e);else if(b){const l=Io.getPrimitive();Pn(e,g,l),l.applyMatrix4(i);const u=nr(t),d=rr(t,f);Pn(u,p,Do),Pn(d,p,ko);const m=l.intersectsBox(Do),_=l.intersectsBox(ko);x=m&&Uo(e,u,s,i,n,o,r,h,a+1,l,!c)||_&&Uo(e,d,s,i,n,o,r,h,a+1,l,!c),Io.releasePrimitive(l)}else{const u=nr(e),d=rr(e,_);Pn(u,g,zo),Pn(d,g,Mo);const m=l.intersectsBox(zo),y=l.intersectsBox(Mo);if(m&&y)x=Uo(t,u,i,s,n,r,o,a,h+1,l,c)||Uo(t,d,i,s,n,r,o,a,h+1,l,c);else if(m)if(v)x=Uo(t,u,i,s,n,r,o,a,h+1,l,c);else{const e=Io.getPrimitive();e.copy(zo).applyMatrix4(i);const l=nr(t),d=rr(t,f);Pn(l,p,Do),Pn(d,p,ko);const m=e.intersectsBox(Do),g=e.intersectsBox(ko);x=m&&Uo(u,l,s,i,n,o,r,h,a+1,e,!c)||g&&Uo(u,d,s,i,n,o,r,h,a+1,e,!c),Io.releasePrimitive(e)}else if(y)if(v)x=Uo(t,d,i,s,n,r,o,a,h+1,l,c);else{const e=Io.getPrimitive();e.copy(Mo).applyMatrix4(i);const l=nr(t),u=rr(t,f);Pn(l,p,Do),Pn(u,p,ko);const m=e.intersectsBox(Do),g=e.intersectsBox(ko);x=m&&Uo(d,l,s,i,n,o,r,h,a+1,e,!c)||g&&Uo(d,u,s,i,n,o,r,h,a+1,e,!c),Io.releasePrimitive(e)}}return x}const Ro=new Qn,No=new h;class Lo{static serialize(t,e={}){e={cloneBuffers:!0,...e};const i=t.geometry,s=t._roots,n=t._indirectBuffer,r=i.getIndex();let o;return o=e.cloneBuffers?{roots:s.map((t=>t.slice())),index:r.array.slice(),indirectBuffer:n?n.slice():null}:{roots:s,index:r.array,indirectBuffer:n},o}static deserialize(t,e,i={}){i={setIndex:!0,indirect:Boolean(t.indirectBuffer),...i};const{index:s,roots:n,indirectBuffer:r}=t,o=new Lo(e,{...i,[Tn]:!0});if(o._roots=n,o._indirectBuffer=r||null,i.setIndex){const i=e.getIndex();if(null===i){const i=new I(t.index,1,!1);e.setIndex(i)}else i.array!==s&&(i.array.set(s),i.needsUpdate=!0)}return o}get indirect(){return!!this._indirectBuffer}constructor(t,e={}){if(!t.isBufferGeometry)throw new Error("MeshBVH: Only BufferGeometries are supported.");if(t.index&&t.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.");if((e=Object.assign({strategy:0,maxDepth:40,maxLeafTris:10,verbose:!0,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,[Tn]:!1},e)).useSharedArrayBuffer&&"undefined"==typeof SharedArrayBuffer)throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=t,this._roots=null,this._indirectBuffer=null,e[Tn]||(Zn(this,e),!t.boundingBox&&e.setBoundingBox&&(t.boundingBox=this.getBoundingBox(new h)));const{_indirectBuffer:i}=this;this.resolveTriangleIndex=e.indirect?t=>i[t]:t=>t}refit(t=null){return(this.indirect?so:Ir)(this,t)}traverse(t,e=0){const i=this._roots[e],s=new Uint32Array(i),n=new Uint16Array(i);!function e(r,o=0){const a=2*r,h=n[a+15]===xn;if(h){const e=s[r+6],l=n[a+14];t(o,h,new Float32Array(i,4*r,6),e,l)}else{const n=r+8,a=s[r+6],l=s[r+7];t(o,h,new Float32Array(i,4*r,6),l)||(e(n,o+1),e(a,o+1))}}(0)}raycast(t,e=D){const i=this._roots,s=this.geometry,n=[],r=e.isMaterial,o=Array.isArray(e),a=s.groups,h=r?e.side:e,l=this.indirect?ro:Br;for(let s=0,r=i.length;s<r;s++){const i=o?e[a[s].materialIndex].side:h,r=n.length;if(l(this,s,i,t,n),o){const t=a[s].materialIndex;for(let e=r,i=n.length;e<i;e++)n[e].face.materialIndex=t}}return n}raycastFirst(t,e=D){const i=this._roots,s=this.geometry,n=e.isMaterial,r=Array.isArray(e);let o=null;const a=s.groups,h=n?e.side:e,l=this.indirect?lo:Lr;for(let s=0,n=i.length;s<n;s++){const i=l(this,s,r?e[a[s].materialIndex].side:h,t);null!=i&&(null==o||i.distance<o.distance)&&(o=i,r&&(i.face.materialIndex=a[s].materialIndex))}return o}intersectsGeometry(t,e){let i=!1;const s=this._roots,n=this.indirect?yo:Wr;for(let r=0,o=s.length;r<o&&(i=n(this,r,t,e),!i);r++);return i}shapecast(t){const e=tr.getPrimitive(),i=this.indirect?zr:Pr;let{boundsTraverseOrder:s,intersectsBounds:n,intersectsRange:r,intersectsTriangle:o}=t;if(r&&o){const t=r;r=(s,n,r,a,h)=>!!t(s,n,r,a,h)||i(s,n,this,o,r,a,e)}else r||(r=o?(t,s,n,r)=>i(t,s,this,o,n,r,e):(t,e,i)=>i);let a=!1,h=0;const l=this._roots;for(let t=0,e=l.length;t<e;t++){const e=l[t];if(a=dr(this,t,n,r,s,h),a)break;h+=e.byteLength}return tr.releasePrimitive(e),a}bvhcast(t,e,i){let{intersectsRanges:s,intersectsTriangles:n}=i;const r=tr.getPrimitive(),o=this.geometry.index,a=this.geometry.attributes.position,h=this.indirect?t=>{const e=this.resolveTriangleIndex(t);Or(r,3*e,o,a)}:t=>{Or(r,3*t,o,a)},l=tr.getPrimitive(),c=t.geometry.index,u=t.geometry.attributes.position,d=t.indirect?e=>{const i=t.resolveTriangleIndex(e);Or(l,3*i,c,u)}:t=>{Or(l,3*t,c,u)};if(n){const t=(t,i,s,o,a,c,u,p)=>{for(let f=s,m=s+o;f<m;f++){d(f),l.a.applyMatrix4(e),l.b.applyMatrix4(e),l.c.applyMatrix4(e),l.needsUpdate=!0;for(let e=t,s=t+i;e<s;e++)if(h(e),r.needsUpdate=!0,n(r,l,e,f,a,c,u,p))return!0}return!1};if(s){const e=s;s=function(i,s,n,r,o,a,h,l){return!!e(i,s,n,r,o,a,h,l)||t(i,s,n,r,o,a,h,l)}}else s=t}return function(t,e,i,s){if(Bo)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");Bo=!0;const n=t._roots,r=e._roots;let o,a=0,h=0;const l=(new p).copy(i).invert();for(let t=0,e=n.length;t<e;t++){Oo.setBuffer(n[t]),h=0;const e=Io.getPrimitive();Pn(0,Oo.float32Array,e),e.applyMatrix4(l);for(let n=0,c=r.length;n<c&&(Po.setBuffer(r[t]),o=Uo(0,0,i,l,s,a,h,0,0,e),Po.clearBuffer(),h+=r[n].length,!o);n++);if(Io.releasePrimitive(e),Oo.clearBuffer(),a+=n[t].length,o)break}return Bo=!1,o}(this,t,e,s)}intersectsBox(t,e){return Ro.set(t.min,t.max,e),Ro.needsUpdate=!0,this.shapecast({intersectsBounds:t=>Ro.intersectsBox(t),intersectsTriangle:t=>Ro.intersectsTriangle(t)})}intersectsSphere(t){return this.shapecast({intersectsBounds:e=>t.intersectsBox(e),intersectsTriangle:e=>e.intersectsSphere(t)})}closestPointToGeometry(t,e,i={},s={},n=0,r=1/0){return(this.indirect?So:io)(this,t,e,i,s,n,r)}closestPointToPoint(t,e={},i=0,s=1/0){return function(t,e,i={},s=0,n=1/0){const r=s*s,o=n*n;let a=1/0,h=null;if(t.shapecast({boundsTraverseOrder:t=>(fr.copy(e).clamp(t.min,t.max),fr.distanceToSquared(e)),intersectsBounds:(t,e,i)=>i<a&&i<o,intersectsTriangle:(t,i)=>{t.closestPointToPoint(e,fr);const s=e.distanceToSquared(fr);return s<a&&(mr.copy(fr),a=s,h=i),s<r}}),a===1/0)return null;const l=Math.sqrt(a);return i.point?i.point.copy(mr):i.point=mr.clone(),i.distance=l,i.faceIndex=h,i}(this,t,e,i,s)}getBoundingBox(t){t.makeEmpty();return this._roots.forEach((e=>{Pn(0,new Float32Array(e),No),t.union(No)})),t}}function Fo(t,e,i){return null===t?null:(t.point.applyMatrix4(e.matrixWorld),t.distance=t.point.distanceTo(i.ray.origin),t.object=e,t.distance<i.near||t.distance>i.far?null:t)}const Vo=new k,jo=new p,Yo=l.prototype.raycast;function Zo(t,e){if(this.geometry.boundsTree){if(void 0===this.material)return;jo.copy(this.matrixWorld).invert(),Vo.copy(t.ray).applyMatrix4(jo);const i=this.geometry.boundsTree;if(!0===t.firstHitOnly){const s=Fo(i.raycastFirst(Vo,this.material),this,t);s&&e.push(s)}else{const s=i.raycast(Vo,this.material);for(let i=0,n=s.length;i<n;i++){const n=Fo(s[i],this,t);n&&e.push(n)}}}else Yo.call(this,t,e)}function Ho(t){return this.boundsTree=new Lo(this,t),this.boundsTree}function $o(){this.boundsTree=null}const Wo=class t{constructor(){ne(this,"onDisposed",new re),ne(this,"list",new e),ne(this,"enabled",!1),ne(this,"_clock"),ne(this,"onInit",new re),ne(this,"update",(()=>{if(!this.enabled)return;const t=this._clock.getDelta();for(const[e,i]of this.list)i.enabled&&i.isUpdateable()&&i.update(t);requestAnimationFrame(this.update)})),this._clock=new s.Clock,t.setupBVH()}add(t,e){if(this.list.has(t))throw new Error("You're trying to add a component that already exists in the components instance. Use Components.get() instead.");_e.validate(t),this.list.set(t,e)}get(t){const e=t.uuid;if(!this.list.has(e)){const i=new t(this);return i.isDisposeable()&&i.onDisposed.add((()=>this.list.delete(e))),this.list.has(e)||this.add(e,i),i}return this.list.get(e)}init(){this.enabled=!0;for(const[t,e]of this.list.entries())e.enabled=!0;this._clock.start(),this.update(),this.onInit.trigger()}dispose(){let t;this.enabled=!1;for(const[e,i]of this.list)i.enabled=!1,e!==qi.uuid?i.isDisposeable()&&i.dispose():t=i;null==t||t.dispose(),this._clock.stop(),this.onDisposed.trigger()}static setupBVH(){s.BufferGeometry.prototype.computeBoundsTree=Ho,s.BufferGeometry.prototype.disposeBoundsTree=$o,s.Mesh.prototype.raycast=Zo}};ne(Wo,"release","2.4.3");let qo=Wo;class Xo{constructor(t){ne(this,"enabled",!1),ne(this,"id","FirstPerson"),this.camera=t}set(t){if(this.enabled=t,t){if("Perspective"!==this.camera.projection.current)return void this.camera.set("Orbit");this.setupFirstPersonCamera()}}setupFirstPersonCamera(){const t=this.camera.controls,e=new s.Vector3;t.distance--,t.getPosition(e),t.minDistance=1,t.maxDistance=1,t.distance=1,t.moveTo(e.x,e.y,e.z),t.truckSpeed=50,t.mouseButtons.wheel=pn.ACTION.DOLLY,t.touches.two=pn.ACTION.TOUCH_ZOOM_TRUCK}}class Go{constructor(t){ne(this,"enabled",!0),ne(this,"id","Orbit"),this.camera=t,this.activateOrbitControls()}set(t){this.enabled=t,t&&this.activateOrbitControls()}activateOrbitControls(){const t=this.camera.controls;t.minDistance=1,t.maxDistance=300;const e=new s.Vector3;t.getPosition(e);const i=e.length();t.distance=i,t.truckSpeed=2;const{rotation:n}=this.camera.three,r=new s.Vector3(0,0,-1).applyEuler(n),o=e.addScaledVector(r,i);t.moveTo(o.x,o.y,o.z)}}class Qo{constructor(t){ne(this,"enabled",!1),ne(this,"id","Plan"),ne(this,"mouseAction1"),ne(this,"mouseAction2"),ne(this,"mouseInitialized",!1),ne(this,"defaultAzimuthSpeed"),ne(this,"defaultPolarSpeed"),this.camera=t,this.defaultAzimuthSpeed=t.controls.azimuthRotateSpeed,this.defaultPolarSpeed=t.controls.polarRotateSpeed}set(t){this.enabled=t;const e=this.camera.controls;e.azimuthRotateSpeed=t?0:this.defaultAzimuthSpeed,e.polarRotateSpeed=t?0:this.defaultPolarSpeed,this.mouseInitialized||(this.mouseAction1=e.touches.one,this.mouseAction2=e.touches.two,this.mouseInitialized=!0),t?(e.mouseButtons.left=pn.ACTION.TRUCK,e.touches.one=pn.ACTION.TOUCH_TRUCK,e.touches.two=pn.ACTION.TOUCH_ZOOM):(e.mouseButtons.left=pn.ACTION.ROTATE,e.touches.one=this.mouseAction1,e.touches.two=this.mouseAction2)}}class Ko{constructor(t){ne(this,"onChanged",new re),ne(this,"current","Perspective"),ne(this,"camera"),ne(this,"matchOrthoDistanceEnabled",!1),ne(this,"_component"),ne(this,"_previousDistance",-1),this._component=t,this.camera=t.three}async set(t){this.current!==t&&("Orthographic"===t?this.setOrthoCamera():await this.setPerspectiveCamera(),this.onChanged.trigger(this.camera))}async toggle(){const t="Perspective"===this.current?"Orthographic":"Perspective";await this.set(t)}setOrthoCamera(){if(null===this._component.mode)return;if("FirstPerson"===this._component.mode.id)return;this._previousDistance=this._component.controls.distance,this._component.controls.distance=200;const t=this.getPerspectiveDims();if(!t)return;const{width:e,height:i}=t;this.setupOrthoCamera(i,e),this.camera=this._component.threeOrtho,this.current="Orthographic"}getPerspectiveDims(){const t=this._component.currentWorld;if(!t||!t.renderer)return null;const e=new s.Vector3;this._component.threePersp.getWorldDirection(e);const i=new s.Vector3;this._component.controls.getTarget(i);const n=i.clone().sub(this._component.threePersp.position).dot(e),r=t.renderer.getSize(),o=r.x/r.y,a=this._component.threePersp,h=2*n*Math.atan(a.fov*(Math.PI/180)/2);return{width:h*o,height:h}}setupOrthoCamera(t,e){this._component.controls.mouseButtons.wheel=pn.ACTION.ZOOM,this._component.controls.mouseButtons.middle=pn.ACTION.ZOOM;const i=this._component.threePersp,s=this._component.threeOrtho;s.zoom=1,s.left=e/-2,s.right=e/2,s.top=t/2,s.bottom=t/-2,s.updateProjectionMatrix(),s.position.copy(i.position),s.quaternion.copy(i.quaternion),this._component.controls.camera=s}getDistance(){const t=this._component.threePersp,e=this._component.threeOrtho;return(e.top-e.bottom)/e.zoom/(2*Math.atan(t.fov*(Math.PI/180)/2))}async setPerspectiveCamera(){this._component.controls.mouseButtons.wheel=pn.ACTION.DOLLY,this._component.controls.mouseButtons.middle=pn.ACTION.DOLLY;const t=this._component.threePersp,e=this._component.threeOrtho;t.position.copy(e.position),t.quaternion.copy(e.quaternion),this._component.controls.mouseButtons.wheel=pn.ACTION.DOLLY,this.matchOrthoDistanceEnabled?this._component.controls.distance=this.getDistance():this._component.controls.distance=this._previousDistance,await this._component.controls.zoomTo(1),t.updateProjectionMatrix(),this._component.controls.camera=t,this.camera=t,this.current="Perspective"}}class Jo extends fn{constructor(t){super(t),ne(this,"projection"),ne(this,"threeOrtho"),ne(this,"threePersp"),ne(this,"_userInputButtons",{}),ne(this,"_frustumSize",50),ne(this,"_navigationModes",new Map),ne(this,"_mode",null),ne(this,"previousSize",null),this.threePersp=this.three,this.threeOrtho=this.newOrthoCamera(),this.projection=new Ko(this),this.onAspectUpdated.add((()=>{this.setOrthoPerspCameraAspect()})),this.projection.onChanged.add((t=>{this.three=t,this.updateAspect()})),this.worlds.onItemSet.add((()=>{this._navigationModes.clear(),this._navigationModes.set("Orbit",new Go(this)),this._navigationModes.set("FirstPerson",new Xo(this)),this._navigationModes.set("Plan",new Qo(this)),this._mode=this._navigationModes.get("Orbit"),this.mode.set(!0,{preventTargetAdjustment:!0}),this.currentWorld&&this.currentWorld.renderer&&(this.previousSize=this.currentWorld.renderer.getSize().clone())})),this.worlds.onItemDeleted.add((()=>{this._navigationModes.clear()}))}get mode(){if(!this._mode)throw new Error("Mode not found, camera not initialized");return this._mode}dispose(){super.dispose(),this.threeOrtho.removeFromParent()}set(t){if(null!==this.mode&&this.mode.id!==t){if(this.mode.set(!1),!this._navigationModes.has(t))throw new Error("The specified mode does not exist!");this._mode=this._navigationModes.get(t),this.mode.set(!0)}}async fit(t,e=1.5){if(!this.enabled)return;const i=Number.MAX_VALUE,n=Number.MIN_VALUE,r=new s.Vector3(i,i,i),o=new s.Vector3(n,n,n);for(const e of t){const t=(new s.Box3).setFromObject(e);t.min.x<r.x&&(r.x=t.min.x),t.min.y<r.y&&(r.y=t.min.y),t.min.z<r.z&&(r.z=t.min.z),t.max.x>o.x&&(o.x=t.max.x),t.max.y>o.y&&(o.y=t.max.y),t.max.z>o.z&&(o.z=t.max.z)}const a=new s.Box3(r,o),h=this.components.get(qi);if(h.initialized)for(const[,t]of h.list){const e=t.box;e.min.x<r.x&&(r.x=e.min.x),e.min.y<r.y&&(r.y=e.min.y),e.min.z<r.z&&(r.z=e.min.z),e.max.x>o.x&&(o.x=e.max.x),e.max.y>o.y&&(o.y=e.max.y),e.max.z>o.z&&(o.z=e.max.z)}const l=new s.Vector3;a.getSize(l);const c=new s.Vector3;a.getCenter(c);const u=Math.max(l.x,l.y,l.z)*e,d=new s.Sphere(c,u);await this.controls.fitToSphere(d,!0)}setUserInput(t){t?this.enableUserInput():this.disableUserInput()}disableUserInput(){this._userInputButtons.left=this.controls.mouseButtons.left,this._userInputButtons.right=this.controls.mouseButtons.right,this._userInputButtons.middle=this.controls.mouseButtons.middle,this._userInputButtons.wheel=this.controls.mouseButtons.wheel,this.controls.mouseButtons.left=0,this.controls.mouseButtons.right=0,this.controls.mouseButtons.middle=0,this.controls.mouseButtons.wheel=0}enableUserInput(){0!==Object.keys(this._userInputButtons).length&&(this.controls.mouseButtons.left=this._userInputButtons.left,this.controls.mouseButtons.right=this._userInputButtons.right,this.controls.mouseButtons.middle=this._userInputButtons.middle,this.controls.mouseButtons.wheel=this._userInputButtons.wheel)}newOrthoCamera(){const t=window.innerWidth/window.innerHeight;return new s.OrthographicCamera(this._frustumSize*t/-2,this._frustumSize*t/2,this._frustumSize/2,this._frustumSize/-2,.1,1e3)}setOrthoPerspCameraAspect(){if(!this.currentWorld||!this.currentWorld.renderer)return;if(!this.previousSize)return;const t=this.currentWorld.renderer.getSize(),e=this.threeOrtho.top,i=this.threeOrtho.right,s=e*(t.y/this.previousSize.y),n=i*(t.x/this.previousSize.x);this.threeOrtho.left=-n,this.threeOrtho.right=n,this.threeOrtho.top=s,this.threeOrtho.bottom=-s,this.threeOrtho.updateProjectionMatrix(),this.previousSize.copy(t)}}function ta(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var ea={exports:{}};
/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/const ia=we(ea.exports=function t(e,i,s){function n(o,a){if(!i[o]){if(!e[o]){if(!a&&ta)return ta(o);if(r)return r(o,!0);var h=new Error("Cannot find module '"+o+"'");throw h.code="MODULE_NOT_FOUND",h}var l=i[o]={exports:{}};e[o][0].call(l.exports,(function(t){return n(e[o][1][t]||t)}),l,l.exports,t,e,i,s)}return i[o].exports}for(var r=ta,o=0;o<s.length;o++)n(s[o]);return n}({1:[function(t,e,i){var s=t("./utils"),n=t("./support"),r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";i.encode=function(t){for(var e,i,n,o,a,h,l,c=[],u=0,d=t.length,p=d,f="string"!==s.getTypeOf(t);u<t.length;)p=d-u,n=f?(e=t[u++],i=u<d?t[u++]:0,u<d?t[u++]:0):(e=t.charCodeAt(u++),i=u<d?t.charCodeAt(u++):0,u<d?t.charCodeAt(u++):0),o=e>>2,a=(3&e)<<4|i>>4,h=1<p?(15&i)<<2|n>>6:64,l=2<p?63&n:64,c.push(r.charAt(o)+r.charAt(a)+r.charAt(h)+r.charAt(l));return c.join("")},i.decode=function(t){var e,i,s,o,a,h,l=0,c=0,u="data:";if(t.substr(0,u.length)===u)throw new Error("Invalid base64 input, it looks like a data url.");var d,p=3*(t=t.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(t.charAt(t.length-1)===r.charAt(64)&&p--,t.charAt(t.length-2)===r.charAt(64)&&p--,p%1!=0)throw new Error("Invalid base64 input, bad content length.");for(d=n.uint8array?new Uint8Array(0|p):new Array(0|p);l<t.length;)e=r.indexOf(t.charAt(l++))<<2|(o=r.indexOf(t.charAt(l++)))>>4,i=(15&o)<<4|(a=r.indexOf(t.charAt(l++)))>>2,s=(3&a)<<6|(h=r.indexOf(t.charAt(l++))),d[c++]=e,64!==a&&(d[c++]=i),64!==h&&(d[c++]=s);return d}},{"./support":30,"./utils":32}],2:[function(t,e,i){var s=t("./external"),n=t("./stream/DataWorker"),r=t("./stream/Crc32Probe"),o=t("./stream/DataLengthProbe");function a(t,e,i,s,n){this.compressedSize=t,this.uncompressedSize=e,this.crc32=i,this.compression=s,this.compressedContent=n}a.prototype={getContentWorker:function(){var t=new n(s.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new o("data_length")),e=this;return t.on("end",(function(){if(this.streamInfo.data_length!==e.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")})),t},getCompressedWorker:function(){return new n(s.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},a.createWorkerFrom=function(t,e,i){return t.pipe(new r).pipe(new o("uncompressedSize")).pipe(e.compressWorker(i)).pipe(new o("compressedSize")).withStreamInfo("compression",e)},e.exports=a},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(t,e,i){var s=t("./stream/GenericWorker");i.STORE={magic:"\0\0",compressWorker:function(){return new s("STORE compression")},uncompressWorker:function(){return new s("STORE decompression")}},i.DEFLATE=t("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(t,e,i){var s=t("./utils"),n=function(){for(var t,e=[],i=0;i<256;i++){t=i;for(var s=0;s<8;s++)t=1&t?3988292384^t>>>1:t>>>1;e[i]=t}return e}();e.exports=function(t,e){return void 0!==t&&t.length?"string"!==s.getTypeOf(t)?function(t,e,i,s){var r=n,o=s+i;t^=-1;for(var a=s;a<o;a++)t=t>>>8^r[255&(t^e[a])];return~t}(0|e,t,t.length,0):function(t,e,i,s){var r=n,o=s+i;t^=-1;for(var a=s;a<o;a++)t=t>>>8^r[255&(t^e.charCodeAt(a))];return~t}(0|e,t,t.length,0):0}},{"./utils":32}],5:[function(t,e,i){i.base64=!1,i.binary=!1,i.dir=!1,i.createFolders=!0,i.date=null,i.compression=null,i.compressionOptions=null,i.comment=null,i.unixPermissions=null,i.dosPermissions=null},{}],6:[function(t,e,i){var s=null;s="undefined"!=typeof Promise?Promise:t("lie"),e.exports={Promise:s}},{lie:37}],7:[function(t,e,i){var s="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array,n=t("pako"),r=t("./utils"),o=t("./stream/GenericWorker"),a=s?"uint8array":"array";function h(t,e){o.call(this,"FlateWorker/"+t),this._pako=null,this._pakoAction=t,this._pakoOptions=e,this.meta={}}i.magic="\b\0",r.inherits(h,o),h.prototype.processChunk=function(t){this.meta=t.meta,null===this._pako&&this._createPako(),this._pako.push(r.transformTo(a,t.data),!1)},h.prototype.flush=function(){o.prototype.flush.call(this),null===this._pako&&this._createPako(),this._pako.push([],!0)},h.prototype.cleanUp=function(){o.prototype.cleanUp.call(this),this._pako=null},h.prototype._createPako=function(){this._pako=new n[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var t=this;this._pako.onData=function(e){t.push({data:e,meta:t.meta})}},i.compressWorker=function(t){return new h("Deflate",t)},i.uncompressWorker=function(){return new h("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(t,e,i){function s(t,e){var i,s="";for(i=0;i<e;i++)s+=String.fromCharCode(255&t),t>>>=8;return s}function n(t,e,i,n,o,c){var u,d,p=t.file,f=t.compression,m=c!==a.utf8encode,g=r.transformTo("string",c(p.name)),_=r.transformTo("string",a.utf8encode(p.name)),y=p.comment,w=r.transformTo("string",c(y)),v=r.transformTo("string",a.utf8encode(y)),b=_.length!==p.name.length,x=v.length!==y.length,E="",T="",A="",C=p.dir,S=p.date,O={crc32:0,compressedSize:0,uncompressedSize:0};e&&!i||(O.crc32=t.crc32,O.compressedSize=t.compressedSize,O.uncompressedSize=t.uncompressedSize);var P=0;e&&(P|=8),m||!b&&!x||(P|=2048);var I,D,k,z=0,M=0;C&&(z|=16),"UNIX"===o?(M=798,z|=(I=p.unixPermissions,D=C,k=I,I||(k=D?16893:33204),(65535&k)<<16)):(M=20,z|=function(t){return 63&(t||0)}(p.dosPermissions)),u=S.getUTCHours(),u<<=6,u|=S.getUTCMinutes(),u<<=5,u|=S.getUTCSeconds()/2,d=S.getUTCFullYear()-1980,d<<=4,d|=S.getUTCMonth()+1,d<<=5,d|=S.getUTCDate(),b&&(T=s(1,1)+s(h(g),4)+_,E+="up"+s(T.length,2)+T),x&&(A=s(1,1)+s(h(w),4)+v,E+="uc"+s(A.length,2)+A);var B="";return B+="\n\0",B+=s(P,2),B+=f.magic,B+=s(u,2),B+=s(d,2),B+=s(O.crc32,4),B+=s(O.compressedSize,4),B+=s(O.uncompressedSize,4),B+=s(g.length,2),B+=s(E.length,2),{fileRecord:l.LOCAL_FILE_HEADER+B+g+E,dirRecord:l.CENTRAL_FILE_HEADER+s(M,2)+B+s(w.length,2)+"\0\0\0\0"+s(z,4)+s(n,4)+g+E+w}}var r=t("../utils"),o=t("../stream/GenericWorker"),a=t("../utf8"),h=t("../crc32"),l=t("../signature");function c(t,e,i,s){o.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=e,this.zipPlatform=i,this.encodeFileName=s,this.streamFiles=t,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}r.inherits(c,o),c.prototype.push=function(t){var e=t.meta.percent||0,i=this.entriesCount,s=this._sources.length;this.accumulate?this.contentBuffer.push(t):(this.bytesWritten+=t.data.length,o.prototype.push.call(this,{data:t.data,meta:{currentFile:this.currentFile,percent:i?(e+100*(i-s-1))/i:100}}))},c.prototype.openedSource=function(t){this.currentSourceOffset=this.bytesWritten,this.currentFile=t.file.name;var e=this.streamFiles&&!t.file.dir;if(e){var i=n(t,e,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:i.fileRecord,meta:{percent:0}})}else this.accumulate=!0},c.prototype.closedSource=function(t){this.accumulate=!1;var e,i=this.streamFiles&&!t.file.dir,r=n(t,i,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(r.dirRecord),i)this.push({data:(e=t,l.DATA_DESCRIPTOR+s(e.crc32,4)+s(e.compressedSize,4)+s(e.uncompressedSize,4)),meta:{percent:100}});else for(this.push({data:r.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},c.prototype.flush=function(){for(var t=this.bytesWritten,e=0;e<this.dirRecords.length;e++)this.push({data:this.dirRecords[e],meta:{percent:100}});var i,n,o,a,h,c,u=this.bytesWritten-t,d=(i=this.dirRecords.length,n=u,o=t,a=this.zipComment,h=this.encodeFileName,c=r.transformTo("string",h(a)),l.CENTRAL_DIRECTORY_END+"\0\0\0\0"+s(i,2)+s(i,2)+s(n,4)+s(o,4)+s(c.length,2)+c);this.push({data:d,meta:{percent:100}})},c.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},c.prototype.registerPrevious=function(t){this._sources.push(t);var e=this;return t.on("data",(function(t){e.processChunk(t)})),t.on("end",(function(){e.closedSource(e.previous.streamInfo),e._sources.length?e.prepareNextSource():e.end()})),t.on("error",(function(t){e.error(t)})),this},c.prototype.resume=function(){return!!o.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},c.prototype.error=function(t){var e=this._sources;if(!o.prototype.error.call(this,t))return!1;for(var i=0;i<e.length;i++)try{e[i].error(t)}catch(t){}return!0},c.prototype.lock=function(){o.prototype.lock.call(this);for(var t=this._sources,e=0;e<t.length;e++)t[e].lock()},e.exports=c},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(t,e,i){var s=t("../compressions"),n=t("./ZipFileWorker");i.generateWorker=function(t,e,i){var r=new n(e.streamFiles,i,e.platform,e.encodeFileName),o=0;try{t.forEach((function(t,i){o++;var n=function(t,e){var i=t||e,n=s[i];if(!n)throw new Error(i+" is not a valid compression method !");return n}(i.options.compression,e.compression),a=i.options.compressionOptions||e.compressionOptions||{},h=i.dir,l=i.date;i._compressWorker(n,a).withStreamInfo("file",{name:t,dir:h,date:l,comment:i.comment||"",unixPermissions:i.unixPermissions,dosPermissions:i.dosPermissions}).pipe(r)})),r.entriesCount=o}catch(t){r.error(t)}return r}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(t,e,i){function s(){if(!(this instanceof s))return new s;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var t=new s;for(var e in this)"function"!=typeof this[e]&&(t[e]=this[e]);return t}}(s.prototype=t("./object")).loadAsync=t("./load"),s.support=t("./support"),s.defaults=t("./defaults"),s.version="3.10.1",s.loadAsync=function(t,e){return(new s).loadAsync(t,e)},s.external=t("./external"),e.exports=s},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(t,e,i){var s=t("./utils"),n=t("./external"),r=t("./utf8"),o=t("./zipEntries"),a=t("./stream/Crc32Probe"),h=t("./nodejsUtils");function l(t){return new n.Promise((function(e,i){var s=t.decompressed.getContentWorker().pipe(new a);s.on("error",(function(t){i(t)})).on("end",(function(){s.streamInfo.crc32!==t.decompressed.crc32?i(new Error("Corrupted zip : CRC32 mismatch")):e()})).resume()}))}e.exports=function(t,e){var i=this;return e=s.extend(e||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:r.utf8decode}),h.isNode&&h.isStream(t)?n.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):s.prepareContent("the loaded zip file",t,!0,e.optimizedBinaryString,e.base64).then((function(t){var i=new o(e);return i.load(t),i})).then((function(t){var i=[n.Promise.resolve(t)],s=t.files;if(e.checkCRC32)for(var r=0;r<s.length;r++)i.push(l(s[r]));return n.Promise.all(i)})).then((function(t){for(var n=t.shift(),r=n.files,o=0;o<r.length;o++){var a=r[o],h=a.fileNameStr,l=s.resolve(a.fileNameStr);i.file(l,a.decompressed,{binary:!0,optimizedBinaryString:!0,date:a.date,dir:a.dir,comment:a.fileCommentStr.length?a.fileCommentStr:null,unixPermissions:a.unixPermissions,dosPermissions:a.dosPermissions,createFolders:e.createFolders}),a.dir||(i.file(l).unsafeOriginalName=h)}return n.zipComment.length&&(i.comment=n.zipComment),i}))}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(t,e,i){var s=t("../utils"),n=t("../stream/GenericWorker");function r(t,e){n.call(this,"Nodejs stream input adapter for "+t),this._upstreamEnded=!1,this._bindStream(e)}s.inherits(r,n),r.prototype._bindStream=function(t){var e=this;(this._stream=t).pause(),t.on("data",(function(t){e.push({data:t,meta:{percent:0}})})).on("error",(function(t){e.isPaused?this.generatedError=t:e.error(t)})).on("end",(function(){e.isPaused?e._upstreamEnded=!0:e.end()}))},r.prototype.pause=function(){return!!n.prototype.pause.call(this)&&(this._stream.pause(),!0)},r.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},e.exports=r},{"../stream/GenericWorker":28,"../utils":32}],13:[function(t,e,i){var s=t("readable-stream").Readable;function n(t,e,i){s.call(this,e),this._helper=t;var n=this;t.on("data",(function(t,e){n.push(t)||n._helper.pause(),i&&i(e)})).on("error",(function(t){n.emit("error",t)})).on("end",(function(){n.push(null)}))}t("../utils").inherits(n,s),n.prototype._read=function(){this._helper.resume()},e.exports=n},{"../utils":32,"readable-stream":16}],14:[function(t,e,i){e.exports={isNode:void 0!==X,newBufferFrom:function(t,e){if(X.from&&X.from!==Uint8Array.from)return X.from(t,e);if("number"==typeof t)throw new Error('The "data" argument must not be a number');return new X(t,e)},allocBuffer:function(t){if(X.alloc)return X.alloc(t);var e=new X(t);return e.fill(0),e},isBuffer:function(t){return X.isBuffer(t)},isStream:function(t){return t&&"function"==typeof t.on&&"function"==typeof t.pause&&"function"==typeof t.resume}}},{}],15:[function(t,e,i){function s(t,e,i){var s,n=r.getTypeOf(e),a=r.extend(i||{},h);a.date=a.date||new Date,null!==a.compression&&(a.compression=a.compression.toUpperCase()),"string"==typeof a.unixPermissions&&(a.unixPermissions=parseInt(a.unixPermissions,8)),a.unixPermissions&&16384&a.unixPermissions&&(a.dir=!0),a.dosPermissions&&16&a.dosPermissions&&(a.dir=!0),a.dir&&(t=m(t)),a.createFolders&&(s=f(t))&&g.call(this,s,!0);var u="string"===n&&!1===a.binary&&!1===a.base64;i&&void 0!==i.binary||(a.binary=!u),(e instanceof l&&0===e.uncompressedSize||a.dir||!e||0===e.length)&&(a.base64=!1,a.binary=!0,e="",a.compression="STORE",n="string");var _=null;_=e instanceof l||e instanceof o?e:d.isNode&&d.isStream(e)?new p(t,e):r.prepareContent(t,e,a.binary,a.optimizedBinaryString,a.base64);var y=new c(t,_,a);this.files[t]=y}var n=t("./utf8"),r=t("./utils"),o=t("./stream/GenericWorker"),a=t("./stream/StreamHelper"),h=t("./defaults"),l=t("./compressedObject"),c=t("./zipObject"),u=t("./generate"),d=t("./nodejsUtils"),p=t("./nodejs/NodejsStreamInputAdapter"),f=function(t){"/"===t.slice(-1)&&(t=t.substring(0,t.length-1));var e=t.lastIndexOf("/");return 0<e?t.substring(0,e):""},m=function(t){return"/"!==t.slice(-1)&&(t+="/"),t},g=function(t,e){return e=void 0!==e?e:h.createFolders,t=m(t),this.files[t]||s.call(this,t,null,{dir:!0,createFolders:e}),this.files[t]};function _(t){return"[object RegExp]"===Object.prototype.toString.call(t)}var y={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(t){var e,i,s;for(e in this.files)s=this.files[e],(i=e.slice(this.root.length,e.length))&&e.slice(0,this.root.length)===this.root&&t(i,s)},filter:function(t){var e=[];return this.forEach((function(i,s){t(i,s)&&e.push(s)})),e},file:function(t,e,i){if(1!==arguments.length)return t=this.root+t,s.call(this,t,e,i),this;if(_(t)){var n=t;return this.filter((function(t,e){return!e.dir&&n.test(t)}))}var r=this.files[this.root+t];return r&&!r.dir?r:null},folder:function(t){if(!t)return this;if(_(t))return this.filter((function(e,i){return i.dir&&t.test(e)}));var e=this.root+t,i=g.call(this,e),s=this.clone();return s.root=i.name,s},remove:function(t){t=this.root+t;var e=this.files[t];if(e||("/"!==t.slice(-1)&&(t+="/"),e=this.files[t]),e&&!e.dir)delete this.files[t];else for(var i=this.filter((function(e,i){return i.name.slice(0,t.length)===t})),s=0;s<i.length;s++)delete this.files[i[s].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(t){var e,i={};try{if((i=r.extend(t||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:n.utf8encode})).type=i.type.toLowerCase(),i.compression=i.compression.toUpperCase(),"binarystring"===i.type&&(i.type="string"),!i.type)throw new Error("No output type specified.");r.checkSupport(i.type),"darwin"!==i.platform&&"freebsd"!==i.platform&&"linux"!==i.platform&&"sunos"!==i.platform||(i.platform="UNIX"),"win32"===i.platform&&(i.platform="DOS");var s=i.comment||this.comment||"";e=u.generateWorker(this,i,s)}catch(t){(e=new o("error")).error(t)}return new a(e,i.type||"string",i.mimeType)},generateAsync:function(t,e){return this.generateInternalStream(t).accumulate(e)},generateNodeStream:function(t,e){return(t=t||{}).type||(t.type="nodebuffer"),this.generateInternalStream(t).toNodejsStream(e)}};e.exports=y},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(t,e,i){e.exports=t("stream")},{stream:void 0}],17:[function(t,e,i){var s=t("./DataReader");function n(t){s.call(this,t);for(var e=0;e<this.data.length;e++)t[e]=255&t[e]}t("../utils").inherits(n,s),n.prototype.byteAt=function(t){return this.data[this.zero+t]},n.prototype.lastIndexOfSignature=function(t){for(var e=t.charCodeAt(0),i=t.charCodeAt(1),s=t.charCodeAt(2),n=t.charCodeAt(3),r=this.length-4;0<=r;--r)if(this.data[r]===e&&this.data[r+1]===i&&this.data[r+2]===s&&this.data[r+3]===n)return r-this.zero;return-1},n.prototype.readAndCheckSignature=function(t){var e=t.charCodeAt(0),i=t.charCodeAt(1),s=t.charCodeAt(2),n=t.charCodeAt(3),r=this.readData(4);return e===r[0]&&i===r[1]&&s===r[2]&&n===r[3]},n.prototype.readData=function(t){if(this.checkOffset(t),0===t)return[];var e=this.data.slice(this.zero+this.index,this.zero+this.index+t);return this.index+=t,e},e.exports=n},{"../utils":32,"./DataReader":18}],18:[function(t,e,i){var s=t("../utils");function n(t){this.data=t,this.length=t.length,this.index=0,this.zero=0}n.prototype={checkOffset:function(t){this.checkIndex(this.index+t)},checkIndex:function(t){if(this.length<this.zero+t||t<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+t+"). Corrupted zip ?")},setIndex:function(t){this.checkIndex(t),this.index=t},skip:function(t){this.setIndex(this.index+t)},byteAt:function(){},readInt:function(t){var e,i=0;for(this.checkOffset(t),e=this.index+t-1;e>=this.index;e--)i=(i<<8)+this.byteAt(e);return this.index+=t,i},readString:function(t){return s.transformTo("string",this.readData(t))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var t=this.readInt(4);return new Date(Date.UTC(1980+(t>>25&127),(t>>21&15)-1,t>>16&31,t>>11&31,t>>5&63,(31&t)<<1))}},e.exports=n},{"../utils":32}],19:[function(t,e,i){var s=t("./Uint8ArrayReader");function n(t){s.call(this,t)}t("../utils").inherits(n,s),n.prototype.readData=function(t){this.checkOffset(t);var e=this.data.slice(this.zero+this.index,this.zero+this.index+t);return this.index+=t,e},e.exports=n},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(t,e,i){var s=t("./DataReader");function n(t){s.call(this,t)}t("../utils").inherits(n,s),n.prototype.byteAt=function(t){return this.data.charCodeAt(this.zero+t)},n.prototype.lastIndexOfSignature=function(t){return this.data.lastIndexOf(t)-this.zero},n.prototype.readAndCheckSignature=function(t){return t===this.readData(4)},n.prototype.readData=function(t){this.checkOffset(t);var e=this.data.slice(this.zero+this.index,this.zero+this.index+t);return this.index+=t,e},e.exports=n},{"../utils":32,"./DataReader":18}],21:[function(t,e,i){var s=t("./ArrayReader");function n(t){s.call(this,t)}t("../utils").inherits(n,s),n.prototype.readData=function(t){if(this.checkOffset(t),0===t)return new Uint8Array(0);var e=this.data.subarray(this.zero+this.index,this.zero+this.index+t);return this.index+=t,e},e.exports=n},{"../utils":32,"./ArrayReader":17}],22:[function(t,e,i){var s=t("../utils"),n=t("../support"),r=t("./ArrayReader"),o=t("./StringReader"),a=t("./NodeBufferReader"),h=t("./Uint8ArrayReader");e.exports=function(t){var e=s.getTypeOf(t);return s.checkSupport(e),"string"!==e||n.uint8array?"nodebuffer"===e?new a(t):n.uint8array?new h(s.transformTo("uint8array",t)):new r(s.transformTo("array",t)):new o(t)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(t,e,i){i.LOCAL_FILE_HEADER="PK",i.CENTRAL_FILE_HEADER="PK",i.CENTRAL_DIRECTORY_END="PK",i.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK",i.ZIP64_CENTRAL_DIRECTORY_END="PK",i.DATA_DESCRIPTOR="PK\b"},{}],24:[function(t,e,i){var s=t("./GenericWorker"),n=t("../utils");function r(t){s.call(this,"ConvertWorker to "+t),this.destType=t}n.inherits(r,s),r.prototype.processChunk=function(t){this.push({data:n.transformTo(this.destType,t.data),meta:t.meta})},e.exports=r},{"../utils":32,"./GenericWorker":28}],25:[function(t,e,i){var s=t("./GenericWorker"),n=t("../crc32");function r(){s.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}t("../utils").inherits(r,s),r.prototype.processChunk=function(t){this.streamInfo.crc32=n(t.data,this.streamInfo.crc32||0),this.push(t)},e.exports=r},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(t,e,i){var s=t("../utils"),n=t("./GenericWorker");function r(t){n.call(this,"DataLengthProbe for "+t),this.propName=t,this.withStreamInfo(t,0)}s.inherits(r,n),r.prototype.processChunk=function(t){if(t){var e=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=e+t.data.length}n.prototype.processChunk.call(this,t)},e.exports=r},{"../utils":32,"./GenericWorker":28}],27:[function(t,e,i){var s=t("../utils"),n=t("./GenericWorker");function r(t){n.call(this,"DataWorker");var e=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,t.then((function(t){e.dataIsReady=!0,e.data=t,e.max=t&&t.length||0,e.type=s.getTypeOf(t),e.isPaused||e._tickAndRepeat()}),(function(t){e.error(t)}))}s.inherits(r,n),r.prototype.cleanUp=function(){n.prototype.cleanUp.call(this),this.data=null},r.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,s.delay(this._tickAndRepeat,[],this)),!0)},r.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(s.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},r.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var t=null,e=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":t=this.data.substring(this.index,e);break;case"uint8array":t=this.data.subarray(this.index,e);break;case"array":case"nodebuffer":t=this.data.slice(this.index,e)}return this.index=e,this.push({data:t,meta:{percent:this.max?this.index/this.max*100:0}})},e.exports=r},{"../utils":32,"./GenericWorker":28}],28:[function(t,e,i){function s(t){this.name=t||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}s.prototype={push:function(t){this.emit("data",t)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(t){this.emit("error",t)}return!0},error:function(t){return!this.isFinished&&(this.isPaused?this.generatedError=t:(this.isFinished=!0,this.emit("error",t),this.previous&&this.previous.error(t),this.cleanUp()),!0)},on:function(t,e){return this._listeners[t].push(e),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(t,e){if(this._listeners[t])for(var i=0;i<this._listeners[t].length;i++)this._listeners[t][i].call(this,e)},pipe:function(t){return t.registerPrevious(this)},registerPrevious:function(t){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=t.streamInfo,this.mergeStreamInfo(),this.previous=t;var e=this;return t.on("data",(function(t){e.processChunk(t)})),t.on("end",(function(){e.end()})),t.on("error",(function(t){e.error(t)})),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var t=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),t=!0),this.previous&&this.previous.resume(),!t},flush:function(){},processChunk:function(t){this.push(t)},withStreamInfo:function(t,e){return this.extraStreamInfo[t]=e,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var t in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,t)&&(this.streamInfo[t]=this.extraStreamInfo[t])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var t="Worker "+this.name;return this.previous?this.previous+" -> "+t:t}},e.exports=s},{}],29:[function(t,e,i){var s=t("../utils"),n=t("./ConvertWorker"),r=t("./GenericWorker"),o=t("../base64"),a=t("../support"),h=t("../external"),l=null;if(a.nodestream)try{l=t("../nodejs/NodejsStreamOutputAdapter")}catch(t){}function c(t,e){return new h.Promise((function(i,n){var r=[],a=t._internalType,h=t._outputType,l=t._mimeType;t.on("data",(function(t,i){r.push(t),e&&e(i)})).on("error",(function(t){r=[],n(t)})).on("end",(function(){try{var t=function(t,e,i){switch(t){case"blob":return s.newBlob(s.transformTo("arraybuffer",e),i);case"base64":return o.encode(e);default:return s.transformTo(t,e)}}(h,function(t,e){var i,s=0,n=null,r=0;for(i=0;i<e.length;i++)r+=e[i].length;switch(t){case"string":return e.join("");case"array":return Array.prototype.concat.apply([],e);case"uint8array":for(n=new Uint8Array(r),i=0;i<e.length;i++)n.set(e[i],s),s+=e[i].length;return n;case"nodebuffer":return X.concat(e);default:throw new Error("concat : unsupported type '"+t+"'")}}(a,r),l);i(t)}catch(t){n(t)}r=[]})).resume()}))}function u(t,e,i){var o=e;switch(e){case"blob":case"arraybuffer":o="uint8array";break;case"base64":o="string"}try{this._internalType=o,this._outputType=e,this._mimeType=i,s.checkSupport(o),this._worker=t.pipe(new n(o)),t.lock()}catch(t){this._worker=new r("error"),this._worker.error(t)}}u.prototype={accumulate:function(t){return c(this,t)},on:function(t,e){var i=this;return"data"===t?this._worker.on(t,(function(t){e.call(i,t.data,t.meta)})):this._worker.on(t,(function(){s.delay(e,arguments,i)})),this},resume:function(){return s.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(t){if(s.checkSupport("nodestream"),"nodebuffer"!==this._outputType)throw new Error(this._outputType+" is not supported by this method");return new l(this,{objectMode:"nodebuffer"!==this._outputType},t)}},e.exports=u},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(t,e,i){if(i.base64=!0,i.array=!0,i.string=!0,i.arraybuffer="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof Uint8Array,i.nodebuffer=void 0!==X,i.uint8array="undefined"!=typeof Uint8Array,"undefined"==typeof ArrayBuffer)i.blob=!1;else{var s=new ArrayBuffer(0);try{i.blob=0===new Blob([s],{type:"application/zip"}).size}catch(t){try{var n=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);n.append(s),i.blob=0===n.getBlob("application/zip").size}catch(t){i.blob=!1}}}try{i.nodestream=!!t("readable-stream").Readable}catch(t){i.nodestream=!1}},{"readable-stream":16}],31:[function(t,e,i){for(var s=t("./utils"),n=t("./support"),r=t("./nodejsUtils"),o=t("./stream/GenericWorker"),a=new Array(256),h=0;h<256;h++)a[h]=252<=h?6:248<=h?5:240<=h?4:224<=h?3:192<=h?2:1;function l(){o.call(this,"utf-8 decode"),this.leftOver=null}function c(){o.call(this,"utf-8 encode")}a[254]=a[254]=1,i.utf8encode=function(t){return n.nodebuffer?r.newBufferFrom(t,"utf-8"):function(t){var e,i,s,r,o,a=t.length,h=0;for(r=0;r<a;r++)55296==(64512&(i=t.charCodeAt(r)))&&r+1<a&&56320==(64512&(s=t.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(s-56320),r++),h+=i<128?1:i<2048?2:i<65536?3:4;for(e=n.uint8array?new Uint8Array(h):new Array(h),r=o=0;o<h;r++)55296==(64512&(i=t.charCodeAt(r)))&&r+1<a&&56320==(64512&(s=t.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(s-56320),r++),i<128?e[o++]=i:(i<2048?e[o++]=192|i>>>6:(i<65536?e[o++]=224|i>>>12:(e[o++]=240|i>>>18,e[o++]=128|i>>>12&63),e[o++]=128|i>>>6&63),e[o++]=128|63&i);return e}(t)},i.utf8decode=function(t){return n.nodebuffer?s.transformTo("nodebuffer",t).toString("utf-8"):function(t){var e,i,n,r,o=t.length,h=new Array(2*o);for(e=i=0;e<o;)if((n=t[e++])<128)h[i++]=n;else if(4<(r=a[n]))h[i++]=65533,e+=r-1;else{for(n&=2===r?31:3===r?15:7;1<r&&e<o;)n=n<<6|63&t[e++],r--;1<r?h[i++]=65533:n<65536?h[i++]=n:(n-=65536,h[i++]=55296|n>>10&1023,h[i++]=56320|1023&n)}return h.length!==i&&(h.subarray?h=h.subarray(0,i):h.length=i),s.applyFromCharCode(h)}(t=s.transformTo(n.uint8array?"uint8array":"array",t))},s.inherits(l,o),l.prototype.processChunk=function(t){var e=s.transformTo(n.uint8array?"uint8array":"array",t.data);if(this.leftOver&&this.leftOver.length){if(n.uint8array){var r=e;(e=new Uint8Array(r.length+this.leftOver.length)).set(this.leftOver,0),e.set(r,this.leftOver.length)}else e=this.leftOver.concat(e);this.leftOver=null}var o=function(t,e){var i;for((e=e||t.length)>t.length&&(e=t.length),i=e-1;0<=i&&128==(192&t[i]);)i--;return i<0||0===i?e:i+a[t[i]]>e?i:e}(e),h=e;o!==e.length&&(n.uint8array?(h=e.subarray(0,o),this.leftOver=e.subarray(o,e.length)):(h=e.slice(0,o),this.leftOver=e.slice(o,e.length))),this.push({data:i.utf8decode(h),meta:t.meta})},l.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:i.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},i.Utf8DecodeWorker=l,s.inherits(c,o),c.prototype.processChunk=function(t){this.push({data:i.utf8encode(t.data),meta:t.meta})},i.Utf8EncodeWorker=c},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(t,e,i){var s=t("./support"),n=t("./base64"),r=t("./nodejsUtils"),o=t("./external");function a(t){return t}function h(t,e){for(var i=0;i<t.length;++i)e[i]=255&t.charCodeAt(i);return e}t("setimmediate"),i.newBlob=function(t,e){i.checkSupport("blob");try{return new Blob([t],{type:e})}catch(i){try{var s=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return s.append(t),s.getBlob(e)}catch(t){throw new Error("Bug : can't construct the Blob.")}}};var l={stringifyByChunk:function(t,e,i){var s=[],n=0,r=t.length;if(r<=i)return String.fromCharCode.apply(null,t);for(;n<r;)"array"===e||"nodebuffer"===e?s.push(String.fromCharCode.apply(null,t.slice(n,Math.min(n+i,r)))):s.push(String.fromCharCode.apply(null,t.subarray(n,Math.min(n+i,r)))),n+=i;return s.join("")},stringifyByChar:function(t){for(var e="",i=0;i<t.length;i++)e+=String.fromCharCode(t[i]);return e},applyCanBeUsed:{uint8array:function(){try{return s.uint8array&&1===String.fromCharCode.apply(null,new Uint8Array(1)).length}catch(t){return!1}}(),nodebuffer:function(){try{return s.nodebuffer&&1===String.fromCharCode.apply(null,r.allocBuffer(1)).length}catch(t){return!1}}()}};function c(t){var e=65536,s=i.getTypeOf(t),n=!0;if("uint8array"===s?n=l.applyCanBeUsed.uint8array:"nodebuffer"===s&&(n=l.applyCanBeUsed.nodebuffer),n)for(;1<e;)try{return l.stringifyByChunk(t,s,e)}catch(t){e=Math.floor(e/2)}return l.stringifyByChar(t)}function u(t,e){for(var i=0;i<t.length;i++)e[i]=t[i];return e}i.applyFromCharCode=c;var d={};d.string={string:a,array:function(t){return h(t,new Array(t.length))},arraybuffer:function(t){return d.string.uint8array(t).buffer},uint8array:function(t){return h(t,new Uint8Array(t.length))},nodebuffer:function(t){return h(t,r.allocBuffer(t.length))}},d.array={string:c,array:a,arraybuffer:function(t){return new Uint8Array(t).buffer},uint8array:function(t){return new Uint8Array(t)},nodebuffer:function(t){return r.newBufferFrom(t)}},d.arraybuffer={string:function(t){return c(new Uint8Array(t))},array:function(t){return u(new Uint8Array(t),new Array(t.byteLength))},arraybuffer:a,uint8array:function(t){return new Uint8Array(t)},nodebuffer:function(t){return r.newBufferFrom(new Uint8Array(t))}},d.uint8array={string:c,array:function(t){return u(t,new Array(t.length))},arraybuffer:function(t){return t.buffer},uint8array:a,nodebuffer:function(t){return r.newBufferFrom(t)}},d.nodebuffer={string:c,array:function(t){return u(t,new Array(t.length))},arraybuffer:function(t){return d.nodebuffer.uint8array(t).buffer},uint8array:function(t){return u(t,new Uint8Array(t.length))},nodebuffer:a},i.transformTo=function(t,e){if(e=e||"",!t)return e;i.checkSupport(t);var s=i.getTypeOf(e);return d[s][t](e)},i.resolve=function(t){for(var e=t.split("/"),i=[],s=0;s<e.length;s++){var n=e[s];"."===n||""===n&&0!==s&&s!==e.length-1||(".."===n?i.pop():i.push(n))}return i.join("/")},i.getTypeOf=function(t){return"string"==typeof t?"string":"[object Array]"===Object.prototype.toString.call(t)?"array":s.nodebuffer&&r.isBuffer(t)?"nodebuffer":s.uint8array&&t instanceof Uint8Array?"uint8array":s.arraybuffer&&t instanceof ArrayBuffer?"arraybuffer":void 0},i.checkSupport=function(t){if(!s[t.toLowerCase()])throw new Error(t+" is not supported by this platform")},i.MAX_VALUE_16BITS=65535,i.MAX_VALUE_32BITS=-1,i.pretty=function(t){var e,i,s="";for(i=0;i<(t||"").length;i++)s+="\\x"+((e=t.charCodeAt(i))<16?"0":"")+e.toString(16).toUpperCase();return s},i.delay=function(t,e,i){setImmediate((function(){t.apply(i||null,e||[])}))},i.inherits=function(t,e){function i(){}i.prototype=e.prototype,t.prototype=new i},i.extend=function(){var t,e,i={};for(t=0;t<arguments.length;t++)for(e in arguments[t])Object.prototype.hasOwnProperty.call(arguments[t],e)&&void 0===i[e]&&(i[e]=arguments[t][e]);return i},i.prepareContent=function(t,e,r,a,l){return o.Promise.resolve(e).then((function(t){return s.blob&&(t instanceof Blob||-1!==["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(t)))&&"undefined"!=typeof FileReader?new o.Promise((function(e,i){var s=new FileReader;s.onload=function(t){e(t.target.result)},s.onerror=function(t){i(t.target.error)},s.readAsArrayBuffer(t)})):t})).then((function(e){var c,u=i.getTypeOf(e);return u?("arraybuffer"===u?e=i.transformTo("uint8array",e):"string"===u&&(l?e=n.decode(e):r&&!0!==a&&(e=h(c=e,s.uint8array?new Uint8Array(c.length):new Array(c.length)))),e):o.Promise.reject(new Error("Can't read the data of '"+t+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))}))}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(t,e,i){var s=t("./reader/readerFor"),n=t("./utils"),r=t("./signature"),o=t("./zipEntry"),a=t("./support");function h(t){this.files=[],this.loadOptions=t}h.prototype={checkSignature:function(t){if(!this.reader.readAndCheckSignature(t)){this.reader.index-=4;var e=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+n.pretty(e)+", expected "+n.pretty(t)+")")}},isSignature:function(t,e){var i=this.reader.index;this.reader.setIndex(t);var s=this.reader.readString(4)===e;return this.reader.setIndex(i),s},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var t=this.reader.readData(this.zipCommentLength),e=a.uint8array?"uint8array":"array",i=n.transformTo(e,t);this.zipComment=this.loadOptions.decodeFileName(i)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var t,e,i,s=this.zip64EndOfCentralSize-44;0<s;)t=this.reader.readInt(2),e=this.reader.readInt(4),i=this.reader.readData(e),this.zip64ExtensibleData[t]={id:t,length:e,value:i}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var t,e;for(t=0;t<this.files.length;t++)e=this.files[t],this.reader.setIndex(e.localHeaderOffset),this.checkSignature(r.LOCAL_FILE_HEADER),e.readLocalPart(this.reader),e.handleUTF8(),e.processAttributes()},readCentralDir:function(){var t;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(r.CENTRAL_FILE_HEADER);)(t=new o({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(t);if(this.centralDirRecords!==this.files.length&&0!==this.centralDirRecords&&0===this.files.length)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var t=this.reader.lastIndexOfSignature(r.CENTRAL_DIRECTORY_END);if(t<0)throw this.isSignature(0,r.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(t);var e=t;if(this.checkSignature(r.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===n.MAX_VALUE_16BITS||this.diskWithCentralDirStart===n.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===n.MAX_VALUE_16BITS||this.centralDirRecords===n.MAX_VALUE_16BITS||this.centralDirSize===n.MAX_VALUE_32BITS||this.centralDirOffset===n.MAX_VALUE_32BITS){if(this.zip64=!0,(t=this.reader.lastIndexOfSignature(r.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(t),this.checkSignature(r.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,r.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(r.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(r.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var i=this.centralDirOffset+this.centralDirSize;this.zip64&&(i+=20,i+=12+this.zip64EndOfCentralSize);var s=e-i;if(0<s)this.isSignature(e,r.CENTRAL_FILE_HEADER)||(this.reader.zero=s);else if(s<0)throw new Error("Corrupted zip: missing "+Math.abs(s)+" bytes.")},prepareReader:function(t){this.reader=s(t)},load:function(t){this.prepareReader(t),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},e.exports=h},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(t,e,i){var s=t("./reader/readerFor"),n=t("./utils"),r=t("./compressedObject"),o=t("./crc32"),a=t("./utf8"),h=t("./compressions"),l=t("./support");function c(t,e){this.options=t,this.loadOptions=e}c.prototype={isEncrypted:function(){return!(1&~this.bitFlag)},useUTF8:function(){return!(2048&~this.bitFlag)},readLocalPart:function(t){var e,i;if(t.skip(22),this.fileNameLength=t.readInt(2),i=t.readInt(2),this.fileName=t.readData(this.fileNameLength),t.skip(i),-1===this.compressedSize||-1===this.uncompressedSize)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if(null===(e=function(t){for(var e in h)if(Object.prototype.hasOwnProperty.call(h,e)&&h[e].magic===t)return h[e];return null}(this.compressionMethod)))throw new Error("Corrupted zip : compression "+n.pretty(this.compressionMethod)+" unknown (inner file : "+n.transformTo("string",this.fileName)+")");this.decompressed=new r(this.compressedSize,this.uncompressedSize,this.crc32,e,t.readData(this.compressedSize))},readCentralPart:function(t){this.versionMadeBy=t.readInt(2),t.skip(2),this.bitFlag=t.readInt(2),this.compressionMethod=t.readString(2),this.date=t.readDate(),this.crc32=t.readInt(4),this.compressedSize=t.readInt(4),this.uncompressedSize=t.readInt(4);var e=t.readInt(2);if(this.extraFieldsLength=t.readInt(2),this.fileCommentLength=t.readInt(2),this.diskNumberStart=t.readInt(2),this.internalFileAttributes=t.readInt(2),this.externalFileAttributes=t.readInt(4),this.localHeaderOffset=t.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");t.skip(e),this.readExtraFields(t),this.parseZIP64ExtraField(t),this.fileComment=t.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var t=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),0==t&&(this.dosPermissions=63&this.externalFileAttributes),3==t&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||"/"!==this.fileNameStr.slice(-1)||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var t=s(this.extraFields[1].value);this.uncompressedSize===n.MAX_VALUE_32BITS&&(this.uncompressedSize=t.readInt(8)),this.compressedSize===n.MAX_VALUE_32BITS&&(this.compressedSize=t.readInt(8)),this.localHeaderOffset===n.MAX_VALUE_32BITS&&(this.localHeaderOffset=t.readInt(8)),this.diskNumberStart===n.MAX_VALUE_32BITS&&(this.diskNumberStart=t.readInt(4))}},readExtraFields:function(t){var e,i,s,n=t.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});t.index+4<n;)e=t.readInt(2),i=t.readInt(2),s=t.readData(i),this.extraFields[e]={id:e,length:i,value:s};t.setIndex(n)},handleUTF8:function(){var t=l.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=a.utf8decode(this.fileName),this.fileCommentStr=a.utf8decode(this.fileComment);else{var e=this.findExtraFieldUnicodePath();if(null!==e)this.fileNameStr=e;else{var i=n.transformTo(t,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(i)}var s=this.findExtraFieldUnicodeComment();if(null!==s)this.fileCommentStr=s;else{var r=n.transformTo(t,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(r)}}},findExtraFieldUnicodePath:function(){var t=this.extraFields[28789];if(t){var e=s(t.value);return 1!==e.readInt(1)||o(this.fileName)!==e.readInt(4)?null:a.utf8decode(e.readData(t.length-5))}return null},findExtraFieldUnicodeComment:function(){var t=this.extraFields[25461];if(t){var e=s(t.value);return 1!==e.readInt(1)||o(this.fileComment)!==e.readInt(4)?null:a.utf8decode(e.readData(t.length-5))}return null}},e.exports=c},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(t,e,i){function s(t,e,i){this.name=t,this.dir=i.dir,this.date=i.date,this.comment=i.comment,this.unixPermissions=i.unixPermissions,this.dosPermissions=i.dosPermissions,this._data=e,this._dataBinary=i.binary,this.options={compression:i.compression,compressionOptions:i.compressionOptions}}var n=t("./stream/StreamHelper"),r=t("./stream/DataWorker"),o=t("./utf8"),a=t("./compressedObject"),h=t("./stream/GenericWorker");s.prototype={internalStream:function(t){var e=null,i="string";try{if(!t)throw new Error("No output type specified.");var s="string"===(i=t.toLowerCase())||"text"===i;"binarystring"!==i&&"text"!==i||(i="string"),e=this._decompressWorker();var r=!this._dataBinary;r&&!s&&(e=e.pipe(new o.Utf8EncodeWorker)),!r&&s&&(e=e.pipe(new o.Utf8DecodeWorker))}catch(t){(e=new h("error")).error(t)}return new n(e,i,"")},async:function(t,e){return this.internalStream(t).accumulate(e)},nodeStream:function(t,e){return this.internalStream(t||"nodebuffer").toNodejsStream(e)},_compressWorker:function(t,e){if(this._data instanceof a&&this._data.compression.magic===t.magic)return this._data.getCompressedWorker();var i=this._decompressWorker();return this._dataBinary||(i=i.pipe(new o.Utf8EncodeWorker)),a.createWorkerFrom(i,t,e)},_decompressWorker:function(){return this._data instanceof a?this._data.getContentWorker():this._data instanceof h?this._data:new r(this._data)}};for(var l=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],c=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},u=0;u<l.length;u++)s.prototype[l[u]]=c;e.exports=s},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(t,e,i){(function(t){var i,s,n=t.MutationObserver||t.WebKitMutationObserver;if(n){var r=0,o=new n(c),a=t.document.createTextNode("");o.observe(a,{characterData:!0}),i=function(){a.data=r=++r%2}}else if(t.setImmediate||void 0===t.MessageChannel)i="document"in t&&"onreadystatechange"in t.document.createElement("script")?function(){var e=t.document.createElement("script");e.onreadystatechange=function(){c(),e.onreadystatechange=null,e.parentNode.removeChild(e),e=null},t.document.documentElement.appendChild(e)}:function(){setTimeout(c,0)};else{var h=new t.MessageChannel;h.port1.onmessage=c,i=function(){h.port2.postMessage(0)}}var l=[];function c(){var t,e;s=!0;for(var i=l.length;i;){for(e=l,l=[],t=-1;++t<i;)e[t]();i=l.length}s=!1}e.exports=function(t){1!==l.push(t)||s||i()}}).call(this,void 0!==ye?ye:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],37:[function(t,e,i){var s=t("immediate");function n(){}var r={},o=["REJECTED"],a=["FULFILLED"],h=["PENDING"];function l(t){if("function"!=typeof t)throw new TypeError("resolver must be a function");this.state=h,this.queue=[],this.outcome=void 0,t!==n&&p(this,t)}function c(t,e,i){this.promise=t,"function"==typeof e&&(this.onFulfilled=e,this.callFulfilled=this.otherCallFulfilled),"function"==typeof i&&(this.onRejected=i,this.callRejected=this.otherCallRejected)}function u(t,e,i){s((function(){var s;try{s=e(i)}catch(e){return r.reject(t,e)}s===t?r.reject(t,new TypeError("Cannot resolve promise with itself")):r.resolve(t,s)}))}function d(t){var e=t&&t.then;if(t&&("object"==typeof t||"function"==typeof t)&&"function"==typeof e)return function(){e.apply(t,arguments)}}function p(t,e){var i=!1;function s(e){i||(i=!0,r.reject(t,e))}function n(e){i||(i=!0,r.resolve(t,e))}var o=f((function(){e(n,s)}));"error"===o.status&&s(o.value)}function f(t,e){var i={};try{i.value=t(e),i.status="success"}catch(t){i.status="error",i.value=t}return i}(e.exports=l).prototype.finally=function(t){if("function"!=typeof t)return this;var e=this.constructor;return this.then((function(i){return e.resolve(t()).then((function(){return i}))}),(function(i){return e.resolve(t()).then((function(){throw i}))}))},l.prototype.catch=function(t){return this.then(null,t)},l.prototype.then=function(t,e){if("function"!=typeof t&&this.state===a||"function"!=typeof e&&this.state===o)return this;var i=new this.constructor(n);return this.state!==h?u(i,this.state===a?t:e,this.outcome):this.queue.push(new c(i,t,e)),i},c.prototype.callFulfilled=function(t){r.resolve(this.promise,t)},c.prototype.otherCallFulfilled=function(t){u(this.promise,this.onFulfilled,t)},c.prototype.callRejected=function(t){r.reject(this.promise,t)},c.prototype.otherCallRejected=function(t){u(this.promise,this.onRejected,t)},r.resolve=function(t,e){var i=f(d,e);if("error"===i.status)return r.reject(t,i.value);var s=i.value;if(s)p(t,s);else{t.state=a,t.outcome=e;for(var n=-1,o=t.queue.length;++n<o;)t.queue[n].callFulfilled(e)}return t},r.reject=function(t,e){t.state=o,t.outcome=e;for(var i=-1,s=t.queue.length;++i<s;)t.queue[i].callRejected(e);return t},l.resolve=function(t){return t instanceof this?t:r.resolve(new this(n),t)},l.reject=function(t){var e=new this(n);return r.reject(e,t)},l.all=function(t){var e=this;if("[object Array]"!==Object.prototype.toString.call(t))return this.reject(new TypeError("must be an array"));var i=t.length,s=!1;if(!i)return this.resolve([]);for(var o=new Array(i),a=0,h=-1,l=new this(n);++h<i;)c(t[h],h);return l;function c(t,n){e.resolve(t).then((function(t){o[n]=t,++a!==i||s||(s=!0,r.resolve(l,o))}),(function(t){s||(s=!0,r.reject(l,t))}))}},l.race=function(t){var e=this;if("[object Array]"!==Object.prototype.toString.call(t))return this.reject(new TypeError("must be an array"));var i=t.length,s=!1;if(!i)return this.resolve([]);for(var o,a=-1,h=new this(n);++a<i;)o=t[a],e.resolve(o).then((function(t){s||(s=!0,r.resolve(h,t))}),(function(t){s||(s=!0,r.reject(h,t))}));return h}},{immediate:36}],38:[function(t,e,i){var s={};(0,t("./lib/utils/common").assign)(s,t("./lib/deflate"),t("./lib/inflate"),t("./lib/zlib/constants")),e.exports=s},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(t,e,i){var s=t("./zlib/deflate"),n=t("./utils/common"),r=t("./utils/strings"),o=t("./zlib/messages"),a=t("./zlib/zstream"),h=Object.prototype.toString,l=0,c=-1,u=0,d=8;function p(t){if(!(this instanceof p))return new p(t);this.options=n.assign({level:c,method:d,chunkSize:16384,windowBits:15,memLevel:8,strategy:u,to:""},t||{});var e=this.options;e.raw&&0<e.windowBits?e.windowBits=-e.windowBits:e.gzip&&0<e.windowBits&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new a,this.strm.avail_out=0;var i=s.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(i!==l)throw new Error(o[i]);if(e.header&&s.deflateSetHeader(this.strm,e.header),e.dictionary){var f;if(f="string"==typeof e.dictionary?r.string2buf(e.dictionary):"[object ArrayBuffer]"===h.call(e.dictionary)?new Uint8Array(e.dictionary):e.dictionary,(i=s.deflateSetDictionary(this.strm,f))!==l)throw new Error(o[i]);this._dict_set=!0}}function f(t,e){var i=new p(e);if(i.push(t,!0),i.err)throw i.msg||o[i.err];return i.result}p.prototype.push=function(t,e){var i,o,a=this.strm,c=this.options.chunkSize;if(this.ended)return!1;o=e===~~e?e:!0===e?4:0,"string"==typeof t?a.input=r.string2buf(t):"[object ArrayBuffer]"===h.call(t)?a.input=new Uint8Array(t):a.input=t,a.next_in=0,a.avail_in=a.input.length;do{if(0===a.avail_out&&(a.output=new n.Buf8(c),a.next_out=0,a.avail_out=c),1!==(i=s.deflate(a,o))&&i!==l)return this.onEnd(i),!(this.ended=!0);0!==a.avail_out&&(0!==a.avail_in||4!==o&&2!==o)||("string"===this.options.to?this.onData(r.buf2binstring(n.shrinkBuf(a.output,a.next_out))):this.onData(n.shrinkBuf(a.output,a.next_out)))}while((0<a.avail_in||0===a.avail_out)&&1!==i);return 4===o?(i=s.deflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===l):2!==o||(this.onEnd(l),!(a.avail_out=0))},p.prototype.onData=function(t){this.chunks.push(t)},p.prototype.onEnd=function(t){t===l&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg},i.Deflate=p,i.deflate=f,i.deflateRaw=function(t,e){return(e=e||{}).raw=!0,f(t,e)},i.gzip=function(t,e){return(e=e||{}).gzip=!0,f(t,e)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(t,e,i){var s=t("./zlib/inflate"),n=t("./utils/common"),r=t("./utils/strings"),o=t("./zlib/constants"),a=t("./zlib/messages"),h=t("./zlib/zstream"),l=t("./zlib/gzheader"),c=Object.prototype.toString;function u(t){if(!(this instanceof u))return new u(t);this.options=n.assign({chunkSize:16384,windowBits:0,to:""},t||{});var e=this.options;e.raw&&0<=e.windowBits&&e.windowBits<16&&(e.windowBits=-e.windowBits,0===e.windowBits&&(e.windowBits=-15)),!(0<=e.windowBits&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),15<e.windowBits&&e.windowBits<48&&!(15&e.windowBits)&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new h,this.strm.avail_out=0;var i=s.inflateInit2(this.strm,e.windowBits);if(i!==o.Z_OK)throw new Error(a[i]);this.header=new l,s.inflateGetHeader(this.strm,this.header)}function d(t,e){var i=new u(e);if(i.push(t,!0),i.err)throw i.msg||a[i.err];return i.result}u.prototype.push=function(t,e){var i,a,h,l,u,d,p=this.strm,f=this.options.chunkSize,m=this.options.dictionary,g=!1;if(this.ended)return!1;a=e===~~e?e:!0===e?o.Z_FINISH:o.Z_NO_FLUSH,"string"==typeof t?p.input=r.binstring2buf(t):"[object ArrayBuffer]"===c.call(t)?p.input=new Uint8Array(t):p.input=t,p.next_in=0,p.avail_in=p.input.length;do{if(0===p.avail_out&&(p.output=new n.Buf8(f),p.next_out=0,p.avail_out=f),(i=s.inflate(p,o.Z_NO_FLUSH))===o.Z_NEED_DICT&&m&&(d="string"==typeof m?r.string2buf(m):"[object ArrayBuffer]"===c.call(m)?new Uint8Array(m):m,i=s.inflateSetDictionary(this.strm,d)),i===o.Z_BUF_ERROR&&!0===g&&(i=o.Z_OK,g=!1),i!==o.Z_STREAM_END&&i!==o.Z_OK)return this.onEnd(i),!(this.ended=!0);p.next_out&&(0!==p.avail_out&&i!==o.Z_STREAM_END&&(0!==p.avail_in||a!==o.Z_FINISH&&a!==o.Z_SYNC_FLUSH)||("string"===this.options.to?(h=r.utf8border(p.output,p.next_out),l=p.next_out-h,u=r.buf2string(p.output,h),p.next_out=l,p.avail_out=f-l,l&&n.arraySet(p.output,p.output,h,l,0),this.onData(u)):this.onData(n.shrinkBuf(p.output,p.next_out)))),0===p.avail_in&&0===p.avail_out&&(g=!0)}while((0<p.avail_in||0===p.avail_out)&&i!==o.Z_STREAM_END);return i===o.Z_STREAM_END&&(a=o.Z_FINISH),a===o.Z_FINISH?(i=s.inflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===o.Z_OK):a!==o.Z_SYNC_FLUSH||(this.onEnd(o.Z_OK),!(p.avail_out=0))},u.prototype.onData=function(t){this.chunks.push(t)},u.prototype.onEnd=function(t){t===o.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg},i.Inflate=u,i.inflate=d,i.inflateRaw=function(t,e){return(e=e||{}).raw=!0,d(t,e)},i.ungzip=d},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(t,e,i){var s="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;i.assign=function(t){for(var e=Array.prototype.slice.call(arguments,1);e.length;){var i=e.shift();if(i){if("object"!=typeof i)throw new TypeError(i+"must be non-object");for(var s in i)i.hasOwnProperty(s)&&(t[s]=i[s])}}return t},i.shrinkBuf=function(t,e){return t.length===e?t:t.subarray?t.subarray(0,e):(t.length=e,t)};var n={arraySet:function(t,e,i,s,n){if(e.subarray&&t.subarray)t.set(e.subarray(i,i+s),n);else for(var r=0;r<s;r++)t[n+r]=e[i+r]},flattenChunks:function(t){var e,i,s,n,r,o;for(e=s=0,i=t.length;e<i;e++)s+=t[e].length;for(o=new Uint8Array(s),e=n=0,i=t.length;e<i;e++)r=t[e],o.set(r,n),n+=r.length;return o}},r={arraySet:function(t,e,i,s,n){for(var r=0;r<s;r++)t[n+r]=e[i+r]},flattenChunks:function(t){return[].concat.apply([],t)}};i.setTyped=function(t){t?(i.Buf8=Uint8Array,i.Buf16=Uint16Array,i.Buf32=Int32Array,i.assign(i,n)):(i.Buf8=Array,i.Buf16=Array,i.Buf32=Array,i.assign(i,r))},i.setTyped(s)},{}],42:[function(t,e,i){var s=t("./common"),n=!0,r=!0;try{String.fromCharCode.apply(null,[0])}catch(t){n=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(t){r=!1}for(var o=new s.Buf8(256),a=0;a<256;a++)o[a]=252<=a?6:248<=a?5:240<=a?4:224<=a?3:192<=a?2:1;function h(t,e){if(e<65537&&(t.subarray&&r||!t.subarray&&n))return String.fromCharCode.apply(null,s.shrinkBuf(t,e));for(var i="",o=0;o<e;o++)i+=String.fromCharCode(t[o]);return i}o[254]=o[254]=1,i.string2buf=function(t){var e,i,n,r,o,a=t.length,h=0;for(r=0;r<a;r++)55296==(64512&(i=t.charCodeAt(r)))&&r+1<a&&56320==(64512&(n=t.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(n-56320),r++),h+=i<128?1:i<2048?2:i<65536?3:4;for(e=new s.Buf8(h),r=o=0;o<h;r++)55296==(64512&(i=t.charCodeAt(r)))&&r+1<a&&56320==(64512&(n=t.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(n-56320),r++),i<128?e[o++]=i:(i<2048?e[o++]=192|i>>>6:(i<65536?e[o++]=224|i>>>12:(e[o++]=240|i>>>18,e[o++]=128|i>>>12&63),e[o++]=128|i>>>6&63),e[o++]=128|63&i);return e},i.buf2binstring=function(t){return h(t,t.length)},i.binstring2buf=function(t){for(var e=new s.Buf8(t.length),i=0,n=e.length;i<n;i++)e[i]=t.charCodeAt(i);return e},i.buf2string=function(t,e){var i,s,n,r,a=e||t.length,l=new Array(2*a);for(i=s=0;i<a;)if((n=t[i++])<128)l[s++]=n;else if(4<(r=o[n]))l[s++]=65533,i+=r-1;else{for(n&=2===r?31:3===r?15:7;1<r&&i<a;)n=n<<6|63&t[i++],r--;1<r?l[s++]=65533:n<65536?l[s++]=n:(n-=65536,l[s++]=55296|n>>10&1023,l[s++]=56320|1023&n)}return h(l,s)},i.utf8border=function(t,e){var i;for((e=e||t.length)>t.length&&(e=t.length),i=e-1;0<=i&&128==(192&t[i]);)i--;return i<0||0===i?e:i+o[t[i]]>e?i:e}},{"./common":41}],43:[function(t,e,i){e.exports=function(t,e,i,s){for(var n=65535&t,r=t>>>16&65535,o=0;0!==i;){for(i-=o=2e3<i?2e3:i;r=r+(n=n+e[s++]|0)|0,--o;);n%=65521,r%=65521}return n|r<<16}},{}],44:[function(t,e,i){e.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(t,e,i){var s=function(){for(var t,e=[],i=0;i<256;i++){t=i;for(var s=0;s<8;s++)t=1&t?3988292384^t>>>1:t>>>1;e[i]=t}return e}();e.exports=function(t,e,i,n){var r=s,o=n+i;t^=-1;for(var a=n;a<o;a++)t=t>>>8^r[255&(t^e[a])];return~t}},{}],46:[function(t,e,i){var s,n=t("../utils/common"),r=t("./trees"),o=t("./adler32"),a=t("./crc32"),h=t("./messages"),l=0,c=4,u=0,d=-2,p=-1,f=4,m=2,g=8,_=9,y=286,w=30,v=19,b=2*y+1,x=15,E=3,T=258,A=T+E+1,C=42,S=113,O=1,P=2,I=3,D=4;function k(t,e){return t.msg=h[e],e}function z(t){return(t<<1)-(4<t?9:0)}function M(t){for(var e=t.length;0<=--e;)t[e]=0}function B(t){var e=t.state,i=e.pending;i>t.avail_out&&(i=t.avail_out),0!==i&&(n.arraySet(t.output,e.pending_buf,e.pending_out,i,t.next_out),t.next_out+=i,e.pending_out+=i,t.total_out+=i,t.avail_out-=i,e.pending-=i,0===e.pending&&(e.pending_out=0))}function U(t,e){r._tr_flush_block(t,0<=t.block_start?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,B(t.strm)}function R(t,e){t.pending_buf[t.pending++]=e}function N(t,e){t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e}function L(t,e){var i,s,n=t.max_chain_length,r=t.strstart,o=t.prev_length,a=t.nice_match,h=t.strstart>t.w_size-A?t.strstart-(t.w_size-A):0,l=t.window,c=t.w_mask,u=t.prev,d=t.strstart+T,p=l[r+o-1],f=l[r+o];t.prev_length>=t.good_match&&(n>>=2),a>t.lookahead&&(a=t.lookahead);do{if(l[(i=e)+o]===f&&l[i+o-1]===p&&l[i]===l[r]&&l[++i]===l[r+1]){r+=2,i++;do{}while(l[++r]===l[++i]&&l[++r]===l[++i]&&l[++r]===l[++i]&&l[++r]===l[++i]&&l[++r]===l[++i]&&l[++r]===l[++i]&&l[++r]===l[++i]&&l[++r]===l[++i]&&r<d);if(s=T-(d-r),r=d-T,o<s){if(t.match_start=e,a<=(o=s))break;p=l[r+o-1],f=l[r+o]}}}while((e=u[e&c])>h&&0!=--n);return o<=t.lookahead?o:t.lookahead}function F(t){var e,i,s,r,h,l,c,u,d,p,f=t.w_size;do{if(r=t.window_size-t.lookahead-t.strstart,t.strstart>=f+(f-A)){for(n.arraySet(t.window,t.window,f,f,0),t.match_start-=f,t.strstart-=f,t.block_start-=f,e=i=t.hash_size;s=t.head[--e],t.head[e]=f<=s?s-f:0,--i;);for(e=i=f;s=t.prev[--e],t.prev[e]=f<=s?s-f:0,--i;);r+=f}if(0===t.strm.avail_in)break;if(l=t.strm,c=t.window,u=t.strstart+t.lookahead,p=void 0,(d=r)<(p=l.avail_in)&&(p=d),i=0===p?0:(l.avail_in-=p,n.arraySet(c,l.input,l.next_in,p,u),1===l.state.wrap?l.adler=o(l.adler,c,p,u):2===l.state.wrap&&(l.adler=a(l.adler,c,p,u)),l.next_in+=p,l.total_in+=p,p),t.lookahead+=i,t.lookahead+t.insert>=E)for(h=t.strstart-t.insert,t.ins_h=t.window[h],t.ins_h=(t.ins_h<<t.hash_shift^t.window[h+1])&t.hash_mask;t.insert&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[h+E-1])&t.hash_mask,t.prev[h&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=h,h++,t.insert--,!(t.lookahead+t.insert<E)););}while(t.lookahead<A&&0!==t.strm.avail_in)}function V(t,e){for(var i,s;;){if(t.lookahead<A){if(F(t),t.lookahead<A&&e===l)return O;if(0===t.lookahead)break}if(i=0,t.lookahead>=E&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+E-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),0!==i&&t.strstart-i<=t.w_size-A&&(t.match_length=L(t,i)),t.match_length>=E)if(s=r._tr_tally(t,t.strstart-t.match_start,t.match_length-E),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=E){for(t.match_length--;t.strstart++,t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+E-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart,0!=--t.match_length;);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+1])&t.hash_mask;else s=r._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(s&&(U(t,!1),0===t.strm.avail_out))return O}return t.insert=t.strstart<E-1?t.strstart:E-1,e===c?(U(t,!0),0===t.strm.avail_out?I:D):t.last_lit&&(U(t,!1),0===t.strm.avail_out)?O:P}function j(t,e){for(var i,s,n;;){if(t.lookahead<A){if(F(t),t.lookahead<A&&e===l)return O;if(0===t.lookahead)break}if(i=0,t.lookahead>=E&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+E-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=E-1,0!==i&&t.prev_length<t.max_lazy_match&&t.strstart-i<=t.w_size-A&&(t.match_length=L(t,i),t.match_length<=5&&(1===t.strategy||t.match_length===E&&4096<t.strstart-t.match_start)&&(t.match_length=E-1)),t.prev_length>=E&&t.match_length<=t.prev_length){for(n=t.strstart+t.lookahead-E,s=r._tr_tally(t,t.strstart-1-t.prev_match,t.prev_length-E),t.lookahead-=t.prev_length-1,t.prev_length-=2;++t.strstart<=n&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+E-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),0!=--t.prev_length;);if(t.match_available=0,t.match_length=E-1,t.strstart++,s&&(U(t,!1),0===t.strm.avail_out))return O}else if(t.match_available){if((s=r._tr_tally(t,0,t.window[t.strstart-1]))&&U(t,!1),t.strstart++,t.lookahead--,0===t.strm.avail_out)return O}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(s=r._tr_tally(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<E-1?t.strstart:E-1,e===c?(U(t,!0),0===t.strm.avail_out?I:D):t.last_lit&&(U(t,!1),0===t.strm.avail_out)?O:P}function Y(t,e,i,s,n){this.good_length=t,this.max_lazy=e,this.nice_length=i,this.max_chain=s,this.func=n}function Z(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=g,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new n.Buf16(2*b),this.dyn_dtree=new n.Buf16(2*(2*w+1)),this.bl_tree=new n.Buf16(2*(2*v+1)),M(this.dyn_ltree),M(this.dyn_dtree),M(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new n.Buf16(x+1),this.heap=new n.Buf16(2*y+1),M(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new n.Buf16(2*y+1),M(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function H(t){var e;return t&&t.state?(t.total_in=t.total_out=0,t.data_type=m,(e=t.state).pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap?C:S,t.adler=2===e.wrap?0:1,e.last_flush=l,r._tr_init(e),u):k(t,d)}function $(t){var e,i=H(t);return i===u&&((e=t.state).window_size=2*e.w_size,M(e.head),e.max_lazy_match=s[e.level].max_lazy,e.good_match=s[e.level].good_length,e.nice_match=s[e.level].nice_length,e.max_chain_length=s[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=E-1,e.match_available=0,e.ins_h=0),i}function W(t,e,i,s,r,o){if(!t)return d;var a=1;if(e===p&&(e=6),s<0?(a=0,s=-s):15<s&&(a=2,s-=16),r<1||_<r||i!==g||s<8||15<s||e<0||9<e||o<0||f<o)return k(t,d);8===s&&(s=9);var h=new Z;return(t.state=h).strm=t,h.wrap=a,h.gzhead=null,h.w_bits=s,h.w_size=1<<h.w_bits,h.w_mask=h.w_size-1,h.hash_bits=r+7,h.hash_size=1<<h.hash_bits,h.hash_mask=h.hash_size-1,h.hash_shift=~~((h.hash_bits+E-1)/E),h.window=new n.Buf8(2*h.w_size),h.head=new n.Buf16(h.hash_size),h.prev=new n.Buf16(h.w_size),h.lit_bufsize=1<<r+6,h.pending_buf_size=4*h.lit_bufsize,h.pending_buf=new n.Buf8(h.pending_buf_size),h.d_buf=1*h.lit_bufsize,h.l_buf=3*h.lit_bufsize,h.level=e,h.strategy=o,h.method=i,$(t)}s=[new Y(0,0,0,0,(function(t,e){var i=65535;for(i>t.pending_buf_size-5&&(i=t.pending_buf_size-5);;){if(t.lookahead<=1){if(F(t),0===t.lookahead&&e===l)return O;if(0===t.lookahead)break}t.strstart+=t.lookahead,t.lookahead=0;var s=t.block_start+i;if((0===t.strstart||t.strstart>=s)&&(t.lookahead=t.strstart-s,t.strstart=s,U(t,!1),0===t.strm.avail_out))return O;if(t.strstart-t.block_start>=t.w_size-A&&(U(t,!1),0===t.strm.avail_out))return O}return t.insert=0,e===c?(U(t,!0),0===t.strm.avail_out?I:D):(t.strstart>t.block_start&&(U(t,!1),t.strm.avail_out),O)})),new Y(4,4,8,4,V),new Y(4,5,16,8,V),new Y(4,6,32,32,V),new Y(4,4,16,16,j),new Y(8,16,32,32,j),new Y(8,16,128,128,j),new Y(8,32,128,256,j),new Y(32,128,258,1024,j),new Y(32,258,258,4096,j)],i.deflateInit=function(t,e){return W(t,e,g,15,8,0)},i.deflateInit2=W,i.deflateReset=$,i.deflateResetKeep=H,i.deflateSetHeader=function(t,e){return t&&t.state?2!==t.state.wrap?d:(t.state.gzhead=e,u):d},i.deflate=function(t,e){var i,n,o,h;if(!t||!t.state||5<e||e<0)return t?k(t,d):d;if(n=t.state,!t.output||!t.input&&0!==t.avail_in||666===n.status&&e!==c)return k(t,0===t.avail_out?-5:d);if(n.strm=t,i=n.last_flush,n.last_flush=e,n.status===C)if(2===n.wrap)t.adler=0,R(n,31),R(n,139),R(n,8),n.gzhead?(R(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),R(n,255&n.gzhead.time),R(n,n.gzhead.time>>8&255),R(n,n.gzhead.time>>16&255),R(n,n.gzhead.time>>24&255),R(n,9===n.level?2:2<=n.strategy||n.level<2?4:0),R(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(R(n,255&n.gzhead.extra.length),R(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(t.adler=a(t.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69):(R(n,0),R(n,0),R(n,0),R(n,0),R(n,0),R(n,9===n.level?2:2<=n.strategy||n.level<2?4:0),R(n,3),n.status=S);else{var p=g+(n.w_bits-8<<4)<<8;p|=(2<=n.strategy||n.level<2?0:n.level<6?1:6===n.level?2:3)<<6,0!==n.strstart&&(p|=32),p+=31-p%31,n.status=S,N(n,p),0!==n.strstart&&(N(n,t.adler>>>16),N(n,65535&t.adler)),t.adler=1}if(69===n.status)if(n.gzhead.extra){for(o=n.pending;n.gzindex<(65535&n.gzhead.extra.length)&&(n.pending!==n.pending_buf_size||(n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),B(t),o=n.pending,n.pending!==n.pending_buf_size));)R(n,255&n.gzhead.extra[n.gzindex]),n.gzindex++;n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),n.gzindex===n.gzhead.extra.length&&(n.gzindex=0,n.status=73)}else n.status=73;if(73===n.status)if(n.gzhead.name){o=n.pending;do{if(n.pending===n.pending_buf_size&&(n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),B(t),o=n.pending,n.pending===n.pending_buf_size)){h=1;break}h=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,R(n,h)}while(0!==h);n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),0===h&&(n.gzindex=0,n.status=91)}else n.status=91;if(91===n.status)if(n.gzhead.comment){o=n.pending;do{if(n.pending===n.pending_buf_size&&(n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),B(t),o=n.pending,n.pending===n.pending_buf_size)){h=1;break}h=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,R(n,h)}while(0!==h);n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),0===h&&(n.status=103)}else n.status=103;if(103===n.status&&(n.gzhead.hcrc?(n.pending+2>n.pending_buf_size&&B(t),n.pending+2<=n.pending_buf_size&&(R(n,255&t.adler),R(n,t.adler>>8&255),t.adler=0,n.status=S)):n.status=S),0!==n.pending){if(B(t),0===t.avail_out)return n.last_flush=-1,u}else if(0===t.avail_in&&z(e)<=z(i)&&e!==c)return k(t,-5);if(666===n.status&&0!==t.avail_in)return k(t,-5);if(0!==t.avail_in||0!==n.lookahead||e!==l&&666!==n.status){var f=2===n.strategy?function(t,e){for(var i;;){if(0===t.lookahead&&(F(t),0===t.lookahead)){if(e===l)return O;break}if(t.match_length=0,i=r._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++,i&&(U(t,!1),0===t.strm.avail_out))return O}return t.insert=0,e===c?(U(t,!0),0===t.strm.avail_out?I:D):t.last_lit&&(U(t,!1),0===t.strm.avail_out)?O:P}(n,e):3===n.strategy?function(t,e){for(var i,s,n,o,a=t.window;;){if(t.lookahead<=T){if(F(t),t.lookahead<=T&&e===l)return O;if(0===t.lookahead)break}if(t.match_length=0,t.lookahead>=E&&0<t.strstart&&(s=a[n=t.strstart-1])===a[++n]&&s===a[++n]&&s===a[++n]){o=t.strstart+T;do{}while(s===a[++n]&&s===a[++n]&&s===a[++n]&&s===a[++n]&&s===a[++n]&&s===a[++n]&&s===a[++n]&&s===a[++n]&&n<o);t.match_length=T-(o-n),t.match_length>t.lookahead&&(t.match_length=t.lookahead)}if(t.match_length>=E?(i=r._tr_tally(t,1,t.match_length-E),t.lookahead-=t.match_length,t.strstart+=t.match_length,t.match_length=0):(i=r._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++),i&&(U(t,!1),0===t.strm.avail_out))return O}return t.insert=0,e===c?(U(t,!0),0===t.strm.avail_out?I:D):t.last_lit&&(U(t,!1),0===t.strm.avail_out)?O:P}(n,e):s[n.level].func(n,e);if(f!==I&&f!==D||(n.status=666),f===O||f===I)return 0===t.avail_out&&(n.last_flush=-1),u;if(f===P&&(1===e?r._tr_align(n):5!==e&&(r._tr_stored_block(n,0,0,!1),3===e&&(M(n.head),0===n.lookahead&&(n.strstart=0,n.block_start=0,n.insert=0))),B(t),0===t.avail_out))return n.last_flush=-1,u}return e!==c?u:n.wrap<=0?1:(2===n.wrap?(R(n,255&t.adler),R(n,t.adler>>8&255),R(n,t.adler>>16&255),R(n,t.adler>>24&255),R(n,255&t.total_in),R(n,t.total_in>>8&255),R(n,t.total_in>>16&255),R(n,t.total_in>>24&255)):(N(n,t.adler>>>16),N(n,65535&t.adler)),B(t),0<n.wrap&&(n.wrap=-n.wrap),0!==n.pending?u:1)},i.deflateEnd=function(t){var e;return t&&t.state?(e=t.state.status)!==C&&69!==e&&73!==e&&91!==e&&103!==e&&e!==S&&666!==e?k(t,d):(t.state=null,e===S?k(t,-3):u):d},i.deflateSetDictionary=function(t,e){var i,s,r,a,h,l,c,p,f=e.length;if(!t||!t.state)return d;if(2===(a=(i=t.state).wrap)||1===a&&i.status!==C||i.lookahead)return d;for(1===a&&(t.adler=o(t.adler,e,f,0)),i.wrap=0,f>=i.w_size&&(0===a&&(M(i.head),i.strstart=0,i.block_start=0,i.insert=0),p=new n.Buf8(i.w_size),n.arraySet(p,e,f-i.w_size,i.w_size,0),e=p,f=i.w_size),h=t.avail_in,l=t.next_in,c=t.input,t.avail_in=f,t.next_in=0,t.input=e,F(i);i.lookahead>=E;){for(s=i.strstart,r=i.lookahead-(E-1);i.ins_h=(i.ins_h<<i.hash_shift^i.window[s+E-1])&i.hash_mask,i.prev[s&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=s,s++,--r;);i.strstart=s,i.lookahead=E-1,F(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=E-1,i.match_available=0,t.next_in=l,t.input=c,t.avail_in=h,i.wrap=a,u},i.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(t,e,i){e.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(t,e,i){e.exports=function(t,e){var i,s,n,r,o,a,h,l,c,u,d,p,f,m,g,_,y,w,v,b,x,E,T,A,C;i=t.state,s=t.next_in,A=t.input,n=s+(t.avail_in-5),r=t.next_out,C=t.output,o=r-(e-t.avail_out),a=r+(t.avail_out-257),h=i.dmax,l=i.wsize,c=i.whave,u=i.wnext,d=i.window,p=i.hold,f=i.bits,m=i.lencode,g=i.distcode,_=(1<<i.lenbits)-1,y=(1<<i.distbits)-1;t:do{f<15&&(p+=A[s++]<<f,f+=8,p+=A[s++]<<f,f+=8),w=m[p&_];e:for(;;){if(p>>>=v=w>>>24,f-=v,0==(v=w>>>16&255))C[r++]=65535&w;else{if(!(16&v)){if(!(64&v)){w=m[(65535&w)+(p&(1<<v)-1)];continue e}if(32&v){i.mode=12;break t}t.msg="invalid literal/length code",i.mode=30;break t}b=65535&w,(v&=15)&&(f<v&&(p+=A[s++]<<f,f+=8),b+=p&(1<<v)-1,p>>>=v,f-=v),f<15&&(p+=A[s++]<<f,f+=8,p+=A[s++]<<f,f+=8),w=g[p&y];i:for(;;){if(p>>>=v=w>>>24,f-=v,!(16&(v=w>>>16&255))){if(!(64&v)){w=g[(65535&w)+(p&(1<<v)-1)];continue i}t.msg="invalid distance code",i.mode=30;break t}if(x=65535&w,f<(v&=15)&&(p+=A[s++]<<f,(f+=8)<v&&(p+=A[s++]<<f,f+=8)),h<(x+=p&(1<<v)-1)){t.msg="invalid distance too far back",i.mode=30;break t}if(p>>>=v,f-=v,(v=r-o)<x){if(c<(v=x-v)&&i.sane){t.msg="invalid distance too far back",i.mode=30;break t}if(T=d,(E=0)===u){if(E+=l-v,v<b){for(b-=v;C[r++]=d[E++],--v;);E=r-x,T=C}}else if(u<v){if(E+=l+u-v,(v-=u)<b){for(b-=v;C[r++]=d[E++],--v;);if(E=0,u<b){for(b-=v=u;C[r++]=d[E++],--v;);E=r-x,T=C}}}else if(E+=u-v,v<b){for(b-=v;C[r++]=d[E++],--v;);E=r-x,T=C}for(;2<b;)C[r++]=T[E++],C[r++]=T[E++],C[r++]=T[E++],b-=3;b&&(C[r++]=T[E++],1<b&&(C[r++]=T[E++]))}else{for(E=r-x;C[r++]=C[E++],C[r++]=C[E++],C[r++]=C[E++],2<(b-=3););b&&(C[r++]=C[E++],1<b&&(C[r++]=C[E++]))}break}}break}}while(s<n&&r<a);s-=b=f>>3,p&=(1<<(f-=b<<3))-1,t.next_in=s,t.next_out=r,t.avail_in=s<n?n-s+5:5-(s-n),t.avail_out=r<a?a-r+257:257-(r-a),i.hold=p,i.bits=f}},{}],49:[function(t,e,i){var s=t("../utils/common"),n=t("./adler32"),r=t("./crc32"),o=t("./inffast"),a=t("./inftrees"),h=1,l=2,c=0,u=-2,d=1,p=852,f=592;function m(t){return(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24)}function g(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new s.Buf16(320),this.work=new s.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function _(t){var e;return t&&t.state?(e=t.state,t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=d,e.last=0,e.havedict=0,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new s.Buf32(p),e.distcode=e.distdyn=new s.Buf32(f),e.sane=1,e.back=-1,c):u}function y(t){var e;return t&&t.state?((e=t.state).wsize=0,e.whave=0,e.wnext=0,_(t)):u}function w(t,e){var i,s;return t&&t.state?(s=t.state,e<0?(i=0,e=-e):(i=1+(e>>4),e<48&&(e&=15)),e&&(e<8||15<e)?u:(null!==s.window&&s.wbits!==e&&(s.window=null),s.wrap=i,s.wbits=e,y(t))):u}function v(t,e){var i,s;return t?(s=new g,(t.state=s).window=null,(i=w(t,e))!==c&&(t.state=null),i):u}var b,x,E=!0;function T(t){if(E){var e;for(b=new s.Buf32(512),x=new s.Buf32(32),e=0;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(a(h,t.lens,0,288,b,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;a(l,t.lens,0,32,x,0,t.work,{bits:5}),E=!1}t.lencode=b,t.lenbits=9,t.distcode=x,t.distbits=5}function A(t,e,i,n){var r,o=t.state;return null===o.window&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new s.Buf8(o.wsize)),n>=o.wsize?(s.arraySet(o.window,e,i-o.wsize,o.wsize,0),o.wnext=0,o.whave=o.wsize):(n<(r=o.wsize-o.wnext)&&(r=n),s.arraySet(o.window,e,i-n,r,o.wnext),(n-=r)?(s.arraySet(o.window,e,i-n,n,0),o.wnext=n,o.whave=o.wsize):(o.wnext+=r,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=r))),0}i.inflateReset=y,i.inflateReset2=w,i.inflateResetKeep=_,i.inflateInit=function(t){return v(t,15)},i.inflateInit2=v,i.inflate=function(t,e){var i,p,f,g,_,y,w,v,b,x,E,C,S,O,P,I,D,k,z,M,B,U,R,N,L=0,F=new s.Buf8(4),V=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!t||!t.state||!t.output||!t.input&&0!==t.avail_in)return u;12===(i=t.state).mode&&(i.mode=13),_=t.next_out,f=t.output,w=t.avail_out,g=t.next_in,p=t.input,y=t.avail_in,v=i.hold,b=i.bits,x=y,E=w,U=c;t:for(;;)switch(i.mode){case d:if(0===i.wrap){i.mode=13;break}for(;b<16;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}if(2&i.wrap&&35615===v){F[i.check=0]=255&v,F[1]=v>>>8&255,i.check=r(i.check,F,2,0),b=v=0,i.mode=2;break}if(i.flags=0,i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&v)<<8)+(v>>8))%31){t.msg="incorrect header check",i.mode=30;break}if(8!=(15&v)){t.msg="unknown compression method",i.mode=30;break}if(b-=4,B=8+(15&(v>>>=4)),0===i.wbits)i.wbits=B;else if(B>i.wbits){t.msg="invalid window size",i.mode=30;break}i.dmax=1<<B,t.adler=i.check=1,i.mode=512&v?10:12,b=v=0;break;case 2:for(;b<16;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}if(i.flags=v,8!=(255&i.flags)){t.msg="unknown compression method",i.mode=30;break}if(57344&i.flags){t.msg="unknown header flags set",i.mode=30;break}i.head&&(i.head.text=v>>8&1),512&i.flags&&(F[0]=255&v,F[1]=v>>>8&255,i.check=r(i.check,F,2,0)),b=v=0,i.mode=3;case 3:for(;b<32;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}i.head&&(i.head.time=v),512&i.flags&&(F[0]=255&v,F[1]=v>>>8&255,F[2]=v>>>16&255,F[3]=v>>>24&255,i.check=r(i.check,F,4,0)),b=v=0,i.mode=4;case 4:for(;b<16;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}i.head&&(i.head.xflags=255&v,i.head.os=v>>8),512&i.flags&&(F[0]=255&v,F[1]=v>>>8&255,i.check=r(i.check,F,2,0)),b=v=0,i.mode=5;case 5:if(1024&i.flags){for(;b<16;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}i.length=v,i.head&&(i.head.extra_len=v),512&i.flags&&(F[0]=255&v,F[1]=v>>>8&255,i.check=r(i.check,F,2,0)),b=v=0}else i.head&&(i.head.extra=null);i.mode=6;case 6:if(1024&i.flags&&(y<(C=i.length)&&(C=y),C&&(i.head&&(B=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Array(i.head.extra_len)),s.arraySet(i.head.extra,p,g,C,B)),512&i.flags&&(i.check=r(i.check,p,C,g)),y-=C,g+=C,i.length-=C),i.length))break t;i.length=0,i.mode=7;case 7:if(2048&i.flags){if(0===y)break t;for(C=0;B=p[g+C++],i.head&&B&&i.length<65536&&(i.head.name+=String.fromCharCode(B)),B&&C<y;);if(512&i.flags&&(i.check=r(i.check,p,C,g)),y-=C,g+=C,B)break t}else i.head&&(i.head.name=null);i.length=0,i.mode=8;case 8:if(4096&i.flags){if(0===y)break t;for(C=0;B=p[g+C++],i.head&&B&&i.length<65536&&(i.head.comment+=String.fromCharCode(B)),B&&C<y;);if(512&i.flags&&(i.check=r(i.check,p,C,g)),y-=C,g+=C,B)break t}else i.head&&(i.head.comment=null);i.mode=9;case 9:if(512&i.flags){for(;b<16;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}if(v!==(65535&i.check)){t.msg="header crc mismatch",i.mode=30;break}b=v=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),t.adler=i.check=0,i.mode=12;break;case 10:for(;b<32;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}t.adler=i.check=m(v),b=v=0,i.mode=11;case 11:if(0===i.havedict)return t.next_out=_,t.avail_out=w,t.next_in=g,t.avail_in=y,i.hold=v,i.bits=b,2;t.adler=i.check=1,i.mode=12;case 12:if(5===e||6===e)break t;case 13:if(i.last){v>>>=7&b,b-=7&b,i.mode=27;break}for(;b<3;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}switch(i.last=1&v,b-=1,3&(v>>>=1)){case 0:i.mode=14;break;case 1:if(T(i),i.mode=20,6!==e)break;v>>>=2,b-=2;break t;case 2:i.mode=17;break;case 3:t.msg="invalid block type",i.mode=30}v>>>=2,b-=2;break;case 14:for(v>>>=7&b,b-=7&b;b<32;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}if((65535&v)!=(v>>>16^65535)){t.msg="invalid stored block lengths",i.mode=30;break}if(i.length=65535&v,b=v=0,i.mode=15,6===e)break t;case 15:i.mode=16;case 16:if(C=i.length){if(y<C&&(C=y),w<C&&(C=w),0===C)break t;s.arraySet(f,p,g,C,_),y-=C,g+=C,w-=C,_+=C,i.length-=C;break}i.mode=12;break;case 17:for(;b<14;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}if(i.nlen=257+(31&v),v>>>=5,b-=5,i.ndist=1+(31&v),v>>>=5,b-=5,i.ncode=4+(15&v),v>>>=4,b-=4,286<i.nlen||30<i.ndist){t.msg="too many length or distance symbols",i.mode=30;break}i.have=0,i.mode=18;case 18:for(;i.have<i.ncode;){for(;b<3;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}i.lens[V[i.have++]]=7&v,v>>>=3,b-=3}for(;i.have<19;)i.lens[V[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,R={bits:i.lenbits},U=a(0,i.lens,0,19,i.lencode,0,i.work,R),i.lenbits=R.bits,U){t.msg="invalid code lengths set",i.mode=30;break}i.have=0,i.mode=19;case 19:for(;i.have<i.nlen+i.ndist;){for(;I=(L=i.lencode[v&(1<<i.lenbits)-1])>>>16&255,D=65535&L,!((P=L>>>24)<=b);){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}if(D<16)v>>>=P,b-=P,i.lens[i.have++]=D;else{if(16===D){for(N=P+2;b<N;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}if(v>>>=P,b-=P,0===i.have){t.msg="invalid bit length repeat",i.mode=30;break}B=i.lens[i.have-1],C=3+(3&v),v>>>=2,b-=2}else if(17===D){for(N=P+3;b<N;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}b-=P,B=0,C=3+(7&(v>>>=P)),v>>>=3,b-=3}else{for(N=P+7;b<N;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}b-=P,B=0,C=11+(127&(v>>>=P)),v>>>=7,b-=7}if(i.have+C>i.nlen+i.ndist){t.msg="invalid bit length repeat",i.mode=30;break}for(;C--;)i.lens[i.have++]=B}}if(30===i.mode)break;if(0===i.lens[256]){t.msg="invalid code -- missing end-of-block",i.mode=30;break}if(i.lenbits=9,R={bits:i.lenbits},U=a(h,i.lens,0,i.nlen,i.lencode,0,i.work,R),i.lenbits=R.bits,U){t.msg="invalid literal/lengths set",i.mode=30;break}if(i.distbits=6,i.distcode=i.distdyn,R={bits:i.distbits},U=a(l,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,R),i.distbits=R.bits,U){t.msg="invalid distances set",i.mode=30;break}if(i.mode=20,6===e)break t;case 20:i.mode=21;case 21:if(6<=y&&258<=w){t.next_out=_,t.avail_out=w,t.next_in=g,t.avail_in=y,i.hold=v,i.bits=b,o(t,E),_=t.next_out,f=t.output,w=t.avail_out,g=t.next_in,p=t.input,y=t.avail_in,v=i.hold,b=i.bits,12===i.mode&&(i.back=-1);break}for(i.back=0;I=(L=i.lencode[v&(1<<i.lenbits)-1])>>>16&255,D=65535&L,!((P=L>>>24)<=b);){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}if(I&&!(240&I)){for(k=P,z=I,M=D;I=(L=i.lencode[M+((v&(1<<k+z)-1)>>k)])>>>16&255,D=65535&L,!(k+(P=L>>>24)<=b);){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}v>>>=k,b-=k,i.back+=k}if(v>>>=P,b-=P,i.back+=P,i.length=D,0===I){i.mode=26;break}if(32&I){i.back=-1,i.mode=12;break}if(64&I){t.msg="invalid literal/length code",i.mode=30;break}i.extra=15&I,i.mode=22;case 22:if(i.extra){for(N=i.extra;b<N;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}i.length+=v&(1<<i.extra)-1,v>>>=i.extra,b-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=23;case 23:for(;I=(L=i.distcode[v&(1<<i.distbits)-1])>>>16&255,D=65535&L,!((P=L>>>24)<=b);){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}if(!(240&I)){for(k=P,z=I,M=D;I=(L=i.distcode[M+((v&(1<<k+z)-1)>>k)])>>>16&255,D=65535&L,!(k+(P=L>>>24)<=b);){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}v>>>=k,b-=k,i.back+=k}if(v>>>=P,b-=P,i.back+=P,64&I){t.msg="invalid distance code",i.mode=30;break}i.offset=D,i.extra=15&I,i.mode=24;case 24:if(i.extra){for(N=i.extra;b<N;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}i.offset+=v&(1<<i.extra)-1,v>>>=i.extra,b-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){t.msg="invalid distance too far back",i.mode=30;break}i.mode=25;case 25:if(0===w)break t;if(C=E-w,i.offset>C){if((C=i.offset-C)>i.whave&&i.sane){t.msg="invalid distance too far back",i.mode=30;break}S=C>i.wnext?(C-=i.wnext,i.wsize-C):i.wnext-C,C>i.length&&(C=i.length),O=i.window}else O=f,S=_-i.offset,C=i.length;for(w<C&&(C=w),w-=C,i.length-=C;f[_++]=O[S++],--C;);0===i.length&&(i.mode=21);break;case 26:if(0===w)break t;f[_++]=i.length,w--,i.mode=21;break;case 27:if(i.wrap){for(;b<32;){if(0===y)break t;y--,v|=p[g++]<<b,b+=8}if(E-=w,t.total_out+=E,i.total+=E,E&&(t.adler=i.check=i.flags?r(i.check,f,E,_-E):n(i.check,f,E,_-E)),E=w,(i.flags?v:m(v))!==i.check){t.msg="incorrect data check",i.mode=30;break}b=v=0}i.mode=28;case 28:if(i.wrap&&i.flags){for(;b<32;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}if(v!==(4294967295&i.total)){t.msg="incorrect length check",i.mode=30;break}b=v=0}i.mode=29;case 29:U=1;break t;case 30:U=-3;break t;case 31:return-4;default:return u}return t.next_out=_,t.avail_out=w,t.next_in=g,t.avail_in=y,i.hold=v,i.bits=b,(i.wsize||E!==t.avail_out&&i.mode<30&&(i.mode<27||4!==e))&&A(t,t.output,t.next_out,E-t.avail_out)?(i.mode=31,-4):(x-=t.avail_in,E-=t.avail_out,t.total_in+=x,t.total_out+=E,i.total+=E,i.wrap&&E&&(t.adler=i.check=i.flags?r(i.check,f,E,t.next_out-E):n(i.check,f,E,t.next_out-E)),t.data_type=i.bits+(i.last?64:0)+(12===i.mode?128:0)+(20===i.mode||15===i.mode?256:0),(0==x&&0===E||4===e)&&U===c&&(U=-5),U)},i.inflateEnd=function(t){if(!t||!t.state)return u;var e=t.state;return e.window&&(e.window=null),t.state=null,c},i.inflateGetHeader=function(t,e){var i;return t&&t.state&&2&(i=t.state).wrap?((i.head=e).done=!1,c):u},i.inflateSetDictionary=function(t,e){var i,s=e.length;return t&&t.state?0!==(i=t.state).wrap&&11!==i.mode?u:11===i.mode&&n(1,e,s,0)!==i.check?-3:A(t,e,s,s)?(i.mode=31,-4):(i.havedict=1,c):u},i.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(t,e,i){var s=t("../utils/common"),n=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],r=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],o=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],a=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];e.exports=function(t,e,i,h,l,c,u,d){var p,f,m,g,_,y,w,v,b,x=d.bits,E=0,T=0,A=0,C=0,S=0,O=0,P=0,I=0,D=0,k=0,z=null,M=0,B=new s.Buf16(16),U=new s.Buf16(16),R=null,N=0;for(E=0;E<=15;E++)B[E]=0;for(T=0;T<h;T++)B[e[i+T]]++;for(S=x,C=15;1<=C&&0===B[C];C--);if(C<S&&(S=C),0===C)return l[c++]=20971520,l[c++]=20971520,d.bits=1,0;for(A=1;A<C&&0===B[A];A++);for(S<A&&(S=A),E=I=1;E<=15;E++)if(I<<=1,(I-=B[E])<0)return-1;if(0<I&&(0===t||1!==C))return-1;for(U[1]=0,E=1;E<15;E++)U[E+1]=U[E]+B[E];for(T=0;T<h;T++)0!==e[i+T]&&(u[U[e[i+T]]++]=T);if(y=0===t?(z=R=u,19):1===t?(z=n,M-=257,R=r,N-=257,256):(z=o,R=a,-1),E=A,_=c,P=T=k=0,m=-1,g=(D=1<<(O=S))-1,1===t&&852<D||2===t&&592<D)return 1;for(;;){for(w=E-P,b=u[T]<y?(v=0,u[T]):u[T]>y?(v=R[N+u[T]],z[M+u[T]]):(v=96,0),p=1<<E-P,A=f=1<<O;l[_+(k>>P)+(f-=p)]=w<<24|v<<16|b,0!==f;);for(p=1<<E-1;k&p;)p>>=1;if(0!==p?(k&=p-1,k+=p):k=0,T++,0==--B[E]){if(E===C)break;E=e[i+u[T]]}if(S<E&&(k&g)!==m){for(0===P&&(P=S),_+=A,I=1<<(O=E-P);O+P<C&&!((I-=B[O+P])<=0);)O++,I<<=1;if(D+=1<<O,1===t&&852<D||2===t&&592<D)return 1;l[m=k&g]=S<<24|O<<16|_-c}}return 0!==k&&(l[_+k]=E-P<<24|64<<16),d.bits=S,0}},{"../utils/common":41}],51:[function(t,e,i){e.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(t,e,i){var s=t("../utils/common"),n=0,r=1;function o(t){for(var e=t.length;0<=--e;)t[e]=0}var a=0,h=29,l=256,c=l+1+h,u=30,d=19,p=2*c+1,f=15,m=16,g=7,_=256,y=16,w=17,v=18,b=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],x=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],E=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],T=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],A=new Array(2*(c+2));o(A);var C=new Array(2*u);o(C);var S=new Array(512);o(S);var O=new Array(256);o(O);var P=new Array(h);o(P);var I,D,k,z=new Array(u);function M(t,e,i,s,n){this.static_tree=t,this.extra_bits=e,this.extra_base=i,this.elems=s,this.max_length=n,this.has_stree=t&&t.length}function B(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e}function U(t){return t<256?S[t]:S[256+(t>>>7)]}function R(t,e){t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255}function N(t,e,i){t.bi_valid>m-i?(t.bi_buf|=e<<t.bi_valid&65535,R(t,t.bi_buf),t.bi_buf=e>>m-t.bi_valid,t.bi_valid+=i-m):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=i)}function L(t,e,i){N(t,i[2*e],i[2*e+1])}function F(t,e){for(var i=0;i|=1&t,t>>>=1,i<<=1,0<--e;);return i>>>1}function V(t,e,i){var s,n,r=new Array(f+1),o=0;for(s=1;s<=f;s++)r[s]=o=o+i[s-1]<<1;for(n=0;n<=e;n++){var a=t[2*n+1];0!==a&&(t[2*n]=F(r[a]++,a))}}function j(t){var e;for(e=0;e<c;e++)t.dyn_ltree[2*e]=0;for(e=0;e<u;e++)t.dyn_dtree[2*e]=0;for(e=0;e<d;e++)t.bl_tree[2*e]=0;t.dyn_ltree[2*_]=1,t.opt_len=t.static_len=0,t.last_lit=t.matches=0}function Y(t){8<t.bi_valid?R(t,t.bi_buf):0<t.bi_valid&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0}function Z(t,e,i,s){var n=2*e,r=2*i;return t[n]<t[r]||t[n]===t[r]&&s[e]<=s[i]}function H(t,e,i){for(var s=t.heap[i],n=i<<1;n<=t.heap_len&&(n<t.heap_len&&Z(e,t.heap[n+1],t.heap[n],t.depth)&&n++,!Z(e,s,t.heap[n],t.depth));)t.heap[i]=t.heap[n],i=n,n<<=1;t.heap[i]=s}function $(t,e,i){var s,n,r,o,a=0;if(0!==t.last_lit)for(;s=t.pending_buf[t.d_buf+2*a]<<8|t.pending_buf[t.d_buf+2*a+1],n=t.pending_buf[t.l_buf+a],a++,0===s?L(t,n,e):(L(t,(r=O[n])+l+1,e),0!==(o=b[r])&&N(t,n-=P[r],o),L(t,r=U(--s),i),0!==(o=x[r])&&N(t,s-=z[r],o)),a<t.last_lit;);L(t,_,e)}function W(t,e){var i,s,n,r=e.dyn_tree,o=e.stat_desc.static_tree,a=e.stat_desc.has_stree,h=e.stat_desc.elems,l=-1;for(t.heap_len=0,t.heap_max=p,i=0;i<h;i++)0!==r[2*i]?(t.heap[++t.heap_len]=l=i,t.depth[i]=0):r[2*i+1]=0;for(;t.heap_len<2;)r[2*(n=t.heap[++t.heap_len]=l<2?++l:0)]=1,t.depth[n]=0,t.opt_len--,a&&(t.static_len-=o[2*n+1]);for(e.max_code=l,i=t.heap_len>>1;1<=i;i--)H(t,r,i);for(n=h;i=t.heap[1],t.heap[1]=t.heap[t.heap_len--],H(t,r,1),s=t.heap[1],t.heap[--t.heap_max]=i,t.heap[--t.heap_max]=s,r[2*n]=r[2*i]+r[2*s],t.depth[n]=(t.depth[i]>=t.depth[s]?t.depth[i]:t.depth[s])+1,r[2*i+1]=r[2*s+1]=n,t.heap[1]=n++,H(t,r,1),2<=t.heap_len;);t.heap[--t.heap_max]=t.heap[1],function(t,e){var i,s,n,r,o,a,h=e.dyn_tree,l=e.max_code,c=e.stat_desc.static_tree,u=e.stat_desc.has_stree,d=e.stat_desc.extra_bits,m=e.stat_desc.extra_base,g=e.stat_desc.max_length,_=0;for(r=0;r<=f;r++)t.bl_count[r]=0;for(h[2*t.heap[t.heap_max]+1]=0,i=t.heap_max+1;i<p;i++)g<(r=h[2*h[2*(s=t.heap[i])+1]+1]+1)&&(r=g,_++),h[2*s+1]=r,l<s||(t.bl_count[r]++,o=0,m<=s&&(o=d[s-m]),a=h[2*s],t.opt_len+=a*(r+o),u&&(t.static_len+=a*(c[2*s+1]+o)));if(0!==_){do{for(r=g-1;0===t.bl_count[r];)r--;t.bl_count[r]--,t.bl_count[r+1]+=2,t.bl_count[g]--,_-=2}while(0<_);for(r=g;0!==r;r--)for(s=t.bl_count[r];0!==s;)l<(n=t.heap[--i])||(h[2*n+1]!==r&&(t.opt_len+=(r-h[2*n+1])*h[2*n],h[2*n+1]=r),s--)}}(t,e),V(r,l,t.bl_count)}function q(t,e,i){var s,n,r=-1,o=e[1],a=0,h=7,l=4;for(0===o&&(h=138,l=3),e[2*(i+1)+1]=65535,s=0;s<=i;s++)n=o,o=e[2*(s+1)+1],++a<h&&n===o||(a<l?t.bl_tree[2*n]+=a:0!==n?(n!==r&&t.bl_tree[2*n]++,t.bl_tree[2*y]++):a<=10?t.bl_tree[2*w]++:t.bl_tree[2*v]++,r=n,l=(a=0)===o?(h=138,3):n===o?(h=6,3):(h=7,4))}function X(t,e,i){var s,n,r=-1,o=e[1],a=0,h=7,l=4;for(0===o&&(h=138,l=3),s=0;s<=i;s++)if(n=o,o=e[2*(s+1)+1],!(++a<h&&n===o)){if(a<l)for(;L(t,n,t.bl_tree),0!=--a;);else 0!==n?(n!==r&&(L(t,n,t.bl_tree),a--),L(t,y,t.bl_tree),N(t,a-3,2)):a<=10?(L(t,w,t.bl_tree),N(t,a-3,3)):(L(t,v,t.bl_tree),N(t,a-11,7));r=n,l=(a=0)===o?(h=138,3):n===o?(h=6,3):(h=7,4)}}o(z);var G=!1;function Q(t,e,i,n){var r,o,h;N(t,(a<<1)+(n?1:0),3),o=e,h=i,Y(r=t),R(r,h),R(r,~h),s.arraySet(r.pending_buf,r.window,o,h,r.pending),r.pending+=h}i._tr_init=function(t){G||(function(){var t,e,i,s,n,r=new Array(f+1);for(s=i=0;s<h-1;s++)for(P[s]=i,t=0;t<1<<b[s];t++)O[i++]=s;for(O[i-1]=s,s=n=0;s<16;s++)for(z[s]=n,t=0;t<1<<x[s];t++)S[n++]=s;for(n>>=7;s<u;s++)for(z[s]=n<<7,t=0;t<1<<x[s]-7;t++)S[256+n++]=s;for(e=0;e<=f;e++)r[e]=0;for(t=0;t<=143;)A[2*t+1]=8,t++,r[8]++;for(;t<=255;)A[2*t+1]=9,t++,r[9]++;for(;t<=279;)A[2*t+1]=7,t++,r[7]++;for(;t<=287;)A[2*t+1]=8,t++,r[8]++;for(V(A,c+1,r),t=0;t<u;t++)C[2*t+1]=5,C[2*t]=F(t,5);I=new M(A,b,l+1,c,f),D=new M(C,x,0,u,f),k=new M(new Array(0),E,0,d,g)}(),G=!0),t.l_desc=new B(t.dyn_ltree,I),t.d_desc=new B(t.dyn_dtree,D),t.bl_desc=new B(t.bl_tree,k),t.bi_buf=0,t.bi_valid=0,j(t)},i._tr_stored_block=Q,i._tr_flush_block=function(t,e,i,s){var o,a,h=0;0<t.level?(2===t.strm.data_type&&(t.strm.data_type=function(t){var e,i=4093624447;for(e=0;e<=31;e++,i>>>=1)if(1&i&&0!==t.dyn_ltree[2*e])return n;if(0!==t.dyn_ltree[18]||0!==t.dyn_ltree[20]||0!==t.dyn_ltree[26])return r;for(e=32;e<l;e++)if(0!==t.dyn_ltree[2*e])return r;return n}(t)),W(t,t.l_desc),W(t,t.d_desc),h=function(t){var e;for(q(t,t.dyn_ltree,t.l_desc.max_code),q(t,t.dyn_dtree,t.d_desc.max_code),W(t,t.bl_desc),e=d-1;3<=e&&0===t.bl_tree[2*T[e]+1];e--);return t.opt_len+=3*(e+1)+5+5+4,e}(t),o=t.opt_len+3+7>>>3,(a=t.static_len+3+7>>>3)<=o&&(o=a)):o=a=i+5,i+4<=o&&-1!==e?Q(t,e,i,s):4===t.strategy||a===o?(N(t,2+(s?1:0),3),$(t,A,C)):(N(t,4+(s?1:0),3),function(t,e,i,s){var n;for(N(t,e-257,5),N(t,i-1,5),N(t,s-4,4),n=0;n<s;n++)N(t,t.bl_tree[2*T[n]+1],3);X(t,t.dyn_ltree,e-1),X(t,t.dyn_dtree,i-1)}(t,t.l_desc.max_code+1,t.d_desc.max_code+1,h+1),$(t,t.dyn_ltree,t.dyn_dtree)),j(t),s&&Y(t)},i._tr_tally=function(t,e,i){return t.pending_buf[t.d_buf+2*t.last_lit]=e>>>8&255,t.pending_buf[t.d_buf+2*t.last_lit+1]=255&e,t.pending_buf[t.l_buf+t.last_lit]=255&i,t.last_lit++,0===e?t.dyn_ltree[2*i]++:(t.matches++,e--,t.dyn_ltree[2*(O[i]+l+1)]++,t.dyn_dtree[2*U(e)]++),t.last_lit===t.lit_bufsize-1},i._tr_align=function(t){var e;N(t,2,3),L(t,_,A),16===(e=t).bi_valid?(R(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):8<=e.bi_valid&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}},{"../utils/common":41}],53:[function(t,e,i){e.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(t,e,i){(function(t){!function(t,e){if(!t.setImmediate){var i,s,n,r,o=1,a={},h=!1,l=t.document,c=Object.getPrototypeOf&&Object.getPrototypeOf(t);c=c&&c.setTimeout?c:t,i="[object process]"==={}.toString.call(t.process)?function(t){ie.nextTick((function(){d(t)}))}:function(){if(t.postMessage&&!t.importScripts){var e=!0,i=t.onmessage;return t.onmessage=function(){e=!1},t.postMessage("","*"),t.onmessage=i,e}}()?(r="setImmediate$"+Math.random()+"$",t.addEventListener?t.addEventListener("message",p,!1):t.attachEvent("onmessage",p),function(e){t.postMessage(r+e,"*")}):t.MessageChannel?((n=new MessageChannel).port1.onmessage=function(t){d(t.data)},function(t){n.port2.postMessage(t)}):l&&"onreadystatechange"in l.createElement("script")?(s=l.documentElement,function(t){var e=l.createElement("script");e.onreadystatechange=function(){d(t),e.onreadystatechange=null,s.removeChild(e),e=null},s.appendChild(e)}):function(t){setTimeout(d,0,t)},c.setImmediate=function(t){"function"!=typeof t&&(t=new Function(""+t));for(var e=new Array(arguments.length-1),s=0;s<e.length;s++)e[s]=arguments[s+1];var n={callback:t,args:e};return a[o]=n,i(o),o++},c.clearImmediate=u}function u(t){delete a[t]}function d(t){if(h)setTimeout(d,0,t);else{var i=a[t];if(i){h=!0;try{!function(t){var i=t.callback,s=t.args;switch(s.length){case 0:i();break;case 1:i(s[0]);break;case 2:i(s[0],s[1]);break;case 3:i(s[0],s[1],s[2]);break;default:i.apply(e,s)}}(i)}finally{u(t),h=!1}}}}function p(e){e.source===t&&"string"==typeof e.data&&0===e.data.indexOf(r)&&d(+e.data.slice(r.length))}}("undefined"==typeof self?void 0===t?this:t:self)}).call(this,void 0!==ye?ye:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[10])(10));class sa{constructor(t,e){ne(this,"date",new Date),ne(this,"author"),ne(this,"guid",_e.create()),ne(this,"viewpoint"),ne(this,"modifiedAuthor"),ne(this,"modifiedDate"),ne(this,"topic"),ne(this,"_components"),ne(this,"_comment",""),this._components=t,this._comment=e;const i=this._components.get(la);this.author=i.config.author}set comment(t){var e;const i=this._components.get(la);this._comment=t,this.modifiedDate=new Date,this.modifiedAuthor=i.config.author,null==(e=this.topic)||e.comments.set(this.guid,this)}get comment(){return this._comment}toJSON(){var t,e;const i={guid:this.guid,date:this.date.toISOString(),author:this.author,comment:this.comment,topic_guid:null==(t=this.topic)?void 0:t.guid,viewpoint_guid:this.viewpoint,modified_date:null==(e=this.modifiedDate)?void 0:e.toISOString(),modified_author:this.modifiedAuthor};for(const[t,e]of Object.entries(i))void 0===e&&delete i[t];return i}}const na=class t{constructor(e){ne(this,"guid",_e.create()),ne(this,"title",t.default.title),ne(this,"creationDate",new Date),ne(this,"creationAuthor",""),ne(this,"viewpoints",new me),ne(this,"relatedTopics",new me),ne(this,"comments",new Fi),ne(this,"documentReferences",new me),ne(this,"customData",{}),ne(this,"description"),ne(this,"serverAssignedId"),ne(this,"dueDate"),ne(this,"modifiedAuthor"),ne(this,"modifiedDate"),ne(this,"index"),ne(this,"_type",t.default.type),ne(this,"_status",t.default.status),ne(this,"_priority",t.default.priority),ne(this,"_stage",t.default.stage),ne(this,"_assignedTo",t.default.assignedTo),ne(this,"_labels",t.default.labels??new Set),ne(this,"_components"),this._components=e;const i=e.get(la);this.creationAuthor=i.config.author,this.relatedTopics.guard=t=>t!==this.guid}set type(t){const e=this._components.get(la),{strict:i,types:s}=e.config;(!i||s.has(t))&&(this._type=t)}get type(){return this._type}set status(t){const e=this._components.get(la),{strict:i,statuses:s}=e.config;(!i||s.has(t))&&(this._status=t)}get status(){return this._status}set priority(t){const e=this._components.get(la);if(t){const{strict:i,priorities:s}=e.config;if(!(!i||s.has(t)))return;this._priority=t}else this._priority=t}get priority(){return this._priority}set stage(t){const e=this._components.get(la);if(t){const{strict:i,stages:s}=e.config;if(!(!i||s.has(t)))return;this._stage=t}else this._stage=t}get stage(){return this._stage}set assignedTo(t){const e=this._components.get(la);if(t){const{strict:i,users:s}=e.config;if(!(!i||s.has(t)))return;this._assignedTo=t}else this._assignedTo=t}get assignedTo(){return this._assignedTo}set labels(t){const e=this._components.get(la),{strict:i,labels:s}=e.config;if(i){const e=new Set;for(const n of t){(!i||s.has(n))&&e.add(n)}this._labels=e}else this._labels=t}get labels(){return this._labels}get _managerVersion(){return this._components.get(la).config.version}set(t){const e=t,i=this;for(const s in t){if("guid"===s)continue;const t=e[s];s in this&&(i[s]=t)}return this._components.get(la).list.set(this.guid,this),this}createComment(t,e){const i=new sa(this._components,t);return i.viewpoint=e,i.topic=this,this.comments.set(i.guid,i),i}createLabelTags(){const t=[...this.labels];if(this._components.get(la).config.exportCustomDataAsLabels)for(const e in this.customData){const i=this.customData[e];"string"==typeof i&&t.push(i)}return t}createCommentTags(){return[...this.comments.values()].map((t=>{var e;return{$Guid:t.guid,Date:t.date.toISOString(),Author:t.author,Comment:t.comment,ModifiedAuthor:t.modifiedAuthor,ModifiedDate:null==(e=t.modifiedDate)?void 0:e.toISOString(),Viewpoint:t.viewpoint?{$Guid:t.viewpoint}:void 0}}))}createViewpointTags(){const t=this._components.get(Ga);return[...this.viewpoints].map((e=>t.list.get(e))).filter((t=>t)).map((e=>{const i={$Guid:e.guid,Viewpoint:`${e.title??e.guid}.bcfv`};if(t.snapshots.get(e.snapshot)){const s=t.getSnapshotExtension(e.snapshot);i.Snapshot=`${e.snapshot}.${s}`}return i}))}createRelatedTopicTags(){return[...this.relatedTopics].map((t=>({$Guid:t})))}createDocumentReferencesTag(t=this._managerVersion){const e=[];if("3"!==t&&"2.1"!==t)return e;const i=this._components.get(la);for(const s of this.documentReferences){const n=i.documents.get(s);if(!n)continue;let r={$Guid:_e.create(),Description:n.description};"2.1"===t&&(r={...r,$isExternal:"external"===n.type||void 0,ReferencedDocument:"external"===n.type?n.url:`../${n.fileName}`}),"3"===t&&(r={...r,DocumentGuid:"internal"===n.type?s:void 0,Url:"external"===n.type?n.url:void 0}),Object.keys(r).length>0&&e.push(r)}return e}toJSON(){var t,e;const i={guid:this.guid,server_assigned_id:this.serverAssignedId,topic_type:this.type,topic_status:this.status,title:this.title,priority:this.priority,index:this.index,labels:[...this.labels],creation_date:this.creationDate.toISOString(),creation_author:this.creationAuthor,modified_date:null==(t=this.modifiedDate)?void 0:t.toISOString(),modified_author:this.modifiedAuthor,assigned_to:this.assignedTo,stage:this.stage,description:this.description,due_date:null==(e=this.dueDate)?void 0:e.toISOString(),comments:[...this.comments].map((([t,e])=>e.toJSON())),relatedTopics:[...this.relatedTopics].map((t=>({related_topic_guid:t})))},s=this._components.get(Ga);for(const t of this.viewpoints){const e=s.list.get(t);e&&(i.viewpoints||(i.viewpoints=[]),i.viewpoints.push(e.toJSON()))}const n=this._components.get(la);for(const t of this.documentReferences){const e=n.documents.get(t);e&&(i.document_references||(i.document_references=[]),"external"===e.type?i.document_references.push({guid:_e.create(),description:e.description,url:e.url}):i.document_references.push({guid:_e.create(),description:e.description,document_guid:t}))}for(const[t,e]of Object.entries(i))(void 0===e||Array.isArray(e)&&0===e.length)&&delete i[t];return i}serialize(){var t,e;const i=this._managerVersion,s={$Guid:this.guid,$TopicType:this.type,$TopicStatus:this.status,$ServerAssignedId:this.serverAssignedId,Title:this.title,CreationAuthor:this.creationAuthor,CreationDate:this.creationDate.toISOString(),Priority:this.priority,Index:"2.1"===i?this.index:void 0,ModifiedDate:null==(t=this.modifiedDate)?void 0:t.toISOString(),ModifiedAuthor:this.modifiedAuthor,DueDate:null==(e=this.dueDate)?void 0:e.toISOString(),AssignedTo:this.assignedTo,Description:this.description,Stage:this.stage,DocumentReferences:"3"===i?{DocumentReference:this.createDocumentReferencesTag(i)}:void 0,RelatedTopics:"3"===i?{RelatedTopic:this.createRelatedTopicTags()}:void 0,RelatedTopic:"2.1"===i?this.createRelatedTopicTags():void 0,Labels:"3"===i?{Label:this.createLabelTags()}:void 0,Viewpoints:"3"===i?{ViewPoint:this.createViewpointTags()}:void 0,Comments:"3"===i?{Comment:this.createCommentTags()}:void 0};"2.1"===i&&(s.Labels=this.createLabelTags(),s.DocumentReference=this.createDocumentReferencesTag(i));const n={Markup:{Topic:s}};return"2.1"===i&&(n.Markup.Viewpoints=this.createViewpointTags(),n.Markup.Comment=this.createCommentTags()),`<?xml version="1.0" encoding="UTF-8"?>\n    ${Ri.builder.build(n)}`}};ne(na,"default",{title:"BCF Topic",type:"Issue",status:"Active"});let ra=na;const oa=(t,e)=>{if(""===e.trim())return;const i=la.xmlParser.parse(e).Extensions;if(!i)return;const{Priorities:s,TopicStatuses:n,TopicTypes:r,Users:o}=i;if(s&&s.Priority){const e=Array.isArray(s.Priority)?s.Priority:[s.Priority];for(const i of e)t.config.priorities.add(i)}if(n&&n.TopicStatus){const e=Array.isArray(n.TopicStatus)?n.TopicStatus:[n.TopicStatus];for(const i of e)t.config.statuses.add(i)}if(r&&r.TopicType){const e=Array.isArray(r.TopicType)?r.TopicType:[r.TopicType];for(const i of e)t.config.types.add(i)}if(o&&o.User){const e=Array.isArray(o.User)?o.User:[o.User];for(const i of e)t.config.users.add(i)}};class aa extends Yi{constructor(){super(...arguments),ne(this,"_config",{version:{type:"Select",options:new Set(["2.1","3"]),multiple:!1,value:""},author:{type:"Text",value:""},types:{type:"TextSet",value:new Set},statuses:{type:"TextSet",value:new Set},priorities:{type:"TextSet",value:new Set},labels:{type:"TextSet",value:new Set},stages:{type:"TextSet",value:new Set},users:{type:"TextSet",value:new Set},includeSelectionTag:{type:"Boolean",value:!1},updateExtensionsOnImport:{type:"Boolean",value:!1},strict:{type:"Boolean",value:!1},includeAllExtensionsOnExport:{type:"Boolean",value:!1},fallbackVersionOnImport:{type:"Select",multiple:!1,options:new Set(["2.1","3"]),value:""},ignoreIncompleteTopicsOnImport:{type:"Boolean",value:!1},exportCustomDataAsLabels:{type:"Boolean",value:!1}})}get version(){return this._config.version.value}set version(t){this._config.version.value=t}get author(){return this._config.author.value}set author(t){this._config.author.value=t}get types(){return this._config.types.value}set types(t){this._config.types.value=t}get statuses(){return this._config.statuses.value}set statuses(t){this._config.statuses.value=t}get priorities(){return this._config.priorities.value}set priorities(t){this._config.priorities.value=t}get labels(){return this._config.labels.value}set labels(t){this._config.labels.value=t}get stages(){return this._config.stages.value}set stages(t){this._config.stages.value=t}get users(){return this._config.users.value}set users(t){this._config.users.value=t}get includeSelectionTag(){return this._config.includeSelectionTag.value}set includeSelectionTag(t){this._config.includeSelectionTag.value=t}get updateExtensionsOnImport(){return this._config.updateExtensionsOnImport.value}set updateExtensionsOnImport(t){this._config.updateExtensionsOnImport.value=t}get strict(){return this._config.strict.value}set strict(t){this._config.strict.value=t}get includeAllExtensionsOnExport(){return this._config.includeAllExtensionsOnExport.value}set includeAllExtensionsOnExport(t){this._config.includeAllExtensionsOnExport.value=t}get fallbackVersionOnImport(){return this._config.fallbackVersionOnImport.value}set fallbackVersionOnImport(t){this._config.fallbackVersionOnImport.value=t}get ignoreIncompleteTopicsOnImport(){return this._config.ignoreIncompleteTopicsOnImport.value}set ignoreIncompleteTopicsOnImport(t){this._config.ignoreIncompleteTopicsOnImport.value=t}get exportCustomDataAsLabels(){return this._config.exportCustomDataAsLabels.value}set exportCustomDataAsLabels(t){this._config.exportCustomDataAsLabels.value=t}}const ha=class t extends he{constructor(){super(...arguments),ne(this,"enabled",!1),ne(this,"_defaultConfig",{author:"jhon.doe@example.com",version:"2.1",types:new Set(["Clash","Failure","Fault","Inquiry","Issue","Remark","Request"]),statuses:new Set(["Active","In Progress","Done","In Review","Closed"]),priorities:new Set(["On hold","Minor","Normal","Major","Critical"]),labels:new Set,stages:new Set,users:new Set,includeSelectionTag:!1,updateExtensionsOnImport:!0,strict:!1,includeAllExtensionsOnExport:!0,fallbackVersionOnImport:"2.1",ignoreIncompleteTopicsOnImport:!1,exportCustomDataAsLabels:!1}),ne(this,"config",new aa(this,this.components,"BCF Topics",t.uuid)),ne(this,"list",new Fi),ne(this,"documents",new Fi),ne(this,"onSetup",new re),ne(this,"isSetup",!1),ne(this,"onBCFImported",new re),ne(this,"onDisposed",new re)}setup(t){if(this.isSetup)return;const e={...this._defaultConfig,...t};this.config.version=e.version,this.config.author=e.author,this.config.types=e.types,this.config.statuses=e.statuses,this.config.priorities=e.priorities,this.config.labels=e.labels,this.config.stages=e.stages,this.config.users=e.users,this.config.includeSelectionTag=e.includeSelectionTag,this.config.updateExtensionsOnImport=e.updateExtensionsOnImport,this.config.strict=e.strict,this.config.includeAllExtensionsOnExport=e.includeAllExtensionsOnExport,this.config.fallbackVersionOnImport=e.fallbackVersionOnImport||"",this.config.ignoreIncompleteTopicsOnImport=e.ignoreIncompleteTopicsOnImport,this.isSetup=!0,this.enabled=!0,this.onSetup.trigger()}create(t){const e=new ra(this.components);return t?(e.guid=t.guid??e.guid,e.set(t)):this.list.set(e.guid,e),e}dispose(){this.list.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}get usedTypes(){const t=[...this.list].map((([t,e])=>e.type));return new Set(t)}get usedStatuses(){const t=[...this.list].map((([t,e])=>e.status));return new Set(t)}get usedPriorities(){const t=[...this.list].map((([t,e])=>e.priority)).filter((t=>t));return new Set(t)}get usedStages(){const t=[...this.list].map((([t,e])=>e.stage)).filter((t=>t));return new Set(t)}get usedUsers(){const t=[];for(const[e,i]of this.list){t.push(i.creationAuthor),i.assignedTo&&t.push(i.assignedTo),i.modifiedAuthor&&t.push(i.modifiedAuthor);for(const[e,s]of i.comments)t.push(s.author),s.modifiedAuthor&&t.push(s.modifiedAuthor)}return new Set(t)}get usedLabels(){const t=[];for(const[e,i]of this.list)t.push(...i.labels);return new Set(t)}updateExtensions(){for(const[t,e]of this.list){for(const t of e.labels)this.config.labels.add(t);this.config.types.add(e.type),e.priority&&this.config.priorities.add(e.priority),e.stage&&this.config.stages.add(e.stage),this.config.statuses.add(e.status),this.config.users.add(e.creationAuthor),e.assignedTo&&this.config.users.add(e.assignedTo),e.modifiedAuthor&&this.config.users.add(e.modifiedAuthor);for(const[t,i]of e.comments)this.config.users.add(i.author),i.modifiedAuthor&&this.config.users.add(i.modifiedAuthor)}}updateViewpointReferences(){const t=this.components.get(Ga);for(const[e,i]of this.list)for(const e of i.viewpoints){t.list.has(e)||i.viewpoints.delete(e)}}async export(t=this.list.values()){const e=new ia;e.file("bcf.version",`<?xml version="1.0" encoding="UTF-8"?>\n    <Version VersionId="${this.config.version}" xsi:noNamespaceSchemaLocation="https://raw.githubusercontent.com/buildingSMART/BCF-XML/release_3_0/Schemas/version.xsd"\n    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">\n    </Version>`);for(const[t,i]of this.documents.entries())"external"!==i.type&&e.file("2.1"===this.config.version?i.fileName:`documents/${t}`,i.data);if("3"===this.config.version){const t=[];for(const[e,i]of this.documents.entries()){const{type:s,description:n}=i;"external"!==s&&t.push(`<Document Guid="${e}">\n        <Filename>${i.fileName}</Filename>\n        ${n?`<Description>${n}</Description>`:""}\n      </Document>`)}t.length>0&&e.file("documents.xml",`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n  <DocumentInfo xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="documents.xsd">\n    <Documents>\n      ${t.join("\n")}\n    </Documents>\n  </DocumentInfo>`)}e.file("bcf.extensions",this.serializeExtensions());const i=this.components.get(Ga);for(const s of t){const t=e.folder(s.guid);t.file("markup.bcf",s.serialize());for(const e of s.viewpoints){const s=i.list.get(e);if(!s)continue;const n=s.title??s.guid;t.file(`${n}.bcfv`,await s.serialize());const r=i.snapshots.get(s.snapshot);if(!r)continue;const o=r?s.snapshot:s.guid,a=i.getSnapshotExtension(s.snapshot);t.file(`${o}.${a}`,r,{binary:!0})}}return await e.generateAsync({type:"blob"})}serializeExtensions(){const t=[...this.config.types].map((t=>`<TopicType>${t}</TopicType>`)).join("\n"),e=[...this.config.statuses].map((t=>`<TopicStatus>${t}</TopicStatus>`)).join("\n"),i=[...this.config.priorities].map((t=>`<Priority>${t}</Priority>`)).join("\n"),s=[...this.config.labels].map((t=>`<TopicLabel>${t}</TopicLabel>`)).join("\n"),n=[...this.config.stages].map((t=>`<Stage>${t}</Stage>`)).join("\n"),r=[...this.config.users].map((t=>`<User>${t}</User>`)).join("\n");return`\n      <?xml version="1.0" encoding="UTF-8"?>\n      <Extensions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="your-schema-location.xsd">\n        ${0!==t.length?`<TopicTypes>\n${t}\n</TopicTypes>`:""}\n        ${0!==e.length?`<TopicStatuses>\n${e}\n</TopicStatuses>`:""}\n        ${0!==i.length?`<Priorities>\n${i}\n</Priorities>`:""}\n        ${0!==s.length?`<TopicLabels>\n${s}\n</TopicLabels>`:""}\n        ${0!==n.length?`<Stages>\n${n}\n</Stages>`:""}\n        ${0!==r.length?`<Users>\n${r}\n</Users>`:""}\n      </Extensions>\n    `}processMarkupComment(t){const{Guid:e,Date:i,Author:s,Comment:n,Viewpoint:r}=t;if(!(e&&i&&s&&(sa||r)))return null;const o=new sa(this.components,n??"");return o.guid=e,o.date=new Date(i),o.author=s,o.viewpoint=null==r?void 0:r.Guid,o.modifiedAuthor=t.ModifiedAuthor,o.modifiedDate=t.ModifiedDate?new Date(t.ModifiedDate):void 0,o}getMarkupComments(t,e){var i;let s;if("2.1"===e&&(s=t.Comment),"3"===e&&(s=null==(i=t.Topic.Comments)?void 0:i.Comment),!s)return[];s=Array.isArray(s)?s:[s];const n=s.map((t=>this.processMarkupComment(t))).filter((t=>t));return Array.isArray(n)?n:[n]}getMarkupLabels(t,e){var i;let s;if("2.1"===e&&(s=t.Topic.Labels),"3"===e&&(s=null==(i=t.Topic.Labels)?void 0:i.Label),!s)return[];return Array.isArray(s)?s:[s]}getMarkupViewpoints(t,e){var i;let s;return"2.1"===e&&(s=t.Viewpoints),"3"===e&&(s=null==(i=t.Topic.Viewpoints)?void 0:i.ViewPoint),s?(s=Array.isArray(s)?s:[s],s):[]}getMarkupRelatedTopics(t,e){var i;let s;if("2.1"===e&&(s=t.Topic.RelatedTopic),"3"===e&&(s=null==(i=t.Topic.RelatedTopics)?void 0:i.RelatedTopic),!s)return[];return(Array.isArray(s)?s:[s]).map((t=>t.Guid))}getMarkupDocumentReferences(t,e){var i;let s;if("2.1"===e&&(s=t.Topic.DocumentReference),"3"===e&&(s=null==(i=t.Topic.DocumentReferences)?void 0:i.DocumentReference),!s)return[];return Array.isArray(s)?s:[s]}async load(e){var i,n,r;const{fallbackVersionOnImport:o,ignoreIncompleteTopicsOnImport:a,updateExtensionsOnImport:h}=this.config,l=new ia;await l.loadAsync(e);const c=Object.values(l.files);let u=o;const d=c.find((t=>t.name.endsWith(".version")));if(d){const e=await d.async("string"),i=t.xmlParser.parse(e).Version.VersionId;u=String(i)}if(!u||"2.1"!==u&&"3"!==u)throw new Error(`BCFTopics: ${u} is not supported.`);const p=c.find((t=>t.name.endsWith(".extensions")));if(h&&p){const t=await p.async("string");oa(this,t)}const f=[],m=this.components.get(Ga),g=c.filter((t=>t.name.endsWith(".bcfv")));for(const e of g){const n=await e.async("string"),r=t.xmlParser.parse(n).VisualizationInfo;if(!r){console.warn("Missing VisualizationInfo in Viewpoint");continue}const o={},{Guid:a,ClippingPlanes:h,Components:l,OrthogonalCamera:c,PerspectiveCamera:d}=r;if(a&&(o.guid=a),l){const t={selection:[],coloring:[],visibility:{default_visibility:!1,exceptions:[],view_setup_hints:{spaces_visible:!1,space_boundaries_visible:!1,openings_visible:!1}}};o.components=t;const{Selection:e,Visibility:s}=l;if(e&&e.Component){const i=Array.isArray(e.Component)?e.Component:[e.Component];t.selection=i.map((t=>t.IfcGuid?{ifc_guid:t.IfcGuid}:null)).filter((t=>null!==t))}if(s&&"DefaultVisibility"in s&&(t.visibility.default_visibility=s.DefaultVisibility),s&&s.Exceptions&&"Component"in s.Exceptions){const{Component:e}=s.Exceptions,i=Array.isArray(e)?e:[e];t.visibility.exceptions=i.map((t=>t.IfcGuid?{ifc_guid:t.IfcGuid}:null)).filter((t=>null!==t))}let n;"2.1"===u&&(n=l.ViewSetupHints),"3"===u&&(n=null==(i=l.Visibility)?void 0:i.ViewSetupHints),n&&("OpeningsVisible"in n&&(t.visibility.view_setup_hints.openings_visible=n.OpeningsVisible),"SpacesVisible"in n&&(t.visibility.view_setup_hints.spaces_visible=n.SpacesVisible),"SpaceBoundariesVisible"in n&&(t.visibility.view_setup_hints.space_boundaries_visible=n.SpaceBoundariesVisible));const{Coloring:r}=l;if(r&&r.Color){const e=Array.isArray(r.Color)?r.Color:[r.Color];for(const i of e){const{Color:e,Component:s}=i;if(6!==e.length&&8!==e.length)continue;const n=6===e.length?e:e.slice(2),r=(Array.isArray(s)?s:[s]).map((t=>t.IfcGuid?{ifc_guid:t.IfcGuid}:null)).filter((t=>null!==t));t.coloring.push({color:n,components:r})}}}if(c||d){const t=r.PerspectiveCamera??r.OrthogonalCamera,{CameraViewPoint:e,CameraDirection:i}=t,n=new s.Vector3(Number(e.X),Number(e.Z),Number(-e.Y)),a=new s.Vector3(Number(i.X),Number(i.Z),Number(-i.Y)),h={camera_view_point:{x:n.x,y:n.y,z:n.z},camera_direction:{x:a.x,y:a.y,z:a.z},aspect_ratio:"AspectRatio"in t?t.AspectRatio:1,camera_up_vector:{x:0,y:0,z:0}};"ViewToWorldScale"in t&&(o.orthogonal_camera={...h,view_to_world_scale:t.ViewToWorldScale}),"FieldOfView"in t&&(o.perspective_camera={...h,field_of_view:t.FieldOfView})}if(h){const t=(Array.isArray(h.ClippingPlane)?h.ClippingPlane:[h.ClippingPlane]).map((({Location:t,Direction:e})=>({location:{x:t.x,y:t.y,z:t.z},direction:{x:e.x,y:e.y,z:e.z}})));o.clipping_planes=t}const p=new Wa(this.components,o);f.push(p)}const _={},y=[],w=c.filter((t=>t.name.endsWith(".bcf")));for(const e of w){const i=await e.async("string"),s=t.xmlParser.parse(i).Markup,o=s.Topic,{Guid:h,TopicType:l,TopicStatus:d,Title:p,CreationDate:f,CreationAuthor:g}=o;if(a&&!(h&&l&&d&&p&&f&&g))continue;const w=new ra(this.components);w.guid=h??w.guid;const v=this.getMarkupRelatedTopics(s,u);_[w.guid]=new Set(v),w.type=l??w.type,w.status=d??w.status,w.title=p??w.title,w.creationDate=f?new Date(f):w.creationDate,w.creationAuthor=g??w.creationAuthor,w.serverAssignedId=o.ServerAssignedId,w.priority=o.Priority,w.index=o.Index,w.modifiedDate=o.ModifiedDate?new Date(o.ModifiedDate):void 0,w.modifiedAuthor=o.ModifiedAuthor,w.dueDate=o.DueDate?new Date(o.DueDate):void 0,w.assignedTo=o.AssignedTo,w.description=o.Description,w.stage=o.Stage;const b=this.getMarkupLabels(s,u);for(const t of b)w.labels.add(t);const x=this.getMarkupComments(s,u);for(const t of x)w.comments.set(t.guid,t);const E=this.getMarkupViewpoints(s,u);for(const t of E){if(!t||!t.Guid)continue;const e=m.list.get(t.Guid);if(!e)continue;w.viewpoints.add(e.guid);const i=`${w.guid}/${t.Snapshot}`,s=c.find((({name:t})=>t===i));if(s){const t=await s.async("arraybuffer"),i=new Uint8Array(t);m.snapshots.set(e.guid,i),e.snapshot=e.guid??null}}const T=this.getMarkupDocumentReferences(s,u),A=c.find((t=>"documents.xml"===t.name));let C=[];const S=await(null==A?void 0:A.async("string"));if(S){const t=null==(r=null==(n=Ri.parser.parse(S).DocumentInfo)?void 0:n.Documents)?void 0:r.Document;C=Array.isArray(t)?t:[t]}for(const t of T){const{Description:e,DocumentGuid:i,Url:s,isExternal:n,ReferencedDocument:r}=t;if(i&&C.length>0){const t=C.find((({Guid:t})=>t===i)),e=c.find((t=>t.name.endsWith(i))),s=await(null==e?void 0:e.async("uint8array"));if(!t||!s)continue;const{Description:n,Filename:r}=t;this.documents.set(i,{type:"internal",fileName:r,description:n,data:s}),w.documentReferences.add(i)}if(s){const t=this.documents.add({type:"external",url:s,description:e});w.documentReferences.add(t)}if(r){let t=null;if(n)t=this.documents.add({type:"external",url:r,description:e});else{const i=r.split("/"),s=i[i.length-1],n=c.find((t=>t.name.endsWith(s))),o=await(null==n?void 0:n.async("uint8array"));if(!o)continue;t=this.documents.add({type:"internal",fileName:s,data:o,description:e})}w.documentReferences.add(t)}}this.list.set(w.guid,w),y.push(w)}for(const t in _){const e=this.list.get(t);if(!e)continue;const i=_[t];for(const t of i)e.relatedTopics.add(t)}return this.onBCFImported.trigger(y),{viewpoints:f,topics:y}}};ne(ha,"uuid","de977976-e4f6-4e4f-a01a-204727839802"),ne(ha,"xmlParser",new Ui.XMLParser({allowBooleanAttributes:!0,attributeNamePrefix:"",ignoreAttributes:!1,ignoreDeclaration:!0,ignorePiTags:!0,numberParseOptions:{leadingZeros:!0,hex:!0},parseAttributeValue:!0,preserveOrder:!1,processEntities:!1,removeNSPrefix:!0,trimValues:!0}));let la=ha;const ca=new c,ua=new n,da=new n,pa=new u,fa={X:new n(1,0,0),Y:new n(0,1,0),Z:new n(0,0,1)},ma={type:"change"},ga={type:"mouseDown",mode:null},_a={type:"mouseUp",mode:null},ya={type:"objectChange"};class wa extends g{constructor(t,e=null){super(void 0,e);const i=new Fa(this);this._root=i;const s=new Va;this._gizmo=s,i.add(s);const r=new ja;this._plane=r,i.add(r);const o=this;function a(t,e){let i=e;Object.defineProperty(o,t,{get:function(){return void 0!==i?i:e},set:function(e){i!==e&&(i=e,r[t]=e,s[t]=e,o.dispatchEvent({type:t+"-changed",value:e}),o.dispatchEvent(ma))}}),o[t]=e,r[t]=e,s[t]=e}a("camera",t),a("object",void 0),a("enabled",!0),a("axis",null),a("mode","translate"),a("translationSnap",null),a("rotationSnap",null),a("scaleSnap",null),a("space","world"),a("size",1),a("dragging",!1),a("showX",!0),a("showY",!0),a("showZ",!0),a("minX",-1/0),a("maxX",1/0),a("minY",-1/0),a("maxY",1/0),a("minZ",-1/0),a("maxZ",1/0);const h=new n,l=new n,c=new u,d=new u,p=new n,f=new u,m=new n,g=new n,_=new n,y=new n;a("worldPosition",h),a("worldPositionStart",l),a("worldQuaternion",c),a("worldQuaternionStart",d),a("cameraPosition",p),a("cameraQuaternion",f),a("pointStart",m),a("pointEnd",g),a("rotationAxis",_),a("rotationAngle",0),a("eye",y),this._offset=new n,this._startNorm=new n,this._endNorm=new n,this._cameraScale=new n,this._parentPosition=new n,this._parentQuaternion=new u,this._parentQuaternionInv=new u,this._parentScale=new n,this._worldScaleStart=new n,this._worldQuaternionInv=new u,this._worldScale=new n,this._positionStart=new n,this._quaternionStart=new u,this._scaleStart=new n,this._getPointer=va.bind(this),this._onPointerDown=xa.bind(this),this._onPointerHover=ba.bind(this),this._onPointerMove=Ea.bind(this),this._onPointerUp=Ta.bind(this),null!==e&&this.connect(e)}connect(t){super.connect(t),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="auto"}getHelper(){return this._root}pointerHover(t){if(void 0===this.object||!0===this.dragging)return;null!==t&&ca.setFromCamera(t,this.camera);const e=Aa(this._gizmo.picker[this.mode],ca);this.axis=e?e.object.name:null}pointerDown(t){if(void 0!==this.object&&!0!==this.dragging&&(null==t||0===t.button)&&null!==this.axis){null!==t&&ca.setFromCamera(t,this.camera);const e=Aa(this._plane,ca,!0);e&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(e.point).sub(this.worldPositionStart)),this.dragging=!0,ga.mode=this.mode,this.dispatchEvent(ga)}}pointerMove(t){const e=this.axis,i=this.mode,s=this.object;let n=this.space;if("scale"===i?n="local":"E"!==e&&"XYZE"!==e&&"XYZ"!==e||(n="world"),void 0===s||null===e||!1===this.dragging||null!==t&&-1!==t.button)return;null!==t&&ca.setFromCamera(t,this.camera);const r=Aa(this._plane,ca,!0);if(r){if(this.pointEnd.copy(r.point).sub(this.worldPositionStart),"translate"===i)this._offset.copy(this.pointEnd).sub(this.pointStart),"local"===n&&"XYZ"!==e&&this._offset.applyQuaternion(this._worldQuaternionInv),-1===e.indexOf("X")&&(this._offset.x=0),-1===e.indexOf("Y")&&(this._offset.y=0),-1===e.indexOf("Z")&&(this._offset.z=0),"local"===n&&"XYZ"!==e?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),s.position.copy(this._offset).add(this._positionStart),this.translationSnap&&("local"===n&&(s.position.applyQuaternion(pa.copy(this._quaternionStart).invert()),-1!==e.search("X")&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),-1!==e.search("Y")&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),-1!==e.search("Z")&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.position.applyQuaternion(this._quaternionStart)),"world"===n&&(s.parent&&s.position.add(ua.setFromMatrixPosition(s.parent.matrixWorld)),-1!==e.search("X")&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),-1!==e.search("Y")&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),-1!==e.search("Z")&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.parent&&s.position.sub(ua.setFromMatrixPosition(s.parent.matrixWorld)))),s.position.x=Math.max(this.minX,Math.min(this.maxX,s.position.x)),s.position.y=Math.max(this.minY,Math.min(this.maxY,s.position.y)),s.position.z=Math.max(this.minZ,Math.min(this.maxZ,s.position.z));else if("scale"===i){if(-1!==e.search("XYZ")){let t=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(t*=-1),da.set(t,t,t)}else ua.copy(this.pointStart),da.copy(this.pointEnd),ua.applyQuaternion(this._worldQuaternionInv),da.applyQuaternion(this._worldQuaternionInv),da.divide(ua),-1===e.search("X")&&(da.x=1),-1===e.search("Y")&&(da.y=1),-1===e.search("Z")&&(da.z=1);s.scale.copy(this._scaleStart).multiply(da),this.scaleSnap&&(-1!==e.search("X")&&(s.scale.x=Math.round(s.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==e.search("Y")&&(s.scale.y=Math.round(s.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==e.search("Z")&&(s.scale.z=Math.round(s.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if("rotate"===i){this._offset.copy(this.pointEnd).sub(this.pointStart);const t=20/this.worldPosition.distanceTo(ua.setFromMatrixPosition(this.camera.matrixWorld));let i=!1;"XYZE"===e?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(ua.copy(this.rotationAxis).cross(this.eye))*t):"X"!==e&&"Y"!==e&&"Z"!==e||(this.rotationAxis.copy(fa[e]),ua.copy(fa[e]),"local"===n&&ua.applyQuaternion(this.worldQuaternion),ua.cross(this.eye),0===ua.length()?i=!0:this.rotationAngle=this._offset.dot(ua.normalize())*t),("E"===e||i)&&(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),"local"===n&&"E"!==e&&"XYZE"!==e?(s.quaternion.copy(this._quaternionStart),s.quaternion.multiply(pa.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),s.quaternion.copy(pa.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),s.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(ma),this.dispatchEvent(ya)}}pointerUp(t){null!==t&&0!==t.button||(this.dragging&&null!==this.axis&&(_a.mode=this.mode,this.dispatchEvent(_a)),this.dragging=!1,this.axis=null)}dispose(){this.disconnect(),this._root.dispose()}attach(t){return this.object=t,this._root.visible=!0,this}detach(){return this.object=void 0,this.axis=null,this._root.visible=!1,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(ma),this.dispatchEvent(ya),this.pointStart.copy(this.pointEnd))}getRaycaster(){return ca}getMode(){return this.mode}setMode(t){this.mode=t}setTranslationSnap(t){this.translationSnap=t}setRotationSnap(t){this.rotationSnap=t}setScaleSnap(t){this.scaleSnap=t}setSize(t){this.size=t}setSpace(t){this.space=t}}function va(t){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:t.button};{const e=this.domElement.getBoundingClientRect();return{x:(t.clientX-e.left)/e.width*2-1,y:-(t.clientY-e.top)/e.height*2+1,button:t.button}}}function ba(t){if(this.enabled)switch(t.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(t))}}function xa(t){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(t.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(t)),this.pointerDown(this._getPointer(t)))}function Ea(t){this.enabled&&this.pointerMove(this._getPointer(t))}function Ta(t){this.enabled&&(this.domElement.releasePointerCapture(t.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(t)))}function Aa(t,e,i){const s=e.intersectObject(t,!0);for(let t=0;t<s.length;t++)if(s[t].object.visible||i)return s[t];return!1}const Ca=new d,Sa=new n(0,1,0),Oa=new n(0,0,0),Pa=new p,Ia=new u,Da=new u,ka=new n,za=new p,Ma=new n(1,0,0),Ba=new n(0,1,0),Ua=new n(0,0,1),Ra=new n,Na=new n,La=new n;class Fa extends _{constructor(t){super(),this.isTransformControlsRoot=!0,this.controls=t,this.visible=!1}updateMatrixWorld(t){const e=this.controls;void 0!==e.object&&(e.object.updateMatrixWorld(),null===e.object.parent?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):e.object.parent.matrixWorld.decompose(e._parentPosition,e._parentQuaternion,e._parentScale),e.object.matrixWorld.decompose(e.worldPosition,e.worldQuaternion,e._worldScale),e._parentQuaternionInv.copy(e._parentQuaternion).invert(),e._worldQuaternionInv.copy(e.worldQuaternion).invert()),e.camera.updateMatrixWorld(),e.camera.matrixWorld.decompose(e.cameraPosition,e.cameraQuaternion,e._cameraScale),e.camera.isOrthographicCamera?e.camera.getWorldDirection(e.eye).negate():e.eye.copy(e.cameraPosition).sub(e.worldPosition).normalize(),super.updateMatrixWorld(t)}dispose(){this.traverse((function(t){t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}))}}class Va extends _{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const t=new y({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),e=new w({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),i=t.clone();i.opacity=.15;const s=e.clone();s.opacity=.5;const n=t.clone();n.color.setHex(16711680);const r=t.clone();r.color.setHex(65280);const o=t.clone();o.color.setHex(255);const a=t.clone();a.color.setHex(16711680),a.opacity=.5;const h=t.clone();h.color.setHex(65280),h.opacity=.5;const c=t.clone();c.color.setHex(255),c.opacity=.5;const u=t.clone();u.opacity=.25;const d=t.clone();d.color.setHex(16776960),d.opacity=.25;t.clone().color.setHex(16776960);const p=t.clone();p.color.setHex(7895160);const f=new v(0,.04,.1,12);f.translate(0,.05,0);const m=new b(.08,.08,.08);m.translate(0,.04,0);const g=new x;g.setAttribute("position",new E([0,0,0,1,0,0],3));const O=new v(.0075,.0075,.5,3);function P(t,e){const i=new S(t,.0075,3,64,e*Math.PI*2);return i.rotateY(Math.PI/2),i.rotateX(Math.PI/2),i}O.translate(0,.25,0);const I={X:[[new l(f,n),[.5,0,0],[0,0,-Math.PI/2]],[new l(f,n),[-.5,0,0],[0,0,Math.PI/2]],[new l(O,n),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new l(f,r),[0,.5,0]],[new l(f,r),[0,-.5,0],[Math.PI,0,0]],[new l(O,r)]],Z:[[new l(f,o),[0,0,.5],[Math.PI/2,0,0]],[new l(f,o),[0,0,-.5],[-Math.PI/2,0,0]],[new l(O,o),null,[Math.PI/2,0,0]]],XYZ:[[new l(new T(.1,0),u.clone()),[0,0,0]]],XY:[[new l(new b(.15,.15,.01),c.clone()),[.15,.15,0]]],YZ:[[new l(new b(.15,.15,.01),a.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new l(new b(.15,.15,.01),h.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},D={X:[[new l(new v(.2,0,.6,4),i),[.3,0,0],[0,0,-Math.PI/2]],[new l(new v(.2,0,.6,4),i),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new l(new v(.2,0,.6,4),i),[0,.3,0]],[new l(new v(.2,0,.6,4),i),[0,-.3,0],[0,0,Math.PI]]],Z:[[new l(new v(.2,0,.6,4),i),[0,0,.3],[Math.PI/2,0,0]],[new l(new v(.2,0,.6,4),i),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new l(new T(.2,0),i)]],XY:[[new l(new b(.2,.2,.01),i),[.15,.15,0]]],YZ:[[new l(new b(.2,.2,.01),i),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new l(new b(.2,.2,.01),i),[.15,0,.15],[-Math.PI/2,0,0]]]},k={START:[[new l(new T(.01,2),s),null,null,null,"helper"]],END:[[new l(new T(.01,2),s),null,null,null,"helper"]],DELTA:[[new A(function(){const t=new x;return t.setAttribute("position",new E([0,0,0,1,1,1],3)),t}(),s),null,null,null,"helper"]],X:[[new A(g,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new A(g,s.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new A(g,s.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},z={XYZE:[[new l(P(.5,1),p),null,[0,Math.PI/2,0]]],X:[[new l(P(.5,.5),n)]],Y:[[new l(P(.5,.5),r),null,[0,0,-Math.PI/2]]],Z:[[new l(P(.5,.5),o),null,[0,Math.PI/2,0]]],E:[[new l(P(.75,1),d),null,[0,Math.PI/2,0]]]},M={AXIS:[[new A(g,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},B={XYZE:[[new l(new C(.25,10,8),i)]],X:[[new l(new S(.5,.1,4,24),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new l(new S(.5,.1,4,24),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new l(new S(.5,.1,4,24),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new l(new S(.75,.1,2,24),i)]]},U={X:[[new l(m,n),[.5,0,0],[0,0,-Math.PI/2]],[new l(O,n),[0,0,0],[0,0,-Math.PI/2]],[new l(m,n),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new l(m,r),[0,.5,0]],[new l(O,r)],[new l(m,r),[0,-.5,0],[0,0,Math.PI]]],Z:[[new l(m,o),[0,0,.5],[Math.PI/2,0,0]],[new l(O,o),[0,0,0],[Math.PI/2,0,0]],[new l(m,o),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new l(new b(.15,.15,.01),c),[.15,.15,0]]],YZ:[[new l(new b(.15,.15,.01),a),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new l(new b(.15,.15,.01),h),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new l(new b(.1,.1,.1),u.clone())]]},R={X:[[new l(new v(.2,0,.6,4),i),[.3,0,0],[0,0,-Math.PI/2]],[new l(new v(.2,0,.6,4),i),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new l(new v(.2,0,.6,4),i),[0,.3,0]],[new l(new v(.2,0,.6,4),i),[0,-.3,0],[0,0,Math.PI]]],Z:[[new l(new v(.2,0,.6,4),i),[0,0,.3],[Math.PI/2,0,0]],[new l(new v(.2,0,.6,4),i),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new l(new b(.2,.2,.01),i),[.15,.15,0]]],YZ:[[new l(new b(.2,.2,.01),i),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new l(new b(.2,.2,.01),i),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new l(new b(.2,.2,.2),i),[0,0,0]]]},N={X:[[new A(g,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new A(g,s.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new A(g,s.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function L(t){const e=new _;for(const i in t)for(let s=t[i].length;s--;){const n=t[i][s][0].clone(),r=t[i][s][1],o=t[i][s][2],a=t[i][s][3],h=t[i][s][4];n.name=i,n.tag=h,r&&n.position.set(r[0],r[1],r[2]),o&&n.rotation.set(o[0],o[1],o[2]),a&&n.scale.set(a[0],a[1],a[2]),n.updateMatrix();const l=n.geometry.clone();l.applyMatrix4(n.matrix),n.geometry=l,n.renderOrder=1/0,n.position.set(0,0,0),n.rotation.set(0,0,0),n.scale.set(1,1,1),e.add(n)}return e}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=L(I)),this.add(this.gizmo.rotate=L(z)),this.add(this.gizmo.scale=L(U)),this.add(this.picker.translate=L(D)),this.add(this.picker.rotate=L(B)),this.add(this.picker.scale=L(R)),this.add(this.helper.translate=L(k)),this.add(this.helper.rotate=L(M)),this.add(this.helper.scale=L(N)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(t){const e="local"===("scale"===this.mode?"local":this.space)?this.worldQuaternion:Da;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;let i=[];i=i.concat(this.picker[this.mode].children),i=i.concat(this.gizmo[this.mode].children),i=i.concat(this.helper[this.mode].children);for(let t=0;t<i.length;t++){const s=i[t];let n;if(s.visible=!0,s.rotation.set(0,0,0),s.position.copy(this.worldPosition),n=this.camera.isOrthographicCamera?(this.camera.top-this.camera.bottom)/this.camera.zoom:this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),s.scale.set(1,1,1).multiplyScalar(n*this.size/4),"helper"!==s.tag){if(s.quaternion.copy(e),"translate"===this.mode||"scale"===this.mode){const t=.99,i=.2;"X"===s.name&&Math.abs(Sa.copy(Ma).applyQuaternion(e).dot(this.eye))>t&&(s.scale.set(1e-10,1e-10,1e-10),s.visible=!1),"Y"===s.name&&Math.abs(Sa.copy(Ba).applyQuaternion(e).dot(this.eye))>t&&(s.scale.set(1e-10,1e-10,1e-10),s.visible=!1),"Z"===s.name&&Math.abs(Sa.copy(Ua).applyQuaternion(e).dot(this.eye))>t&&(s.scale.set(1e-10,1e-10,1e-10),s.visible=!1),"XY"===s.name&&Math.abs(Sa.copy(Ua).applyQuaternion(e).dot(this.eye))<i&&(s.scale.set(1e-10,1e-10,1e-10),s.visible=!1),"YZ"===s.name&&Math.abs(Sa.copy(Ma).applyQuaternion(e).dot(this.eye))<i&&(s.scale.set(1e-10,1e-10,1e-10),s.visible=!1),"XZ"===s.name&&Math.abs(Sa.copy(Ba).applyQuaternion(e).dot(this.eye))<i&&(s.scale.set(1e-10,1e-10,1e-10),s.visible=!1)}else"rotate"===this.mode&&(Ia.copy(e),Sa.copy(this.eye).applyQuaternion(pa.copy(e).invert()),-1!==s.name.search("E")&&s.quaternion.setFromRotationMatrix(Pa.lookAt(this.eye,Oa,Ba)),"X"===s.name&&(pa.setFromAxisAngle(Ma,Math.atan2(-Sa.y,Sa.z)),pa.multiplyQuaternions(Ia,pa),s.quaternion.copy(pa)),"Y"===s.name&&(pa.setFromAxisAngle(Ba,Math.atan2(Sa.x,Sa.z)),pa.multiplyQuaternions(Ia,pa),s.quaternion.copy(pa)),"Z"===s.name&&(pa.setFromAxisAngle(Ua,Math.atan2(Sa.y,Sa.x)),pa.multiplyQuaternions(Ia,pa),s.quaternion.copy(pa)));s.visible=s.visible&&(-1===s.name.indexOf("X")||this.showX),s.visible=s.visible&&(-1===s.name.indexOf("Y")||this.showY),s.visible=s.visible&&(-1===s.name.indexOf("Z")||this.showZ),s.visible=s.visible&&(-1===s.name.indexOf("E")||this.showX&&this.showY&&this.showZ),s.material._color=s.material._color||s.material.color.clone(),s.material._opacity=s.material._opacity||s.material.opacity,s.material.color.copy(s.material._color),s.material.opacity=s.material._opacity,this.enabled&&this.axis&&(s.name===this.axis||this.axis.split("").some((function(t){return s.name===t})))&&(s.material.color.setHex(16776960),s.material.opacity=1)}else s.visible=!1,"AXIS"===s.name?(s.visible=!!this.axis,"X"===this.axis&&(pa.setFromEuler(Ca.set(0,0,0)),s.quaternion.copy(e).multiply(pa),Math.abs(Sa.copy(Ma).applyQuaternion(e).dot(this.eye))>.9&&(s.visible=!1)),"Y"===this.axis&&(pa.setFromEuler(Ca.set(0,0,Math.PI/2)),s.quaternion.copy(e).multiply(pa),Math.abs(Sa.copy(Ba).applyQuaternion(e).dot(this.eye))>.9&&(s.visible=!1)),"Z"===this.axis&&(pa.setFromEuler(Ca.set(0,Math.PI/2,0)),s.quaternion.copy(e).multiply(pa),Math.abs(Sa.copy(Ua).applyQuaternion(e).dot(this.eye))>.9&&(s.visible=!1)),"XYZE"===this.axis&&(pa.setFromEuler(Ca.set(0,Math.PI/2,0)),Sa.copy(this.rotationAxis),s.quaternion.setFromRotationMatrix(Pa.lookAt(Oa,Sa,Ba)),s.quaternion.multiply(pa),s.visible=this.dragging),"E"===this.axis&&(s.visible=!1)):"START"===s.name?(s.position.copy(this.worldPositionStart),s.visible=this.dragging):"END"===s.name?(s.position.copy(this.worldPosition),s.visible=this.dragging):"DELTA"===s.name?(s.position.copy(this.worldPositionStart),s.quaternion.copy(this.worldQuaternionStart),ua.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),ua.applyQuaternion(this.worldQuaternionStart.clone().invert()),s.scale.copy(ua),s.visible=this.dragging):(s.quaternion.copy(e),this.dragging?s.position.copy(this.worldPositionStart):s.position.copy(this.worldPosition),this.axis&&(s.visible=-1!==this.axis.search(s.name)))}super.updateMatrixWorld(t)}}class ja extends l{constructor(){super(new O(1e5,1e5,2,2),new y({visible:!1,wireframe:!0,side:P,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(t){let e=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(e="local"),Ra.copy(Ma).applyQuaternion("local"===e?this.worldQuaternion:Da),Na.copy(Ba).applyQuaternion("local"===e?this.worldQuaternion:Da),La.copy(Ua).applyQuaternion("local"===e?this.worldQuaternion:Da),Sa.copy(Na),this.mode){case"translate":case"scale":switch(this.axis){case"X":Sa.copy(this.eye).cross(Ra),ka.copy(Ra).cross(Sa);break;case"Y":Sa.copy(this.eye).cross(Na),ka.copy(Na).cross(Sa);break;case"Z":Sa.copy(this.eye).cross(La),ka.copy(La).cross(Sa);break;case"XY":ka.copy(La);break;case"YZ":ka.copy(Ra);break;case"XZ":Sa.copy(La),ka.copy(Na);break;case"XYZ":case"E":ka.set(0,0,0)}break;default:ka.set(0,0,0)}0===ka.length()?this.quaternion.copy(this.cameraQuaternion):(za.lookAt(ua.set(0,0,0),ka,Sa),this.quaternion.setFromRotationMatrix(za)),super.updateMatrixWorld(t)}}class Ya{constructor(t,e,i,n,r,o=5,a=!0){if(ne(this,"onDraggingStarted",new re),ne(this,"onDraggingEnded",new re),ne(this,"onDisposed",new re),ne(this,"normal"),ne(this,"origin"),ne(this,"three",new s.Plane),ne(this,"components"),ne(this,"world"),ne(this,"type","default"),ne(this,"_title","Clipping Plane"),ne(this,"_helper"),ne(this,"_visible",!0),ne(this,"_enabled",!0),ne(this,"_controlsActive",!1),ne(this,"_arrowBoundBox",new s.Mesh),ne(this,"_planeMesh"),ne(this,"_controls"),ne(this,"_hiddenMaterial",new s.MeshBasicMaterial({visible:!1})),ne(this,"_visibilityBeforeDisabled",!0),ne(this,"notifyManager",(()=>{const t=this.components.get($a),e=t.list.getKey(this);e&&t.list.set(e,this)})),ne(this,"update",(()=>{this._enabled&&this.three.setFromNormalAndCoplanarPoint(this.normal,this._helper.position)})),ne(this,"changeDrag",(t=>{this._visible=!t.value,this.preventCameraMovement(),this.notifyDraggingChanged(t)})),this.components=t,this.world=e,!e.renderer)throw new Error("The given world must have a renderer!");this.normal=n,this.origin=i,e.renderer.setPlane(!0,this.three),this._planeMesh=Ya.newPlaneMesh(o,r),this._helper=this.newHelper(),this._controls=this.newTransformControls(),this.three.setFromNormalAndCoplanarPoint(n,i),a&&this.toggleControls(!0)}set title(t){this._title=t,this.notifyManager()}get title(){return this._title}get enabled(){return this._enabled}set enabled(t){if(!this.world.isDisposing){if(!this.world.renderer)throw new Error("No renderer found for clipping plane!");this._enabled=t,t?this.visible=this._visibilityBeforeDisabled:(this._visibilityBeforeDisabled=this.visible,this.visible=!1),this.world.renderer.setPlane(t,this.three),this.notifyManager()}}get visible(){return this._visible}set visible(t){this._visible=t,this._controls.getHelper().visible=t,this._helper.visible=t,this.toggleControls(t),this.notifyManager()}get meshes(){return[this._planeMesh,this._arrowBoundBox]}get planeMaterial(){return this._planeMesh.material}set planeMaterial(t){this._planeMesh.material=t}get size(){return this._planeMesh.scale.x}set size(t){this._planeMesh.scale.set(t,t,t)}get helper(){return this._helper}setFromNormalAndCoplanarPoint(t,e){this.reset(),this.normal.equals(t)||(this.normal.copy(t),this._helper.lookAt(t)),this.origin.copy(e),this._helper.position.copy(e),this._helper.updateMatrix(),this.update()}dispose(){this._enabled=!1,this.onDraggingStarted.reset(),this.onDraggingEnded.reset(),this._helper.removeFromParent(),this.world.renderer&&this.world.renderer.setPlane(!1,this.three),this._arrowBoundBox.removeFromParent(),this._arrowBoundBox.geometry.dispose(),this._planeMesh.geometry.dispose(),this._controls.getHelper().removeFromParent(),this._controls.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}reset(){const t=new s.Vector3(1,0,0),e=new s.Vector3;this.normal.equals(t)||(this.normal.copy(t),this._helper.lookAt(t)),this.origin.copy(e),this._helper.position.copy(e),this._helper.updateMatrix()}toggleControls(t){if(t){if(this._controlsActive)return;this._controls.addEventListener("change",this.update),this._controls.addEventListener("dragging-changed",this.changeDrag)}else this._controls.removeEventListener("change",this.update),this._controls.removeEventListener("dragging-changed",this.changeDrag);this._controlsActive=t}newTransformControls(){if(!this.world.renderer)throw new Error("No renderer found for clipping plane!");const t=this.world.camera.three,e=this.world.renderer.three.domElement,i=new wa(t,e);return this.initializeControls(i),this.world.scene.three.add(i.getHelper()),i}initializeControls(t){t.attach(this._helper),t.showX=!1,t.showY=!1,t.setSpace("local"),this.createArrowBoundingBox(),t.getHelper().children[0].children[0].add(this._arrowBoundBox)}createArrowBoundingBox(){this._arrowBoundBox.geometry=new s.CylinderGeometry(.18,.18,1.2),this._arrowBoundBox.material=this._hiddenMaterial,this._arrowBoundBox.rotateX(Math.PI/2),this._arrowBoundBox.updateMatrix(),this._arrowBoundBox.geometry.applyMatrix4(this._arrowBoundBox.matrix)}notifyDraggingChanged(t){t.value?this.onDraggingStarted.trigger():this.onDraggingEnded.trigger()}preventCameraMovement(){this.world.camera.enabled=this._visible}newHelper(){const t=new s.Object3D;return t.lookAt(this.normal),t.position.copy(this.origin),this._planeMesh.position.z+=.01,t.add(this._planeMesh),this.world.scene.three.add(t),t}static newPlaneMesh(t,e){const i=new s.PlaneGeometry(1),n=new s.Mesh(i,e);return n.scale.set(t,t,t),n}}class Za extends Yi{constructor(){super(...arguments),ne(this,"_config",{enabled:{value:!0,type:"Boolean"},visible:{value:!0,type:"Boolean"},color:{value:new s.Color,type:"Color"},opacity:{type:"Number",interpolable:!0,value:1,min:0,max:1},size:{type:"Number",interpolable:!0,value:2,min:0,max:100}})}get enabled(){return this._config.enabled.value}set enabled(t){this._config.enabled.value=t,this._component.enabled=t}get visible(){return this._config.visible.value}set visible(t){this._config.visible.value=t,this._component.visible=t}get color(){return this._config.color.value}set color(t){this._config.color.value=t,this._component.material.color.copy(t)}get opacity(){return this._config.opacity.value}set opacity(t){this._config.opacity.value=t,this._component.material.opacity=t}get size(){return this._config.size.value}set size(t){this._config.size.value=t,this._component.size=t}}const Ha=class e extends he{constructor(i){super(i),ne(this,"onSetup",new re),ne(this,"onBeforeDrag",new re),ne(this,"onAfterDrag",new re),ne(this,"onBeforeCreate",new re),ne(this,"onBeforeCancel",new re),ne(this,"onAfterCancel",new re),ne(this,"onBeforeDelete",new re),ne(this,"onAfterCreate",new re),ne(this,"onAfterDelete",new re),ne(this,"onDisposed",new re),ne(this,"isSetup",!1),ne(this,"orthogonalY",!1),ne(this,"toleranceOrthogonalY",.7),ne(this,"Type",Ya),ne(this,"list",new t.DataMap),ne(this,"config",new Za(this,this.components,"Clipper",e.uuid)),ne(this,"_defaultConfig",{color:new s.Color(12255487),opacity:.2,size:2}),ne(this,"_material",new s.MeshBasicMaterial({color:12255487,side:s.DoubleSide,transparent:!0,opacity:.2})),ne(this,"_size",5),ne(this,"_enabled",!1),ne(this,"_visible",!0),ne(this,"_onStartDragging",(()=>{this.onBeforeDrag.trigger()})),ne(this,"_onEndDragging",(()=>{this.onAfterDrag.trigger()})),this.components.add(e.uuid,this),this.setEvents()}get enabled(){return this._enabled}set enabled(t){this._enabled=t}get visible(){return this._visible}set visible(t){this._visible=t;for(const[e,i]of this.list)i.visible=t}get material(){return this._material}set material(t){this._material=t;for(const[e,i]of this.list)i.planeMaterial=t}get size(){return this._size}set size(t){this._size=t;for(const[e,i]of this.list)i.size=t}setEvents(){this.list.onBeforeDelete.add((({value:t})=>{if(!t.world.renderer)throw new Error("Renderer not found for this plane's world!");t.world.renderer.setPlane(!1,t.three),t.dispose(),this.updateMaterialsAndPlanes(),this.onAfterDelete.trigger(t)}))}dispose(){this._enabled=!1;this.components.get(Hi).list.delete(this.config.uuid),this.list.clear(),this._material.dispose(),this.onBeforeCreate.reset(),this.onBeforeCancel.reset(),this.onBeforeDelete.reset(),this.onBeforeDrag.reset(),this.onAfterCreate.reset(),this.onAfterCancel.reset(),this.onAfterDelete.reset(),this.onAfterDrag.reset(),this.onDisposed.trigger(e.uuid),this.onDisposed.reset()}async create(t){const e=this.components.get(ls).get(t),i=await e.castRay();return i?this.createPlaneFromIntersection(t,i):null}createFromNormalAndCoplanarPoint(t,e,i){const s=this.newPlane(t,i,e);return this.updateMaterialsAndPlanes(),s}async delete(t,e){if(!e){const i=await this.pickPlane(t);if(!i)return;e=this.list.getKey(i)}e&&this.list.delete(e)}deleteAll(t){for(const[e,i]of this.list)t&&!t.has(i.type)||this.list.delete(e)}setup(t){const e={...this._defaultConfig,...t};this.config.color=e.color,this.config.opacity=e.opacity,this.config.size=e.size,this.isSetup=!0,this.onSetup.trigger()}async pickPlane(t){const e=this.components.get(ls).get(t),i=this.getAllPlaneMeshes(),s=await e.castRay({items:i});if(s){const t=s.object;return[...this.list.values()].find((e=>e.meshes.includes(t)))}}getAllPlaneMeshes(){const t=[];for(const[e,i]of this.list)t.push(...i.meshes);return t}createPlaneFromIntersection(t,e){var i;if(!t.renderer)throw new Error("The given world must have a renderer!");const n=e.point.distanceTo(new s.Vector3(0,0,0)),r=e.normal||(null==(i=e.face)?void 0:i.normal);if(!n||!r)return null;const o=this.getWorldNormal(e,r),a=this.newPlane(t,e.point,o.negate()),h=this.list.get(a);return h.visible=this._visible,h.size=this._size,t.renderer.setPlane(!0,h.three),this.updateMaterialsAndPlanes(),h}getWorldNormal(t,e){const i=t.object;let n=t.object.matrixWorld.clone();if(i instanceof s.InstancedMesh&&void 0!==t.instanceId){const e=new s.Matrix4;i.getMatrixAt(t.instanceId,e),n=e.multiply(n)}const r=(new s.Matrix3).getNormalMatrix(n),o=e.clone().applyMatrix3(r).normalize();return this.normalizePlaneDirectionY(o),o}normalizePlaneDirectionY(t){this.orthogonalY&&(t.y>this.toleranceOrthogonalY&&(t.x=0,t.y=1,t.z=0),t.y<-this.toleranceOrthogonalY&&(t.x=0,t.y=-1,t.z=0))}newPlane(t,e,i){const s=new this.Type(this.components,t,e,i,this._material);s.onDraggingStarted.add(this._onStartDragging),s.onDraggingEnded.add(this._onEndDragging);const n=_e.create();return this.list.set(n,s),this.onAfterCreate.trigger(s),n}updateMaterialsAndPlanes(){const t=this.components.get(gn);for(const[e,i]of t.list){if(!i.renderer)continue;i.renderer.updateClippingPlanes();const{clippingPlanes:t}=i.renderer;for(const e of i.meshes)if(e.material)if(Array.isArray(e.material))for(const i of e.material)i.clippingPlanes=t;else e.material.clippingPlanes=t}}};ne(Ha,"uuid","66290bc5-18c4-4cd1-9379-2e17a0617611");let $a=Ha;class Wa{constructor(e,i){ne(this,"title"),ne(this,"guid",_e.create()),ne(this,"clippingPlanes",new t.DataSet),ne(this,"camera",{aspect_ratio:1,field_of_view:60,camera_direction:{x:0,y:0,z:0},camera_view_point:{x:0,y:0,z:0},camera_up_vector:{x:0,y:1,z:0}}),ne(this,"exceptionComponents",new t.DataSet),ne(this,"selectionComponents",new t.DataSet),ne(this,"componentColors",new t.DataMap),ne(this,"spacesVisible",!1),ne(this,"spaceBoundariesVisible",!1),ne(this,"openingsVisible",!1),ne(this,"defaultVisibility",!0),ne(this,"snapshot",this.guid),ne(this,"_components"),ne(this,"_world",null),ne(this,"notifyUpdate",(()=>{this._components.get(Ga).list.set(this.guid,this)})),this._components=e,i&&(this.guid=i.guid??this.guid,this.set(i)),this.setEvents()}async getSelectionMap(){const t=this._components.get(qi);return await t.guidsToModelIdMap([...this.selectionComponents])}async getExceptionMap(){const t=this._components.get(qi);return await t.guidsToModelIdMap([...this.exceptionComponents])}get projection(){return"field_of_view"in this.camera?"Perspective":"Orthographic"}get position(){const t=this._components.get(qi),{camera_view_point:e}=this.camera,{x:i,y:n,z:r}=e,o=new s.Vector3(i,n,r);return t.applyBaseCoordinateSystem(o,new s.Matrix4),o}set position(t){const e=t.clone(),i=this._components.get(qi);t.clone().applyMatrix4(i.baseCoordinationMatrix.clone().invert()),this.camera.camera_view_point={x:e.x,y:e.y,z:e.z}}get direction(){const{camera_direction:t}=this.camera,{x:e,y:i,z:n}=t;return new s.Vector3(e,i,n)}set world(t){this._world=t}get world(){return this._world}get _managerVersion(){return this._components.get(la).config.version}get topics(){return[...this._components.get(la).list.values()].filter((t=>t.viewpoints.has(this.guid)))}setEvents(){this.selectionComponents.onUpdated.add(this.notifyUpdate),this.exceptionComponents.onUpdated.add(this.notifyUpdate),this.clippingPlanes.onUpdated.add(this.notifyUpdate),this.componentColors.onItemSet.add(this.notifyUpdate),this.componentColors.onItemDeleted.add(this.notifyUpdate),this.componentColors.onItemUpdated.add(this.notifyUpdate),this.componentColors.onCleared.add(this.notifyUpdate)}set(t){this.title=t.title;const{components:e,perspective_camera:i,orthogonal_camera:n,clipping_planes:r}=t;if(e){const{selection:t,visibility:i,coloring:s}=e;if(t){this.selectionComponents.clear();for(const{ifc_guid:e}of t)e&&this.selectionComponents.add(e)}if(i){const{default_visibility:t,exceptions:e,view_setup_hints:s}=i;if(void 0!==t&&(this.defaultVisibility=t),e){this.exceptionComponents.clear();for(const{ifc_guid:t}of e)t&&this.exceptionComponents.add(t)}if(s){const{spaces_visible:t,space_boundaries_visible:e,openings_visible:i}=s;void 0!==t&&(this.spacesVisible=t),void 0!==e&&(this.spaceBoundariesVisible=e),void 0!==i&&(this.openingsVisible=i)}}if(s){this.componentColors.clear();for(const t of s){const{color:e,components:i}=t,s=i.map((t=>t.ifc_guid)).filter((t=>null!==t));this.componentColors.set(e,s)}}}if((i||n)&&(this.camera=i??n),r&&this.world){const t=this._components.get($a);for(const e of r){const{location:i,direction:n}=e,r=new s.Vector3(i.x,i.z,-i.y),o=new s.Vector3(n.x,n.z,-n.y),a=t.createFromNormalAndCoplanarPoint(this.world,o,r);this.clippingPlanes.add(a),t.list.get(a).enabled=!1,t.list.get(a).visible=!1}}this.notifyUpdate()}async go(t){if(!this.world)return;const{camera:e}=this.world;if(!(e instanceof Jo))throw new Error("Viewpoint: the world's camera component must be of type OrthoPerspectiveCamera to switch between perspective and orthographic projections.");const{transition:i,applyClippings:n,applyVisibility:r,clippingsVisibility:o}={transition:!0,applyClippings:!0,applyVisibility:!0,clippingsVisibility:!0,...t};e.projection.set(this.projection);const a=new s.Vector3(this.camera.camera_view_point.x,this.camera.camera_view_point.y,this.camera.camera_view_point.z),h=new s.Vector3(this.camera.camera_direction.x,this.camera.camera_direction.y,this.camera.camera_direction.z);if(a.equals(new s.Vector3)&&h.equals(new s.Vector3))return;const l=this.position,c=this.direction,u={x:l.x+80*c.x,y:l.y+80*c.y,z:l.z+80*c.z},d=[];n&&this.setClippingState(!0),r&&d.push(this.applyVisibility()),this.setClippingVisibility(o),d.push(e.controls.setLookAt(l.x,l.y,l.z,u.x,u.y,u.z,i)),await Promise.all(d)}async updateCamera(t=!0){return new Promise((e=>{if(!this.world)return void e(!1);const{camera:i,renderer:n}=this.world;if(!n)throw new Error("Viewpoint: the world needs to have a renderer!");if(!i.hasCameraControls())throw new Error("Viewpoint: world's camera need camera controls!");const r=new s.Vector3;i.controls.getPosition(r);const o=i.three,a=new s.Vector3(0,0,-1).applyEuler(o.rotation),{width:h,height:l}=n.getSize();let c=h/l;Number.isNaN(c)&&(c=1);const u=this._components.get(qi);r.applyMatrix4(u.baseCoordinationMatrix.clone().invert());const d={aspect_ratio:c,camera_view_point:{x:r.x,y:r.y,z:r.z},camera_direction:{x:a.x,y:a.y,z:a.z},camera_up_vector:{x:0,y:1,z:0}};if(o instanceof s.PerspectiveCamera?this.camera={...d,field_of_view:o.fov}:o instanceof s.OrthographicCamera&&(this.camera={...d,view_to_world_scale:o.top-o.bottom}),t){const t=this._components.get(Ga),s=n.three.domElement;n.three.render(this.world.scene.three,i.three),s.toBlob((async i=>{if(i){const e=await i.arrayBuffer(),s=new Uint8Array(e);t.snapshots.set(this.guid,s)}this.notifyUpdate(),e(!0)}))}else this.notifyUpdate(),e(!0)}))}takeSnapshot(){return new Promise((t=>{if(!this.world)return void t(!1);const{camera:e,renderer:i}=this.world;if(!i)throw new Error("Viewpoint: the world needs to have a renderer!");const s=this._components.get(Ga),n=i.three.domElement;i.three.render(this.world.scene.three,e.three),n.toBlob((async e=>{if(e){const t=await e.arrayBuffer(),i=new Uint8Array(t);s.snapshots.set(this.guid,i)}this.notifyUpdate(),t(!0)}))}))}updateClippingPlanes(){this.clippingPlanes.clear();const t=this._components.get($a);for(const[e,i]of t.list)i.enabled&&this.clippingPlanes.add(e)}async applyVisibility(){const t=this._components.get(Ji);t.set(this.defaultVisibility);const e=await this.getExceptionMap();t.set(!this.defaultVisibility,e);const i=await this.getSelectionMap();t.set(!0,i)}async setColorizationState(e){const i=this._components.get(qi),n=[];if(e)for(const[e,r]of this.componentColors){const o=`#${e}`,a=await i.guidsToModelIdMap(r);for(const[e,r]of Object.entries(a)){const a=i.list.get(e);a&&n.push(a.highlight([...r],{customId:o,color:new s.Color(o),renderedFaces:t.RenderedFaces.ONE,opacity:1,transparent:!1}))}}else for(const[t,e]of this.componentColors){const t=await i.guidsToModelIdMap(e);for(const[e,s]of Object.entries(t)){const t=i.list.get(e);t&&n.push(t.resetHighlight([...s]))}}n.push(i.core.update(!0)),await Promise.all(n)}setClippingState(t){const e=this._components.get($a);for(const[i,s]of e.list)s.enabled=t&&this.clippingPlanes.has(i)}setClippingVisibility(t){const e=this._components.get($a);for(const i of this.clippingPlanes){const s=e.list.get(i);s&&(s.visible=t)}}async createComponentTags(t){var e;const i=this._components.get(qi);let s="";if(this._components.get(la).config.includeSelectionTag){const n="selection"===t?await this.getSelectionMap():await this.getExceptionMap();for(const t in n){const r=i.list.get(t);if(!r)continue;const o=n[t];for(const t of o){const i=r.getItem(t),n=await i.getGuid();if(!n)continue;const o=null==(e=await i.getAttributes())?void 0:e.getValue("Tag");let a=null;o&&(a=`AuthoringToolId="${o}"`),s+=`\n<Component IfcGuid="${n}" ${a??""} />`}}}else s=[...this.selectionComponents].map((t=>`<Component IfcGuid="${t}" />`)).join("\n");return s}createColorTags(){let t="";for(const[e,i]of this.componentColors.entries()){t+=`<Color Color="${e}">\n${i.map((t=>`\n<Component IfcGuid="${t}" />`)).join("\n")}\n</Color>`}return 0!==t.length?`<Coloring>\n${t}\n</Coloring>`:"<Coloring />"}toJSON(){const t=this._components.get($a),e={guid:this.guid,components:{selection:[...this.selectionComponents].map((t=>({ifc_guid:t,authoring_tool_id:null}))),coloring:[...this.componentColors].map((([t,e])=>({color:t,components:e.map((t=>({ifc_guid:t,authoring_tool_id:null})))}))),visibility:{default_visibility:this.defaultVisibility,exceptions:[...this.exceptionComponents].map((t=>({ifc_guid:t,authoring_tool_id:null}))),view_setup_hints:{spaces_visible:this.spacesVisible,space_boundaries_visible:this.spaceBoundariesVisible,openings_visible:this.openingsVisible}}},clipping_planes:[...this.clippingPlanes].map((e=>{const i=t.list.get(e);if(!i)return null;const s=i._controls.worldPosition??i.origin,{normal:n}=i;return{location:{x:s.x,y:-s.z,z:s.y},direction:{x:n.x,y:-n.z,z:n.y}}})).filter((t=>null!==t))};"field_of_view"in this.camera?e.perspective_camera=this.camera:e.orthogonal_camera=this.camera;const i=this._components.get(Ga),s=i.snapshots.get(this.snapshot);if(s){const t=s.toString(),n=btoa(t),r=i.getSnapshotExtension(this.snapshot);e.snapshot={snapshot_type:r,snapshot_data:n}}return e}async serialize(t=this._managerVersion){const e=this._components.get(qi),i=this.position;i.applyMatrix4(e.baseCoordinationMatrix.clone().invert());const n=this.direction;n.normalize();const r=(new s.Matrix4).makeRotationX(Math.PI/2),o=n.clone().applyMatrix4(r);o.normalize();const a=`<CameraViewPoint>\n      <X>${i.x}</X>\n      <Y>${-i.z}</Y>\n      <Z>${i.y}</Z>\n    </CameraViewPoint>`,h=`<CameraDirection>\n      <X>${n.x}</X>\n      <Y>${-n.z}</Y>\n      <Z>${n.y}</Z>\n    </CameraDirection>`,l=`<CameraUpVector>\n      <X>${o.x}</X>\n      <Y>${-o.z}</Y>\n      <Z>${o.y}</Z>\n    </CameraUpVector>`,c=`<AspectRatio>${this.camera.aspect_ratio}</AspectRatio>`;let u="";"view_to_world_scale"in this.camera?u=`<OrthogonalCamera>\n        ${a}\n        ${h}\n        ${l}\n        ${c}\n        <ViewToWorldScale>${this.camera.view_to_world_scale}</ViewToWorldScale>\n      </OrthogonalCamera>`:"field_of_view"in this.camera&&(u=`<PerspectiveCamera>\n        ${a}\n        ${h}\n        ${l}\n        ${c}\n        <FieldOfView>${this.camera.field_of_view}</FieldOfView>\n      </PerspectiveCamera>`);const d=`<ViewSetupHints SpacesVisible="${this.spacesVisible??!1}" SpaceBoundariesVisible="${this.spaceBoundariesVisible??!1}" OpeningsVisible="${this.openingsVisible??!1}" />`,p=(await this.createComponentTags("selection")).trim(),f=(await this.createComponentTags("exception")).trim(),m=this.createColorTags();return`<?xml version="1.0" encoding="UTF-8"?>\n    <VisualizationInfo Guid="${this.guid}">\n      <Components>\n        ${"2.1"===t?d:""}\n        ${0!==p.length?`<Selection>${p}</Selection>`:""}\n        <Visibility DefaultVisibility="${this.defaultVisibility}">\n          ${"3"===t?d:""}\n          ${0!==f.length?`<Exceptions>${f}</Exceptions>`:""}\n        </Visibility>\n        ${m}\n      </Components>\n      ${u}\n    </VisualizationInfo>`}}class qa extends Yi{constructor(){super(...arguments),ne(this,"_config",{overwriteColors:{value:!1,type:"Boolean"}})}get overwriteColors(){return this._config.overwriteColors.value}set overwriteColors(t){this._config.overwriteColors.value=t}}const Xa=class t extends he{constructor(i){super(i),ne(this,"enabled",!0),ne(this,"world",null),ne(this,"list",new e),ne(this,"snapshots",new e),ne(this,"isSetup",!1),ne(this,"onSetup",new re),ne(this,"config",new qa(this,this.components,"Viewpoints",t.uuid)),ne(this,"onDisposed",new re),i.add(t.uuid,this)}create(t){const e=new Wa(this.components,t);return e.world=this.world,t||this.list.set(e.guid,e),e}getSnapshotExtension(t){let e="jpeg";const i=this.snapshots.get(t);if(!i)return e;const s=i.subarray(0,4);let n="";for(let t=0;t<s.length;t++)n+=s[t].toString(16);return n.startsWith("89504e47")&&(e="png"),n.startsWith("ffd8ffe")&&(e="jpeg"),e}setup(){}dispose(){this.list.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}};ne(Xa,"uuid","ee867824-a796-408d-8aa0-4e5962a83c66");let Ga=Xa;class Qa{constructor(t,e){ne(this,"_components"),ne(this,"_cameraOffset",10),ne(this,"_planeHelper"),ne(this,"_farPlaneHelper"),ne(this,"_cameraHelper"),ne(this,"onStateChanged",new re),ne(this,"onUpdated",new re),ne(this,"onDisposed",new re),ne(this,"camera"),ne(this,"plane",new s.Plane),ne(this,"farPlane",new s.Plane),ne(this,"id",_e.create()),ne(this,"_open",!1),ne(this,"_range",Ja.defaultRange),ne(this,"_world",null),ne(this,"_helpersVisible",!1),ne(this,"_planesEnabled",!1),this._components=t,this.camera=new Jo(this._components);const{threeOrtho:i}=this.camera;if((null==e?void 0:e.id)&&(this.id=e.id),(null==e?void 0:e.normal)&&(null==e?void 0:e.point)){const{normal:t,point:i}=e;this.plane.setFromNormalAndCoplanarPoint(t,i)}this._cameraHelper=new s.CameraHelper(i),this._planeHelper=new s.PlaneHelper(this.plane,50),this._farPlaneHelper=new s.PlaneHelper(this.farPlane,50),this.farPlaneHelperColor=new s.Color("blue"),this.update()}get _planeNormalOpposite(){return this.plane.normal.clone().negate()}get _planePosition(){return this.plane.normal.clone().multiplyScalar(-this.plane.constant)}get _cameraPosition(){return this._planePosition.addScaledVector(this._planeNormalOpposite,this._cameraOffset)}set open(t){this._open=t,this.onStateChanged.trigger(["open"])}get open(){return this._open}set planeHelperColor(t){!Array.isArray(this._planeHelper.material)&&"color"in this._planeHelper.material&&this._planeHelper.material.color instanceof s.Color&&(this._planeHelper.material.color=t)}set farPlaneHelperColor(t){!Array.isArray(this._farPlaneHelper.material)&&"color"in this._farPlaneHelper.material&&this._farPlaneHelper.material.color instanceof s.Color&&(this._farPlaneHelper.material.color=t)}set range(t){this._range=t,this.update()}get range(){return this._range}set distance(t){this.plane.constant=t,this.update()}get distance(){return this.plane.constant}set world(t){this._world=t,this.camera.currentWorld=t,t&&(this.camera.projection.set("Orthographic"),this.camera.set("Plan"),this.camera.controls.dollySpeed=6,this.camera.controls.restThreshold=.005,this.update())}get world(){return this._world}set helpersVisible(t){if(!t)return this._helpersVisible=t,this._planeHelper.removeFromParent(),this._farPlaneHelper.removeFromParent(),void this._cameraHelper.removeFromParent();this.world&&(this._helpersVisible=t,this.world.scene.three.add(this._planeHelper,this._farPlaneHelper))}get helpersVisible(){return this._helpersVisible}set planesEnabled(t){const{world:e}=this;if(!e)return;const{renderer:i}=e;i&&(i.setPlane(t,this.plane),i.setPlane(t,this.farPlane),this._planesEnabled=t)}get planesEnabled(){return this._planesEnabled}dispose(){this.helpersVisible=!1;const t=this._components.get(pe);t.destroy(this._planeHelper),t.destroy(this._farPlaneHelper),t.destroy(this._cameraHelper),this.camera.dispose(),this.onDisposed.trigger()}update(){if(this.world){const t=this._cameraPosition,e=this._planePosition;this.camera.controls.setLookAt(t.x,t.y,t.z,e.x,e.y,e.z,!1)}this.farPlane.normal.copy(this._planeNormalOpposite),this.farPlane.constant=this.range-this.plane.constant,this.onUpdated.trigger()}flip(){this.plane.normal.negate(),this.update()}}const Ka=class t extends he{constructor(i){super(i),ne(this,"list",new e),ne(this,"enabled",!0),ne(this,"world",null),ne(this,"_fragmentsUpdateEvent",(()=>{this.components.get(qi).core.update(!0)})),i.add(t.uuid,this),this.setupEvents()}get hasOpenViews(){return[...this.list.values()].some((t=>t.open))}setupEvents(){this.list.onBeforeDelete.add((({key:t,value:e})=>{e.open&&this.close(t),e.dispose()}))}create(t,e,i){const s=new Qa(this.components,{id:null==i?void 0:i.id,normal:t,point:e});return s.world=(null==i?void 0:i.world)??this.world,this.list.set(s.id,s),s}createFromPlane(t,e){const i=new Qa(this.components,{id:null==e?void 0:e.id});return i.plane.copy(t),i.update(),i.world=(null==e?void 0:e.world)??this.world,this.list.set(i.id,i),i}async createFromIfcStoreys(t){const e=[],i=this.components.get(qi),n=void 0===(null==t?void 0:t.offset)?.25:t.offset;for(const[r,o]of i.list){if(t&&t.modelIds&&!t.modelIds.some((t=>t.test(r))))continue;const i=Object.values(await o.getItemsOfCategories([/BUILDINGSTOREY/])).flat();if(0===i.length)continue;const a=await o.getItemsData(i),[,h]=await o.getCoordinates(),l=new s.Vector3(0,-1,0);for(const i of a){if(!("value"in i.Name)||!("value"in i.Elevation))continue;const{value:r}=i.Name;if((null==t?void 0:t.storeyNames)&&!t.storeyNames.some((t=>t.test(r))))continue;const o=i.Elevation.value+h+n,a=new s.Plane(l,o),c=this.createFromPlane(a,{id:r,world:null==t?void 0:t.world});e.push(c)}}return e}createElevations(t){const e=[],i=this.components.get(qi),n=void 0!==(null==t?void 0:t.combine)&&t.combine,r=(null==t?void 0:t.namingCallback)??(t=>({front:""+(n?"Front":`${t}: Front`),back:""+(n?"Back":`${t}: Back`),left:""+(n?"Left":`${t}: Left`),right:""+(n?"Right":`${t}: Right`)}));let o=[];for(const[e,s]of i.list)t&&t.modelIds&&!t.modelIds.some((t=>t.test(e)))||o.push({id:e,box:s.box});if(n){const t=this.components.get(es);t.list.clear(),t.list.add(...o.map((t=>t.box)));o=[{id:"combined",box:t.get()}]}for(const{id:i,box:n}of o){const{min:o,max:a}=n,h=Math.abs(a.x-o.x),l=Math.abs(a.z-o.z),c=new s.Vector3;n.getCenter(c);const u=new s.Plane(new s.Vector3(0,0,-1),a.z),d=new s.Plane(new s.Vector3(0,0,1),-o.z),p=new s.Plane(new s.Vector3(-1,0,0),a.x),f=new s.Plane(new s.Vector3(1,0,0),-o.x),{front:m,back:g,left:_,right:y}=r(i),w=this.createFromPlane(u,{id:m,world:null==t?void 0:t.world});w.range=l;const v=this.createFromPlane(d,{id:g,world:null==t?void 0:t.world});v.range=l;const b=this.createFromPlane(p,{id:_,world:null==t?void 0:t.world});b.range=h;const x=this.createFromPlane(f,{id:y,world:null==t?void 0:t.world});x.range=h,e.push(w,v,b,x)}return e}open(t){const e=this.list.get(t);if(!e)throw new Error(`Views: the view with id ${t} doesn't exist.`);if(e.open)return;const{world:i}=e;if(!i)throw new Error(`Views: no world found for view with id ${t}.`);const{renderer:s}=i;if(!s)throw new Error(`Views: no renderer found for world with id ${i.uuid}.`);for(const[,t]of this.list)t.world===i&&this.close(t.id);s.setPlane(!0,e.plane),s.setPlane(!0,e.farPlane),e.camera.controls.addEventListener("rest",this._fragmentsUpdateEvent),i.camera=e.camera,e.open=!0}close(t){let e;if(e=t?this.list.get(t):[...this.list.values()].find((t=>t.open)),t&&!e)throw new Error(`Views: the view with id ${t} doesn't exist.`);if(!e)return;if(!e.open)return;const{world:i}=e;if(!i)throw new Error(`Views: no world found for view with id ${t}.`);const{renderer:s}=i;if(!s)throw new Error(`Views: no renderer found for world with id ${i.uuid}.`);s.setPlane(!1,e.plane),s.setPlane(!1,e.farPlane),e.camera.controls.removeEventListener("rest",this._fragmentsUpdateEvent),i.useDefaultCamera(),e.open=!1}};ne(Ka,"uuid","fb22f1f5-6598-4664-a11d-de8963ae420f"),ne(Ka,"defaultRange",15);let Ja=Ka;async function th(t,e,i,s,n,r,o){const a=t.fenceSync(t.SYNC_GPU_COMMANDS_COMPLETE,0);t.flush(),await function(t,e,i,s){return new Promise(((n,r)=>{!function o(){const a=t.clientWaitSync(e,i,0);a!==t.WAIT_FAILED?a!==t.TIMEOUT_EXPIRED?n():setTimeout(o,s):r()}()}))}(t,a,0,10),t.deleteSync(a),t.bindBuffer(e,i),t.getBufferSubData(e,s,n,r,o),t.bindBuffer(e,null)}class eh{constructor(t,e){if(ne(this,"onDisposed",new re),ne(this,"onDistanceComputed",new re),ne(this,"excludedObjects",new Set),ne(this,"enabled",!0),ne(this,"renderDebugFrame",!1),ne(this,"components"),ne(this,"scene",new s.Scene),ne(this,"camera",new s.OrthographicCamera(-1,1,1,-1,0,1)),ne(this,"depthMaterial"),ne(this,"world"),ne(this,"worker"),ne(this,"_width",512),ne(this,"_height",512),ne(this,"_postQuad"),ne(this,"tempRT"),ne(this,"resultRT"),ne(this,"bufferSize"),ne(this,"_buffer"),ne(this,"_isWorkerBusy",!1),ne(this,"compute",(async()=>{if(!this.enabled||this.world.isDisposing)return;if(this._isWorkerBusy)return;this._isWorkerBusy=!0,this.world.camera.three.updateMatrix();const t=this.world.renderer.three;t.setRenderTarget(this.tempRT);const e="visibilityBeforeDistanceCheck";for(const t of this.excludedObjects)t.userData[e]=t.visible,t.visible=!1;t.render(this.world.scene.three,this.world.camera.three);for(const t of this.excludedObjects)void 0!==t.userData[e]&&(t.visible=t.userData[e]);this.depthMaterial.uniforms.tDiffuse.value=this.tempRT.texture,this.depthMaterial.uniforms.tDepth.value=this.tempRT.depthTexture,t.setRenderTarget(this.resultRT),t.render(this.scene,this.camera);const i=t.getContext();try{await async function(t,e,i,s,n,r,o,a){const h=t.createBuffer();return t.bindBuffer(t.PIXEL_PACK_BUFFER,h),t.bufferData(t.PIXEL_PACK_BUFFER,a.byteLength,t.STREAM_READ),t.readPixels(e,i,s,n,r,o,0),t.bindBuffer(t.PIXEL_PACK_BUFFER,null),await th(t,t.PIXEL_PACK_BUFFER,h,0,a),t.deleteBuffer(h),a}(i,0,0,this._width,this._height,i.RGBA,i.UNSIGNED_BYTE,this._buffer)}catch(e){return t.setRenderTarget(null),void(this._isWorkerBusy=!1)}t.setRenderTarget(null),this.renderDebugFrame&&t.render(this.scene,this.camera),this.worker.postMessage({buffer:this._buffer})})),ne(this,"handleWorkerMessage",(t=>{if(!this.enabled||this.world.isDisposing)return;const e=t.data.colors;let i=Number.MAX_VALUE;for(const t of e)0!==t&&t<i&&(i=t);const n=this.world.camera.three||s.OrthographicCamera,r=-1*(i/255-1)*(n.far-n.near),o=Math.min(r,n.far);this.onDistanceComputed.trigger(o),this._isWorkerBusy=!1})),!e.renderer)throw new Error("The given world must have a renderer!");this.components=t,this.world=e;const i=e.camera.three;this.tempRT=new s.WebGLRenderTarget(this._width,this._height),this.bufferSize=this._width*this._height*4,this._buffer=new Uint8Array(this.bufferSize),this.tempRT.texture.minFilter=s.NearestFilter,this.tempRT.texture.magFilter=s.NearestFilter,this.tempRT.stencilBuffer=!1,this.tempRT.samples=0,this.tempRT.depthTexture=new s.DepthTexture(this._width,this._height),this.tempRT.depthTexture.format=s.DepthFormat,this.tempRT.depthTexture.type=s.UnsignedShortType,this.resultRT=new s.WebGLRenderTarget(this._width,this._height),this.depthMaterial=new s.ShaderMaterial({vertexShader:"\nvarying vec2 vUv;\n\nvoid main() {\n  vUv = uv;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}\n    ",fragmentShader:"\n#include <packing>\n\nvarying vec2 vUv;\nuniform sampler2D tDiffuse;\nuniform sampler2D tDepth;\nuniform float cameraNear;\nuniform float cameraFar;\n\n\nfloat readDepth( sampler2D depthSampler, vec2 coord ) {\n  float fragCoordZ = texture2D( depthSampler, coord ).x;\n  float viewZ = perspectiveDepthToViewZ( fragCoordZ, cameraNear, cameraFar );\n  return viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );\n}\n\nvoid main() {\n  //vec3 diffuse = texture2D( tDiffuse, vUv ).rgb;\n  float depth = readDepth( tDepth, vUv );\n\n  gl_FragColor.rgb = 1.0 - vec3( depth );\n  gl_FragColor.a = 1.0;\n}\n    ",uniforms:{cameraNear:{value:i.near},cameraFar:{value:i.far},tDiffuse:{value:null},tDepth:{value:null}}});const n=new s.PlaneGeometry(2,2);this._postQuad=new s.Mesh(n,this.depthMaterial),this.scene.add(this._postQuad);const r=new Blob(['\n      addEventListener("message", (event) => {\n        const { buffer } = event.data;\n        const colors = new Set();\n        for (let i = 0; i < buffer.length; i += 4) {\n          const r = buffer[i];\n          colors.add(r);\n        }\n        postMessage({ colors });\n      });\n    '],{type:"application/javascript"});this.worker=new Worker(URL.createObjectURL(r)),this.worker.addEventListener("message",this.handleWorkerMessage)}dispose(){this.enabled=!1,this.onDistanceComputed.reset(),this.worker.terminate(),this.tempRT.dispose(),this.resultRT.dispose();const t=[...this.scene.children];this.excludedObjects.clear();for(const e of t)e.removeFromParent();this._postQuad.geometry.dispose(),this._postQuad.removeFromParent(),this._buffer=null,this.onDisposed.reset()}}class ih extends fs{constructor(){super(...arguments),ne(this,"_distanceRenderer"),ne(this,"autoBias",!0),ne(this,"_defaultShadowConfig",{cascade:1,resolution:512}),ne(this,"_lightsWithShadow",new Map),ne(this,"_isComputingShadows",!1),ne(this,"_shadowsEnabled",!0),ne(this,"_bias",0),ne(this,"recomputeShadows",(t=>{if(!this._shadowsEnabled)return;this.autoBias&&(this.bias=-.005);if(t*=1.5,!this.currentWorld)throw new Error("A world needs to be assigned to the scene before computing shadows!");if(!this._lightsWithShadow.size)throw new Error("No shadows found!");const e=this.currentWorld.camera.three;if(!(e instanceof s.PerspectiveCamera||e instanceof s.OrthographicCamera))throw new Error("Invalid camera type!");const i=new s.Vector3;e.getWorldDirection(i);let n=t;const r=new s.Vector3;r.copy(this.config.directionalLight.position),r.normalize();for(const[t,o]of this._lightsWithShadow){const a=this.directionalLights.get(o);if(!a)throw new Error("Light not found.");const h=new s.Vector3;h.copy(i);const l=t===this._lightsWithShadow.size-1,c=l?n/2:2*n/3;h.multiplyScalar(c),h.add(e.position);const u=n-c,d=new s.Vector3;d.copy(r),d.multiplyScalar(u),a.target.position.copy(h),a.position.copy(h),a.position.add(d),a.shadow.camera.right=u,a.shadow.camera.left=-u,a.shadow.camera.top=u,a.shadow.camera.bottom=-u,a.shadow.camera.far=2*u,a.shadow.camera.updateProjectionMatrix(),a.shadow.camera.updateMatrix(),l||(n/=3)}this._isComputingShadows=!1}))}get bias(){return this._bias}set bias(t){this._bias=t;for(const[,e]of this._lightsWithShadow){const i=this.directionalLights.get(e);i&&(i.shadow.bias=t)}}get shadowsEnabled(){return this._shadowsEnabled}set shadowsEnabled(t){this._shadowsEnabled=t;for(const[,e]of this.directionalLights)e.castShadow=t}get distanceRenderer(){if(!this._distanceRenderer)throw new Error("You must set up this component before accessing the distance renderer!");return this._distanceRenderer}setup(t){super.setup(t);const e={...this._defaultConfig,...this._defaultShadowConfig,...t};if(e.cascade<=0)throw new Error("Config.shadows.cascade must be a natural number greater than 0!");if(e.cascade>1)throw new Error("Multiple shadows not supported yet!");if(!this.currentWorld)throw new Error("A world needs to be assigned to the scene before setting it up!");for(const[,t]of this.directionalLights)t.target.removeFromParent(),t.removeFromParent(),t.dispose();this.directionalLights.clear(),this._distanceRenderer||(this._distanceRenderer=new eh(this.components,this.currentWorld),this._distanceRenderer.onDistanceComputed.add(this.recomputeShadows)),this._lightsWithShadow.clear();for(let t=0;t<e.cascade;t++){const i=new s.DirectionalLight;i.intensity=this.config.directionalLight.intensity,i.color=this.config.directionalLight.color,i.position.copy(this.config.directionalLight.position),i.shadow.mapSize.width=e.resolution,i.shadow.mapSize.height=e.resolution,this.three.add(i,i.target),this.directionalLights.set(i.uuid,i),this._lightsWithShadow.set(t,i.uuid),i.castShadow=!0,i.shadow.bias=this._bias}}dispose(){super.dispose(),this._distanceRenderer&&this._distanceRenderer.dispose(),this._lightsWithShadow.clear()}async updateShadows(){!this._isComputingShadows&&this._shadowsEnabled&&(this._isComputingShadows=!0,await this.distanceRenderer.compute())}}class sh{constructor(t){ne(this,"cardinality","required"),ne(this,"instructions"),ne(this,"evalRequirement",((t,e,i,s)=>{const n={parameter:i,currentValue:t,requiredValue:e,pass:!1};s&&this.addCheckResult(n,s);let r=!1;if("simple"===e.type&&(r=t===e.parameter),"enumeration"===e.type&&(r=e.parameter.includes(t)),"pattern"===e.type){r=new RegExp(e.parameter).test(String(t))}if("length"===e.type){const{min:i,length:s,max:n}=e.parameter;void 0!==s&&(r=String(t).length===s),void 0!==i&&(r=String(t).length>=i),void 0!==n&&(r=String(t).length<=n)}if("bounds"===e.type&&"number"==typeof t){const{min:i,minInclusive:s,max:n,maxInclusive:o}=e.parameter;let a=!0,h=!0;void 0!==i&&(a=s?t>=i:t>i),void 0!==n&&(h=o?t<=n:t<n),r=a&&h}return"prohibited"===this.cardinality&&(r=!r),"optional"===this.cardinality&&(r=!0),n.pass=r,n.pass})),this._components=t}addCheckResult(t,e){const i=e.findIndex((({parameter:e})=>e===t.parameter));-1!==i?e[i]=t:e.push(t)}getItemChecks(e,i,s,n){if(!("value"in s._localId)||"number"!=typeof s._localId.value)return null;let r=e.get(i);r||(r=new t.DataMap,e.set(i,r));let o=r.get(s._localId.value);if(o&&n&&!o.pass)return null;if(!o){const t=[];o={guid:Array.isArray(s._guid)?void 0:s._guid.value,pass:!1,checks:t},Object.defineProperty(o,"pass",{get:()=>t.every((({pass:t})=>t))}),r.set(s._localId.value,o)}const a=[],h={facetType:this.facetType,cardinality:this.cardinality,checks:a,pass:!1};return Object.defineProperty(h,"pass",{get:()=>a.every((({pass:t})=>t))}),o.checks.push(h),h.checks}}const nh=(t,e)=>{let i="";if(!e)return i;if("simple"===e.type&&(i=`<simpleValue>${e.parameter}</simpleValue>`),"enumeration"===e.type){i=`<xs:restriction base="xs:string">\n    ${e.parameter.map((t=>`<xs:enumeration value="${t}" />`)).join("\n")}\n    </xs:restriction>`}if("pattern"===e.type){i=`<xs:restriction base="xs:string">\n      <xs:pattern value="${e.parameter}" />\n    </xs:restriction>`}if("bounds"===e.type){const{min:t,minInclusive:s,max:n,maxInclusive:r}=e.parameter;let o="";void 0!==t&&(o=`<xs:min${s?"Inclusive":"Exclusive"} value="${t}">`);let a="";void 0!==n&&(a=`<xs:max${r?"Inclusive":"Exclusive"} value="${n}">`),i=`<xs:restriction base="xs:double">\n      ${o}\n      ${a}\n    </xs:restriction>`}if("length"===e.type){const{length:t,min:s,max:n}=e.parameter;let r="";void 0!==t&&void 0===s&&void 0===n&&(r=`<xs:length value="${t}" />`);let o="";void 0!==s&&void 0===t&&(o=`<xs:minLength value="${s}" />`);let a="";void 0!==n&&void 0===t&&(a=`<xs:maxLength value="${n}" />`),i=`<xs:restriction base="xs:string">\n      ${r}\n      ${o}\n      ${a}\n    </xs:restriction>`}return`<${t[0].toLowerCase()+t.slice(1)}>\n    ${i}\n  </${t[0].toLowerCase()+t.slice(1)}>`};class rh extends sh{constructor(t,e){super(t),ne(this,"facetType","Attribute"),ne(this,"name"),ne(this,"value"),this.name=e}serialize(t){const e=nh("Name",this.name),i=nh("Value",this.value);let s="";return"requirement"===t&&(s+=`cardinality="${this.cardinality}"`,s+=this.instructions?`instructions="${this.instructions}"`:""),`<attribute ${s}>\n  ${e}\n  ${i}\n</attribute>`}async getEntities(){}async test(t,e,i={skipIfFails:!0}){const s=this._components.get(qi);for(const[n,r]of Object.entries(t)){const t=s.list.get(n);if(!t)continue;const o=await t.getItemsData([...r]);for(const t of o){const s=this.getItemChecks(e,n,t,i.skipIfFails);if(!s)continue;const r=Object.keys(t).filter((e=>{const i=this.evalRequirement(e,this.name,"Name");if(!i)return!1;const s=t[e];return!!Array.isArray(s)||(null===s||null===s.value?"optional"===this.cardinality||"prohibited"===this.cardinality:(!Array.isArray(s.value)||0!==s.value.length)&&(("string"!=typeof s.value||""!==s.value.trim())&&i))})),o=r.length>0;if(s.push({parameter:"Name",currentValue:o?r[0]:null,requiredValue:this.name,pass:"prohibited"===this.cardinality?!o:o}),this.value)if(r[0]){const e=t[r[0]];if(Array.isArray(e))s.push({parameter:"Value",currentValue:null,requiredValue:this.value,pass:"prohibited"===this.cardinality});else{Array.isArray(e.value)?s.push({parameter:"Value",currentValue:null,requiredValue:this.value,pass:"prohibited"===this.cardinality}):this.evalRequirement(e.value,this.value,"Value",s)}}else s.push({parameter:"Value",currentValue:null,requiredValue:this.value,pass:"prohibited"===this.cardinality})}}}}class oh extends sh{constructor(t,e){super(t),ne(this,"facetType","Classification"),ne(this,"system"),ne(this,"value"),ne(this,"uri"),this.system=e}serialize(t){const e=nh("System",this.system),i=nh("Value",this.value);let s="";return"requirement"===t&&(s+=`cardinality="${this.cardinality}"`,s+=this.uri?`uri=${this.uri}`:"",s+=this.instructions?`instructions="${this.instructions}"`:""),`<classification ${s}>\n  ${e}\n  ${i}\n</classification>`}async getEntities(t,e){}async test(t,e){}}class ah extends sh{constructor(t,e){super(t),ne(this,"facetType","Entity"),ne(this,"name"),ne(this,"predefinedType"),this.name=e}serialize(t){const e=nh("Name",this.name),i=nh("Name",this.predefinedType);let s="";return"requirement"===t&&(s+=`cardinality="${this.cardinality}"`,s+=this.instructions?`instructions="${this.instructions}"`:""),`<entity ${s}>\n  ${e}\n  ${i}\n</entity>`}async getEntities(t,e){const i=this._components.get(qi),s=new Map;for(const[e,n]of i.list){if(!t.find((t=>t.test(e))))continue;const i=await n.getCategories();for(const t of i){if(!await this.evalName(t))continue;let i=s.get(e);i||(i=[],s.set(e,i)),i.push(t)}}const n={};if(await Promise.all(Array.from(s.entries()).map((async([t,e])=>{const s=i.list.get(t);if(!s)return;const r=e.map((t=>new RegExp(`^${t}$`))),o=await s.getItemsOfCategories(r),a=Object.values(o).flat();n[t]=new Set(a)}))),this.predefinedType)for(const[t,s]of Object.entries(n)){const n=i.list.get(t);if(!n)continue;const r=await n.getItemsData([...s]);for(const i of r){if(!("value"in i._localId))continue;await this.evalPredefinedType(t,i)&&Li.append(e,t,i._localId.value)}}else Li.add(e,n)}async test(t,e,i){const s=this._components.get(qi);for(const[n,r]of Object.entries(t)){const t=s.list.get(n);if(!t)continue;const o=await t.getItemsData([...r]);for(const t of o){if(!("value"in t._category))continue;const s=this.getItemChecks(e,n,t,i.skipIfFails);s&&(await this.evalName(t._category.value,s),await this.evalPredefinedType(n,t,s))}}}async evalName(t,e){return this.evalRequirement(t,this.name,"Name",e)}async evalPredefinedType(t,e,i){if(!this.predefinedType)return null;if(!("value"in e.PredefinedType))return null;const s="string"==typeof this.predefinedType.parameter&&"USERDEFINED"===this.predefinedType.parameter;let n=e.PredefinedType.value;if("USERDEFINED"===n&&!s){const t=Object.keys(e).find((t=>/^((?!Predefined).)*Type$/.test(t)));if(t){const i=e[t];"value"in i&&(n=i.value)}else n="USERDEFINED"}if(!n){const i=this._components.get(qi).list.get(t);if(i&&"value"in e._localId){const[t]=await i.getItemsData([e._localId.value],{relations:{IsTypedBy:{attributes:!0,relations:!1}}});if(Array.isArray(t.IsTypedBy)){const e=t.IsTypedBy[0];if(e&&"value"in e.PredefinedType&&(n=e.PredefinedType.value,"USERDEFINED"===n&&!s)){const t=Object.keys(e).find((t=>/^((?!Predefined).)*Type$/.test(t)));if(t){const i=e[t];"value"in i&&(n=i.value)}else n="USERDEFINED"}}}}return this.evalRequirement(n,this.predefinedType,"PredefinedType",i)}}class hh extends sh{constructor(t,e,i){super(t),ne(this,"facetType","Property"),ne(this,"propertySet"),ne(this,"baseName"),ne(this,"value"),ne(this,"dataType"),ne(this,"uri"),ne(this,"_unsupportedTypes",["IFCCOMPLEXPROPERTY","IFCPHYSICALCOMPLEXQUANTITY"]),this.propertySet=e,this.baseName=i}serialize(t){const e=nh("PropertySet",this.propertySet),i=nh("BaseName",this.baseName),s=nh("Value",this.value),n=this.dataType?`dataType=${this.dataType}`:"";let r="";return"requirement"===t&&(r+=`cardinality="${this.cardinality}"`,r+=this.uri?`uri=${this.uri}`:"",r+=this.instructions?`instructions="${this.instructions}"`:""),`<property ${n} ${r}>\n  ${e}\n  ${i}\n  ${s}\n</property>`}async getEntities(t,e){const i=this._components.get(qi);for(const[s,n]of i.list){if(!t.find((t=>t.test(s))))continue;const i=await n.getItemsOfCategories([/PROPERTYSET/,/ELEMENTQUANTITY/]),r=Object.values(i).flat();if(0===r.length)continue;const o=await n.getItemsData(r,{relations:{HasProperties:{attributes:!0,relations:!1},DefinesOcurrence:{attributes:!0,relations:!1}}});for(const t of o){if(!("value"in t._localId&&"value"in t._category&&"value"in t.Name&&Array.isArray(t.DefinesOcurrence)))continue;if(!this.evalRequirement(t.Name.value,this.propertySet,"PropertySet"))continue;let i;if("IFCPROPERTYSET"===t._category.value&&(i="HasProperties"),"IFCELEMENTQUANTITY"===t._category.value&&(i="Quantities"),!i)continue;const n=t[i];if(Array.isArray(n))for(const i of n){const n=Object.keys(i),r=n.find((t=>/Name/.test(t)));if(!r||!("value"in i[r]))continue;const o=i[r];if(!("value"in o))continue;if(!this.evalRequirement(o.value,this.baseName,"BaseName"))continue;if(this.value){const t=n.find((t=>/Value/.test(t)));if(!t)continue;const e=i[t];if(!("value"in e))continue;if(!this.evalRequirement(e.value,this.value,"Value"))continue}const a=t.DefinesOcurrence.map((t=>"value"in t._localId&&"number"==typeof t._localId.value?t._localId.value:null)).filter((t=>null!==t));Li.append(e,s,...a)}}}}async test(t,e,i={skipIfFails:!0}){const s=this._components.get(qi);for(const[n,r]of Object.entries(t)){const t=s.list.get(n);if(!t)continue;const o=await t.getItemsData([...r],{relations:{IsDefinedBy:{attributes:!0,relations:!0},IsTypedBy:{attributes:!0,relations:!1},HasPropertySets:{attributes:!0,relations:!0},DefinesOcurrence:{attributes:!1,relations:!1}}});for(const t of o){const s=this.getItemChecks(e,n,t,i.skipIfFails);if(!s)continue;const r=(await this.getPsets(t)).filter((t=>{if(!("value"in t.Name))return!1;return!!this.evalRequirement(t.Name.value,this.propertySet,"PropertySet")&&(s.push({currentValue:t.Name.value,parameter:"PropertySet",pass:!0,requiredValue:this.propertySet}),!0)}));if(0!==r.length)for(const t of r){const e=this.getPropertyListName(t);if(!e)continue;const i=t[e];if(!Array.isArray(i)){s.push({currentValue:null,parameter:"BaseName",pass:!1,requiredValue:this.baseName});continue}const n=i.filter((t=>{if(!("value"in t._category)||!("value"in t.Name))return!1;if(this._unsupportedTypes.includes(t._category.value))return!1;return!!this.evalRequirement(t.Name.value,this.baseName,"BaseName")&&(s.push({currentValue:t.Name.value,parameter:"BaseName",pass:!0,requiredValue:this.baseName}),!0)}));if(0!==n.length)for(const t of n)this.evalValue(t,s),this.evalDataType(t,s),this.evalURI();else s.push({currentValue:null,parameter:"BaseName",pass:!1,requiredValue:this.baseName})}else s.push({currentValue:null,parameter:"PropertySet",pass:!1,requiredValue:this.propertySet})}}}getPropertyListName(t){let e;return"value"in t._category?("IFCPROPERTYSET"===t._category.value&&(e="HasProperties"),"IFCELEMENTQUANTITY"===t._category.value&&(e="Quantities"),e):e}getValueKey(t){return Object.keys(t).find((t=>/Value/.test(t)||/Values/.test(t)))}getTypePsets(t){if(!Array.isArray(t.IsTypedBy))return[];const[e]=t.IsTypedBy;return e&&Array.isArray(e.HasPropertySets)?e.HasPropertySets:[]}async getPsets(t){const e=this.getTypePsets(t);if(!Array.isArray(t.IsDefinedBy))return e;const i=[];for(const s of t.IsDefinedBy){if(!("value"in s.Name))continue;const t=s.Name.value,n=this.getPropertyListName(s);if(!t||!n)continue;const r=e.find((e=>"value"in e.Name&&e.Name.value===t));if(r&&Array.isArray(r.HasProperties)&&Array.isArray(s.HasProperties))for(const t of r.HasProperties){if(!("value"in t.Name))continue;const e=t.Name.value;s.HasProperties.find((t=>"value"in t.Name&&t.Name.value===e))||s.HasProperties.push(t)}i.push(s)}return i}evalValue(t,e){const i=this.getValueKey(t),s=t[i];if(!("value"in s))return!1;if(this.value){if(!i)return null==e||e.push({parameter:"Value",currentValue:null,pass:!1,requiredValue:this.value}),!1;const t=structuredClone(this.value);"IFCLABEL"===s.type&&"simple"===t.type&&(t.parameter=String(t.parameter));return this.evalRequirement(s.value,t,"Value",e)}return!i||("string"!=typeof s.value||""!==s.value.trim()||(null==e||e.push({parameter:"Value",currentValue:"",pass:!1,requiredValue:this.value}),!1))}evalDataType(t,e){if(!this.dataType)return!0;const i=this.getValueKey(t);if(!i||!("value"in t[i]))return null==e||e.push({parameter:"DataType",currentValue:null,pass:!1,requiredValue:this.dataType}),!1;const s=t[i];return this.evalRequirement(s.type??null,{type:"simple",parameter:this.dataType},"DataType",e)}evalURI(){return!0}}class lh extends sh{constructor(){super(...arguments),ne(this,"_ifcMaterialEntities",[/^IFCMATERIALLAYERSETUSAGE$/,/^IFCMATERIALCONSTITUENTSET$/,/^IFCMATERIAL$/,/^IFCMATERIALLIST$/]),ne(this,"facetType","Material"),ne(this,"value"),ne(this,"uri")}serialize(t){if(!this.value||!this.uri)return"<material />";const e=nh("Value",this.value);let i="";return"requirement"===t&&(i+=`cardinality="${this.cardinality}"`,i+=this.uri?`uri=${this.uri}`:"",i+=this.instructions?`instructions="${this.instructions}"`:""),`<material ${i}>\n  ${e}\n</material>`}async getEntities(t,e){const i=this._components.get(qi);for(const[s,n]of i.list){if(!t.find((t=>t.test(s))))continue;const i=await n.getItemsOfCategories(this._ifcMaterialEntities),r=Object.values(i).flat();if(0===r.length)continue;const o=await n.getItemsData(r,{relations:{AssociatedTo:{attributes:!0,relations:!1},MaterialConstituents:{attributes:!0,relations:!0},ForLayerSet:{attributes:!0,relations:!0},MaterialLayers:{attributes:!0,relations:!0},Materials:{attributes:!0,relations:!1}}});for(const t of o){if(!("value"in t._localId&&"value"in t._category&&Array.isArray(t.AssociatedTo)))continue;if(!this.hasValidMaterial(t))continue;const i=t.AssociatedTo.map((t=>"value"in t._localId&&t._localId.value?t._localId.value:null)).filter((t=>null!==t));Li.append(e,s,...i)}}}async test(t,e,i={skipIfFails:!0}){const s=this._components.get(qi);for(const[n,r]of Object.entries(t)){const t=s.list.get(n);if(!t)continue;const o=await t.getItemsData([[...r][0]],{relations:{AssociatedTo:{attributes:!1,relations:!1},HasAssociations:{attributes:!0,relations:!0},MaterialConstituents:{attributes:!0,relations:!0},ForLayerSet:{attributes:!0,relations:!0},MaterialLayers:{attributes:!0,relations:!0},Materials:{attributes:!0,relations:!1}}});for(const t of o){const s=this.getItemChecks(e,n,t,i.skipIfFails);if(s)if(Array.isArray(t.HasAssociations))for(const e of t.HasAssociations){if(!this._ifcMaterialEntities.some((t=>"value"in e._category&&t.test(e._category.value))))continue;if(this.hasValidMaterial(e,s))break}else s.push({parameter:null,currentValue:null,requiredValue:this.value,pass:!1})}}}hasValidMaterial(t,e){let i=!1;if("value"in t._category&&"IFCMATERIAL"===t._category.value){this.evalValue(t,e)&&(i=!0)}else for(const[s,n]of Object.entries(t))if(["ForLayerSet","MaterialLayers","Material","MaterialConstituents","Materials"].includes(s)&&Array.isArray(n))for(const t of n){if("value"in t._category&&"IFCMATERIAL"===t._category.value){if(this.evalValue(t,e)){i=!0;break}}else{if(this.hasValidMaterial(t)){i=!0;break}}}return i}evalValue(t,e){if(!this.value)return null==e||e.push({parameter:null,currentValue:t.Name&&"value"in t.Name?t.Name.value:null,pass:!0}),!0;if(!("value"in t._category)||"IFCMATERIAL"!==t._category.value)return null;let i=!1;return t.Name&&"value"in t.Name&&(i=this.evalRequirement(t.Name.value,this.value,"Value",e)),i||(t.Category&&"value"in t.Category&&(i=this.evalRequirement(t.Category.value,this.value,"Value",e)),i)}}class ch extends sh{constructor(t,e){super(t),ne(this,"facetType","PartOf"),ne(this,"_entityFacet"),ne(this,"_entity"),ne(this,"relation"),ne(this,"cardinality","required"),this._entity=e,this._entityFacet=new ah(t,e.name),this._entityFacet.predefinedType=e.predefinedType}set entity(t){this._entity=t;const{name:e,predefinedType:i}=t;this._entityFacet=new ah(this._components,e),this._entityFacet.predefinedType=i}get entity(){return this._entity}serialize(){return""}async getEntities(t,e){}async test(t){}}class uh{constructor(e,i,s){ne(this,"name"),ne(this,"ifcVersion",new Set),ne(this,"identifier",_e.create()),ne(this,"description"),ne(this,"instructions"),ne(this,"requirementsDescription"),ne(this,"applicability",new t.DataSet),ne(this,"requirements",new t.DataSet),ne(this,"components"),this.components=e,this.name=i;for(const t of s)this.ifcVersion.add(t)}set(t){const e=t,i=this;for(const s in t){if("identifier"===s)continue;const t=e[s];s in this&&(i[s]=t)}return this.components.get(vh).list.set(this.identifier,this),this}async test(e,i={skipIfFails:!0}){const s=new t.DataMap;if(0===this.requirements.size)return s;const n={},r=[];for(const t of this.applicability)r.push(t.getEntities(e,n));await Promise.all(r);const o=[];for(const t of this.requirements)o.push(t.test(n,s,i));return await Promise.all(o),s}serialize(){const t=`name="${this.name}"`,e=this.identifier?`identifier="${this.identifier}"`:"",i=this.description?`description="${this.description}"`:"",s=this.instructions?`instructions="${this.instructions}"`:"";return`<specification ifcVersion="${[...this.ifcVersion].join(" ")}" ${t} ${e} ${i} ${s}>\n      <applicability minOccurs="1" maxOccurs="unbounded">\n        ${[...this.applicability].map((t=>t.serialize("applicability"))).join("\n")}\n      </applicability>\n      <requirements>\n        ${[...this.requirements].map((t=>t.serialize("requirement"))).join("\n")}\n      </requirements>\n    </specification>`}}const dh=t=>{if(!t)return;const e={};if("simpleValue"in t&&(e.type="simple",e.parameter=t.simpleValue),"restriction"in t){const i=t.restriction,s=Object.keys(i);if("pattern"in i&&(e.type="pattern",e.parameter=i.pattern.value),"enumeration"in i){e.type="enumeration";const t=i.enumeration.map((({value:t})=>i.base.includes("string")?String(t):i.base.includes("integer")||i.base.includes("double")?Number(t):t));e.parameter=t}if(s.some((t=>["minInclusive","minExclusive","maxInclusive","maxExclusive"].includes(t)))){e.type="bounds";const t={},n=s.find((t=>t.includes("min"))),r=s.find((t=>t.includes("max")));n&&(t.minInclusive="minInclusive"===n,t.min=i[n].value),r&&(t.maxInclusive="maxInclusive"===r,t.max=i[r].value),e.parameter=t}if(s.some((t=>["minLength","length","maxLength"].includes(t)))){e.type="length";const t={};void 0!==i.length&&(t.length=i.length.value),void 0!==i.minLength&&(t.min=i.minLength.value),void 0!==i.maxLength&&(t.max=i.maxLength.value),e.parameter=t}}return void 0!==e.parameter?e:void 0},ph=(t,e)=>{const i=[];for(const s of e){const e=s.name,n=dh(e);if(!n)continue;const r=new ah(t,n);s.cardinality&&(r.cardinality=s.cardinality),r.predefinedType=dh(s.predefinedType),r.instructions=s.instructions,i.push(r)}return i},fh=(t,e)=>{const i=[];for(const s of e){const e=s.name,n=dh(e);if(!n)continue;const r=new rh(t,n);s.cardinality&&(r.cardinality=s.cardinality),r.value=dh(s.value),r.instructions=s.instructions,i.push(r)}return i},mh=(t,e)=>{const i=[];for(const s of e){const e=new lh(t);s.cardinality&&(e.cardinality=s.cardinality);const n=dh(s.value);"enumeration"===(null==n?void 0:n.type)&&Array.isArray(n.parameter)&&(n.parameter=n.parameter.map(String)),e.value=n,e.uri=s.uri,e.instructions=s.instructions,i.push(e)}return i},gh=(t,e)=>{const i=[];for(const s of e){const e=s.propertySet,n=s.baseName,r=dh(e),o=dh(n);if(!o||!r)continue;const a=new hh(t,r,o);s.cardinality&&(a.cardinality=s.cardinality);const h=dh(s.value);a.value=h,a.dataType=s.dataType,a.uri=s.uri,a.instructions=s.instructions,i.push(a)}return i},_h=(t,e)=>{const i=[];for(const s of e){const e=s.system,n=dh(e);if(!n)continue;const r=new oh(t,n);s.cardinality&&(r.cardinality=s.cardinality);const o=dh(s.value);"simple"===(null==o?void 0:o.type)&&(o.parameter=String(o.parameter)),"enumeration"===(null==o?void 0:o.type)&&Array.isArray(o.parameter)&&(o.parameter=o.parameter.map(String)),r.value=o,r.uri=s.uri,r.instructions=s.instructions,i.push(r)}return i},yh=(t,e)=>{const i=[];for(const s of e){const e=dh(s.entity.name);if(!e)continue;const n=dh(s.entity.predefinedType),r=new ch(t,{name:e,predefinedType:n});r.relation=s.relation,s.cardinality&&(r.cardinality=s.cardinality),r.instructions=s.instructions,i.push(r)}return i},wh=class t extends he{constructor(e){super(e),ne(this,"enabled",!0),ne(this,"IDSInfo"),ne(this,"list",new Fi),e.add(t.uuid,this)}getModelIdMap(t){const e={},i={};for(const[s,n]of t){const t=[...n].filter((([,t])=>t.pass)).map((([t])=>t));Li.append(e,s,...t);const r=[...n].filter((([,t])=>!t.pass)).map((([t])=>t));Li.append(i,s,...r)}return{pass:e,fail:i}}create(t,e,i){const s=new uh(this.components,t,e);return i&&(s.identifier=i),this.list.set(s.identifier,s),s}load(e){const i=[],s=t.xmlParser.parse(e).ids,{specifications:n,info:r}=s;if(this.IDSInfo={...r},n&&n.specification){const t=Array.isArray(n.specification)?n.specification:[n.specification];for(const e of t){const{name:t,ifcVersion:s,description:n,instructions:r,identifier:o}=e;if(!t||!s)continue;const a=[],h=[],{applicability:l,requirements:c}=e;if(l){const{maxOccurs:t,...e}=l,i=Array.isArray(e)?e:[e];for(const t of i)for(const e in t){const i=Array.isArray(t[e])?t[e]:[t[e]];if("entity"===e){const t=ph(this.components,i);a.push(...t)}if("attribute"===e){const t=fh(this.components,i);a.push(...t)}if("material"===e){const t=mh(this.components,i);a.push(...t)}if("classification"===e){const t=_h(this.components,i);a.push(...t)}if("property"===e){const t=gh(this.components,i);a.push(...t)}if("partOf"===e){const t=yh(this.components,i);a.push(...t)}}}let u;if(c){const{maxOccurs:t,...e}=c;u=c.description;const i=Array.isArray(e)?e:[e];for(const t of i)for(const e in t){const i=Array.isArray(t[e])?t[e]:[t[e]];if("entity"===e){const t=ph(this.components,i);h.push(...t)}if("attribute"===e){const t=fh(this.components,i);h.push(...t)}if("material"===e){const t=mh(this.components,i);h.push(...t)}if("classification"===e){const t=_h(this.components,i);h.push(...t)}if("property"===e){const t=gh(this.components,i);h.push(...t)}if("partOf"===e){const t=yh(this.components,i);h.push(...t)}}}const d=this.create(t,s.split(/\s+/),o);d.description=n,d.instructions=r,d.requirementsDescription=u,d.applicability.add(...a),d.requirements.add(...h),i.push(d)}}return i}export(t,e=this.list.values()){const i=e??this.list;return`<ids xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://standards.buildingsmart.org/IDS http://standards.buildingsmart.org/IDS/1.0/ids.xsd" xmlns:ids="http://standards.buildingsmart.org/IDS">\n  \x3c!-- Made with That Open Engine ${qo.release} (https://github.com/thatopen/engine_components) --\x3e\n  <info>\n    <title>${t.title}</title>\n    ${t.copyright?`<copyright>${t.copyright}</copyright>`:""}\n    ${t.version?`<version>${t.version}</version>`:""}\n    ${t.description?`<description>${t.description}</description>`:""}\n    ${t.author?`<author>${t.author}</author>`:""}\n    ${t.date?`<date>${t.date.toISOString().split("T")[0]}</date>`:""}\n    ${t.purpose?`<purpose>${t.purpose}</purpose>`:""}\n    ${t.milestone?`<milestone>${t.milestone}</milestone>`:""}\n  </info>\n  <specifications>\n    ${[...i].map((t=>t.serialize())).join("\n")}\n  </specifications>\n</ids>`}};ne(wh,"uuid","9f0b9f78-9b2e-481a-b766-2fbfd01f342c"),ne(wh,"xmlParser",new Ui.XMLParser({allowBooleanAttributes:!0,attributeNamePrefix:"",ignoreAttributes:!1,ignoreDeclaration:!0,ignorePiTags:!0,numberParseOptions:{leadingZeros:!0,hex:!0},parseAttributeValue:!0,preserveOrder:!1,processEntities:!1,removeNSPrefix:!0,trimValues:!0}));let vh=wh;const bh=class t extends he{constructor(e){super(e),ne(this,"enabled",!0),e.add(t.uuid,this)}static distanceFromPointToLine(t,e,i,n=!1){const r=new s.Line3,o=new s.Vector3;return r.set(e,i),r.closestPointToPoint(t,n,o),o.distanceTo(t)}round(t){const e=1e3;t.x=Math.trunc(t.x*e)/e,t.y=Math.trunc(t.y*e)/e,t.z=Math.trunc(t.z*e)/e}async getVolumeFromFragments(t){return console.warn("getVolumeFromFragments is deprecated. Use getItemsVolume instead."),this.getItemsVolume(t)}async getItemsVolume(t){let e=0;const i=this.components.get(qi);for(const[s,n]of Object.entries(t)){const t=i.list.get(s);t&&(e+=await t.getItemsVolume([...n]))}return e}static convertUnits(t,e,i,s=2){const n={m:1,cm:.01,mm:.001,km:1e3,m2:1,cm2:1e-4,mm2:1e-6,km2:1e6,m3:1,cm3:1e-6,mm3:1e-9,km3:1e9};if(!n[e]||!n[i])throw new Error("Invalid units provided for conversion.");if(!Number.isInteger(s)||s<0||s>5)throw new Error("Precision must be an integer between 0 and 5.");let r=n[e]/n[i];e.endsWith("2")&&i.endsWith("2")?r**=2:e.endsWith("3")&&i.endsWith("3")&&(r**=3);const o=t*r,a=10**s;return Math.round(o*a)/a}};ne(bh,"uuid","267ca032-672f-4cb0-afa9-d24e904f39d6");let xh=bh;export{oe as AsyncEvent,la as BCFTopics,aa as BCFTopicsConfigManager,ae as Base,ce as BaseCamera,ue as BaseRenderer,fe as BaseScene,le as BaseWorldItem,es as BoundingBoxer,os as Classifier,$a as Clipper,sa as Comment,he as Component,qo as Components,Hi as ConfigManager,Yi as Configurator,Vi as ControlsUtils,Fi as DataMap,me as DataSet,pe as Disposer,re as Event,ji as EventManager,is as FinderQuery,Xo as FirstPersonMode,qi as FragmentsManager,vn as Grids,Ji as Hider,rh as IDSAttribute,oh as IDSClassification,ah as IDSEntity,sh as IDSFacet,lh as IDSMaterial,ch as IDSPartOf,hh as IDSProperty,uh as IDSSpecification,vh as IDSSpecifications,Xi as IfcFragmentSettings,Qi as IfcLoader,ns as ItemsFinder,xh as MeasurementUtils,Li as ModelIdMapUtils,$i as Mouse,Go as OrbitMode,Jo as OrthoPerspectiveCamera,Qo as PlanMode,Ko as ProjectionManager,ls as Raycasters,ms as RendererMode,ih as ShadowedScene,fn as SimpleCamera,yn as SimpleGrid,_n as SimpleGridConfigManager,Ya as SimplePlane,as as SimpleRaycaster,gs as SimpleRenderer,fs as SimpleScene,ps as SimpleSceneConfigManager,cs as SimpleWorld,ra as Topic,_e as UUID,Ni as VertexPicker,Qa as View,Wa as Viewpoint,Ga as Viewpoints,Ja as Views,gn as Worlds,Ri as XML,oa as extensionsImporter};export default null;
//# sourceMappingURL=/sm/3051d8984e89a10b081be291670accbc2df4ab96fc20adbcaedb07aa601293be.map